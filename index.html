<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter&family=Lato&family=Montserrat&family=Nunito&family=Open+Sans&family=Poppins&family=Roboto&family=Source+Sans+Pro&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%20300%20300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%20%20%3Crect%20width%3D%22290%22%20height%3D%22290%22%20fill%3D%22%23444%22%20rx%3D%2210%22%20ry%3D%2210%22%20%2F%3E%20%20%3Cdefs%3E%20%20%20%20%3Cpattern%20id%3D%22peg-grid%22%20x%3D%2215%22%20y%3D%2215%22%20width%3D%2230%22%20height%3D%2230%22%20patternUnits%3D%22userSpaceOnUse%22%3E%20%20%20%20%20%20%3Ccircle%20cx%3D%2210%22%20cy%3D%2210%22%20r%3D%2210.5%22%20fill%3D%22%23000%22%20%2F%3E%20%20%20%20%3C%2Fpattern%3E%20%20%3C%2Fdefs%3E%20%20%3Crect%20x%3D%225%22%20y%3D%225%22%20width%3D%22275%22%20height%3D%22275%22%20fill%3D%22url(%23peg-grid)%22%20%2F%3E%20%20%3Cg%20fill%3D%22%23ff8%22%3E%20%20%20%20%3Ccircle%20cx%3D%2225%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2225%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2225%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2255%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2255%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2255%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22235%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22235%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22235%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22265%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22265%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22265%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22115%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22115%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22115%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22145%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22145%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22145%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22175%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22175%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22175%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22205%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22205%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22205%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22235%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22235%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22235%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22265%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22265%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22265%22%20r%3D%2210.5%22%20%2F%3E%20%20%3C%2Fg%3E%3C%2Fsvg%3E">
    <style>
:root {
    --bg-primary: #f5f5f5;
    --bg-secondary: white;
    --bg-tertiary: #f8f9fa;
    --bg-header: #2c3e50;
    --bg-tool-header: #34495e;
    --text-primary: #333;
    --text-secondary: #666;
    --text-muted: #7f8c8d;
    --text-heading: #2c3e50;
    --border-color: #ddd;
    --border-light: #eee;
    --shadow-light: rgba(0,0,0,0.1);
    --shadow-medium: rgba(0,0,0,0.15);
    --shadow-heavy: rgba(0,0,0,0.25);
    --overlay-bg: rgba(0,0,0,0.5);
    --code-bg: #f4f4f4;
    --table-stripe: #f8f9fa;
    --table-hover: #e8f4fd;
    --input-bg: white;
    --success-bg: #d4edda;
    --success-text: #155724;
    --error-bg: #f8d7da;
    --error-text: #721c24;
}

body.dark-mode {
    --bg-primary: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-tertiary: #1f2940;
    --bg-header: #0f0f23;
    --bg-tool-header: #1f2940;
    --text-primary: #e4e4e7;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --text-heading: #e4e4e7;
    --border-color: #3f3f46;
    --border-light: #27272a;
    --shadow-light: rgba(0,0,0,0.3);
    --shadow-medium: rgba(0,0,0,0.4);
    --shadow-heavy: rgba(0,0,0,0.5);
    --overlay-bg: rgba(0,0,0,0.7);
    --code-bg: #27272a;
    --table-stripe: #1f2940;
    --table-hover: #2d3a52;
    --input-bg: #1f2940;
    --success-bg: #064e3b;
    --success-text: #6ee7b7;
    --error-bg: #7f1d1d;
    --error-text: #fca5a5;
}

/* Dark mode scrollbar */
body.dark-mode ::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

body.dark-mode ::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

body.dark-mode ::-webkit-scrollbar-thumb {
    background: #4a4a5a;
    border-radius: 5px;
}

body.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: #5a5a6a;
}

body.dark-mode {
    scrollbar-color: #4a4a5a var(--bg-secondary);
}

/* Calculator Widget Styles */
.calc-widget {
    background: var(--bg-tertiary);
    padding: 15px;
    border-radius: 6px;
}
.calc-widget input, .calc-widget select {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    background: var(--input-bg);
    color: var(--text-primary);
}
.calc-widget label {
    display: block;
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
}
.calc-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}
.calc-card {
    background: var(--bg-secondary);
    padding: 10px;
    border-radius: 4px;
    text-align: center;
}
.calc-card-label {
    font-size: 12px;
    color: var(--text-muted);
}
.calc-card-value {
    font-size: 18px;
    font-weight: 600;
}
.calc-card-value.large {
    font-size: 20px;
}
.calc-card-value.positive { color: #27ae60; }
.calc-card-value.negative { color: #c0392b; }
.calc-card-value.info { color: #2980b9; }
.calc-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 12px;
}
.calc-section-title {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-muted);
}
.calc-highlight {
    background: var(--success-bg);
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
}
.calc-highlight-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--success-text);
    margin-bottom: 5px;
}
.calc-toggle {
    display: flex;
    gap: 0;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}
.calc-toggle label {
    flex: 1;
    margin: 0;
}
.calc-toggle span {
    display: block;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    font-size: 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
}
.calc-toggle input:checked + span {
    background: #3498db;
    color: white;
}
.calc-toggle input {
    display: none;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--bg-primary);
    min-height: 100vh;
    font-size: 12px;
    color: var(--text-primary);
    transition: background 0.3s, color 0.3s;
    overscroll-behavior: none;
}

/* Prevent pull-to-refresh and overscroll when dragging */
html {
    overscroll-behavior: none;
}

/* Prevent scrolling when actively dragging/resizing */
body.is-dragging,
body.is-resizing {
    overflow: hidden;
    touch-action: none;
}

header {
    background: var(--bg-header);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10002;
    transition: background 0.3s;
}

header h1 {
    font-size: 1.5rem;
}

.header-title-area {
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-settings-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}

.header-settings-btn:hover {
    background: rgba(255,255,255,0.3);
}

.toolboard-version {
    font-size: 10px;
    opacity: 0.7;
    font-weight: normal;
    margin-left: 8px;
    background: rgba(255,255,255,0.15);
    padding: 2px 8px;
    border-radius: 10px;
}

.toolboard-settings {
    position: absolute;
    top: 100%;
    left: 20px;
    background: var(--bg-secondary);
    border-radius: 6px;
    box-shadow: 0 4px 20px var(--shadow-heavy);
    padding: 12px;
    z-index: 10001;
    min-width: 250px;
    display: none;
    color: var(--text-primary);
}

.toolboard-settings.open {
    display: block;
}

.toolboard-settings label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.toolboard-settings input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.toolboard-settings input[type="text"]:focus {
    outline: none;
    border-color: #3498db;
}

.font-select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
    cursor: pointer;
}

.font-select:focus {
    outline: none;
    border-color: #3498db;
}

.header-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.storage-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.15);
    border-radius: 4px;
    font-size: 11px;
    color: rgba(255,255,255,0.9);
    cursor: pointer;
    transition: background 0.2s;
}

.storage-indicator:hover {
    background: rgba(255,255,255,0.25);
}

.storage-bar {
    width: 60px;
    height: 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
    overflow: hidden;
}

.storage-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s, background 0.3s;
}

.storage-bar-fill.low { background: #27ae60; }
.storage-bar-fill.medium { background: #f39c12; }
.storage-bar-fill.high { background: #e74c3c; }

.storage-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.storage-modal {
    background: var(--bg-secondary);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px var(--shadow-heavy);
}

.storage-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
}

.storage-modal-header h3 {
    margin: 0;
    font-size: 16px;
    color: var(--text-primary);
}

.storage-modal-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.storage-modal-header button:hover {
    color: var(--text-primary);
}

.storage-modal-body {
    padding: 15px 20px;
    overflow-y: auto;
}

.storage-total {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 15px;
    padding: 10px;
    background: var(--bg-tertiary);
    border-radius: 4px;
}

.storage-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

.storage-table th,
.storage-table td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.storage-table th {
    font-weight: 600;
    color: var(--text-muted);
    background: var(--bg-tertiary);
}

.storage-table td:first-child {
    color: var(--text-primary);
    word-break: break-all;
}

.storage-table td:last-child {
    color: var(--text-secondary);
    white-space: nowrap;
    text-align: right;
}

.header-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
}

.board-selector-wrapper {
    position: relative;
}

#boardSelector {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    background: #9b59b6;
    color: white;
    min-width: 150px;
    appearance: none;
    -webkit-appearance: none;
    padding-right: 30px;
}

#boardSelector:hover {
    background: #8e44ad;
}

.board-selector-wrapper::after {
    content: '▼';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: white;
    font-size: 10px;
    pointer-events: none;
}

#editVariablesBtn {
    background: #3498db;
    color: white;
}

#editVariablesBtn:hover {
    background: #2980b9;
}

#addToolBtn {
    background: #27ae60;
    color: white;
}

#addToolBtn:hover {
    background: #219a52;
}

#deleteBoardBtn {
    background: #e74c3c;
    color: white;
}

#deleteBoardBtn:hover {
    background: #c0392b;
}

#deleteBoardBtn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}

#importExportBtn {
    background: #1abc9c;
    color: white;
}

#importExportBtn:hover {
    background: #16a085;
}

/* Import/Export Modal */
.import-export-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.import-export-modal.open {
    display: flex;
}

.import-export-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.import-export-content h2 {
    margin-bottom: 15px;
    color: var(--text-heading);
}

.import-export-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 10px;
}

.import-export-tab {
    padding: 8px 16px;
    border: none;
    background: var(--bg-tertiary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-primary);
}

.import-export-tab.active {
    background: #3498db;
    color: white;
}

.import-export-tool {
    display: none;
    margin-bottom: 15px;
}

.import-export-tool.active {
    display: block;
}

.import-export-tool h3 {
    margin-bottom: 10px;
    color: var(--text-heading);
    font-size: 14px;
}

.export-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 10px;
}

.export-option label {
    flex: 1;
}

.export-btn, .import-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

.export-btn {
    background: #27ae60;
    color: white;
}

.export-btn:hover {
    background: #219a52;
}

.import-btn {
    background: #3498db;
    color: white;
}

.import-btn:hover {
    background: #2980b9;
}

.checkbox-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
    background: var(--bg-tertiary);
}

.checkbox-list label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    cursor: pointer;
    color: var(--text-primary);
}

.checkbox-list label:hover {
    background: var(--table-hover);
}

.import-textarea {
    width: 100%;
    height: 150px;
    font-family: monospace;
    font-size: 12px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    resize: vertical;
    margin-bottom: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.import-file-input {
    margin-bottom: 10px;
}

.import-export-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.import-export-close:hover {
    color: var(--text-heading);
}

.select-all-row {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
    margin-bottom: 8px;
}

.import-result {
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 13px;
}

.import-result.success {
    background: var(--success-bg);
    color: var(--success-text);
}

.import-result.error {
    background: var(--error-bg);
    color: var(--error-text);
}

main#toolboard {
    position: relative;
    min-height: calc(100vh - 60px);
    padding: 20px;
}

.tool {
    position: absolute;
    background: var(--bg-secondary);
    border-radius: 8px;
    box-shadow: 0 2px 10px var(--shadow-light);
    overflow: visible;
    transition: box-shadow 0.2s, background 0.3s;
    min-width: 150px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
}

/* Resize handles */
.resize-handle {
    position: absolute;
    background: transparent;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.15s, background 0.15s;
    touch-action: none;
}

.tool:hover .resize-handle,
.tool:active .resize-handle {
    opacity: 1;
}

.resize-handle:hover {
    background: rgba(52, 152, 219, 0.4);
}

.resize-handle.active {
    background: rgba(52, 152, 219, 0.6);
    opacity: 1;
}

/* Corner handles */
.resize-handle-nw {
    top: -4px;
    left: -4px;
    width: 12px;
    height: 12px;
    cursor: nw-resize;
    border-radius: 4px 0 0 0;
}

.resize-handle-ne {
    top: -4px;
    right: -4px;
    width: 12px;
    height: 12px;
    cursor: ne-resize;
    border-radius: 0 4px 0 0;
}

.resize-handle-sw {
    bottom: -4px;
    left: -4px;
    width: 12px;
    height: 12px;
    cursor: sw-resize;
    border-radius: 0 0 0 4px;
}

.resize-handle-se {
    bottom: -4px;
    right: -4px;
    width: 12px;
    height: 12px;
    cursor: se-resize;
    border-radius: 0 0 4px 0;
}

/* Visible resize grip indicator on SE corner */
.resize-handle-se::after {
    content: '';
    position: absolute;
    right: 2px;
    bottom: 2px;
    width: 8px;
    height: 8px;
    border-right: 2px solid rgba(52, 152, 219, 0.5);
    border-bottom: 2px solid rgba(52, 152, 219, 0.5);
    opacity: 0;
    transition: opacity 0.15s;
}

.tool:hover .resize-handle-se::after {
    opacity: 1;
}

/* Edge handles */
.resize-handle-n {
    top: -4px;
    left: 12px;
    right: 12px;
    height: 8px;
    cursor: n-resize;
}

.resize-handle-s {
    bottom: -4px;
    left: 12px;
    right: 12px;
    height: 8px;
    cursor: s-resize;
}

.resize-handle-w {
    top: 12px;
    bottom: 12px;
    left: -4px;
    width: 8px;
    cursor: w-resize;
}

.resize-handle-e {
    top: 12px;
    bottom: 12px;
    right: -4px;
    width: 8px;
    cursor: e-resize;
}

.tool:hover {
    box-shadow: 0 4px 20px var(--shadow-medium);
}

.tool.dragging {
    opacity: 0.9;
    box-shadow: 0 8px 30px var(--shadow-heavy);
    z-index: 1000 !important;
}

.tool-header {
    background: var(--bg-tool-header);
    color: white;
    padding: 10px 15px;
    font-weight: bold;
    font-size: 0.95rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    user-select: none;
    flex-shrink: 0;
    border-radius: 8px 8px 0 0;
    transition: background 0.3s;
}

.tool-header:active {
    cursor: grabbing;
}

.tool-header {
    touch-action: none;
}

.tool-header .drag-handle {
    opacity: 0.7;
}

.tool-header .header-buttons {
    display: flex;
    gap: 4px;
    align-items: center;
}

.tool-header .header-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.15s, background 0.15s;
    padding: 0;
}

.tool:hover .header-btn {
    opacity: 1;
}

.header-btn:hover {
    background: rgba(255,255,255,0.35);
}

.tool.minimized .tool-content {
    display: none;
}

.tool.minimized {
    min-height: auto !important;
    height: auto !important;
}

.tool.minimized .resize-handle {
    display: none;
}

.tool.minimized .tool-header {
    border-radius: 8px;
}

.minimize-btn.minimized {
    transform: rotate(180deg);
}

/* Fullscreen mode */
.tool.fullscreen {
    position: fixed !important;
    top: 56px !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: calc(100vh - 56px) !important;
    z-index: 10001 !important;
    border-radius: 0 !important;
    margin: 0 !important;
}

.tool.fullscreen .tool-header {
    border-radius: 0;
}

.tool.fullscreen .tool-content {
    max-height: calc(100vh - 56px - 36px);
    overflow: auto;
}

.tool.fullscreen .resize-handle {
    display: none;
}

.fullscreen-btn.active {
    background: rgba(255,255,255,0.4);
}

/* Fullscreen overlay backdrop */
.fullscreen-backdrop {
    display: none;
    position: fixed;
    top: 56px;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10000;
}

.fullscreen-backdrop.active {
    display: block;
}

/* Tool settings popup - modal style */
.tool-settings-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.tool-settings-overlay.open {
    display: flex;
}

.tool-settings {
    background: var(--bg-secondary);
    border-radius: 8px;
    box-shadow: 0 4px 20px var(--shadow-heavy);
    padding: 20px;
    min-width: 280px;
    max-width: 90%;
    color: var(--text-primary);
    font-weight: normal;
}

.tool-settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-light);
}

.tool-settings-header h3 {
    margin: 0;
    font-size: 16px;
    color: var(--text-heading);
}

.tool-settings-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    line-height: 1;
}

.tool-settings-close:hover {
    color: var(--text-primary);
}

.tool-settings label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.tool-settings input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-primary);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
}

.tool-settings input[type="text"]:focus {
    outline: none;
    border-color: #3498db;
}

.color-picker-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.color-swatch {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.1s, border-color 0.1s;
}

.color-swatch:hover {
    transform: scale(1.15);
}

.color-swatch.selected {
    border-color: #333;
}

/* Content editor */
.edit-content-btn {
    width: 100%;
    padding: 6px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.edit-content-btn:hover {
    background: #2980b9;
}

.duplicate-tool-btn {
    width: 100%;
    padding: 6px 12px;
    background: #9b59b6;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.duplicate-tool-btn:hover {
    background: #8e44ad;
}

.export-tool-btn {
    width: 100%;
    padding: 6px 12px;
    background: #1abc9c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.export-tool-btn:hover {
    background: #16a085;
}

.export-png-btn {
    width: 100%;
    padding: 6px 12px;
    background: #e67e22;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.export-png-btn:hover {
    background: #d35400;
}

.delete-tool-btn {
    width: 100%;
    padding: 6px 12px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.delete-tool-btn:hover {
    background: #c0392b;
}

.content-editor-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 20000;
    align-items: center;
    justify-content: center;
}

.content-editor-overlay.open {
    display: flex;
}

.content-editor {
    background: var(--bg-secondary);
    border-radius: 8px;
    width: 95%;
    max-width: 1400px;
    height: 90vh;
    min-width: 500px;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: absolute;
    box-shadow: 0 10px 50px var(--shadow-heavy);
}

.content-editor-resize {
    position: absolute;
    background: transparent;
    z-index: 10;
    touch-action: none;
}

.content-editor-resize-e {
    top: 10px;
    bottom: 10px;
    right: -4px;
    width: 8px;
    cursor: e-resize;
}

.content-editor-resize-s {
    left: 10px;
    right: 10px;
    bottom: -4px;
    height: 8px;
    cursor: s-resize;
}

.content-editor-resize-se {
    right: -4px;
    bottom: -4px;
    width: 16px;
    height: 16px;
    cursor: se-resize;
}

.content-editor-header {
    padding: 15px 20px;
    background: var(--bg-tool-header);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    user-select: none;
    touch-action: none;
}

.content-editor-header:active {
    cursor: grabbing;
}

.content-editor-header h3 {
    margin: 0;
    font-size: 1rem;
    pointer-events: none;
}

.content-editor-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
}

.content-editor-body {
    display: flex;
    flex: 1;
    min-height: 0;
}

.content-editor-input {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.content-editor-resizer {
    width: 6px;
    background: var(--border-color);
    cursor: col-resize;
    flex-shrink: 0;
    transition: background 0.15s;
    touch-action: none;
}

.content-editor-resizer:hover,
.content-editor-resizer.active {
    background: #3498db;
}

.content-editor-preview {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.content-editor-label {
    padding: 8px 12px;
    background: var(--bg-tertiary);
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 500;
    border-bottom: 1px solid var(--border-color);
}

.content-editor-textarea {
    flex: 1;
    border: none;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
    resize: none;
    outline: none;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.content-editor-preview-area {
    flex: 1;
    padding: 12px;
    overflow: auto;
    font-size: 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.content-editor-footer {
    padding: 12px 20px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.content-editor-footer button {
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.content-editor-save {
    background: #27ae60;
    color: white;
}

.content-editor-save:hover {
    background: #219a52;
}

.content-editor-reset {
    background: #e74c3c;
    color: white;
}

.content-editor-reset:hover {
    background: #c0392b;
}

.content-editor-cancel {
    background: #95a5a6;
    color: white;
}

.content-editor-cancel:hover {
    background: #7f8c8d;
}

/* Markdown rendered styles */
.markdown-content h1, .markdown-content h2, .markdown-content h3,
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    margin-top: 0.5em;
    margin-bottom: 0.3em;
    color: var(--text-heading);
}

.markdown-content h1 { font-size: 1.4em; }
.markdown-content h2 { font-size: 1.2em; }
.markdown-content h3 { font-size: 1.1em; }

.markdown-content p {
    margin: 0.5em 0;
}

.markdown-content ul, .markdown-content ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}

.markdown-content code {
    background: var(--code-bg);
    padding: 2px 5px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.9em;
}

.markdown-content pre {
    background: var(--code-bg);
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
}

.markdown-content pre code {
    background: none;
    padding: 0;
}

.markdown-content blockquote {
    border-left: 3px solid #3498db;
    margin: 0.5em 0;
    padding-left: 1em;
    color: var(--text-secondary);
}

.markdown-content hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 1em 0;
}

.markdown-content strong {
    font-weight: 600;
}

.markdown-content a {
    color: #3498db;
}

.markdown-content img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    margin: 0.5em 0;
    display: block;
}

.markdown-content table {
    margin: 0.5em 0;
}

.tool-content {
    padding: 15px;
    overflow: auto;
    flex: 1;
    min-height: 0;
}

.tool.resizing {
    user-select: none;
}

.tool.resizing .tool-content {
    pointer-events: none;
}

/* Tables */
table {
    border-collapse: collapse;
    width: 100%;
    font-size: 11px;
}

th, td {
    border: 1px solid var(--border-color);
    padding: 6px 8px;
    text-align: left;
}

th {
    background: var(--bg-tertiary);
    font-weight: 600;
}

tr:nth-child(even) {
    background: var(--table-stripe);
}

tr:hover {
    background: var(--table-hover);
}

/* Checklist Widget */
.checklist-items {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checklist-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    margin-bottom: 4px;
    transition: background 0.15s, opacity 0.15s, box-shadow 0.15s;
}

.checklist-item:hover {
    background: var(--table-hover);
}

.checklist-item.dragging {
    opacity: 0.5;
    box-shadow: 0 2px 8px var(--shadow-medium);
}

.checklist-item.drag-over {
    border-top: 2px solid #3498db;
    margin-top: -2px;
}

.checklist-item.completed {
    opacity: 0.6;
}

.checklist-item.completed .checklist-text {
    text-decoration: line-through;
    color: var(--text-muted);
}

.checklist-item.in_progress .checklist-status {
    background: #f39c12;
    border-color: #f39c12;
}

.checklist-item.in_progress .checklist-status::after {
    content: '▶';
    color: white;
    font-size: 9px;
    margin-left: 1px;
}

.checklist-drag {
    cursor: grab;
    color: var(--text-muted);
    font-size: 12px;
    padding: 2px;
    opacity: 0.4;
    transition: opacity 0.15s;
}

.checklist-item:hover .checklist-drag {
    opacity: 1;
}

.checklist-drag:active {
    cursor: grabbing;
}

.checklist-status {
    width: 18px;
    height: 18px;
    min-width: 18px;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    background: transparent;
}

.checklist-status:hover {
    border-color: #3498db;
}

.checklist-item.completed .checklist-status {
    background: #27ae60;
    border-color: #27ae60;
}

.checklist-item.completed .checklist-status::after {
    content: '✓';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.checklist-text {
    flex: 1;
    font-size: 13px;
    word-break: break-word;
    cursor: text;
    padding: 2px 4px;
    border-radius: 3px;
    min-height: 1.4em;
}

.checklist-text:hover {
    background: rgba(0,0,0,0.05);
}

.checklist-text:focus {
    outline: none;
    background: var(--input-bg);
    box-shadow: 0 0 0 2px #3498db;
}

.checklist-actions {
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
}

.checklist-item:hover .checklist-actions {
    opacity: 1;
}

.checklist-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 5px;
    border-radius: 3px;
    transition: color 0.15s, background 0.15s;
}

.checklist-btn:hover {
    background: rgba(0,0,0,0.1);
    color: var(--text-primary);
}

.checklist-btn.delete:hover {
    color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
}

/* Sub-items */
.checklist-subitems {
    list-style: none;
    padding: 0;
    margin: 4px 0 0 24px;
    border-left: 2px solid var(--border-light);
    padding-left: 8px;
}

.checklist-subitems .checklist-item {
    background: transparent;
    padding: 4px 6px;
    margin-bottom: 2px;
}

.checklist-subitems .checklist-item:hover {
    background: var(--bg-tertiary);
}

.checklist-add-sub {
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px 8px;
    margin-left: 24px;
    opacity: 0;
    transition: opacity 0.15s;
}

.checklist-item-wrapper:hover .checklist-add-sub {
    opacity: 1;
}

.checklist-add-sub:hover {
    color: #3498db;
}

.checklist-input:focus {
    outline: none;
    border-color: #3498db;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: var(--overlay-bg);
    overflow: auto;
}

.modal-content {
    background: var(--bg-secondary);
    margin: 50px auto;
    padding: 20px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 8px;
}

.modal-content h2 {
    margin-bottom: 20px;
}

.close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: var(--text-secondary);
}

.close:hover {
    color: #e74c3c;
}

/* Calendar Widget Styles */
.tool-content:has(.calendar-widget) {
    display: flex;
    flex-direction: column;
}

.calendar-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    gap: 10px;
    flex-shrink: 0;
}

.calendar-year-nav {
    display: flex;
    align-items: center;
    gap: 8px;
}

.calendar-year-nav button {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 14px;
}

.calendar-year-nav button:hover {
    background: var(--table-hover);
}

.calendar-year-nav span {
    font-weight: 600;
    font-size: 16px;
    min-width: 50px;
    text-align: center;
}

.calendar-manage-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 11px;
}

.calendar-manage-btn:hover {
    background: #2980b9;
}

.calendar-year-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 12px;
    flex: 1;
    min-height: 0;
}

.calendar-month {
    background: var(--bg-tertiary);
    border-radius: 6px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.calendar-month-name {
    font-weight: 600;
    text-align: center;
    margin-bottom: 6px;
    font-size: 11px;
    color: var(--text-heading);
    flex-shrink: 0;
    border-radius: 3px;
    padding: 2px 4px;
    transition: background 0.15s;
}

.calendar-month-name:hover {
    background: var(--table-hover);
    color: #3498db;
}

.calendar-month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 1px;
    flex: 1;
    min-height: 0;
}

.calendar-dow {
    text-align: center;
    font-size: 8px;
    color: var(--text-muted);
    padding: 2px 0;
}

.calendar-day {
    text-align: center;
    padding: 2px;
    font-size: 9px;
    position: relative;
    min-height: 16px;
    border-radius: 2px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.calendar-day:hover {
    background: var(--table-hover);
}

.calendar-day.other-month {
    cursor: default;
}

.calendar-day.today {
    background: #3498db;
    color: white;
    border-radius: 50%;
    font-weight: 600;
}

.calendar-day.other-month {
    color: var(--text-muted);
    opacity: 0.4;
}

.calendar-event-dots {
    display: flex;
    justify-content: center;
    gap: 1px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
}

.calendar-event-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
}

.calendar-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border-light);
    font-size: 11px;
    flex-shrink: 0;
}

.calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.calendar-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.calendar-legend-count {
    color: var(--text-muted);
    margin-left: 2px;
}

/* Calendar View Toggle */
.calendar-view-toggle {
    display: flex;
    gap: 4px;
}

.calendar-view-btn {
    padding: 4px 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.calendar-view-btn:first-child {
    border-radius: 4px 0 0 4px;
}

.calendar-view-btn:last-child {
    border-radius: 0 4px 4px 0;
}

.calendar-view-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

/* Month View */
.calendar-month-view {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
}

.calendar-month-view.active {
    display: flex;
}

.calendar-year-grid.hidden {
    display: none;
}

.calendar-month-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 12px;
}

.calendar-month-nav button {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 10px;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 14px;
}

.calendar-month-nav button:hover {
    background: var(--table-hover);
}

.calendar-month-nav .calendar-month-title {
    font-weight: 600;
    font-size: 16px;
    min-width: 150px;
    text-align: center;
}

.calendar-month-nav .calendar-today-btn {
    background: #27ae60;
    color: white;
    border: none;
    font-size: 10px;
    padding: 4px 8px;
}

.calendar-month-detail {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 4px;
    min-height: 0;
}

.calendar-month-detail .calendar-dow {
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    padding: 8px 4px;
}

.calendar-month-detail .calendar-day-cell {
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 4px;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: pointer;
}

.calendar-month-detail .calendar-day-cell:hover {
    background: var(--table-hover);
}

.calendar-month-detail .calendar-day-cell.other-month {
    opacity: 0.4;
    background: transparent;
}

.calendar-month-detail .calendar-day-cell.today {
    box-shadow: inset 0 0 0 2px #3498db;
}

.calendar-day-number {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-primary);
}

.calendar-day-cell.today .calendar-day-number {
    background: #3498db;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.calendar-day-events {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.calendar-day-event {
    font-size: 9px;
    padding: 2px 4px;
    border-radius: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: white;
}

.calendar-day-more {
    font-size: 9px;
    color: var(--text-muted);
    text-align: center;
}

/* Calendar Management Modal */
.calendar-manage-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10020;
    justify-content: center;
    align-items: center;
}

.calendar-manage-modal.open {
    display: flex;
}

.calendar-manage-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 450px;
    max-height: 80vh;
    overflow-y: auto;
}

.calendar-manage-content h3 {
    margin-bottom: 15px;
    color: var(--text-heading);
}

.calendar-manage-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.calendar-manage-close:hover {
    color: var(--text-heading);
}

.calendar-list {
    margin-bottom: 15px;
}

.calendar-list-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    margin-bottom: 8px;
}

.calendar-list-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
}

.calendar-list-name {
    flex: 1;
    font-weight: 500;
}

.calendar-list-count {
    color: var(--text-muted);
    font-size: 11px;
}

.calendar-list-remove {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
}

.calendar-list-remove:hover {
    background: rgba(231, 76, 60, 0.1);
    border-radius: 4px;
}

.calendar-add-form {
    border-top: 1px solid var(--border-light);
    padding-top: 15px;
}

.calendar-add-form h4 {
    margin-bottom: 10px;
    font-size: 13px;
    color: var(--text-heading);
}

.calendar-add-row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.calendar-add-name {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.calendar-color-picker {
    display: flex;
    gap: 4px;
    margin-bottom: 10px;
}

.calendar-color-option {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
}

.calendar-color-option:hover {
    transform: scale(1.1);
}

.calendar-color-option.selected {
    border-color: var(--text-heading);
}

.calendar-add-btn {
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 12px;
}

.calendar-add-btn:hover {
    background: #229954;
}

.calendar-import-section {
    border-top: 1px solid var(--border-light);
    padding-top: 15px;
    margin-top: 15px;
}

.calendar-import-section h4 {
    margin-bottom: 10px;
    font-size: 13px;
    color: var(--text-heading);
}

.calendar-import-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.calendar-import-file {
    flex: 1;
}

.calendar-import-select {
    padding: 6px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
}

/* Calendar Day Tooltip */
.calendar-day-tooltip {
    position: absolute;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 8px;
    min-width: 150px;
    max-width: 250px;
    z-index: 10030;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 11px;
}

.calendar-day-tooltip-date {
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-heading);
}

.calendar-day-tooltip-event {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 0;
}

.calendar-day-tooltip-text {
    flex: 1;
}

.calendar-event-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 0 4px;
    line-height: 1;
    opacity: 0.5;
}

.calendar-event-delete:hover {
    color: #e74c3c;
    opacity: 1;
}

.calendar-day-tooltip-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
}

.calendar-day-add-form {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-light);
}

.calendar-day-add-input {
    flex: 1;
    min-width: 0;
    padding: 4px 6px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    font-size: 11px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.calendar-day-add-select {
    padding: 4px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    font-size: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
    max-width: 80px;
}

.calendar-day-add-btn {
    padding: 4px 8px;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
}

.calendar-day-add-btn:hover {
    background: #229954;
}

/* Diff Viewer Widget Styles */
.tool-content:has(.diff-widget) {
    display: flex;
    flex-direction: column;
}

.diff-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
}

.diff-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
    flex-shrink: 0;
    flex-wrap: wrap;
}

.diff-mode-toggle {
    display: flex;
    gap: 4px;
}

.diff-mode-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.diff-mode-btn:first-child {
    border-radius: 4px 0 0 4px;
}

.diff-mode-btn:last-child {
    border-radius: 0 4px 4px 0;
}

.diff-mode-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.diff-view-options {
    display: flex;
    align-items: center;
    gap: 8px;
}

.diff-view-btn {
    padding: 5px 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 10px;
    border-radius: 3px;
}

.diff-view-btn.active {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
}

.diff-whitespace-toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    color: var(--text-secondary);
}

.diff-whitespace-toggle input {
    margin: 0;
}

.diff-edit-container {
    display: flex;
    gap: 10px;
    flex: 1;
    min-height: 0;
}

.diff-edit-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.diff-edit-pane label {
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 11px;
    color: var(--text-heading);
}

.diff-edit-pane textarea {
    flex: 1;
    resize: none;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    min-height: 100px;
}

.diff-edit-pane textarea:focus {
    outline: none;
    border-color: #3498db;
}

.diff-edit-resizer {
    width: 6px;
    background: var(--border-color);
    cursor: col-resize;
    border-radius: 3px;
    flex-shrink: 0;
}

.diff-edit-resizer:hover {
    background: #3498db;
}

.diff-view-container {
    flex: 1;
    min-height: 0;
    display: none;
    flex-direction: column;
}

.diff-view-container.active {
    display: flex;
}

.diff-edit-container.hidden {
    display: none;
}

.diff-output {
    flex: 1;
    overflow: auto;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-tertiary);
    font-family: monospace;
    font-size: 12px;
}

.diff-split-view {
    display: flex;
    min-height: 100%;
}

.diff-split-pane {
    flex: 1;
    min-width: 0;
}

.diff-split-pane:first-child {
    border-right: 1px solid var(--border-color);
}

.diff-split-header {
    padding: 6px 10px;
    background: var(--bg-tool-header);
    color: white;
    font-weight: 600;
    font-size: 11px;
    position: sticky;
    top: 0;
}

.diff-unified-view {
    min-height: 100%;
}

.diff-line {
    display: flex;
    line-height: 1.5;
    min-height: 20px;
}

.diff-gutter {
    width: 40px;
    padding: 0 6px;
    text-align: right;
    color: var(--text-muted);
    background: var(--bg-tertiary);
    border-right: 1px solid var(--border-light);
    flex-shrink: 0;
    font-size: 10px;
    user-select: none;
}

.diff-content {
    flex: 1;
    padding: 0 8px;
    white-space: pre-wrap;
    word-break: break-all;
    min-width: 0;
}

.diff-line.addition {
    background: rgba(39, 174, 96, 0.15);
}

.diff-line.addition .diff-gutter {
    background: rgba(39, 174, 96, 0.3);
    color: #27ae60;
}

.diff-line.deletion {
    background: rgba(231, 76, 60, 0.15);
}

.diff-line.deletion .diff-gutter {
    background: rgba(231, 76, 60, 0.3);
    color: #e74c3c;
}

.diff-line.unchanged {
    background: transparent;
}

.diff-prefix {
    width: 16px;
    text-align: center;
    flex-shrink: 0;
    font-weight: bold;
}

.diff-line.addition .diff-prefix {
    color: #27ae60;
}

.diff-line.deletion .diff-prefix {
    color: #e74c3c;
}

.diff-stats {
    display: flex;
    gap: 16px;
    padding: 8px 0;
    font-size: 11px;
    color: var(--text-secondary);
    border-top: 1px solid var(--border-light);
    margin-top: 8px;
    flex-shrink: 0;
}

.diff-stats-additions {
    color: #27ae60;
}

.diff-stats-deletions {
    color: #e74c3c;
}

.diff-empty-message {
    padding: 20px;
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
}

/* Dark mode adjustments for diff */
body.dark-mode .diff-line.addition {
    background: rgba(39, 174, 96, 0.2);
}

body.dark-mode .diff-line.addition .diff-gutter {
    background: rgba(39, 174, 96, 0.35);
}

body.dark-mode .diff-line.deletion {
    background: rgba(231, 76, 60, 0.2);
}

body.dark-mode .diff-line.deletion .diff-gutter {
    background: rgba(231, 76, 60, 0.35);
}

/* Sequence Diagram Widget Styles */
.tool-content:has(.seq-widget) {
    display: flex;
    flex-direction: column;
}

.seq-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
}

.seq-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
    flex-shrink: 0;
    flex-wrap: wrap;
}

.seq-mode-toggle {
    display: flex;
    gap: 4px;
}

.seq-mode-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.seq-mode-btn:first-child {
    border-radius: 4px 0 0 4px;
}

.seq-mode-btn:last-child {
    border-radius: 0 4px 4px 0;
}

.seq-mode-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.seq-help-btn {
    padding: 5px 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 10px;
    border-radius: 3px;
}

.seq-help-btn:hover {
    background: var(--table-hover);
}

.seq-split-container {
    flex: 1;
    display: none;
    gap: 10px;
    min-height: 0;
}

.seq-split-container.active {
    display: flex;
}

.seq-split-container .seq-edit-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.seq-split-container .seq-edit-pane textarea {
    flex: 1;
    resize: none;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    min-height: 100px;
    line-height: 1.5;
}

.seq-split-container .seq-edit-pane textarea:focus {
    outline: none;
    border-color: #3498db;
}

.seq-split-container .seq-view-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-tertiary);
    overflow: auto;
}

.seq-split-resizer {
    width: 6px;
    background: var(--border-color);
    cursor: col-resize;
    border-radius: 3px;
    flex-shrink: 0;
}

.seq-split-resizer:hover {
    background: #3498db;
}

.seq-edit-container {
    flex: 1;
    display: none;
    flex-direction: column;
    min-height: 0;
}

.seq-edit-container.active {
    display: flex;
}

.seq-edit-container textarea {
    flex: 1;
    resize: none;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    min-height: 100px;
    line-height: 1.5;
}

.seq-edit-container textarea:focus {
    outline: none;
    border-color: #3498db;
}

.seq-edit-container textarea::placeholder {
    color: var(--text-muted);
}

.seq-view-container {
    flex: 1;
    min-height: 0;
    display: none;
    flex-direction: column;
    overflow: auto;
}

.seq-view-container.active {
    display: flex;
}

.seq-diagram {
    flex: 1;
    min-height: 200px;
    display: flex;
    justify-content: center;
    padding: 10px;
}

.seq-diagram svg {
    max-width: 100%;
    height: auto;
}

.seq-participant-box {
    fill: var(--bg-tertiary);
    stroke: var(--border-color);
    stroke-width: 2;
}

.seq-participant-text {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 12px;
    font-weight: 600;
    fill: var(--text-primary);
    text-anchor: middle;
    dominant-baseline: middle;
}

.seq-lifeline {
    stroke: var(--border-color);
    stroke-width: 1;
    stroke-dasharray: 5, 5;
}

.seq-arrow {
    stroke: var(--text-primary);
    stroke-width: 1.5;
    fill: none;
}

.seq-arrow-head {
    fill: var(--text-primary);
    stroke: none;
}

.seq-arrow.dashed {
    stroke-dasharray: 5, 3;
}

.seq-arrow-label {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    fill: var(--text-primary);
    dominant-baseline: middle;
}

.seq-arrow-number {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 10px;
    font-weight: 700;
    fill: white;
}

.seq-arrow-number-bg {
    fill: #3498db;
}

.seq-arrow.dashed + .seq-arrow-number-bg,
.seq-dashed-number-bg {
    fill: #9b59b6;
}

.seq-self-arrow {
    stroke: var(--text-primary);
    stroke-width: 1.5;
    fill: none;
}

.seq-note-box {
    fill: #ffffcc;
    stroke: #cccc00;
    stroke-width: 1;
}

.seq-note-text {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 10px;
    fill: #333;
}

body.dark-mode .seq-note-box {
    fill: #4a4a2a;
    stroke: #8a8a3a;
}

body.dark-mode .seq-note-text {
    fill: #e4e4e7;
}

.seq-error-message {
    padding: 20px;
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
}

.seq-help-text {
    font-size: 10px;
    color: var(--text-muted);
    padding: 8px 0;
    border-top: 1px solid var(--border-light);
    margin-top: 8px;
    flex-shrink: 0;
}

.seq-help-text code {
    background: var(--code-bg);
    padding: 1px 4px;
    border-radius: 3px;
    font-family: monospace;
}

/* Sequence Diagram Help Modal */
.seq-help-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10015;
    justify-content: center;
    align-items: center;
}

.seq-help-modal.open {
    display: flex;
}

.seq-help-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.seq-help-content h3 {
    margin-bottom: 12px;
    color: var(--text-heading);
}

.seq-help-content pre {
    background: var(--code-bg);
    padding: 12px;
    border-radius: 4px;
    font-size: 11px;
    overflow-x: auto;
    margin: 10px 0;
}

.seq-help-content p {
    margin: 8px 0;
    font-size: 12px;
    color: var(--text-secondary);
}

.seq-help-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.seq-help-close:hover {
    color: var(--text-heading);
}

/* Dark mode adjustments for sequence diagram */
body.dark-mode .seq-participant-box {
    fill: var(--bg-tertiary);
    stroke: var(--border-color);
}

body.dark-mode .seq-arrow-number-bg {
    fill: #2980b9;
}

body.dark-mode .seq-dashed-number-bg {
    fill: #8e44ad;
}

/* JWT Decoder Widget */
.tool-content:has(.jwt-widget) {
    display: flex;
    flex-direction: column;
}

.jwt-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
    gap: 10px;
}

.jwt-input-section {
    flex-shrink: 0;
}

.jwt-input-section label {
    display: block;
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
    font-weight: 600;
}

.jwt-input-section textarea {
    width: 100%;
    min-height: 60px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 11px;
    background: var(--input-bg);
    color: var(--text-primary);
    resize: vertical;
    box-sizing: border-box;
    word-break: break-all;
}

.jwt-input-section textarea:focus {
    outline: none;
    border-color: #3498db;
}

.jwt-output-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: auto;
}

.jwt-parts {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.jwt-part {
    background: var(--bg-tertiary);
    border-radius: 6px;
    overflow: hidden;
}

.jwt-part-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    font-weight: 600;
    font-size: 11px;
}

.jwt-part-header.header { background: #e74c3c; color: white; }
.jwt-part-header.payload { background: #9b59b6; color: white; }
.jwt-part-header.signature { background: #3498db; color: white; }

.jwt-part-content {
    padding: 10px 12px;
    font-family: monospace;
    font-size: 11px;
    white-space: pre-wrap;
    word-break: break-all;
    background: var(--bg-secondary);
    color: var(--text-primary);
    max-height: 200px;
    overflow-y: auto;
}

.jwt-part-content.raw {
    color: var(--text-muted);
    font-size: 10px;
}

.jwt-error {
    padding: 12px;
    background: var(--error-bg);
    color: var(--error-text);
    border-radius: 6px;
    font-size: 12px;
}

.jwt-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
}

.jwt-status.valid {
    background: var(--success-bg);
    color: var(--success-text);
}

.jwt-status.invalid {
    background: var(--error-bg);
    color: var(--error-text);
}

.jwt-status.info {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.jwt-claims {
    margin-top: 8px;
}

.jwt-claim {
    display: flex;
    padding: 4px 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 11px;
}

.jwt-claim:last-child {
    border-bottom: none;
}

.jwt-claim-key {
    min-width: 80px;
    color: var(--text-muted);
    font-weight: 500;
}

.jwt-claim-value {
    flex: 1;
    color: var(--text-primary);
    word-break: break-all;
}

.jwt-claim-value.expired {
    color: #e74c3c;
}

.jwt-claim-value.valid {
    color: #27ae60;
}

.jwt-copy-btn {
    padding: 2px 8px;
    font-size: 10px;
    border: none;
    background: rgba(255,255,255,0.2);
    color: inherit;
    border-radius: 3px;
    cursor: pointer;
}

.jwt-copy-btn:hover {
    background: rgba(255,255,255,0.3);
}

.jwt-toolbar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
}

.jwt-sample-btn {
    padding: 4px 10px;
    font-size: 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border-radius: 3px;
    cursor: pointer;
}

.jwt-sample-btn:hover {
    background: var(--table-hover);
}

/* Code Formatter Widget Styles */
.tool-content:has(.fmt-widget) {
    display: flex;
    flex-direction: column;
    padding: 0;
}

.fmt-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
}

.fmt-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
    flex-shrink: 0;
    flex-wrap: wrap;
}

.fmt-format-toggle {
    display: flex;
    gap: 0;
}

.fmt-format-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    margin-left: -1px;
}

.fmt-format-btn:first-child {
    border-radius: 4px 0 0 4px;
    margin-left: 0;
}

.fmt-format-btn:last-child {
    border-radius: 0 4px 4px 0;
}

.fmt-format-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
    z-index: 1;
}

.fmt-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.fmt-action-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.fmt-action-btn:hover {
    background: var(--table-hover);
}

.fmt-container {
    flex: 1;
    display: flex;
    gap: 10px;
    min-height: 0;
}

.fmt-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.fmt-pane label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.fmt-pane textarea {
    flex: 1;
    resize: none;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    min-height: 100px;
    line-height: 1.4;
    white-space: pre;
    overflow-wrap: normal;
    overflow-x: auto;
}

.fmt-pane textarea:focus {
    outline: none;
    border-color: #3498db;
}

.fmt-pane textarea::placeholder {
    color: var(--text-muted);
}

.fmt-pane textarea.fmt-output {
    background: var(--bg-tertiary);
}

.fmt-resizer {
    width: 6px;
    background: var(--border-color);
    cursor: col-resize;
    border-radius: 3px;
    flex-shrink: 0;
}

.fmt-resizer:hover {
    background: #3498db;
}

.fmt-status {
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-muted);
    min-height: 16px;
}

.fmt-status.error {
    color: #e74c3c;
}

.fmt-status.success {
    color: #27ae60;
}

/* Cron Expression Widget Styles */
.tool-content:has(.cron-widget) {
    display: flex;
    flex-direction: column;
    padding: 0;
}

.cron-widget {
    padding: 12px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
    gap: 12px;
}

.cron-input-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.cron-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.cron-input {
    flex: 1;
    padding: 10px 12px;
    font-family: monospace;
    font-size: 16px;
    border: 2px solid var(--border-color);
    border-radius: 6px;
    background: var(--input-bg);
    color: var(--text-primary);
    text-align: center;
    letter-spacing: 2px;
}

.cron-input:focus {
    outline: none;
    border-color: #3498db;
}

.cron-input.valid {
    border-color: #27ae60;
}

.cron-input.invalid {
    border-color: #e74c3c;
}

.cron-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.cron-preset-btn {
    padding: 4px 10px;
    font-size: 11px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    cursor: pointer;
}

.cron-preset-btn:hover {
    background: var(--table-hover);
    color: var(--text-primary);
}

.cron-explanation {
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 6px;
    min-height: 40px;
}

.cron-explanation-text {
    font-size: 14px;
    color: var(--text-primary);
    line-height: 1.5;
}

.cron-explanation-text strong {
    color: #3498db;
}

.cron-error {
    color: #e74c3c;
    font-size: 13px;
}

.cron-fields {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
}

.cron-field {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 6px;
    background: var(--bg-tertiary);
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.cron-field-value {
    font-family: monospace;
    font-size: 18px;
    font-weight: bold;
    color: #3498db;
    margin-bottom: 4px;
}

.cron-field-name {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.cron-field-desc {
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 4px;
    text-align: center;
}

.cron-schedule {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
}

.cron-schedule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.cron-schedule-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
}

.cron-schedule-count {
    font-size: 11px;
    color: var(--text-muted);
}

.cron-schedule-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 150px;
}

.cron-schedule-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 10px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    font-size: 12px;
}

.cron-schedule-item:first-child {
    background: rgba(39, 174, 96, 0.1);
    border: 1px solid rgba(39, 174, 96, 0.3);
}

.cron-schedule-date {
    color: var(--text-primary);
    font-family: monospace;
}

.cron-schedule-relative {
    color: var(--text-muted);
    font-size: 11px;
}

/* Regex Tester Widget Styles */
.tool-content:has(.regex-widget) {
    display: flex;
    flex-direction: column;
    padding: 0;
}

.regex-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
}

.regex-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 10px;
    flex-shrink: 0;
    flex-wrap: wrap;
}

.regex-flags {
    display: flex;
    gap: 10px;
}

.regex-flags label {
    display: flex;
    align-items: center;
    gap: 3px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: monospace;
}

.regex-flags input[type="checkbox"] {
    cursor: pointer;
}

.regex-actions {
    display: flex;
    gap: 6px;
}

.regex-action-btn {
    padding: 5px 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.regex-action-btn:hover {
    background: var(--table-hover);
}

.regex-input-row {
    margin-bottom: 8px;
    flex-shrink: 0;
}

.regex-input-row label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.regex-pattern {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
    box-sizing: border-box;
}

.regex-pattern:focus {
    outline: none;
    border-color: #3498db;
}

.regex-container {
    flex: 1;
    display: flex;
    gap: 10px;
    min-height: 0;
}

.regex-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.regex-pane label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.regex-test-string {
    flex: 1;
    resize: none;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    min-height: 80px;
    line-height: 1.5;
}

.regex-test-string:focus {
    outline: none;
    border-color: #3498db;
}

.regex-results-pane {
    min-width: 0;
}

.regex-results {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-tertiary);
    overflow: auto;
    font-family: monospace;
    font-size: 12px;
    line-height: 1.5;
    min-height: 80px;
}

.regex-results .match-highlight {
    background: #f1c40f;
    color: #000;
    padding: 1px 2px;
    border-radius: 2px;
}

.regex-results .match-group {
    background: #3498db;
    color: #fff;
    padding: 1px 2px;
    border-radius: 2px;
}

.regex-results .match-info {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
}

.regex-results .match-item {
    margin-bottom: 8px;
    padding: 6px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
}

.regex-results .match-index {
    color: var(--text-muted);
    font-size: 10px;
    margin-bottom: 2px;
}

.regex-results .match-value {
    color: var(--text-primary);
    word-break: break-all;
}

.regex-results .match-groups {
    margin-top: 4px;
    padding-left: 10px;
    border-left: 2px solid var(--border-color);
}

.regex-results .group-item {
    font-size: 11px;
    color: var(--text-secondary);
}

.regex-results .no-match {
    color: var(--text-muted);
    font-style: italic;
}

.regex-resizer {
    width: 6px;
    background: var(--border-color);
    cursor: col-resize;
    border-radius: 3px;
    flex-shrink: 0;
}

.regex-resizer:hover {
    background: #3498db;
}

.regex-status {
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-muted);
    min-height: 16px;
    flex-shrink: 0;
}

.regex-status.error {
    color: #e74c3c;
}

.regex-status.success {
    color: #27ae60;
}

/* Epoch Converter Widget Styles */
.tool-content:has(.epoch-widget) {
    display: flex;
    flex-direction: column;
    padding: 0;
}

.epoch-widget {
    padding: 12px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    width: 100%;
    box-sizing: border-box;
}

.epoch-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.epoch-section > label {
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 500;
}

.epoch-current {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

.epoch-now-value {
    font-family: monospace;
    font-size: 14px;
    color: var(--text-primary);
    flex: 1;
}

.epoch-action-btn {
    padding: 4px 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.epoch-action-btn:hover {
    background: var(--table-hover);
}

.epoch-input-row {
    display: flex;
    gap: 8px;
}

.epoch-timestamp-input {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: monospace;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.epoch-timestamp-input:focus {
    outline: none;
    border-color: #3498db;
}

.epoch-unit-select,
.epoch-tz-select {
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    cursor: pointer;
}

.epoch-datetime-inputs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.epoch-date-input,
.epoch-time-input {
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    font-family: monospace;
}

.epoch-date-input:focus,
.epoch-time-input:focus {
    outline: none;
    border-color: #3498db;
}

.epoch-result {
    padding: 10px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    border: 1px solid var(--border-color);
    font-family: monospace;
    font-size: 12px;
    line-height: 1.6;
    min-height: 20px;
}

.epoch-result .result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 0;
}

.epoch-result .result-label {
    color: var(--text-secondary);
}

.epoch-result .result-value {
    color: var(--text-primary);
    font-weight: 500;
}

.epoch-result .result-value.copyable {
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 3px;
}

.epoch-result .result-value.copyable:hover {
    background: var(--table-hover);
}

.epoch-reference {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 8px 10px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

.epoch-ref-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
}

.epoch-ref-item span {
    color: var(--text-secondary);
}

.epoch-ref-item code {
    font-family: monospace;
    color: var(--text-primary);
    background: var(--bg-secondary);
    padding: 2px 6px;
    border-radius: 3px;
}

/* Feature Selection Modal */
.feature-select-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.feature-select-modal.open {
    display: flex;
}

.feature-select-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.feature-select-content h2 {
    margin-bottom: 15px;
    color: var(--text-heading);
}

.feature-select-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.feature-select-close:hover {
    color: var(--text-heading);
}

.feature-select-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.feature-select-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
}

.feature-select-item:hover {
    background: var(--bg-tertiary);
    border-color: #3498db;
}

.feature-select-item:active {
    background: var(--table-hover);
}

.feature-select-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
    flex-shrink: 0;
}

.feature-select-info {
    flex: 1;
}

.feature-select-name {
    font-weight: 600;
    color: var(--text-heading);
    margin-bottom: 2px;
}

.feature-select-description {
    font-size: 11px;
    color: var(--text-muted);
}

/* Number formatting */
.currency::before {
    content: '$';
}

.percent::after {
    content: '%';
}

/* Snap guides */
.snap-guide {
    opacity: 0.8;
    box-shadow: 0 0 4px rgba(52, 152, 219, 0.8);
}

.tool.snapping {
    transition: none;
}

/* Responsive */
@media (max-width: 768px) {
    header {
        padding: 8px 10px;
        gap: 8px;
    }

    .header-title-area {
        gap: 6px;
    }

    .header-title-area img {
        width: 24px !important;
        height: 24px !important;
    }

    header h1 {
        font-size: 1rem;
        white-space: nowrap;
    }

    .toolboard-version {
        display: none;
    }

    .storage-indicator {
        display: none;
    }

    .header-controls {
        gap: 6px;
    }

    .header-controls button {
        padding: 8px 10px;
        font-size: 0.8rem;
    }

    #boardSelector {
        min-width: 100px;
        max-width: 120px;
        padding: 8px 10px;
        font-size: 0.8rem;
    }

    /* Hide button text on mobile, show icons */
    #addToolBtn {
        font-size: 0;
    }
    #addToolBtn::before {
        content: "+";
        font-size: 1.2rem;
    }

    #deleteBoardBtn {
        font-size: 0;
    }
    #deleteBoardBtn::before {
        content: "\1F5D1";
        font-size: 1rem;
    }

    #importExportBtn {
        font-size: 0;
    }
    #importExportBtn::before {
        content: "\21C5";
        font-size: 1rem;
    }

    main#toolboard {
        padding: 10px;
    }

    .tool {
        min-width: 120px;
        min-height: 80px;
    }

    .tool-header {
        padding: 12px 10px;
        font-size: 0.85rem;
    }

    /* Larger touch targets for resize handles on mobile */
    .resize-handle {
        opacity: 0.5;
    }

    .resize-handle-nw,
    .resize-handle-ne,
    .resize-handle-sw,
    .resize-handle-se {
        width: 24px;
        height: 24px;
    }

    .resize-handle-nw {
        top: -8px;
        left: -8px;
    }

    .resize-handle-ne {
        top: -8px;
        right: -8px;
    }

    .resize-handle-sw {
        bottom: -8px;
        left: -8px;
    }

    .resize-handle-se {
        bottom: -8px;
        right: -8px;
        /* Add visible indicator for primary resize handle */
        background: rgba(52, 152, 219, 0.3);
        border-radius: 0 0 8px 0;
    }

    .resize-handle-n,
    .resize-handle-s {
        height: 16px;
        left: 24px;
        right: 24px;
    }

    .resize-handle-n {
        top: -8px;
    }

    .resize-handle-s {
        bottom: -8px;
    }

    .resize-handle-w,
    .resize-handle-e {
        width: 16px;
        top: 24px;
        bottom: 24px;
    }

    .resize-handle-w {
        left: -8px;
    }

    .resize-handle-e {
        right: -8px;
    }

    /* Content editor adjustments for mobile */
    .content-editor {
        width: 100% !important;
        height: 100vh !important;
        max-width: 100% !important;
        min-width: unset !important;
        border-radius: 0;
        left: 0 !important;
        top: 0 !important;
    }

    .content-editor-body {
        flex-direction: column;
    }

    .content-editor-resizer {
        width: 100%;
        height: 6px;
        cursor: row-resize;
    }

    .content-editor-input,
    .content-editor-preview {
        min-width: 100%;
        min-height: 150px;
    }

    /* Tool settings modal adjustments */
    .tool-settings {
        width: 90%;
        max-width: 320px;
    }

    /* Import/Export modal adjustments */
    .import-export-content {
        width: 95%;
        max-height: 90vh;
        padding: 15px;
    }

    /* Better tap feedback */
    .tool-header .header-btn {
        opacity: 1;
        width: 28px;
        height: 28px;
    }

    .toolboard-settings {
        left: 10px;
        right: 10px;
        min-width: unset;
    }
}

/* Extra small screens (portrait phones) */
@media (max-width: 480px) {
    header {
        padding: 6px 8px;
        gap: 6px;
    }

    header h1 {
        font-size: 0.9rem;
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .header-settings-btn {
        width: 32px;
        height: 32px;
    }

    .header-controls {
        gap: 4px;
    }

    .header-controls button {
        padding: 8px;
        min-width: 36px;
    }

    #boardSelector {
        min-width: 70px;
        max-width: 90px;
        padding: 8px 6px;
    }

}

/* Touch-specific improvements */
@media (pointer: coarse) {
    .tool-header {
        cursor: grab;
        -webkit-user-select: none;
        user-select: none;
    }

    .resize-handle {
        opacity: 0.6;
    }

    .resize-handle-se {
        background: rgba(52, 152, 219, 0.4);
    }

    .tool-header .header-btn {
        opacity: 1;
    }
}
    </style>
</head>
<body>
    <header id="mainHeader">
        <div class="header-title-area">
            <a href="https://toolboard.me" title="Visit Toolboard.me"><img alt="Toolboard Logo" style="width: 32px; height: 32px;" src="data:image/svg+xml,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%20300%20300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%20%20%3Crect%20width%3D%22290%22%20height%3D%22290%22%20fill%3D%22%23444%22%20rx%3D%2210%22%20ry%3D%2210%22%20%2F%3E%20%20%3Cdefs%3E%20%20%20%20%3Cpattern%20id%3D%22peg-grid%22%20x%3D%2215%22%20y%3D%2215%22%20width%3D%2230%22%20height%3D%2230%22%20patternUnits%3D%22userSpaceOnUse%22%3E%20%20%20%20%20%20%3Ccircle%20cx%3D%2210%22%20cy%3D%2210%22%20r%3D%2210.5%22%20fill%3D%22%23000%22%20%2F%3E%20%20%20%20%3C%2Fpattern%3E%20%20%3C%2Fdefs%3E%20%20%3Crect%20x%3D%225%22%20y%3D%225%22%20width%3D%22275%22%20height%3D%22275%22%20fill%3D%22url(%23peg-grid)%22%20%2F%3E%20%20%3Cg%20fill%3D%22%23ff8%22%3E%20%20%20%20%3Ccircle%20cx%3D%2225%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2225%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2225%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2255%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2255%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2255%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22235%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22235%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22235%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22265%22%20cy%3D%2225%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22265%22%20cy%3D%2255%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22265%22%20cy%3D%2285%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22115%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22115%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22115%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22145%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22145%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22145%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22175%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22175%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22175%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22205%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22205%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22205%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22235%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22235%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22235%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22115%22%20cy%3D%22265%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22145%22%20cy%3D%22265%22%20r%3D%2210.5%22%20%2F%3E%20%20%20%20%3Ccircle%20cx%3D%22175%22%20cy%3D%22265%22%20r%3D%2210.5%22%20%2F%3E%20%20%3C%2Fg%3E%3C%2Fsvg%3E"></a>
            <h1 id="toolboardTitle">My Toolboard</h1>
            <button id="toolboardSettingsBtn" class="header-settings-btn" title="Edit Toolboard">&#9881;</button>
            <span id="toolboardVersion" class="toolboard-version"></span>
        </div>
        <div class="header-controls">
            <div id="storageIndicator" class="storage-indicator" title="localStorage usage"></div>
            <button id="darkModeToggle" class="header-settings-btn" title="Toggle Dark Mode">&#9790;</button>
            <div class="board-selector-wrapper">
                <select id="boardSelector"></select>
            </div>
            <button id="addToolBtn">+ Add Tool</button>
            <button id="deleteBoardBtn">Delete Board</button>
            <button id="importExportBtn">Import/Export</button>
        </div>
        <div id="toolboardSettings" class="toolboard-settings">
            <label>Board Title</label>
            <input type="text" id="toolboardTitleInput" placeholder="Board title">
            <label>Header Color</label>
            <div class="color-picker-row" id="toolboardColorPicker"></div>
            <label>Board Font</label>
            <select id="toolboardFontFamily" class="font-select">
                <option value="">System Default</option>
                <option value="Inter, sans-serif">Inter</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Monaco', monospace">Monaco</option>
                <option value="'Fira Code', monospace">Fira Code</option>
            </select>
            <label>Font Size</label>
            <select id="toolboardFontSize" class="font-select">
                <option value="">Default</option>
                <option value="11px">Small (11px)</option>
                <option value="13px">Medium (13px)</option>
                <option value="14px">Large (14px)</option>
                <option value="16px">X-Large (16px)</option>
                <option value="18px">XX-Large (18px)</option>
            </select>
        </div>
    </header>

    <!-- Import/Export Modal -->
    <div id="importExportModal" class="import-export-modal">
        <div class="import-export-content">
            <span class="import-export-close">&times;</span>
            <h2>Import / Export</h2>

            <div class="import-export-tabs">
                <button class="import-export-tab active" data-tab="export">Export</button>
                <button class="import-export-tab" data-tab="import">Import</button>
                <button class="import-export-tab" data-tab="restore">Restore</button>
            </div>

            <!-- Export Tool -->
            <div id="exportTool" class="import-export-tool active">
                <h3>Export Tools</h3>
                <div id="exportToolsList" class="checkbox-list"></div>
                <button id="exportSelectedTools" class="export-btn">Export Selected Tools</button>

                <h3 style="margin-top: 15px;">Export Boards</h3>
                <div id="exportBoardsList" class="checkbox-list"></div>
                <button id="exportSelectedBoards" class="export-btn">Export Selected Boards</button>

                <h3 style="margin-top: 15px;">Export Current Board View</h3>
                <p style="color: #7f8c8d; margin-bottom: 10px; font-size: 12px;">Export the current board as a standalone file.</p>
                <div style="display: flex; gap: 10px;">
                    <button id="exportBoardAsHTML" class="export-btn">Export as HTML</button>
                    <button id="exportBoardAsPNG" class="export-btn">Export as PNG</button>
                </div>
            </div>

            <!-- Import Tool -->
            <div id="importTool" class="import-export-tool">
                <h3>Import from File</h3>
                <input type="file" id="importFileInput" class="import-file-input" accept=".json">

                <h3>Or Paste JSON</h3>
                <textarea id="importTextarea" class="import-textarea" placeholder="Paste JSON data here..."></textarea>

                <button id="importDataBtn" class="import-btn">Import Data</button>
                <div id="importResult"></div>
            </div>

            <!-- Restore Tool -->
            <div id="restoreTool" class="import-export-tool">
                <h3>Restore Hidden Tools</h3>
                <p style="color: #7f8c8d; margin-bottom: 10px; font-size: 12px;">These built-in tools have been hidden. Select tools to restore them to your board.</p>
                <div id="hiddenToolsList" class="checkbox-list"></div>
                <button id="restoreSelectedTools" class="import-btn">Restore Selected</button>
                <div id="restoreResult"></div>
            </div>
        </div>
    </div>

    <!-- Fullscreen backdrop -->
    <div id="fullscreenBackdrop" class="fullscreen-backdrop"></div>

    <main id="toolboard">
        <!-- Tools will be dynamically generated -->
    </main>

    <!-- Content Editor Modal -->
    <div id="contentEditorOverlay" class="content-editor-overlay">
        <div class="content-editor">
            <div class="content-editor-header">
                <h3>Edit Content: <span id="editorToolTitle"></span></h3>
                <button class="content-editor-close">&times;</button>
            </div>
            <div class="content-editor-body">
                <div class="content-editor-input">
                    <div class="content-editor-label">Markdown</div>
                    <textarea class="content-editor-textarea" id="contentEditorTextarea" placeholder="Enter markdown content..."></textarea>
                </div>
                <div class="content-editor-resizer" id="editorResizer"></div>
                <div class="content-editor-preview">
                    <div class="content-editor-label">Preview</div>
                    <div class="content-editor-preview-area markdown-content" id="contentEditorPreview"></div>
                </div>
            </div>
            <div class="content-editor-footer">
                <button class="content-editor-reset">Reset to Default</button>
                <button class="content-editor-cancel">Cancel</button>
                <button class="content-editor-save">Save</button>
            </div>
            <div class="content-editor-resize content-editor-resize-e" data-resize="e"></div>
            <div class="content-editor-resize content-editor-resize-s" data-resize="s"></div>
            <div class="content-editor-resize content-editor-resize-se" data-resize="se"></div>
        </div>
    </div>

    <!-- Feature Selection Modal -->
    <div id="featureSelectModal" class="feature-select-modal">
        <div class="feature-select-content">
            <span class="feature-select-close">&times;</span>
            <h2>Choose Tool Type</h2>
            <div id="featureSelectList" class="feature-select-list"></div>
        </div>
    </div>

    <!-- Tool Settings Modal -->
    <div id="toolSettingsOverlay" class="tool-settings-overlay">
        <div class="tool-settings">
            <div class="tool-settings-header">
                <h3>Tool Settings</h3>
                <button class="tool-settings-close">&times;</button>
            </div>
            <label>Title</label>
            <input type="text" id="toolSettingsTitleInput" class="title-input" placeholder="Tool title">
            <label>Color</label>
            <div class="color-picker-row" id="toolSettingsColorPicker"></div>
            <label>Font Family</label>
            <select id="toolSettingsFontFamily" class="font-select">
                <option value="">Use Board Default</option>
                <option value="Inter, sans-serif">Inter</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Monaco', monospace">Monaco</option>
                <option value="'Fira Code', monospace">Fira Code</option>
            </select>
            <label>Font Size</label>
            <select id="toolSettingsFontSize" class="font-select">
                <option value="">Use Board Default</option>
                <option value="10px">X-Small (10px)</option>
                <option value="11px">Small (11px)</option>
                <option value="12px">Medium (12px)</option>
                <option value="13px">Large (13px)</option>
                <option value="14px">X-Large (14px)</option>
                <option value="16px">XX-Large (16px)</option>
            </select>
            <button class="edit-content-btn" id="toolSettingsEditBtn">Edit Content</button>
            <button class="duplicate-tool-btn" id="toolSettingsDuplicateBtn">Duplicate Tool</button>
            <button class="export-tool-btn" id="toolSettingsExportBtn">Export as HTML</button>
            <button class="export-png-btn" id="toolSettingsExportPngBtn">Export as PNG</button>
            <button class="delete-tool-btn" id="toolSettingsDeleteBtn">Hide Tool</button>
        </div>
    </div>

    <script>
// Default variables - empty for generic toolboard, import a board to add data
const DEFAULT_VARIABLES = {};

// Built-in tools - empty for generic toolboard, import tools/boards to add
const SECTIONS = [];

// Generate default positions (empty for generic toolboard)
function generateDefaultPositions() {
    return {};
}

const DEFAULT_POSITIONS = generateDefaultPositions();

// Tool templates for feature selection
const NOTE_TEMPLATES = {
    'blank': {
        id: 'blank',
        name: 'Blank Tool',
        description: 'Start with an empty tool',
        icon: '📝',
        title: 'New Tool',
        content: ''
    },
    'dynamic-investment-calculator': {
        id: 'dynamic-investment-calculator',
        name: 'Investment Growth Calculator',
        description: 'Interactive calculator with inputs for initial amount, monthly contribution, rate, and years',
        icon: '📈',
        title: 'Investment Growth Calculator',
        content: `<div class="calc-widget">
<div class="calc-grid">
<div>
<label>Initial Investment</label>
<input type="number" id="growthInitial" value="10000" oninput="calculateGrowth()">
</div>
<div>
<label>Monthly Contribution</label>
<input type="number" id="growthMonthly" value="500" oninput="calculateGrowth()">
</div>
<div>
<label>Annual Return (%)</label>
<input type="number" id="growthRate" value="7" step="0.1" oninput="calculateGrowth()">
</div>
<div>
<label>Years</label>
<input type="number" id="growthYears" value="30" oninput="calculateGrowth()">
</div>
</div>
<div style="margin-bottom:15px;">
<label>Compounding</label>
<div class="calc-toggle">
<label><input type="radio" name="growthCompound" value="monthly" checked onchange="calculateGrowth()"><span>Monthly</span></label>
<label><input type="radio" name="growthCompound" value="annual" onchange="calculateGrowth()"><span>Annual</span></label>
</div>
</div>
<div id="growthResults"></div>
</div>`,
        onInit: 'calculateGrowth'
    },
    'simple-calculator': {
        id: 'simple-calculator',
        name: 'Simple Calculator',
        description: 'Basic arithmetic calculator for quick math',
        icon: '🔢',
        title: 'Calculator',
        content: `<div style="background:#2c3e50;padding:15px;border-radius:8px;max-width:240px;">
<input type="text" id="calcDisplay" value="0" readonly style="width:100%;padding:12px;font-size:24px;text-align:right;border:none;border-radius:4px;margin-bottom:10px;background:#ecf0f1;font-family:monospace;">
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
<button onclick="calcClear()" style="grid-column:span 2;padding:15px;font-size:16px;border:none;border-radius:4px;background:#e74c3c;color:white;cursor:pointer;">C</button>
<button onclick="calcBackspace()" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#95a5a6;color:white;cursor:pointer;">⌫</button>
<button onclick="calcOp('/')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">÷</button>
<button onclick="calcNum('7')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">7</button>
<button onclick="calcNum('8')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">8</button>
<button onclick="calcNum('9')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">9</button>
<button onclick="calcOp('*')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">×</button>
<button onclick="calcNum('4')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">4</button>
<button onclick="calcNum('5')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">5</button>
<button onclick="calcNum('6')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">6</button>
<button onclick="calcOp('-')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">−</button>
<button onclick="calcNum('1')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">1</button>
<button onclick="calcNum('2')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">2</button>
<button onclick="calcNum('3')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">3</button>
<button onclick="calcOp('+')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">+</button>
<button onclick="calcNum('0')" style="grid-column:span 2;padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">0</button>
<button onclick="calcNum('.')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">.</button>
<button onclick="calcEquals()" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#27ae60;color:white;cursor:pointer;">=</button>
</div>
</div>`,
        onInit: 'calcInit'
    },
    'dynamic-tax-calculator': {
        id: 'dynamic-tax-calculator',
        name: 'Tax Calculator',
        description: 'Interactive calculator for estimating federal income tax',
        icon: '🧾',
        title: 'Tax Calculator',
        content: `<div class="calc-widget">
<div class="calc-grid">
<div>
<label>Annual Income</label>
<input type="number" id="taxIncome" value="75000" oninput="calculateTax()">
</div>
<div>
<label>Filing Status</label>
<select id="taxStatus" onchange="calculateTax()">
<option value="single">Single</option>
<option value="married">Married Filing Jointly</option>
</select>
</div>
</div>
<div id="taxResults"></div>
</div>`,
        onInit: 'calculateTax'
    },
    'loan-calculator': {
        id: 'loan-calculator',
        name: 'Loan Calculator',
        description: 'Calculate monthly payments, total interest, and amortization',
        icon: '🏦',
        title: 'Loan Calculator',
        content: `<div class="calc-widget">
<div class="calc-grid">
<div>
<label>Loan Amount</label>
<input type="number" id="loanAmount" value="300000" oninput="calculateLoan()">
</div>
<div>
<label>Interest Rate (%)</label>
<input type="number" id="loanRate" value="6.5" step="0.125" oninput="calculateLoan()">
</div>
<div>
<label>Loan Term (years)</label>
<input type="number" id="loanYears" value="30" oninput="calculateLoan()">
</div>
<div>
<label>Extra Monthly Payment</label>
<input type="number" id="loanExtra" value="0" oninput="calculateLoan()">
</div>
</div>
<div id="loanResults"></div>
</div>`,
        onInit: 'calculateLoan'
    },
    'checklist': {
        id: 'checklist',
        name: 'Checklist',
        description: 'Interactive checklist with add, check, and delete functionality',
        icon: '✅',
        title: 'Checklist',
        content: `<div class="checklist-widget" style="padding:10px;">
<div style="display:flex;gap:8px;margin-bottom:12px;">
<input type="text" class="checklist-input" placeholder="Add new item..." style="flex:1;padding:8px 10px;border:1px solid var(--border-color);border-radius:4px;font-size:13px;background:var(--input-bg);color:var(--text-primary);">
<button onclick="checklistAddItem(this)" style="padding:8px 14px;background:#27ae60;color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px;">Add</button>
</div>
<ul class="checklist-items" style="list-style:none;padding:0;margin:0;"></ul>
<div class="checklist-summary" style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border-light);font-size:11px;color:var(--text-muted);"></div>
</div>`,
        onInit: 'checklistInit'
    },
    'calendar': {
        id: 'calendar',
        name: 'Calendar',
        description: 'Year view calendar with .ics import and event tracking',
        icon: '📅',
        title: 'Calendar ' + new Date().getFullYear(),
        content: `<div class="calendar-widget">
<div class="calendar-header">
<div class="calendar-view-toggle">
<button class="calendar-view-btn active" onclick="calendarSetView(this, 'year')">Year</button>
<button class="calendar-view-btn" onclick="calendarSetView(this, 'month')">Month</button>
</div>
<div class="calendar-year-nav">
<button onclick="calendarPrevYear(this)">&lt;</button>
<span class="calendar-year-display">${new Date().getFullYear()}</span>
<button onclick="calendarNextYear(this)">&gt;</button>
</div>
<button class="calendar-manage-btn" onclick="calendarOpenManage(this)">Manage</button>
</div>
<div class="calendar-year-grid"></div>
<div class="calendar-month-view">
<div class="calendar-month-nav">
<button onclick="calendarPrevMonth(this)">&lt;</button>
<span class="calendar-month-title"></span>
<button onclick="calendarNextMonth(this)">&gt;</button>
<button class="calendar-today-btn" onclick="calendarGoToToday(this)">Today</button>
</div>
<div class="calendar-month-detail"></div>
</div>
<div class="calendar-legend"></div>
</div>`,
        onInit: 'calendarInit'
    },
    'diff-viewer': {
        id: 'diff-viewer',
        name: 'Diff Viewer',
        description: 'Compare two texts with visual diff highlighting',
        icon: '🔀',
        title: 'Text Diff',
        content: `<div class="diff-widget">
<div class="diff-toolbar">
<div class="diff-mode-toggle">
<button class="diff-mode-btn active" onclick="diffSetMode(this, 'edit')">Edit</button>
<button class="diff-mode-btn" onclick="diffSetMode(this, 'view')">View</button>
</div>
<div class="diff-view-options">
<button class="diff-view-btn active" onclick="diffSetView(this, 'split')">Split</button>
<button class="diff-view-btn" onclick="diffSetView(this, 'unified')">Unified</button>
<label class="diff-whitespace-toggle">
<input type="checkbox" onchange="diffToggleWhitespace(this)">
Hide Whitespace
</label>
</div>
</div>
<div class="diff-edit-container">
<div class="diff-edit-pane">
<label>Original</label>
<textarea placeholder="Enter original text..." oninput="diffOnInput(this, 'original')" onscroll="diffSyncScroll(this, 'original')"></textarea>
</div>
<div class="diff-edit-resizer"></div>
<div class="diff-edit-pane">
<label>Modified</label>
<textarea placeholder="Enter modified text..." oninput="diffOnInput(this, 'modified')" onscroll="diffSyncScroll(this, 'modified')"></textarea>
</div>
</div>
<div class="diff-view-container">
<div class="diff-output"></div>
</div>
<div class="diff-stats"></div>
</div>`,
        onInit: 'diffInit'
    },
    'sequence-diagram': {
        id: 'sequence-diagram',
        name: 'Sequence Diagram',
        description: 'Create sequence diagrams from simple text notation',
        icon: '📊',
        title: 'Sequence Diagram',
        content: `<div class="seq-widget">
<div class="seq-toolbar">
<div class="seq-mode-toggle">
<button class="seq-mode-btn" onclick="seqSetMode(this, 'edit')">Edit</button>
<button class="seq-mode-btn active" onclick="seqSetMode(this, 'split')">Split</button>
<button class="seq-mode-btn" onclick="seqSetMode(this, 'view')">View</button>
</div>
<button class="seq-help-btn" onclick="seqShowHelp(this)">? Syntax Help</button>
</div>
<div class="seq-edit-container">
<textarea placeholder="Enter sequence diagram notation..." oninput="seqOnInput(this)"></textarea>
</div>
<div class="seq-split-container active">
<div class="seq-edit-pane">
<textarea placeholder="Enter sequence diagram notation...

Example:
Alice -> Bob: Hello
Bob --> Alice: Hi there!
Bob -> Charlie: Forward
Charlie --> Bob: Reply" oninput="seqOnInput(this)"></textarea>
</div>
<div class="seq-split-resizer"></div>
<div class="seq-view-pane">
<div class="seq-diagram"></div>
</div>
</div>
<div class="seq-view-container">
<div class="seq-diagram"></div>
</div>
<div class="seq-help-text">
<code>A -> B: msg</code> | <code>Note over A: text</code> | Colors: <code>[red]</code> or <code>[line:red, text:blue]</code>
</div>
</div>`,
        onInit: 'seqInit'
    },
    'jwt-decoder': {
        id: 'jwt-decoder',
        name: 'JWT Decoder',
        description: 'Decode and inspect JSON Web Tokens',
        icon: '🔐',
        title: 'JWT Decoder',
        content: `<div class="jwt-widget">
<div class="jwt-input-section">
<label>Paste JWT Token</label>
<div class="jwt-toolbar">
<button class="jwt-sample-btn" onclick="jwtLoadSample()">Load Sample</button>
<button class="jwt-sample-btn" onclick="jwtClear()">Clear</button>
</div>
<textarea placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c" oninput="jwtDecode(this)"></textarea>
</div>
<div class="jwt-output-section">
<div class="jwt-results"></div>
</div>
</div>`,
        onInit: 'jwtInit'
    },
    'code-formatter': {
        id: 'code-formatter',
        name: 'Code Formatter',
        description: 'Prettify or minify JSON, XML, CSV, and SQL',
        icon: '🎨',
        title: 'Code Formatter',
        content: `<div class="fmt-widget">
<div class="fmt-toolbar">
<div class="fmt-format-toggle">
<button class="fmt-format-btn active" onclick="fmtSetFormat(this, 'json')">JSON</button>
<button class="fmt-format-btn" onclick="fmtSetFormat(this, 'xml')">XML</button>
<button class="fmt-format-btn" onclick="fmtSetFormat(this, 'csv')">CSV</button>
<button class="fmt-format-btn" onclick="fmtSetFormat(this, 'sql')">SQL</button>
</div>
<div class="fmt-actions">
<button class="fmt-action-btn" onclick="fmtPrettify(this)">Prettify</button>
<button class="fmt-action-btn" onclick="fmtMinify(this)">Minify</button>
<button class="fmt-action-btn" onclick="fmtCopy(this)">Copy</button>
<button class="fmt-action-btn" onclick="fmtSwap(this)">Swap</button>
</div>
</div>
<div class="fmt-container">
<div class="fmt-pane">
<label>Input</label>
<textarea class="fmt-input" placeholder="Paste your code here..." oninput="fmtOnInput(this)"></textarea>
</div>
<div class="fmt-resizer"></div>
<div class="fmt-pane">
<label>Output</label>
<textarea class="fmt-output" readonly placeholder="Formatted output will appear here..."></textarea>
</div>
</div>
<div class="fmt-status"></div>
</div>`,
        onInit: 'fmtInit'
    },
    'cron-expression': {
        id: 'cron-expression',
        name: 'Cron Expression',
        description: 'Interactive cron expression parser with schedule preview',
        icon: '⏰',
        title: 'Cron Expression',
        content: `<div class="cron-widget">
<div class="cron-input-section">
<div class="cron-input-row">
<input type="text" class="cron-input" placeholder="* * * * *" value="0 9 * * MON-FRI" oninput="cronParse(this)">
</div>
<div class="cron-presets">
<button class="cron-preset-btn" onclick="cronSetPreset(this, '* * * * *')">Every minute</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 * * * *')">Every hour</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 0 * * *')">Daily midnight</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 9 * * MON-FRI')">Weekdays 9am</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 0 * * 0')">Weekly Sunday</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 0 1 * *')">Monthly 1st</button>
</div>
</div>
<div class="cron-explanation">
<div class="cron-explanation-text"></div>
</div>
<div class="cron-fields"></div>
<div class="cron-schedule">
<div class="cron-schedule-header">
<span class="cron-schedule-title">Next scheduled runs</span>
<span class="cron-schedule-count"></span>
</div>
<div class="cron-schedule-list"></div>
</div>
</div>`,
        onInit: 'cronInit'
    },
    'regex-tester': {
        id: 'regex-tester',
        name: 'Regex Tester',
        description: 'Test regular expressions with real-time matching and highlighting',
        icon: '🔍',
        title: 'Regex Tester',
        content: `<div class="regex-widget">
<div class="regex-toolbar">
<div class="regex-flags">
<label title="Global - find all matches"><input type="checkbox" class="regex-flag" data-flag="g" checked onchange="regexOnInput(this)"> g</label>
<label title="Case insensitive"><input type="checkbox" class="regex-flag" data-flag="i" onchange="regexOnInput(this)"> i</label>
<label title="Multiline - ^ and $ match line boundaries"><input type="checkbox" class="regex-flag" data-flag="m" onchange="regexOnInput(this)"> m</label>
<label title="Dot matches newlines"><input type="checkbox" class="regex-flag" data-flag="s" onchange="regexOnInput(this)"> s</label>
</div>
<div class="regex-actions">
<button class="regex-action-btn" onclick="regexCopy(this)">Copy Regex</button>
<button class="regex-action-btn" onclick="regexClear(this)">Clear</button>
</div>
</div>
<div class="regex-input-row">
<label>Pattern</label>
<input type="text" class="regex-pattern" placeholder="Enter regex pattern..." oninput="regexOnInput(this)">
</div>
<div class="regex-container">
<div class="regex-pane">
<label>Test String</label>
<textarea class="regex-test-string" placeholder="Enter text to test against..." oninput="regexOnInput(this)"></textarea>
</div>
<div class="regex-resizer"></div>
<div class="regex-pane regex-results-pane">
<label>Match Results</label>
<div class="regex-results"></div>
</div>
</div>
<div class="regex-status"></div>
</div>`,
        onInit: 'regexInit'
    },
    'epoch-converter': {
        id: 'epoch-converter',
        name: 'Epoch Converter',
        description: 'Convert between Unix timestamps and human-readable dates',
        icon: '⏱️',
        title: 'Epoch Converter',
        content: `<div class="epoch-widget">
<div class="epoch-section">
<label>Current Time</label>
<div class="epoch-current">
<span class="epoch-now-value">-</span>
<button class="epoch-action-btn" onclick="epochCopyNow(this)">Copy</button>
<button class="epoch-action-btn" onclick="epochUseNow(this)">Use</button>
</div>
</div>
<div class="epoch-section">
<label>Unix Timestamp (seconds or milliseconds)</label>
<div class="epoch-input-row">
<input type="text" class="epoch-timestamp-input" placeholder="e.g. 1700000000 or 1700000000000" oninput="epochFromTimestamp(this)">
<select class="epoch-unit-select" onchange="epochFromTimestamp(this)">
<option value="auto">Auto-detect</option>
<option value="s">Seconds</option>
<option value="ms">Milliseconds</option>
</select>
</div>
<div class="epoch-result epoch-from-ts"></div>
</div>
<div class="epoch-section">
<label>Human Date/Time</label>
<div class="epoch-datetime-inputs">
<input type="date" class="epoch-date-input" oninput="epochFromDatetime(this)">
<input type="time" class="epoch-time-input" step="1" oninput="epochFromDatetime(this)">
<select class="epoch-tz-select" onchange="epochFromDatetime(this)">
<option value="local">Local Time</option>
<option value="utc">UTC</option>
</select>
</div>
<div class="epoch-result epoch-from-dt"></div>
</div>
<div class="epoch-section">
<label>Quick Reference</label>
<div class="epoch-reference">
<div class="epoch-ref-item"><span>Start of today:</span><code class="epoch-ref-today">-</code></div>
<div class="epoch-ref-item"><span>Start of year:</span><code class="epoch-ref-year">-</code></div>
<div class="epoch-ref-item"><span>Unix epoch:</span><code>0 (Jan 1, 1970 00:00:00 UTC)</code></div>
</div>
</div>
</div>`,
        onInit: 'epochInit'
    }
};

// Board management
function loadBoards() {
    const stored = localStorage.getItem('financeBoards');
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return [{ id: 'default', name: 'Toolboard' }];
        }
    }
    return [{ id: 'default', name: 'Toolboard' }];
}

function saveBoards(boards) {
    localStorage.setItem('financeBoards', JSON.stringify(boards));
    updateStorageIndicator();
}

function getCurrentBoardId() {
    return localStorage.getItem('financeCurrentBoard') || 'default';
}

function setCurrentBoardId(boardId) {
    localStorage.setItem('financeCurrentBoard', boardId);
}

let boards = loadBoards();
let currentBoardId = getCurrentBoardId();

// Migrate old data to new board-specific format (one-time migration)
function migrateOldData() {
    // Check if migration already done
    if (localStorage.getItem('financeMigrationDone')) return;

    // Map of old keys to new key suffixes
    const migrations = {
        'financeVariables': 'variables',
        'financeNotePositions': 'positions',
        'financeNoteCustomizations': 'toolCustomizations',
        'financeCustomNotes': 'customTools',
        'financeToolboardSettings': 'toolboardSettings'
    };

    let hadOldData = false;
    for (const [oldKey, newSuffix] of Object.entries(migrations)) {
        const oldData = localStorage.getItem(oldKey);
        if (oldData) {
            hadOldData = true;
            // Copy to default board
            localStorage.setItem(`finance_default_${newSuffix}`, oldData);
            // Remove old key
            localStorage.removeItem(oldKey);
        }
    }

    if (hadOldData) {
        console.log('Migrated old data to default board');
    }

    localStorage.setItem('financeMigrationDone', 'true');
}

migrateOldData();

// Helper to get board-specific storage key
function boardKey(key) {
    return `finance_${currentBoardId}_${key}`;
}

// Load variables from localStorage or use defaults
function loadVariables() {
    const stored = localStorage.getItem(boardKey('variables'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            console.error('Error parsing stored variables:', e);
            return DEFAULT_VARIABLES;
        }
    }
    return DEFAULT_VARIABLES;
}

// Save variables to localStorage
function saveVariables(variables) {
    localStorage.setItem(boardKey('variables'), JSON.stringify(variables));
    updateStorageIndicator();
}

// Load tool positions from localStorage or use defaults
function loadPositions() {
    const stored = localStorage.getItem(boardKey('positions'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            console.error('Error parsing stored positions:', e);
            return { ...DEFAULT_POSITIONS };
        }
    }
    return { ...DEFAULT_POSITIONS };
}

// Save tool positions to localStorage
function savePositions(positions) {
    localStorage.setItem(boardKey('positions'), JSON.stringify(positions));
    updateStorageIndicator();
}

// Reset everything
function resetVariables() {
    localStorage.removeItem(boardKey('variables'));
    updateStorageIndicator();
    return DEFAULT_VARIABLES;
}

function resetPositions() {
    localStorage.removeItem(boardKey('positions'));
    updateStorageIndicator();
    return { ...generateDefaultPositions() };
}

// Helper functions for calculations
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-US').format(Math.round(num));
}

// Main application
let variables = loadVariables();
let positions = loadPositions();
let maxZ = Math.max(...Object.values(positions).map(p => p.z || 1), 1);

// Snap threshold in pixels
const SNAP_THRESHOLD = 15;

// Drag state
let dragState = {
    isDragging: false,
    tool: null,
    startX: 0,
    startY: 0,
    offsetX: 0,
    offsetY: 0
};

// Resize state
let resizeState = {
    isResizing: false,
    tool: null,
    handle: null,
    startX: 0,
    startY: 0,
    startWidth: 0,
    startHeight: 0,
    startLeft: 0,
    startTop: 0
};

// Dark mode setup
function setupDarkMode() {
    const toggle = document.getElementById('darkModeToggle');
    const stored = localStorage.getItem('toolboard_darkMode');

    // Apply stored preference or check system preference
    if (stored === 'true' || (stored === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-mode');
        toggle.innerHTML = '&#9788;'; // Sun icon for light mode
        toggle.title = 'Switch to Light Mode';
    }

    toggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('toolboard_darkMode', isDark);
        toggle.innerHTML = isDark ? '&#9788;' : '&#9790;'; // Sun or Moon
        toggle.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    });
}

// Initialize the toolboard
function init() {
    setupDarkMode();
    populateBoardSelector();
    applyToolboardSettings();
    setupToolboardSettings();
    renderToolboard();
    setupDragging();
    setupResizing();
    setupToolControls();
    setupContentEditor();
    setupButtons();
    setupImportExport();
    setupFeatureSelect();
    displayVersion();
    updateStorageIndicator();
}

// Display Toolboard version based on file modification date
function displayVersion() {
    const versionEl = document.getElementById('toolboardVersion');
    if (versionEl) {
        const lastMod = new Date(document.lastModified);
        const version = lastMod.toISOString().slice(0, 10).replace(/-/g, '.');
        versionEl.textContent = 'v' + version;
        versionEl.title = 'Toolboard version (last modified: ' + lastMod.toLocaleString() + ')';
    }
}

// Display localStorage usage and quota
function updateStorageIndicator() {
    const indicator = document.getElementById('storageIndicator');
    if (!indicator) return;

    // Calculate total localStorage size
    let totalSize = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            totalSize += key.length + localStorage[key].length;
        }
    }
    const usedKB = (totalSize * 2) / 1024; // UTF-16 = 2 bytes per char
    const usedMB = usedKB / 1024;

    // Estimate quota (typically 5-10MB, test by trying to write)
    let quotaMB = 5; // Default assumption
    try {
        // Try to detect actual quota by attempting storage
        const testKey = '__storage_test__';
        const testData = 'x'.repeat(1024 * 1024); // 1MB test
        let canStore = true;
        for (let i = 0; i < 10 && canStore; i++) {
            try {
                localStorage.setItem(testKey + i, testData);
                localStorage.removeItem(testKey + i);
            } catch (e) {
                quotaMB = usedMB + i;
                canStore = false;
            }
        }
        if (canStore) quotaMB = 10; // Could store 10MB, assume 10MB quota
    } catch (e) {
        // Ignore test errors
    }

    const percent = Math.min(100, (usedMB / quotaMB) * 100);
    const levelClass = percent < 50 ? 'low' : percent < 80 ? 'medium' : 'high';

    // Format display
    const usedDisplay = usedKB < 1024
        ? usedKB.toFixed(1) + ' KB'
        : usedMB.toFixed(2) + ' MB';
    const quotaDisplay = quotaMB + ' MB';

    indicator.innerHTML = `
        <span class="storage-label">${usedDisplay} / ${quotaDisplay}</span>
        <div class="storage-bar">
            <div class="storage-bar-fill ${levelClass}" style="width: ${percent}%"></div>
        </div>
    `;
    indicator.title = `localStorage: ${usedDisplay} used of ~${quotaDisplay} (${percent.toFixed(1)}%)\nClick to see storage breakdown`;

    // Add click handler to show details
    indicator.onclick = showStorageDetails;
}

function showStorageDetails() {
    // Gather storage breakdown
    const items = [];
    let totalSize = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            const size = (key.length + localStorage[key].length) * 2;
            totalSize += size;
            items.push({ key, size });
        }
    }
    items.sort((a, b) => b.size - a.size);

    const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    };

    let html = `
        <div class="storage-modal-overlay" onclick="this.remove()">
            <div class="storage-modal" onclick="event.stopPropagation()">
                <div class="storage-modal-header">
                    <h3>localStorage Usage</h3>
                    <button onclick="this.closest('.storage-modal-overlay').remove()">&times;</button>
                </div>
                <div class="storage-modal-body">
                    <div class="storage-total">Total: ${formatSize(totalSize)}</div>
                    <table class="storage-table">
                        <thead><tr><th>Key</th><th>Size</th></tr></thead>
                        <tbody>
                            ${items.slice(0, 50).map(item => `
                                <tr>
                                    <td title="${item.key}">${item.key.length > 40 ? item.key.slice(0, 40) + '...' : item.key}</td>
                                    <td>${formatSize(item.size)}</td>
                                </tr>
                            `).join('')}
                            ${items.length > 50 ? `<tr><td colspan="2">... and ${items.length - 50} more items</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}

// Setup tool minimize and settings controls
let currentSettingsToolId = null;

function setupToolControls() {
    const toolboard = document.getElementById('toolboard');
    const settingsOverlay = document.getElementById('toolSettingsOverlay');
    const settingsTitleInput = document.getElementById('toolSettingsTitleInput');
    const settingsColorPicker = document.getElementById('toolSettingsColorPicker');
    const settingsFontFamily = document.getElementById('toolSettingsFontFamily');
    const settingsFontSize = document.getElementById('toolSettingsFontSize');
    const settingsEditBtn = document.getElementById('toolSettingsEditBtn');
    const settingsDuplicateBtn = document.getElementById('toolSettingsDuplicateBtn');
    const settingsExportBtn = document.getElementById('toolSettingsExportBtn');
    const settingsExportPngBtn = document.getElementById('toolSettingsExportPngBtn');
    const settingsDeleteBtn = document.getElementById('toolSettingsDeleteBtn');
    const settingsCloseBtn = settingsOverlay.querySelector('.tool-settings-close');

    // Populate color picker
    settingsColorPicker.innerHTML = HEADER_COLORS.map(c =>
        `<div class="color-swatch" style="background: ${c}" data-color="${c}"></div>`
    ).join('');

    // Minimize button
    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.minimize-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            const toolId = tool.getAttribute('data-tool');
            const btn = e.target.closest('.minimize-btn');

            tool.classList.toggle('minimized');
            btn.classList.toggle('minimized');

            // Save state
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].minimized = tool.classList.contains('minimized');
            saveToolCustomizations(toolCustomizations);
        }
    });

    // Fullscreen button
    const fullscreenBackdrop = document.getElementById('fullscreenBackdrop');
    let currentFullscreenTool = null;

    function exitFullscreen() {
        if (currentFullscreenTool) {
            currentFullscreenTool.classList.remove('fullscreen');
            const btn = currentFullscreenTool.querySelector('.fullscreen-btn');
            if (btn) btn.classList.remove('active');
            fullscreenBackdrop.classList.remove('active');
            currentFullscreenTool = null;
        }
    }

    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.fullscreen-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            const btn = e.target.closest('.fullscreen-btn');

            if (tool.classList.contains('fullscreen')) {
                exitFullscreen();
            } else {
                // Exit any existing fullscreen first
                exitFullscreen();
                tool.classList.add('fullscreen');
                btn.classList.add('active');
                fullscreenBackdrop.classList.add('active');
                currentFullscreenTool = tool;
            }
        }
    });

    // Click backdrop to exit fullscreen
    fullscreenBackdrop.addEventListener('click', exitFullscreen);

    // ESC key to exit fullscreen
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentFullscreenTool) {
            exitFullscreen();
        }
    });

    // Settings button - open modal
    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.settings-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            const toolId = tool.getAttribute('data-tool');
            currentSettingsToolId = toolId;

            // Bring tool to front
            let highestZ = 0;
            document.querySelectorAll('.tool').forEach(s => {
                const z = parseInt(s.style.zIndex) || 0;
                if (z > highestZ) highestZ = z;
            });
            maxZ = highestZ + 1;
            tool.style.zIndex = maxZ;
            positions[toolId] = positions[toolId] || {};
            positions[toolId].z = maxZ;

            // Populate modal with current tool settings
            const custom = toolCustomizations[toolId] || {};
            const content = getToolContent(toolId);
            const displayTitle = custom.title || content.title;
            const headerColor = custom.color || null;
            const isCustomTool = customTools.includes(toolId);

            settingsTitleInput.value = displayTitle;
            settingsDeleteBtn.textContent = isCustomTool ? 'Delete Tool' : 'Hide Tool';

            // Update color picker selection
            settingsColorPicker.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.toggle('selected', s.getAttribute('data-color') === headerColor);
            });

            // Update font selects
            settingsFontFamily.value = custom.fontFamily || '';
            settingsFontSize.value = custom.fontSize || '';

            // Open modal
            settingsOverlay.classList.add('open');
        }
    });

    // Close modal
    function closeSettingsModal() {
        settingsOverlay.classList.remove('open');
        currentSettingsToolId = null;
    }

    settingsCloseBtn.addEventListener('click', closeSettingsModal);

    // Close on overlay background click
    settingsOverlay.addEventListener('click', (e) => {
        if (e.target === settingsOverlay) {
            closeSettingsModal();
        }
    });

    // Color swatch click in modal
    settingsColorPicker.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch') && currentSettingsToolId) {
            e.stopPropagation();
            const toolId = currentSettingsToolId;
            const tool = document.querySelector(`.tool[data-tool="${toolId}"]`);
            const color = e.target.getAttribute('data-color');
            const header = tool.querySelector('.tool-header');

            // Update UI
            header.style.background = color;
            settingsColorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            e.target.classList.add('selected');

            // Save
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].color = color;
            saveToolCustomizations(toolCustomizations);
        }
    });

    // Title input change in modal
    settingsTitleInput.addEventListener('input', (e) => {
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            const tool = document.querySelector(`.tool[data-tool="${toolId}"]`);
            const titleSpan = tool.querySelector('.tool-title');
            const newTitle = e.target.value;

            // Update UI
            titleSpan.textContent = newTitle;

            // Save
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].title = newTitle;
            saveToolCustomizations(toolCustomizations);
        }
    });

    // Font family change in modal
    settingsFontFamily.addEventListener('change', (e) => {
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].fontFamily = e.target.value;
            saveToolCustomizations(toolCustomizations);
            applyToolFont(toolId);
        }
    });

    // Font size change in modal
    settingsFontSize.addEventListener('change', (e) => {
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].fontSize = e.target.value;
            saveToolCustomizations(toolCustomizations);
            applyToolFont(toolId);
        }
    });

    // Edit content button in modal
    settingsEditBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            openContentEditor(toolId);
        }
    });

    // Duplicate tool button in modal
    settingsDuplicateBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            duplicateTool(toolId);
        }
    });

    // Export tool button in modal
    settingsExportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            exportToolAsHtml(toolId);
        }
    });

    // Export tool as PNG button in modal
    settingsExportPngBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            exportToolAsPng(toolId);
        }
    });

    // Delete tool button in modal
    settingsDeleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            deleteTool(toolId);
        }
    });

    // Prevent dragging when interacting with header buttons
    toolboard.addEventListener('mousedown', (e) => {
        if (e.target.closest('.header-btn')) {
            e.stopPropagation();
        }
    });
}

// Render all tools
function renderToolboard() {
    const toolboard = document.getElementById('toolboard');
    toolboard.innerHTML = '';

    const toolsToAutoFit = [];

    // Render built-in tools (excluding hidden ones)
    SECTIONS.forEach(toolId => {
        if (hiddenTools.includes(toolId)) return;
        const tool = createTool(toolId);
        if (tool) {
            toolboard.appendChild(tool);
            // Check if tool needs auto-fitting (no saved dimensions and has content)
            const pos = positions[toolId];
            const custom = toolCustomizations[toolId] || {};
            if ((!pos || (!pos.width && !pos.height)) && custom.customContent) {
                toolsToAutoFit.push(tool);
            }
        }
    });

    // Render custom tools
    customTools.forEach(toolId => {
        const tool = createTool(toolId);
        if (tool) {
            toolboard.appendChild(tool);
            // Check if tool needs auto-fitting (no saved dimensions)
            const pos = positions[toolId];
            const custom = toolCustomizations[toolId] || {};
            if ((!pos || (!pos.width && !pos.height)) && (custom.customContent || custom.templateId)) {
                toolsToAutoFit.push(tool);
            }
        }
    });

    // Initialize dynamic calculators if present
    initializeCalculators();

    // Auto-fit tools after DOM is ready
    if (toolsToAutoFit.length > 0) {
        requestAnimationFrame(() => {
            toolsToAutoFit.forEach(tool => autoFitToolContent(tool, true));
        });
    }
}

function initializeCalculators() {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
        if (document.getElementById('taxIncome')) calculateTax();
        if (document.getElementById('growthInitial')) calculateGrowth();
        if (document.querySelector('.checklist-widget')) checklistInit();
        if (document.querySelector('.calendar-widget')) calendarInit();
        if (document.querySelector('.diff-widget')) diffInit();
        if (document.querySelector('.seq-widget')) seqInit();
        if (document.querySelector('.jwt-widget')) jwtInit();
        if (document.querySelector('.fmt-widget')) fmtInit();
        if (document.querySelector('.cron-widget')) cronInit();
        if (document.querySelector('.regex-widget')) regexInit();
        if (document.querySelector('.epoch-widget')) epochInit();
    }, 50);
}

// Dynamic Calculator Functions
const taxBrackets = {
    single: [
        {min: 0, max: 12400, rate: 0.10},
        {min: 12400, max: 50400, rate: 0.12},
        {min: 50400, max: 105700, rate: 0.22},
        {min: 105700, max: 201775, rate: 0.24},
        {min: 201775, max: 256225, rate: 0.32},
        {min: 256225, max: 640800, rate: 0.35},
        {min: 640800, max: Infinity, rate: 0.37}
    ],
    married: [
        {min: 0, max: 24800, rate: 0.10},
        {min: 24800, max: 100800, rate: 0.12},
        {min: 100800, max: 211400, rate: 0.22},
        {min: 211400, max: 403550, rate: 0.24},
        {min: 403550, max: 512450, rate: 0.32},
        {min: 512450, max: 788700, rate: 0.35},
        {min: 788700, max: Infinity, rate: 0.37}
    ]
};
const stdDeductions = {single: 16100, married: 32200};

function calculateTax() {
    const incomeEl = document.getElementById('taxIncome');
    const statusEl = document.getElementById('taxStatus');
    const resultsEl = document.getElementById('taxResults');
    if (!incomeEl || !statusEl || !resultsEl) return;

    const income = parseFloat(incomeEl.value) || 0;
    const status = statusEl.value;
    const ded = stdDeductions[status];
    const taxable = Math.max(0, income - ded);
    let totalTax = 0;
    let breakdown = '';

    for (const b of taxBrackets[status]) {
        if (taxable > b.min) {
            const amt = Math.min(taxable, b.max) - b.min;
            const tax = amt * b.rate;
            totalTax += tax;
            if (amt > 0) {
                breakdown += `<div class="calc-row"><span>${(b.rate*100)}%</span><span>$${amt.toLocaleString()}</span><span class="calc-card-value negative">$${tax.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</span></div>`;
            }
        }
    }

    const effRate = income > 0 ? (totalTax / income * 100).toFixed(1) : 0;
    const margBracket = taxBrackets[status].find(b => taxable >= b.min && taxable < b.max);
    const margRate = margBracket ? margBracket.rate * 100 : 37;

    resultsEl.innerHTML = `
        <div class="calc-grid">
            <div class="calc-card">
                <div class="calc-card-label">Standard Deduction</div>
                <div class="calc-card-value positive">$${ded.toLocaleString()}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Taxable Income</div>
                <div class="calc-card-value">$${taxable.toLocaleString()}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Total Tax</div>
                <div class="calc-card-value negative">$${totalTax.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Effective / Marginal</div>
                <div class="calc-card-value">${effRate}% / ${margRate}%</div>
            </div>
        </div>
        <div class="calc-section-title">TAX BY BRACKET</div>
        ${breakdown}
        <div class="calc-row" style="padding:8px 0;font-weight:600;">
            <span>Take Home (Monthly)</span>
            <span class="calc-card-value positive">$${((income - totalTax) / 12).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</span>
        </div>
    `;
}

// Loan Calculator
function calculateLoan() {
    const amountEl = document.getElementById('loanAmount');
    const rateEl = document.getElementById('loanRate');
    const yearsEl = document.getElementById('loanYears');
    const extraEl = document.getElementById('loanExtra');
    const resultsEl = document.getElementById('loanResults');
    if (!amountEl || !rateEl || !yearsEl || !resultsEl) return;

    const principal = parseFloat(amountEl.value) || 0;
    const annualRate = (parseFloat(rateEl.value) || 0) / 100;
    const years = parseInt(yearsEl.value) || 0;
    const extraPayment = parseFloat(extraEl.value) || 0;
    const monthlyRate = annualRate / 12;
    const numPayments = years * 12;

    if (principal <= 0 || annualRate <= 0 || years <= 0) {
        resultsEl.innerHTML = '<div style="color:#7f8c8d;text-align:center;padding:20px;">Enter loan details above</div>';
        return;
    }

    // Standard monthly payment formula: M = P * [r(1+r)^n] / [(1+r)^n - 1]
    const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
    const totalPayment = monthlyPayment * numPayments;
    const totalInterest = totalPayment - principal;

    // Calculate with extra payments
    let balance = principal;
    let totalInterestWithExtra = 0;
    let monthsWithExtra = 0;
    while (balance > 0 && monthsWithExtra < numPayments * 2) {
        const interestPayment = balance * monthlyRate;
        const principalPayment = Math.min(balance, monthlyPayment - interestPayment + extraPayment);
        totalInterestWithExtra += interestPayment;
        balance -= principalPayment;
        monthsWithExtra++;
        if (balance < 0.01) balance = 0;
    }
    const yearsWithExtra = Math.floor(monthsWithExtra / 12);
    const monthsRemainder = monthsWithExtra % 12;
    const interestSaved = totalInterest - totalInterestWithExtra;

    // Amortization milestones
    let milestones = '';
    const checkYears = [1, 5, 10, 15, 20, 25, 30].filter(y => y <= years);
    let bal = principal;
    let paidPrincipal = 0;
    let paidInterest = 0;
    for (let m = 1; m <= numPayments; m++) {
        const intPmt = bal * monthlyRate;
        const prinPmt = monthlyPayment - intPmt;
        paidInterest += intPmt;
        paidPrincipal += prinPmt;
        bal -= prinPmt;
        if (checkYears.includes(m / 12)) {
            milestones += `<div class="calc-row"><span>Year ${m/12}</span><span>Balance: $${Math.max(0,bal).toLocaleString(undefined,{maximumFractionDigits:0})}</span><span style="color:var(--text-muted);">Paid: $${paidPrincipal.toLocaleString(undefined,{maximumFractionDigits:0})}</span></div>`;
        }
    }

    resultsEl.innerHTML = `
        <div class="calc-grid">
            <div class="calc-card">
                <div class="calc-card-label">Monthly Payment</div>
                <div class="calc-card-value large info">$${monthlyPayment.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Total Interest</div>
                <div class="calc-card-value large negative">$${totalInterest.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Total Cost</div>
                <div class="calc-card-value">$${totalPayment.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Interest Ratio</div>
                <div class="calc-card-value">${(totalInterest/principal*100).toFixed(1)}%</div>
            </div>
        </div>
        ${extraPayment > 0 ? `
        <div class="calc-highlight">
            <div class="calc-highlight-title">WITH $${extraPayment.toLocaleString()}/mo EXTRA</div>
            <div class="calc-row" style="border:none;font-size:13px;">
                <span>Payoff: ${yearsWithExtra}y ${monthsRemainder}m</span>
                <span class="calc-card-value positive" style="font-size:13px;">Save $${interestSaved.toLocaleString(undefined,{maximumFractionDigits:0})}</span>
            </div>
        </div>` : ''}
        <div class="calc-section-title">AMORTIZATION</div>
        ${milestones}
    `;
}

// Checklist Widget Functions
let checklistDragState = { dragging: null, toolId: null, parentIdx: null };

function checklistGetToolId(element) {
    const tool = element.closest('.tool');
    return tool ? tool.getAttribute('data-tool') : null;
}

function checklistGetData(toolId) {
    const custom = toolCustomizations[toolId] || {};
    // Migrate old format: convert completed boolean to status
    let items = custom.checklistItems || [];
    items = items.map(item => {
        if (typeof item.completed === 'boolean' && !item.status) {
            return { ...item, status: item.completed ? 'completed' : 'pending', children: item.children || [] };
        }
        return { ...item, children: item.children || [] };
    });
    return items;
}

function checklistSaveData(toolId, items) {
    toolCustomizations[toolId] = toolCustomizations[toolId] || {};
    toolCustomizations[toolId].checklistItems = items;
    saveToolCustomizations(toolCustomizations);
}

function checklistInit() {
    document.querySelectorAll('.checklist-widget').forEach(widget => {
        const toolId = checklistGetToolId(widget);
        if (toolId) {
            checklistRender(widget, toolId);
        }
    });
}

function checklistRenderItem(item, idx, parentIdx = null) {
    const statusClass = item.status || 'pending';
    const path = parentIdx !== null ? `${parentIdx}.${idx}` : `${idx}`;
    const isSubitem = parentIdx !== null;

    let childrenHtml = '';
    if (!isSubitem && item.children && item.children.length > 0) {
        childrenHtml = `<ul class="checklist-subitems">${item.children.map((child, cIdx) =>
            checklistRenderItem(child, cIdx, idx)
        ).join('')}</ul>`;
    }

    const addSubBtn = !isSubitem ? `<span class="checklist-add-sub" onclick="checklistAddSub(this, ${idx})">+ Add sub-item</span>` : '';

    return `
        <div class="checklist-item-wrapper" data-path="${path}">
            <li class="checklist-item ${statusClass}" data-path="${path}" draggable="true"
                ondragstart="checklistDragStart(event, '${path}')"
                ondragover="checklistDragOver(event)"
                ondragleave="checklistDragLeave(event)"
                ondrop="checklistDrop(event, '${path}')">
                <span class="checklist-drag">⋮⋮</span>
                <span class="checklist-status" onclick="checklistCycleStatus(this, '${path}')" title="Click to change status"></span>
                <span class="checklist-text" contenteditable="true"
                    onblur="checklistUpdateText(this, '${path}')"
                    onkeydown="checklistTextKeydown(event, this)">${escapeHtml(item.text)}</span>
                <span class="checklist-actions">
                    ${!isSubitem ? `<button class="checklist-btn" onclick="checklistAddSub(this, ${idx})" title="Add sub-item">+</button>` : ''}
                    <button class="checklist-btn delete" onclick="checklistDelete(this, '${path}')" title="Delete">×</button>
                </span>
            </li>
            ${childrenHtml}
            ${addSubBtn}
        </div>
    `;
}

function checklistRender(widget, toolId) {
    const items = checklistGetData(toolId);
    const listEl = widget.querySelector('.checklist-items');
    const summaryEl = widget.querySelector('.checklist-summary');

    if (!listEl) return;

    listEl.innerHTML = items.map((item, idx) => checklistRenderItem(item, idx)).join('');

    // Update summary with all items including children
    let total = 0, completed = 0, inProgress = 0;
    const countItems = (arr) => {
        arr.forEach(item => {
            total++;
            if (item.status === 'completed') completed++;
            else if (item.status === 'in_progress') inProgress++;
            if (item.children) countItems(item.children);
        });
    };
    countItems(items);

    if (total > 0) {
        let summary = `${completed}/${total} done`;
        if (inProgress > 0) summary += ` · ${inProgress} in progress`;
        summaryEl.textContent = summary;
    } else {
        summaryEl.textContent = 'No items yet';
    }
}

function checklistGetItemByPath(items, path) {
    const parts = path.split('.').map(Number);
    let item = items[parts[0]];
    if (parts.length > 1 && item && item.children) {
        item = item.children[parts[1]];
    }
    return item;
}

function checklistSetItemByPath(items, path, value) {
    const parts = path.split('.').map(Number);
    if (parts.length === 1) {
        if (value === null) {
            items.splice(parts[0], 1);
        } else {
            items[parts[0]] = value;
        }
    } else if (items[parts[0]] && items[parts[0]].children) {
        if (value === null) {
            items[parts[0]].children.splice(parts[1], 1);
        } else {
            items[parts[0]].children[parts[1]] = value;
        }
    }
}

function checklistAddItem(btn) {
    const widget = btn.closest('.checklist-widget');
    const input = widget.querySelector('.checklist-input');
    const toolId = checklistGetToolId(widget);

    if (!toolId || !input.value.trim()) return;

    const items = checklistGetData(toolId);
    items.push({ text: input.value.trim(), status: 'pending', children: [] });
    checklistSaveData(toolId, items);

    input.value = '';
    checklistRender(widget, toolId);
}

function checklistAddSub(el, parentIdx) {
    const widget = el.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    if (!items[parentIdx].children) items[parentIdx].children = [];
    items[parentIdx].children.push({ text: 'New sub-item', status: 'pending' });
    checklistSaveData(toolId, items);
    checklistRender(widget, toolId);

    // Focus the new item for editing
    setTimeout(() => {
        const newItem = widget.querySelector(`[data-path="${parentIdx}.${items[parentIdx].children.length - 1}"] .checklist-text`);
        if (newItem) {
            newItem.focus();
            document.execCommand('selectAll', false, null);
        }
    }, 10);
}

function checklistCycleStatus(el, path) {
    const widget = el.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    const item = checklistGetItemByPath(items, path);
    if (!item) return;

    // Cycle: pending -> in_progress -> completed -> pending
    const cycle = { 'pending': 'in_progress', 'in_progress': 'completed', 'completed': 'pending' };
    item.status = cycle[item.status] || 'pending';

    checklistSaveData(toolId, items);
    checklistRender(widget, toolId);
}

function checklistUpdateText(el, path) {
    const widget = el.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    const item = checklistGetItemByPath(items, path);
    if (!item) return;

    const newText = el.textContent.trim();
    if (newText && newText !== item.text) {
        item.text = newText;
        checklistSaveData(toolId, items);
    } else if (!newText) {
        el.textContent = item.text; // Restore if empty
    }
}

function checklistTextKeydown(e, el) {
    if (e.key === 'Enter') {
        e.preventDefault();
        el.blur();
    } else if (e.key === 'Escape') {
        const widget = el.closest('.checklist-widget');
        const toolId = checklistGetToolId(widget);
        const path = el.closest('.checklist-item').dataset.path;
        const items = checklistGetData(toolId);
        const item = checklistGetItemByPath(items, path);
        if (item) el.textContent = item.text;
        el.blur();
    }
}

function checklistDelete(btn, path) {
    const widget = btn.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    checklistSetItemByPath(items, path, null);
    checklistSaveData(toolId, items);
    checklistRender(widget, toolId);
}

// Drag and drop for reordering
function checklistDragStart(e, path) {
    const widget = e.target.closest('.checklist-widget');
    checklistDragState.dragging = path;
    checklistDragState.toolId = checklistGetToolId(widget);
    checklistDragState.parentIdx = path.includes('.') ? parseInt(path.split('.')[0]) : null;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function checklistDragOver(e) {
    e.preventDefault();
    const item = e.target.closest('.checklist-item');
    if (item && !item.classList.contains('dragging')) {
        item.classList.add('drag-over');
    }
}

function checklistDragLeave(e) {
    const item = e.target.closest('.checklist-item');
    if (item) item.classList.remove('drag-over');
}

function checklistDrop(e, targetPath) {
    e.preventDefault();
    const targetItem = e.target.closest('.checklist-item');
    if (targetItem) targetItem.classList.remove('drag-over');

    const sourcePath = checklistDragState.dragging;
    const toolId = checklistDragState.toolId;

    if (!sourcePath || !toolId || sourcePath === targetPath) {
        checklistDragState = { dragging: null, toolId: null, parentIdx: null };
        return;
    }

    // Only allow reordering within same level (both top-level or both same parent)
    const sourceParent = sourcePath.includes('.') ? sourcePath.split('.')[0] : null;
    const targetParent = targetPath.includes('.') ? targetPath.split('.')[0] : null;

    if (sourceParent !== targetParent) {
        checklistDragState = { dragging: null, toolId: null, parentIdx: null };
        return;
    }

    const items = checklistGetData(toolId);
    const sourceIdx = parseInt(sourcePath.split('.').pop());
    const targetIdx = parseInt(targetPath.split('.').pop());

    let arr = items;
    if (sourceParent !== null) {
        arr = items[parseInt(sourceParent)].children;
    }

    // Move item
    const [moved] = arr.splice(sourceIdx, 1);
    arr.splice(targetIdx > sourceIdx ? targetIdx : targetIdx, 0, moved);

    checklistSaveData(toolId, items);

    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .checklist-widget`);
    if (widget) checklistRender(widget, toolId);

    checklistDragState = { dragging: null, toolId: null, parentIdx: null };
}

document.addEventListener('dragend', (e) => {
    document.querySelectorAll('.checklist-item.dragging').forEach(el => el.classList.remove('dragging'));
    document.querySelectorAll('.checklist-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    checklistDragState = { dragging: null, toolId: null, parentIdx: null };
});

// Add enter key support for checklist input
document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.classList.contains('checklist-input')) {
        e.preventDefault();
        const widget = e.target.closest('.checklist-widget');
        const addBtn = widget.querySelector('button[onclick*="checklistAddItem"]');
        if (addBtn) checklistAddItem(addBtn);
    }
});

// Simple Calculator State
let calcState = { current: '0', previous: '', operator: '', newNumber: true };

function calcInit() {
    calcState = { current: '0', previous: '', operator: '', newNumber: true };
    const display = document.getElementById('calcDisplay');
    if (display) {
        display.value = '0';
        // Add keyboard support
        display.removeAttribute('readonly');
        display.addEventListener('keydown', calcKeyHandler);
        display.addEventListener('input', calcInputHandler);
        display.focus();
    }
}

function calcKeyHandler(e) {
    const key = e.key;

    // Prevent default for keys we handle
    if (/^[0-9.]$/.test(key) || ['+', '-', '*', '/', 'Enter', 'Escape', 'Backspace', '='].includes(key)) {
        e.preventDefault();
    }

    if (/^[0-9.]$/.test(key)) {
        calcNum(key);
    } else if (['+', '-', '*', '/'].includes(key)) {
        calcOp(key);
    } else if (key === 'Enter' || key === '=') {
        calcEquals();
    } else if (key === 'Escape' || key === 'Delete') {
        calcClear();
    } else if (key === 'Backspace') {
        calcBackspace();
    }
}

function calcInputHandler(e) {
    // Reset display to current state (prevent direct typing)
    const display = document.getElementById('calcDisplay');
    if (display) display.value = calcState.current;
}

function calcNum(num) {
    const display = document.getElementById('calcDisplay');
    if (!display) return;

    if (calcState.newNumber) {
        calcState.current = (num === '.') ? '0.' : num;
        calcState.newNumber = false;
    } else {
        if (num === '.' && calcState.current.includes('.')) return;
        calcState.current += num;
    }
    display.value = calcState.current;
}

function calcOp(op) {
    const display = document.getElementById('calcDisplay');
    if (!display) return;

    if (calcState.operator && !calcState.newNumber) {
        calcEquals();
    }
    calcState.previous = calcState.current;
    calcState.operator = op;
    calcState.newNumber = true;
}

function calcEquals() {
    const display = document.getElementById('calcDisplay');
    if (!display || !calcState.operator) return;

    const prev = parseFloat(calcState.previous);
    const curr = parseFloat(calcState.current);
    let result;

    switch (calcState.operator) {
        case '+': result = prev + curr; break;
        case '-': result = prev - curr; break;
        case '*': result = prev * curr; break;
        case '/': result = curr !== 0 ? prev / curr : 'Error'; break;
        default: return;
    }

    calcState.current = typeof result === 'number' ? String(Math.round(result * 1e10) / 1e10) : result;
    calcState.operator = '';
    calcState.newNumber = true;
    display.value = calcState.current;
}

function calcClear() {
    calcInit();
}

function calcBackspace() {
    const display = document.getElementById('calcDisplay');
    if (!display) return;

    if (calcState.current.length > 1) {
        calcState.current = calcState.current.slice(0, -1);
    } else {
        calcState.current = '0';
        calcState.newNumber = true;
    }
    display.value = calcState.current;
}

function calculateGrowth() {
    const initialEl = document.getElementById('growthInitial');
    const monthlyEl = document.getElementById('growthMonthly');
    const rateEl = document.getElementById('growthRate');
    const yearsEl = document.getElementById('growthYears');
    const resultsEl = document.getElementById('growthResults');
    const compoundEl = document.querySelector('input[name="growthCompound"]:checked');
    if (!initialEl || !monthlyEl || !rateEl || !yearsEl || !resultsEl) return;

    const initial = parseFloat(initialEl.value) || 0;
    const monthly = parseFloat(monthlyEl.value) || 0;
    const rate = (parseFloat(rateEl.value) || 0) / 100;
    const years = parseInt(yearsEl.value) || 0;
    const isMonthly = !compoundEl || compoundEl.value === 'monthly';

    const months = years * 12;
    const totalContrib = initial + (monthly * months);

    let fv = initial;
    if (isMonthly) {
        // Monthly compounding
        const monthlyRate = rate / 12;
        for (let i = 0; i < months; i++) {
            fv = fv * (1 + monthlyRate) + monthly;
        }
    } else {
        // Annual compounding
        for (let i = 0; i < years; i++) {
            fv = fv * (1 + rate) + (monthly * 12);
        }
    }
    const growth = fv - totalContrib;

    // Calculate timeline milestones
    const milestones = [5, 10, 15, 20, 25, 30, 35, 40].filter(y => y <= years);
    let timeline = '';
    for (const y of milestones) {
        let val = initial;
        if (isMonthly) {
            const monthlyRate = rate / 12;
            for (let i = 0; i < y * 12; i++) val = val * (1 + monthlyRate) + monthly;
        } else {
            for (let i = 0; i < y; i++) val = val * (1 + rate) + (monthly * 12);
        }
        timeline += `<div class="calc-row"><span>${y} years</span><span class="calc-card-value positive">$${val.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</span></div>`;
    }

    resultsEl.innerHTML = `
        <div class="calc-grid">
            <div class="calc-card">
                <div class="calc-card-label">Future Value</div>
                <div class="calc-card-value large positive">$${fv.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Total Contributions</div>
                <div class="calc-card-value large">$${totalContrib.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Investment Growth</div>
                <div class="calc-card-value large positive">$${growth.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</div>
            </div>
            <div class="calc-card">
                <div class="calc-card-label">Growth Multiple</div>
                <div class="calc-card-value large">${totalContrib > 0 ? (fv / totalContrib).toFixed(1) : '0.0'}x</div>
            </div>
        </div>
        ${timeline ? `<div class="calc-section-title">GROWTH TIMELINE</div>${timeline}` : ''}
    `;
}

// Calendar Widget
const CALENDAR_COLORS = [
    '#3498db', '#e74c3c', '#27ae60', '#9b59b6',
    '#f39c12', '#1abc9c', '#e67e22', '#34495e'
];

const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const DAY_NAMES = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

function calendarGetToolId(widget) {
    const tool = widget.closest('.tool');
    return tool ? tool.dataset.tool: null;
}

function calendarGetData(toolId) {
    const customizations = loadToolCustomizations();
    const custom = customizations[toolId] || {};
    const data = custom.calendarData || { calendars: [], events: [] };
    return data;
}

function calendarSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].calendarData = data;
    saveToolCustomizations(customizations);
}

function calendarInit() {
    document.querySelectorAll('.calendar-widget').forEach(widget => {
        const toolId = calendarGetToolId(widget);
        if (!toolId) return;

        const data = calendarGetData(toolId);
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    });
}

function calendarRender(widget, toolId, year) {
    const data = calendarGetData(toolId);
    const grid = widget.querySelector('.calendar-year-grid');
    const legend = widget.querySelector('.calendar-legend');
    const yearDisplay = widget.querySelector('.calendar-year-display');

    if (yearDisplay) yearDisplay.textContent = year;

    // Render 12 months in year grid
    let html = '';
    for (let month = 0; month < 12; month++) {
        html += calendarRenderMonth(year, month, data);
    }
    grid.innerHTML = html;

    // Also update month view if it exists and has data
    const monthView = widget.querySelector('.calendar-month-view');
    if (monthView && widget.dataset.viewMonth !== undefined) {
        calendarRenderMonthView(widget, toolId);
    }

    // Render legend with event counts
    const counts = calendarCountByType(data, year);
    let legendHtml = '';
    data.calendars.forEach(cal => {
        const count = counts[cal.id] || 0;
        legendHtml += `<div class="calendar-legend-item">
            <span class="calendar-legend-dot" style="background:${cal.color}"></span>
            <span>${cal.name}</span>
            <span class="calendar-legend-count">${count}</span>
        </div>`;
    });
    legend.innerHTML = legendHtml;
}

function calendarRenderMonth(year, month, data) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDow = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
    const todayDate = today.getDate();

    let html = `<div class="calendar-month">
        <div class="calendar-month-name" onclick="calendarGoToMonth(this, ${year}, ${month})" style="cursor:pointer" title="Click for month view">${MONTH_NAMES[month]}</div>
        <div class="calendar-month-grid">`;

    // Day of week headers
    DAY_NAMES.forEach(d => {
        html += `<div class="calendar-dow">${d}</div>`;
    });

    // Empty cells before first day
    for (let i = 0; i < startDow; i++) {
        html += `<div class="calendar-day other-month"></div>`;
    }

    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = calendarGetEventsForDate(data, dateStr);
        const isToday = isCurrentMonth && day === todayDate;

        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (dayEvents.length > 0) classes += ' has-events';

        html += `<div class="${classes}" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            ${day}`;

        if (dayEvents.length > 0) {
            html += `<div class="calendar-event-dots">`;
            // Show up to 3 dots
            const uniqueCals = [...new Set(dayEvents.map(e => e.calendarId))];
            uniqueCals.slice(0, 3).forEach(calId => {
                const cal = data.calendars.find(c => c.id === calId);
                if (cal) {
                    html += `<span class="calendar-event-dot" style="background:${cal.color}"></span>`;
                }
            });
            html += `</div>`;
        }

        html += `</div>`;
    }

    html += `</div></div>`;
    return html;
}

function calendarGetEventsForDate(data, dateStr) {
    return data.events.filter(event => {
        // Check if date falls within event range or matches single day
        const startDate = event.startDate.split('T')[0];
        const endDate = event.endDate ? event.endDate.split('T')[0] : startDate;
        return dateStr >= startDate && dateStr <= endDate;
    });
}

function calendarCountByType(data, year) {
    const counts = {};
    data.calendars.forEach(cal => counts[cal.id] = 0);

    const yearStart = new Date(year, 0, 1);
    const yearEnd = new Date(year, 11, 31);

    data.events.forEach(event => {
        if (!counts.hasOwnProperty(event.calendarId)) return;

        const startDate = new Date(event.startDate.split('T')[0]);
        const endDate = new Date((event.endDate || event.startDate).split('T')[0]);

        // Clamp to year boundaries
        const countStart = startDate < yearStart ? yearStart : startDate;
        const countEnd = endDate > yearEnd ? yearEnd : endDate;

        if (countStart <= countEnd) {
            // Count number of days
            const days = Math.round((countEnd - countStart) / (1000 * 60 * 60 * 24)) + 1;
            counts[event.calendarId] += days;
        }
    });

    return counts;
}

function calendarCountTotal(data) {
    const counts = {};
    data.calendars.forEach(cal => counts[cal.id] = 0);

    data.events.forEach(event => {
        if (!counts.hasOwnProperty(event.calendarId)) return;

        const startDate = new Date(event.startDate.split('T')[0]);
        const endDate = new Date((event.endDate || event.startDate).split('T')[0]);

        // Count number of days
        const days = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        counts[event.calendarId] += days;
    });

    return counts;
}

function calendarPrevYear(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const yearDisplay = widget.querySelector('.calendar-year-display');
    const year = parseInt(yearDisplay.textContent) - 1;
    calendarRender(widget, toolId, year);
}

function calendarNextYear(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const yearDisplay = widget.querySelector('.calendar-year-display');
    const year = parseInt(yearDisplay.textContent) + 1;
    calendarRender(widget, toolId, year);
}

function calendarSetView(btn, view) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);

    // Update toggle buttons
    widget.querySelectorAll('.calendar-view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const yearGrid = widget.querySelector('.calendar-year-grid');
    const monthView = widget.querySelector('.calendar-month-view');
    const yearNav = widget.querySelector('.calendar-year-nav');

    if (view === 'month') {
        yearGrid.classList.add('hidden');
        monthView.classList.add('active');
        yearNav.style.display = 'none';

        // Initialize month view with current month if not set
        if (!widget.dataset.viewMonth) {
            const now = new Date();
            widget.dataset.viewMonth = now.getMonth();
            widget.dataset.viewYear = now.getFullYear();
        }
        calendarRenderMonthView(widget, toolId);
    } else {
        yearGrid.classList.remove('hidden');
        monthView.classList.remove('active');
        yearNav.style.display = 'flex';
    }
}

function calendarPrevMonth(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    let month = parseInt(widget.dataset.viewMonth);
    let year = parseInt(widget.dataset.viewYear);

    month--;
    if (month < 0) {
        month = 11;
        year--;
    }

    widget.dataset.viewMonth = month;
    widget.dataset.viewYear = year;
    calendarRenderMonthView(widget, toolId);
}

function calendarNextMonth(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    let month = parseInt(widget.dataset.viewMonth);
    let year = parseInt(widget.dataset.viewYear);

    month++;
    if (month > 11) {
        month = 0;
        year++;
    }

    widget.dataset.viewMonth = month;
    widget.dataset.viewYear = year;
    calendarRenderMonthView(widget, toolId);
}

function calendarGoToMonth(el, year, month) {
    const widget = el.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);

    // Set the month/year
    widget.dataset.viewMonth = month;
    widget.dataset.viewYear = year;

    // Switch to month view
    const monthBtn = widget.querySelector('.calendar-view-btn:last-child');
    calendarSetView(monthBtn, 'month');
}

function calendarGoToToday(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const now = new Date();

    widget.dataset.viewMonth = now.getMonth();
    widget.dataset.viewYear = now.getFullYear();
    calendarRenderMonthView(widget, toolId);
}

function calendarRenderMonthView(widget, toolId) {
    const data = calendarGetData(toolId);
    const month = parseInt(widget.dataset.viewMonth);
    const year = parseInt(widget.dataset.viewYear);

    const monthTitle = widget.querySelector('.calendar-month-title');
    const monthDetail = widget.querySelector('.calendar-month-detail');

    monthTitle.textContent = `${MONTH_NAMES[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDow = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
    const todayDate = today.getDate();

    let html = '';

    // Day of week headers
    DAY_NAMES.forEach(d => {
        html += `<div class="calendar-dow">${d}</div>`;
    });

    // Days from previous month
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startDow - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const prevMonth = month === 0 ? 11 : month - 1;
        const prevYear = month === 0 ? year - 1 : year;
        const dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        html += `<div class="calendar-day-cell other-month" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            <div class="calendar-day-number">${day}</div>
        </div>`;
    }

    // Days of current month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = calendarGetEventsForDate(data, dateStr);
        const isToday = isCurrentMonth && day === todayDate;

        let classes = 'calendar-day-cell';
        if (isToday) classes += ' today';

        html += `<div class="${classes}" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            <div class="calendar-day-number">${day}</div>
            <div class="calendar-day-events">`;

        // Show up to 3 events
        dayEvents.slice(0, 3).forEach(event => {
            const cal = data.calendars.find(c => c.id === event.calendarId);
            const color = cal ? cal.color : '#999';
            html += `<div class="calendar-day-event" style="background:${color}" title="${event.summary}">${event.summary}</div>`;
        });

        if (dayEvents.length > 3) {
            html += `<div class="calendar-day-more">+${dayEvents.length - 3} more</div>`;
        }

        html += `</div></div>`;
    }

    // Days from next month to fill the grid
    const totalCells = startDow + daysInMonth;
    const remainingCells = (7 - (totalCells % 7)) % 7;
    for (let day = 1; day <= remainingCells; day++) {
        const nextMonth = month === 11 ? 0 : month + 1;
        const nextYear = month === 11 ? year + 1 : year;
        const dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        html += `<div class="calendar-day-cell other-month" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            <div class="calendar-day-number">${day}</div>
        </div>`;
    }

    monthDetail.innerHTML = html;
}

function calendarShowDayEvents(dayEl, dateStr) {
    // Remove existing tooltip
    document.querySelectorAll('.calendar-day-tooltip').forEach(t => t.remove());

    const widget = dayEl.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const data = calendarGetData(toolId);
    const events = calendarGetEventsForDate(data, dateStr);

    const date = new Date(dateStr + 'T00:00:00');
    const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

    let html = `<div class="calendar-day-tooltip" data-tool-id="${toolId}" data-date="${dateStr}">
        <div class="calendar-day-tooltip-date">${dateFormatted}</div>`;

    events.forEach(event => {
        const cal = data.calendars.find(c => c.id === event.calendarId);
        const color = cal ? cal.color : '#999';
        html += `<div class="calendar-day-tooltip-event">
            <span class="calendar-day-tooltip-dot" style="background:${color}"></span>
            <span class="calendar-day-tooltip-text">${event.summary}</span>
            <button class="calendar-event-delete" onclick="calendarDeleteEvent('${event.uid}')" title="Delete event">&times;</button>
        </div>`;
    });

    // Add event form
    if (data.calendars.length > 0) {
        const calendarOptions = data.calendars.map(cal =>
            `<option value="${cal.id}">${cal.name}</option>`
        ).join('');
        html += `<div class="calendar-day-add-form">
            <input type="text" class="calendar-day-add-input" placeholder="New event..." id="calendarDayEventTitle">
            <select class="calendar-day-add-select" id="calendarDayEventCalendar">${calendarOptions}</select>
            <button class="calendar-day-add-btn" onclick="calendarAddEventFromDay(this)">+</button>
        </div>`;
    } else {
        html += `<div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Add a calendar first to create events</div>`;
    }

    html += `</div>`;

    const tooltip = document.createElement('div');
    tooltip.innerHTML = html;
    const tooltipEl = tooltip.firstChild;
    document.body.appendChild(tooltipEl);

    // Position tooltip
    const rect = dayEl.getBoundingClientRect();
    let left = rect.left + window.scrollX;
    let top = rect.bottom + window.scrollY + 5;

    // Adjust if tooltip would go off-screen
    tooltipEl.style.left = left + 'px';
    tooltipEl.style.top = top + 'px';

    // Focus the input and add Enter key support
    setTimeout(() => {
        const input = tooltipEl.querySelector('.calendar-day-add-input');
        if (input) {
            input.focus();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const btn = tooltipEl.querySelector('.calendar-day-add-btn');
                    if (btn) btn.click();
                }
            });
        }
    }, 0);

    // Close on click outside
    const closeHandler = (e) => {
        if (!tooltipEl.contains(e.target) && e.target !== dayEl) {
            tooltipEl.remove();
            document.removeEventListener('click', closeHandler);
        }
    };
    setTimeout(() => document.addEventListener('click', closeHandler), 0);
}

function calendarOpenManage(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const data = calendarGetData(toolId);

    // Create modal if it doesn't exist
    let modal = document.getElementById('calendarManageModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'calendarManageModal';
        modal.className = 'calendar-manage-modal';
        modal.innerHTML = `
            <div class="calendar-manage-content">
                <span class="calendar-manage-close" onclick="calendarCloseManage()">&times;</span>
                <h3>Manage Calendars</h3>
                <div class="calendar-list" id="calendarManageList"></div>
                <div class="calendar-add-form">
                    <h4>Add New Calendar</h4>
                    <div class="calendar-add-row">
                        <input type="text" class="calendar-add-name" id="calendarAddName" placeholder="Calendar name...">
                    </div>
                    <div class="calendar-color-picker" id="calendarColorPicker"></div>
                    <button class="calendar-add-btn" onclick="calendarAddCalendar()">Add Calendar</button>
                </div>
                <div class="calendar-import-section">
                    <h4>Add Event</h4>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">Title:</label>
                        <input type="text" class="calendar-add-name" id="calendarEventTitle" placeholder="Event title..." style="flex:1;">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">Start:</label>
                        <input type="date" class="calendar-add-name" id="calendarEventStart" style="flex:1;">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">End:</label>
                        <input type="date" class="calendar-add-name" id="calendarEventEnd" style="flex:1;">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">Calendar:</label>
                        <select class="calendar-import-select" id="calendarEventCalendar" style="flex:1;"></select>
                    </div>
                    <button class="calendar-add-btn" onclick="calendarAddEvent()">Add Event</button>
                </div>
                <div class="calendar-import-section">
                    <h4>Import .ics</h4>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">From file:</label>
                        <input type="file" class="calendar-import-file" id="calendarImportFile" accept=".ics">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">From URL:</label>
                        <input type="text" class="calendar-add-name" id="calendarImportUrl" placeholder="https://example.com/calendar.ics" style="flex:1;">
                        <button class="calendar-add-btn" onclick="calendarImportFromUrl()" style="padding:6px 10px;">Fetch</button>
                    </div>
                    <div class="calendar-import-row">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">To calendar:</label>
                        <select class="calendar-import-select" id="calendarImportSelect"></select>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // File import handler
        document.getElementById('calendarImportFile').addEventListener('change', calendarHandleFileImport);
    }

    modal.dataset.toolId = toolId;
    modal.classList.add('open');

    // Render color picker
    const colorPicker = document.getElementById('calendarColorPicker');
    colorPicker.innerHTML = CALENDAR_COLORS.map((color, i) =>
        `<div class="calendar-color-option${i === 0 ? ' selected' : ''}"
             style="background:${color}"
             data-color="${color}"
             onclick="calendarSelectColor(this)"></div>`
    ).join('');

    // Render calendar list
    calendarRenderManageList(data);
}

function calendarCloseManage() {
    const modal = document.getElementById('calendarManageModal');
    if (modal) modal.classList.remove('open');
}

function calendarSelectColor(el) {
    document.querySelectorAll('.calendar-color-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
}

function calendarRenderManageList(data) {
    const list = document.getElementById('calendarManageList');
    const importSelect = document.getElementById('calendarImportSelect');
    const eventSelect = document.getElementById('calendarEventCalendar');

    if (data.calendars.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);font-size:12px;">No calendars yet. Add one below.</p>';
        const emptyOption = '<option value="">Add a calendar first</option>';
        importSelect.innerHTML = emptyOption;
        eventSelect.innerHTML = emptyOption;
        importSelect.disabled = true;
        eventSelect.disabled = true;
    } else {
        const counts = calendarCountTotal(data);

        list.innerHTML = data.calendars.map(cal => `
            <div class="calendar-list-item">
                <span class="calendar-list-color" style="background:${cal.color}"></span>
                <span class="calendar-list-name">${cal.name}</span>
                <span class="calendar-list-count">${counts[cal.id] || 0} days</span>
                <button class="calendar-list-remove" onclick="calendarRemoveCalendar('${cal.id}')">&times;</button>
            </div>
        `).join('');

        const calendarOptions = data.calendars.map(cal =>
            `<option value="${cal.id}">${cal.name}</option>`
        ).join('');
        importSelect.innerHTML = calendarOptions;
        eventSelect.innerHTML = calendarOptions;
        importSelect.disabled = false;
        eventSelect.disabled = false;
    }
}

function calendarAddCalendar() {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;
    const nameInput = document.getElementById('calendarAddName');
    const colorEl = document.querySelector('.calendar-color-option.selected');

    const name = nameInput.value.trim();
    if (!name) {
        nameInput.focus();
        return;
    }

    const color = colorEl ? colorEl.dataset.color : CALENDAR_COLORS[0];
    const data = calendarGetData(toolId);

    const newCal = {
        id: 'cal_' + Date.now(),
        name: name,
        color: color
    };

    data.calendars.push(newCal);
    calendarSaveData(toolId, data);

    nameInput.value = '';
    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarAddEvent() {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;

    const titleInput = document.getElementById('calendarEventTitle');
    const startInput = document.getElementById('calendarEventStart');
    const endInput = document.getElementById('calendarEventEnd');
    const calendarSelect = document.getElementById('calendarEventCalendar');

    const title = titleInput.value.trim();
    const startDate = startInput.value;
    const endDate = endInput.value || startDate;
    const calendarId = calendarSelect.value;

    if (!title) {
        titleInput.focus();
        return;
    }

    if (!startDate) {
        startInput.focus();
        return;
    }

    if (!calendarId) {
        alert('Please create a calendar first.');
        return;
    }

    const data = calendarGetData(toolId);

    const newEvent = {
        uid: 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        calendarId: calendarId,
        summary: title,
        startDate: startDate,
        endDate: endDate
    };

    data.events.push(newEvent);
    calendarSaveData(toolId, data);

    // Clear inputs
    titleInput.value = '';
    startInput.value = '';
    endInput.value = '';

    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarAddEventFromDay(btn) {
    const tooltip = btn.closest('.calendar-day-tooltip');
    const toolId = tooltip.dataset.toolId;
    const dateStr = tooltip.dataset.date;

    const titleInput = tooltip.querySelector('.calendar-day-add-input');
    const calendarSelect = tooltip.querySelector('.calendar-day-add-select');

    const title = titleInput.value.trim();
    const calendarId = calendarSelect.value;

    if (!title) {
        titleInput.focus();
        return;
    }

    const data = calendarGetData(toolId);

    const newEvent = {
        uid: 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        calendarId: calendarId,
        summary: title,
        startDate: dateStr,
        endDate: dateStr
    };

    data.events.push(newEvent);
    calendarSaveData(toolId, data);

    // Close tooltip
    tooltip.remove();

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarDeleteEvent(eventUid) {
    const tooltip = document.querySelector('.calendar-day-tooltip');
    if (!tooltip) return;

    const toolId = tooltip.dataset.toolId;
    const dateStr = tooltip.dataset.date;
    const data = calendarGetData(toolId);

    data.events = data.events.filter(e => e.uid !== eventUid);
    calendarSaveData(toolId, data);

    // Close tooltip
    tooltip.remove();

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarRemoveCalendar(calId) {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;
    const data = calendarGetData(toolId);

    data.calendars = data.calendars.filter(c => c.id !== calId);
    data.events = data.events.filter(e => e.calendarId !== calId);
    calendarSaveData(toolId, data);

    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarHandleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
        const content = evt.target.result;
        calendarImportICS(content);
    };
    reader.readAsText(file);

    // Clear the input
    e.target.value = '';
}

async function calendarImportFromUrl() {
    const urlInput = document.getElementById('calendarImportUrl');
    const url = urlInput.value.trim();

    if (!url) {
        urlInput.focus();
        return;
    }

    // Validate URL
    try {
        new URL(url);
    } catch {
        alert('Please enter a valid URL.');
        return;
    }

    const select = document.getElementById('calendarImportSelect');
    if (!select.value) {
        alert('Please create a calendar first before importing events.');
        return;
    }

    // Show loading state
    const fetchBtn = document.querySelector('.calendar-import-section .calendar-add-btn');
    const originalText = fetchBtn.textContent;
    fetchBtn.textContent = 'Fetching...';
    fetchBtn.disabled = true;

    try {
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const content = await response.text();

        if (!content.includes('BEGIN:VCALENDAR')) {
            throw new Error('The URL does not appear to contain valid ICS data.');
        }

        calendarImportICS(content);
        urlInput.value = '';
    } catch (error) {
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            alert('Could not fetch the URL. This may be due to CORS restrictions. Try downloading the .ics file and importing it manually.');
        } else {
            alert('Error fetching calendar: ' + error.message);
        }
    } finally {
        fetchBtn.textContent = originalText;
        fetchBtn.disabled = false;
    }
}

function calendarImportICS(content) {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;
    const select = document.getElementById('calendarImportSelect');
    const calendarId = select.value;

    if (!calendarId) {
        alert('Please create a calendar first before importing events.');
        return;
    }

    const events = parseICSContent(content, calendarId);

    if (events.length === 0) {
        alert('No events found in the ICS file.');
        return;
    }

    const data = calendarGetData(toolId);

    // Add events (avoiding duplicates by UID)
    const existingUids = new Set(data.events.map(e => e.uid));
    let added = 0;

    events.forEach(event => {
        if (!existingUids.has(event.uid)) {
            data.events.push(event);
            existingUids.add(event.uid);
            added++;
        }
    });

    calendarSaveData(toolId, data);
    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }

    alert(`Imported ${added} event(s).`);
}

function parseICSContent(text, calendarId) {
    const events = [];
    const lines = text.replace(/\r\n /g, '').replace(/\r/g, '\n').split('\n');

    let inEvent = false;
    let currentEvent = {};

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (line === 'BEGIN:VEVENT') {
            inEvent = true;
            currentEvent = { calendarId };
        } else if (line === 'END:VEVENT') {
            if (currentEvent.startDate && currentEvent.summary) {
                if (!currentEvent.uid) {
                    currentEvent.uid = 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                if (!currentEvent.endDate) {
                    currentEvent.endDate = currentEvent.startDate;
                }
                events.push(currentEvent);
            }
            inEvent = false;
            currentEvent = {};
        } else if (inEvent) {
            const colonIndex = line.indexOf(':');
            if (colonIndex === -1) continue;

            let key = line.substring(0, colonIndex);
            const value = line.substring(colonIndex + 1);

            // Handle parameters in key (e.g., DTSTART;VALUE=DATE:20240101)
            const semiIndex = key.indexOf(';');
            if (semiIndex !== -1) {
                key = key.substring(0, semiIndex);
            }

            switch (key) {
                case 'UID':
                    currentEvent.uid = value;
                    break;
                case 'SUMMARY':
                    currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, '\n');
                    break;
                case 'DTSTART':
                    currentEvent.startDate = parseICSDate(value);
                    break;
                case 'DTEND':
                    // ICS end dates are exclusive for all-day events
                    // If date-only (length 8), subtract one day
                    const cleanedEnd = value.replace('Z', '');
                    if (cleanedEnd.length === 8) {
                        const d = new Date(
                            parseInt(cleanedEnd.substring(0, 4)),
                            parseInt(cleanedEnd.substring(4, 6)) - 1,
                            parseInt(cleanedEnd.substring(6, 8))
                        );
                        d.setDate(d.getDate() - 1);
                        currentEvent.endDate = d.toISOString().split('T')[0];
                    } else {
                        currentEvent.endDate = parseICSDate(value);
                    }
                    break;
                case 'RRULE':
                    // Basic recurring event support - expand first year of occurrences
                    currentEvent.rrule = value;
                    break;
            }
        }
    }

    // Expand recurring events for current year
    const expandedEvents = [];
    events.forEach(event => {
        if (event.rrule) {
            const expanded = expandRRULE(event);
            expandedEvents.push(...expanded);
        } else {
            expandedEvents.push(event);
        }
    });

    return expandedEvents;
}

function parseICSDate(value) {
    // Handle formats: 20240115, 20240115T103000, 20240115T103000Z
    const cleaned = value.replace('Z', '');

    if (cleaned.length === 8) {
        // Date only: YYYYMMDD
        return `${cleaned.substring(0, 4)}-${cleaned.substring(4, 6)}-${cleaned.substring(6, 8)}`;
    } else if (cleaned.length >= 15) {
        // DateTime: YYYYMMDDTHHMMSS
        return `${cleaned.substring(0, 4)}-${cleaned.substring(4, 6)}-${cleaned.substring(6, 8)}T${cleaned.substring(9, 11)}:${cleaned.substring(11, 13)}:${cleaned.substring(13, 15)}`;
    }

    return value;
}

function expandRRULE(event) {
    const events = [event];
    const rrule = event.rrule;

    // Parse RRULE components
    const parts = {};
    rrule.split(';').forEach(part => {
        const [key, val] = part.split('=');
        parts[key] = val;
    });

    if (!parts.FREQ) return events;

    const startDate = new Date(event.startDate);
    const endDate = event.endDate ? new Date(event.endDate) : new Date(event.startDate);
    const duration = endDate - startDate;

    const count = parts.COUNT ? parseInt(parts.COUNT) : 52; // Default to 1 year of weekly events
    const interval = parts.INTERVAL ? parseInt(parts.INTERVAL) : 1;

    let until = parts.UNTIL ? new Date(parseICSDate(parts.UNTIL)) : null;
    if (!until) {
        until = new Date(startDate);
        until.setFullYear(until.getFullYear() + 1);
    }

    let currentDate = new Date(startDate);
    let occurrences = 1;

    while (occurrences < count && currentDate < until) {
        // Advance to next occurrence
        switch (parts.FREQ) {
            case 'DAILY':
                currentDate.setDate(currentDate.getDate() + interval);
                break;
            case 'WEEKLY':
                currentDate.setDate(currentDate.getDate() + (7 * interval));
                break;
            case 'MONTHLY':
                currentDate.setMonth(currentDate.getMonth() + interval);
                break;
            case 'YEARLY':
                currentDate.setFullYear(currentDate.getFullYear() + interval);
                break;
            default:
                return events;
        }

        if (currentDate > until) break;

        const newEndDate = new Date(currentDate.getTime() + duration);
        events.push({
            ...event,
            uid: event.uid + '_' + occurrences,
            startDate: currentDate.toISOString().split('T')[0],
            endDate: newEndDate.toISOString().split('T')[0],
            rrule: undefined
        });

        occurrences++;
    }

    return events;
}

// ==================== Diff Viewer Functions ====================

function diffGetToolId(element) {
    const tool = element.closest('.tool');
    return tool ? tool.dataset.tool: null;
}

function diffGetData(toolId) {
    const customizations = loadToolCustomizations();
    const custom = customizations[toolId] || {};
    return custom.diffData || {
        original: '',
        modified: '',
        mode: 'edit',
        viewType: 'split',
        hideWhitespace: false
    };
}

function diffSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].diffData = data;
    saveToolCustomizations(customizations);
}

function diffInit() {
    document.querySelectorAll('.diff-widget').forEach(widget => {
        const toolId = diffGetToolId(widget);
        if (!toolId) return;

        const data = diffGetData(toolId);

        // Populate textareas
        const textareas = widget.querySelectorAll('.diff-edit-pane textarea');
        if (textareas[0]) textareas[0].value = data.original;
        if (textareas[1]) textareas[1].value = data.modified;

        // Set mode
        const modeButtons = widget.querySelectorAll('.diff-mode-btn');
        modeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase() === data.mode);
        });

        // Set view type
        const viewButtons = widget.querySelectorAll('.diff-view-btn');
        viewButtons.forEach(btn => {
            const btnView = btn.textContent.toLowerCase();
            btn.classList.toggle('active', btnView === data.viewType);
        });

        // Set hide whitespace checkbox
        const wsCheckbox = widget.querySelector('.diff-whitespace-toggle input');
        if (wsCheckbox) wsCheckbox.checked = data.hideWhitespace;

        // Show correct container
        const editContainer = widget.querySelector('.diff-edit-container');
        const viewContainer = widget.querySelector('.diff-view-container');
        if (data.mode === 'view') {
            editContainer.classList.add('hidden');
            viewContainer.classList.add('active');
            diffRenderOutput(widget, toolId);
        } else {
            editContainer.classList.remove('hidden');
            viewContainer.classList.remove('active');
        }

        // Update stats
        diffUpdateStats(widget, toolId);
    });
}

function diffOnInput(textarea, field) {
    const toolId = diffGetToolId(textarea);
    if (!toolId) return;

    const data = diffGetData(toolId);
    data[field] = textarea.value;
    diffSaveData(toolId, data);

    const widget = textarea.closest('.diff-widget');
    diffUpdateStats(widget, toolId);
}

function diffSetMode(btn, mode) {
    const widget = btn.closest('.diff-widget');
    const toolId = diffGetToolId(widget);
    if (!toolId) return;

    const data = diffGetData(toolId);
    data.mode = mode;
    diffSaveData(toolId, data);

    // Update button states
    widget.querySelectorAll('.diff-mode-btn').forEach(b => {
        b.classList.toggle('active', b.textContent.toLowerCase() === mode);
    });

    // Toggle containers
    const editContainer = widget.querySelector('.diff-edit-container');
    const viewContainer = widget.querySelector('.diff-view-container');

    if (mode === 'view') {
        editContainer.classList.add('hidden');
        viewContainer.classList.add('active');
        diffRenderOutput(widget, toolId);
    } else {
        editContainer.classList.remove('hidden');
        viewContainer.classList.remove('active');
    }
}

function diffSetView(btn, viewType) {
    const widget = btn.closest('.diff-widget');
    const toolId = diffGetToolId(widget);
    if (!toolId) return;

    const data = diffGetData(toolId);
    data.viewType = viewType;
    diffSaveData(toolId, data);

    // Update button states
    widget.querySelectorAll('.diff-view-btn').forEach(b => {
        const bView = b.textContent.toLowerCase();
        b.classList.toggle('active', bView === viewType);
    });

    // Re-render if in view mode
    if (data.mode === 'view') {
        diffRenderOutput(widget, toolId);
    }
}

function diffToggleWhitespace(checkbox) {
    const widget = checkbox.closest('.diff-widget');
    const toolId = diffGetToolId(widget);
    if (!toolId) return;

    const data = diffGetData(toolId);
    data.hideWhitespace = checkbox.checked;
    diffSaveData(toolId, data);

    // Re-render if in view mode
    if (data.mode === 'view') {
        diffRenderOutput(widget, toolId);
    }

    diffUpdateStats(widget, toolId);
}

function diffSyncScroll(textarea, source) {
    const widget = textarea.closest('.diff-widget');
    const textareas = widget.querySelectorAll('.diff-edit-pane textarea');

    const other = source === 'original' ? textareas[1] : textareas[0];
    if (other && other !== textarea) {
        other.scrollTop = textarea.scrollTop;
        other.scrollLeft = textarea.scrollLeft;
    }
}

// LCS-based diff algorithm
function computeDiff(original, modified, hideWhitespace) {
    let origLines = original.split('\n');
    let modLines = modified.split('\n');

    if (hideWhitespace) {
        // For comparison, normalize whitespace but keep original for display
        const normalize = line => line.replace(/\s+/g, ' ').trim();
        const origNorm = origLines.map(normalize);
        const modNorm = modLines.map(normalize);

        const lcs = buildLCSMatrix(origNorm, modNorm);
        return backtrackDiff(lcs, origNorm, modNorm, origLines, modLines);
    }

    const lcs = buildLCSMatrix(origLines, modLines);
    return backtrackDiff(lcs, origLines, modLines, origLines, modLines);
}

function buildLCSMatrix(a, b) {
    const m = a.length;
    const n = b.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (a[i - 1] === b[j - 1]) {
                dp[i][j] = dp[i - 1][j - 1] + 1;
            } else {
                dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
            }
        }
    }

    return dp;
}

function backtrackDiff(dp, aNorm, bNorm, aOrig, bOrig) {
    const result = [];
    let i = aNorm.length;
    let j = bNorm.length;

    const stack = [];

    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && aNorm[i - 1] === bNorm[j - 1]) {
            stack.push({ type: 'unchanged', origLine: i, modLine: j, origContent: aOrig[i - 1], modContent: bOrig[j - 1] });
            i--;
            j--;
        } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
            stack.push({ type: 'addition', modLine: j, content: bOrig[j - 1] });
            j--;
        } else {
            stack.push({ type: 'deletion', origLine: i, content: aOrig[i - 1] });
            i--;
        }
    }

    // Reverse to get correct order
    while (stack.length) {
        result.push(stack.pop());
    }

    return result;
}

function diffRenderOutput(widget, toolId) {
    const data = diffGetData(toolId);
    const output = widget.querySelector('.diff-output');

    if (!data.original && !data.modified) {
        output.innerHTML = '<div class="diff-empty-message">Enter text in both panes to see the diff</div>';
        return;
    }

    const diff = computeDiff(data.original, data.modified, data.hideWhitespace);

    if (data.viewType === 'split') {
        output.innerHTML = renderSplitView(diff);
    } else {
        output.innerHTML = renderUnifiedView(diff);
    }
}

function renderSplitView(diff) {
    let leftLines = '';
    let rightLines = '';

    diff.forEach(item => {
        if (item.type === 'unchanged') {
            leftLines += renderDiffLine(item.origLine, item.origContent, 'unchanged');
            rightLines += renderDiffLine(item.modLine, item.modContent, 'unchanged');
        } else if (item.type === 'deletion') {
            leftLines += renderDiffLine(item.origLine, item.content, 'deletion');
            rightLines += renderDiffLine('', '', 'empty');
        } else if (item.type === 'addition') {
            leftLines += renderDiffLine('', '', 'empty');
            rightLines += renderDiffLine(item.modLine, item.content, 'addition');
        }
    });

    return `
        <div class="diff-split-view">
            <div class="diff-split-pane">
                <div class="diff-split-header">Original</div>
                ${leftLines}
            </div>
            <div class="diff-split-pane">
                <div class="diff-split-header">Modified</div>
                ${rightLines}
            </div>
        </div>
    `;
}

function renderUnifiedView(diff) {
    let lines = '';

    diff.forEach(item => {
        if (item.type === 'unchanged') {
            lines += renderUnifiedLine(item.origLine, item.modLine, item.origContent, 'unchanged', ' ');
        } else if (item.type === 'deletion') {
            lines += renderUnifiedLine(item.origLine, '', item.content, 'deletion', '-');
        } else if (item.type === 'addition') {
            lines += renderUnifiedLine('', item.modLine, item.content, 'addition', '+');
        }
    });

    return `<div class="diff-unified-view">${lines}</div>`;
}

function renderDiffLine(lineNum, content, type) {
    const escapedContent = escapeHtml(content || '');
    const displayContent = escapedContent || '&nbsp;';
    return `
        <div class="diff-line ${type}">
            <div class="diff-gutter">${lineNum || ''}</div>
            <div class="diff-content">${displayContent}</div>
        </div>
    `;
}

function renderUnifiedLine(origLine, modLine, content, type, prefix) {
    const escapedContent = escapeHtml(content || '');
    const lineInfo = origLine && modLine ? `${origLine}/${modLine}` : (origLine || modLine || '');
    return `
        <div class="diff-line ${type}">
            <div class="diff-gutter">${lineInfo}</div>
            <div class="diff-prefix">${prefix}</div>
            <div class="diff-content">${escapedContent || '&nbsp;'}</div>
        </div>
    `;
}

function diffUpdateStats(widget, toolId) {
    const data = diffGetData(toolId);
    const statsEl = widget.querySelector('.diff-stats');

    if (!data.original && !data.modified) {
        statsEl.innerHTML = '';
        return;
    }

    const diff = computeDiff(data.original, data.modified, data.hideWhitespace);

    let additions = 0;
    let deletions = 0;

    diff.forEach(item => {
        if (item.type === 'addition') additions++;
        if (item.type === 'deletion') deletions++;
    });

    statsEl.innerHTML = `
        <span class="diff-stats-additions">+${additions} addition${additions !== 1 ? 's' : ''}</span>
        <span class="diff-stats-deletions">-${deletions} deletion${deletions !== 1 ? 's' : ''}</span>
    `;
}

// ==================== Sequence Diagram Functions ====================

function seqGetToolId(element) {
    const tool = element.closest('.tool');
    return tool ? tool.dataset.tool: null;
}

function seqGetData(toolId) {
    const customizations = loadToolCustomizations();
    const custom = customizations[toolId] || {};
    return custom.seqData || {
        text: '',
        mode: 'split'
    };
}

function seqSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].seqData = data;
    saveToolCustomizations(customizations);
}

function seqInit() {
    document.querySelectorAll('.seq-widget').forEach(widget => {
        const toolId = seqGetToolId(widget);
        if (!toolId) return;

        const data = seqGetData(toolId);

        // Populate all textareas
        widget.querySelectorAll('textarea').forEach(ta => {
            ta.value = data.text;
        });

        // Set mode buttons
        const modeButtons = widget.querySelectorAll('.seq-mode-btn');
        modeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase() === data.mode);
        });

        // Show correct container
        seqUpdateContainers(widget, data.mode, toolId);
    });
}

function seqUpdateContainers(widget, mode, toolId) {
    const editContainer = widget.querySelector('.seq-edit-container');
    const splitContainer = widget.querySelector('.seq-split-container');
    const viewContainer = widget.querySelector('.seq-view-container');

    // Hide all first
    editContainer.classList.remove('active');
    splitContainer.classList.remove('active');
    viewContainer.classList.remove('active');

    if (mode === 'edit') {
        editContainer.classList.add('active');
    } else if (mode === 'split') {
        splitContainer.classList.add('active');
        seqRenderDiagram(widget, toolId, '.seq-split-container .seq-diagram');
    } else if (mode === 'view') {
        viewContainer.classList.add('active');
        seqRenderDiagram(widget, toolId, '.seq-view-container .seq-diagram');
    }
}

function seqOnInput(textarea) {
    const widget = textarea.closest('.seq-widget');
    const toolId = seqGetToolId(textarea);
    if (!toolId) return;

    const data = seqGetData(toolId);
    data.text = textarea.value;
    seqSaveData(toolId, data);

    // Sync all textareas in the widget
    widget.querySelectorAll('textarea').forEach(ta => {
        if (ta !== textarea) ta.value = textarea.value;
    });

    // Live render if in split mode
    if (data.mode === 'split') {
        seqRenderDiagram(widget, toolId, '.seq-split-container .seq-diagram');
    }
}

function seqSetMode(btn, mode) {
    const widget = btn.closest('.seq-widget');
    const toolId = seqGetToolId(widget);
    if (!toolId) return;

    const data = seqGetData(toolId);
    data.mode = mode;
    seqSaveData(toolId, data);

    // Update button states
    widget.querySelectorAll('.seq-mode-btn').forEach(b => {
        b.classList.toggle('active', b.textContent.toLowerCase() === mode);
    });

    // Sync textarea content before switching
    const currentText = data.text;
    widget.querySelectorAll('textarea').forEach(ta => {
        ta.value = currentText;
    });

    // Update containers
    seqUpdateContainers(widget, mode, toolId);
}

function seqShowHelp(btn) {
    // Create modal if it doesn't exist
    let modal = document.querySelector('.seq-help-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'seq-help-modal';
        modal.innerHTML = `
            <div class="seq-help-content">
                <span class="seq-help-close" onclick="this.closest('.seq-help-modal').classList.remove('open')">&times;</span>
                <h3>Sequence Diagram Syntax</h3>
                <p><strong>Messages:</strong></p>
                <pre>Participant1 -> Participant2: Message text</pre>
                <p><code>-></code> Solid arrow (request/call)</p>
                <p><code>--></code> Dashed arrow (response/return)</p>
                <p><strong>Self-messages:</strong></p>
                <pre>Alice -> Alice: Think about it</pre>
                <p><strong>Notes:</strong></p>
                <pre>Note left of Actor: Text
Note right of Actor: Text
Note over Actor: Text
Note over Actor1, Actor2: Text</pre>
                <p><strong>Colors:</strong></p>
                <p>Add <code>[color]</code> at end of line:</p>
                <pre>A -> B: Request [red]
A -> B: Request [line:red, text:blue]
Note over A: Info [#90EE90]
Note over A: Info [bg:pink, text:black]</pre>
                <p>Message options: <code>line</code>, <code>text</code>, <code>number</code></p>
                <p>Note options: <code>bg</code>, <code>text</code>, <code>border</code></p>
                <p><strong>Example:</strong></p>
                <pre>Client -> Server: HTTP Request [green]
Note right of Server: Validate [#ffe0b0]
Server -> Database: Query [blue]
Database --> Server: Results [purple]
Server --> Client: HTTP Response [green]</pre>
                <p>Participants are automatically detected. Each arrow is numbered sequentially.</p>
            </div>
        `;
        document.body.appendChild(modal);

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('open');
        });
    }
    modal.classList.add('open');
}

function seqParseColors(text) {
    // Parse color options from end of text: [color] or [bg:color, line:color, text:color]
    const colorMatch = text.match(/\s*\[([^\]]+)\]\s*$/);
    if (!colorMatch) {
        return { text: text.trim(), colors: {} };
    }

    const cleanText = text.substring(0, text.lastIndexOf('[')).trim();
    const colorStr = colorMatch[1].trim();
    const colors = {};

    // Check if it's a simple color or key:value pairs
    if (colorStr.includes(':')) {
        // Parse key:value pairs like "bg:yellow, line:red, text:black"
        colorStr.split(',').forEach(part => {
            const [key, value] = part.split(':').map(s => s.trim());
            if (key && value) {
                colors[key] = value;
            }
        });
    } else {
        // Simple color - use as primary (line for messages, bg for notes)
        colors.primary = colorStr;
    }

    return { text: cleanText, colors };
}

function seqParseText(text) {
    const lines = text.split('\n').filter(line => line.trim());
    const participants = [];
    const items = []; // Can be messages or notes
    const participantSet = new Set();
    let messageCount = 0;

    lines.forEach((line, index) => {
        // Match note syntax: Note left/right/over Actor: Text
        // or: Note over Actor1, Actor2: Text
        const noteMatch = line.match(/^\s*note\s+(left\s+of|right\s+of|over)\s+([^:]+?)\s*:\s*(.*)$/i);
        if (noteMatch) {
            const position = noteMatch[1].toLowerCase().replace(/\s+/g, '');
            const actorsStr = noteMatch[2].trim();
            const rawNoteText = noteMatch[3].trim();

            // Parse colors from note text
            const { text: noteText, colors } = seqParseColors(rawNoteText);

            // Parse actors (can be comma-separated for "over")
            const actors = actorsStr.split(',').map(a => a.trim()).filter(a => a);

            // Add actors to participants if not already present
            actors.forEach(actor => {
                if (!participantSet.has(actor)) {
                    participantSet.add(actor);
                    participants.push(actor);
                }
            });

            items.push({
                type: 'note',
                position: position, // 'leftof', 'rightof', or 'over'
                actors: actors,
                text: noteText,
                colors: {
                    bg: colors.bg || colors.primary || null,
                    text: colors.text || null,
                    border: colors.border || colors.line || null
                }
            });
            return;
        }

        // Match: Participant1 -> Participant2: Message
        // or: Participant1 --> Participant2: Message
        const match = line.match(/^\s*([^-]+?)\s*(-->|->)\s*([^:]+?)\s*:\s*(.*)$/);
        if (match) {
            const from = match[1].trim();
            const arrowType = match[2];
            const to = match[3].trim();
            const rawMessage = match[4].trim();

            // Parse colors from message
            const { text: message, colors } = seqParseColors(rawMessage);

            // Add participants in order of appearance
            if (!participantSet.has(from)) {
                participantSet.add(from);
                participants.push(from);
            }
            if (!participantSet.has(to)) {
                participantSet.add(to);
                participants.push(to);
            }

            messageCount++;
            items.push({
                type: 'message',
                from,
                to,
                message,
                dashed: arrowType === '-->',
                number: messageCount,
                colors: {
                    line: colors.line || colors.primary || null,
                    text: colors.text || null,
                    number: colors.number || colors.bg || null
                }
            });
        }
    });

    return { participants, items };
}

function seqRenderDiagram(widget, toolId, containerSelector) {
    const data = seqGetData(toolId);
    const container = widget.querySelector(containerSelector || '.seq-diagram');

    if (!container) return;

    if (!data.text.trim()) {
        container.innerHTML = '<div class="seq-error-message">Enter sequence diagram notation to see the diagram</div>';
        return;
    }

    const { participants, items } = seqParseText(data.text);

    if (participants.length === 0) {
        container.innerHTML = '<div class="seq-error-message">No valid entries found. Use syntax: Actor -> Actor: Message</div>';
        return;
    }

    // Calculate dimensions
    const boxWidth = 100;
    const boxHeight = 36;
    const boxPadding = 40;
    const itemSpacing = 50;
    const topMargin = 20;
    const bottomMargin = 50;
    const numberRadius = 10;
    const noteWidth = 120;
    const noteHeight = 30;
    const notePadding = 8;

    const totalWidth = participants.length * (boxWidth + boxPadding) - boxPadding + 40;
    const totalHeight = topMargin + boxHeight + (items.length * itemSpacing) + boxHeight + bottomMargin;

    // Build SVG
    let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${totalWidth} ${totalHeight}" width="${totalWidth}" height="${totalHeight}">`;

    // Calculate participant positions
    const participantX = {};
    participants.forEach((p, i) => {
        participantX[p] = 20 + i * (boxWidth + boxPadding) + boxWidth / 2;
    });

    // Draw lifelines (behind everything)
    participants.forEach(p => {
        const x = participantX[p];
        const y1 = topMargin + boxHeight;
        const y2 = totalHeight - bottomMargin - boxHeight;
        svg += `<line class="seq-lifeline" x1="${x}" y1="${y1}" x2="${x}" y2="${y2}" />`;
    });

    // Draw top participant boxes
    participants.forEach(p => {
        const x = participantX[p] - boxWidth / 2;
        const y = topMargin;
        svg += `<rect class="seq-participant-box" x="${x}" y="${y}" width="${boxWidth}" height="${boxHeight}" rx="4" />`;
        svg += `<text class="seq-participant-text" x="${participantX[p]}" y="${y + boxHeight / 2}">${escapeHtml(p)}</text>`;
    });

    // Draw bottom participant boxes
    participants.forEach(p => {
        const x = participantX[p] - boxWidth / 2;
        const y = totalHeight - bottomMargin - boxHeight;
        svg += `<rect class="seq-participant-box" x="${x}" y="${y}" width="${boxWidth}" height="${boxHeight}" rx="4" />`;
        svg += `<text class="seq-participant-text" x="${participantX[p]}" y="${y + boxHeight / 2}">${escapeHtml(p)}</text>`;
    });

    // Draw items (messages and notes)
    items.forEach((item, i) => {
        const y = topMargin + boxHeight + (i + 1) * itemSpacing - itemSpacing / 2;

        if (item.type === 'note') {
            // Render note with optional colors
            const actor = item.actors[0];
            const actorX = participantX[actor] || 0;
            let noteX, textAnchor;

            // Build style strings for colors
            const noteColors = item.colors || {};
            let boxStyle = '';
            let textStyle = '';
            if (noteColors.bg) boxStyle += `fill:${noteColors.bg};`;
            if (noteColors.border) boxStyle += `stroke:${noteColors.border};`;
            if (noteColors.text) textStyle += `fill:${noteColors.text};`;

            if (item.position === 'leftof') {
                noteX = actorX - boxWidth / 2 - noteWidth - 10;
                textAnchor = 'start';
            } else if (item.position === 'rightof') {
                noteX = actorX + boxWidth / 2 + 10;
                textAnchor = 'start';
            } else if (item.position === 'over') {
                if (item.actors.length > 1) {
                    // Note spanning multiple actors
                    const actor2 = item.actors[1];
                    const actor2X = participantX[actor2] || actorX;
                    const minX = Math.min(actorX, actor2X);
                    const maxX = Math.max(actorX, actor2X);
                    noteX = minX - noteWidth / 2;
                    const spanWidth = maxX - minX + noteWidth;
                    svg += `<rect class="seq-note-box" x="${noteX}" y="${y - noteHeight / 2}" width="${spanWidth}" height="${noteHeight}" rx="2"${boxStyle ? ` style="${boxStyle}"` : ''} />`;
                    svg += `<text class="seq-note-text" x="${(minX + maxX) / 2}" y="${y}" text-anchor="middle" dominant-baseline="middle"${textStyle ? ` style="${textStyle}"` : ''}>${escapeHtml(item.text)}</text>`;
                    return;
                } else {
                    noteX = actorX - noteWidth / 2;
                    textAnchor = 'middle';
                }
            }

            svg += `<rect class="seq-note-box" x="${noteX}" y="${y - noteHeight / 2}" width="${noteWidth}" height="${noteHeight}" rx="2"${boxStyle ? ` style="${boxStyle}"` : ''} />`;
            const textX = item.position === 'over' ? actorX : noteX + notePadding;
            svg += `<text class="seq-note-text" x="${textX}" y="${y}" text-anchor="${textAnchor}" dominant-baseline="middle"${textStyle ? ` style="${textStyle}"` : ''}>${escapeHtml(item.text)}</text>`;

        } else if (item.type === 'message') {
            // Render message with optional colors
            const fromX = participantX[item.from];
            const toX = participantX[item.to];
            const dashedClass = item.dashed ? ' dashed' : '';

            // Build style strings for colors
            const msgColors = item.colors || {};
            let lineStyle = '';
            let headStyle = '';
            let labelStyle = '';
            let numBgStyle = '';
            if (msgColors.line) {
                lineStyle = `stroke:${msgColors.line};`;
                headStyle = `fill:${msgColors.line};`;
            }
            if (msgColors.text) labelStyle = `fill:${msgColors.text};`;
            if (msgColors.number) numBgStyle = `fill:${msgColors.number};`;

            if (item.from === item.to) {
                // Self-message: loop to the right
                const loopWidth = 30;
                const loopHeight = 20;
                svg += `<path class="seq-self-arrow${dashedClass}" d="M ${fromX} ${y}
                        L ${fromX + loopWidth} ${y}
                        L ${fromX + loopWidth} ${y + loopHeight}
                        L ${fromX + 8} ${y + loopHeight}"${lineStyle ? ` style="${lineStyle}"` : ''} />`;
                // Arrow head
                svg += `<polygon class="seq-arrow-head" points="${fromX + 8},${y + loopHeight - 4} ${fromX + 8},${y + loopHeight + 4} ${fromX},${y + loopHeight}"${headStyle ? ` style="${headStyle}"` : ''} />`;
                // Label
                svg += `<text class="seq-arrow-label" x="${fromX + loopWidth + 5}" y="${y + loopHeight / 2}"${labelStyle ? ` style="${labelStyle}"` : ''}>${escapeHtml(item.message)}</text>`;
                // Number
                const numBgClass = item.dashed ? 'seq-dashed-number-bg' : 'seq-arrow-number-bg';
                svg += `<circle class="${numBgClass}" cx="${fromX + loopWidth}" cy="${y}" r="${numberRadius}"${numBgStyle ? ` style="${numBgStyle}"` : ''} />`;
                svg += `<text class="seq-arrow-number" x="${fromX + loopWidth}" y="${y}" text-anchor="middle" dominant-baseline="middle">${item.number}</text>`;
            } else {
                // Regular message
                const direction = toX > fromX ? 1 : -1;
                const arrowLength = 8;

                // Arrow line
                svg += `<line class="seq-arrow${dashedClass}" x1="${fromX}" y1="${y}" x2="${toX - direction * arrowLength}" y2="${y}"${lineStyle ? ` style="${lineStyle}"` : ''} />`;

                // Arrow head
                const headX = toX;
                const headY = y;
                svg += `<polygon class="seq-arrow-head" points="${headX},${headY} ${headX - direction * arrowLength},${headY - 4} ${headX - direction * arrowLength},${headY + 4}"${headStyle ? ` style="${headStyle}"` : ''} />`;

                // Label (centered above arrow)
                const labelX = (fromX + toX) / 2;
                svg += `<text class="seq-arrow-label" x="${labelX}" y="${y - 8}" text-anchor="middle"${labelStyle ? ` style="${labelStyle}"` : ''}>${escapeHtml(item.message)}</text>`;

                // Number badge (at the start of arrow)
                const numX = fromX + direction * 15;
                const numBgClass = item.dashed ? 'seq-dashed-number-bg' : 'seq-arrow-number-bg';
                svg += `<circle class="${numBgClass}" cx="${numX}" cy="${y}" r="${numberRadius}"${numBgStyle ? ` style="${numBgStyle}"` : ''} />`;
                svg += `<text class="seq-arrow-number" x="${numX}" y="${y}" text-anchor="middle" dominant-baseline="middle">${item.number}</text>`;
            }
        }
    });

    svg += '</svg>';
    container.innerHTML = svg;
}

// Markdown Parser using marked.js (GitHub Flavored Markdown)
(function() {
    // Custom renderer to open links in new tabs
    const renderer = new marked.Renderer();
    renderer.link = function(href, title, text) {
        // Handle marked v5+ object format
        if (typeof href === 'object') {
            const token = href;
            href = token.href;
            title = token.title;
            text = token.text;
        }
        const titleAttr = title ? ` title="${title}"` : '';
        return `<a href="${href}" target="_blank" rel="noopener noreferrer"${titleAttr}>${text}</a>`;
    };

    // Configure marked with GFM options
    marked.setOptions({
        renderer: renderer,
        gfm: true,           // GitHub Flavored Markdown
        breaks: true,        // Convert \n to <br>
        pedantic: false,
        smartypants: false
    });
})();

function parseMarkdown(text) {
    if (!text) return '';
    return marked.parse(text);
}

function escapeHtml(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

// JWT Decoder Widget
function jwtGetToolId(element) {
    const widget = element.closest('.jwt-widget');
    return widget?.closest('.tool')?.getAttribute('data-tool');
}

function jwtInit() {
    document.querySelectorAll('.jwt-widget').forEach(widget => {
        const textarea = widget.querySelector('textarea');
        if (textarea && textarea.value) {
            jwtDecode(textarea);
        }
    });
}

function jwtDecode(textarea) {
    const widget = textarea.closest('.jwt-widget');
    const results = widget.querySelector('.jwt-results');
    const token = textarea.value.trim();

    if (!token) {
        results.innerHTML = '<div class="jwt-status info">Paste a JWT token above to decode it</div>';
        return;
    }

    // Split token into parts
    const parts = token.split('.');
    if (parts.length !== 3) {
        results.innerHTML = '<div class="jwt-error">Invalid JWT format. A JWT should have 3 parts separated by dots (header.payload.signature)</div>';
        return;
    }

    try {
        // Decode header
        const header = JSON.parse(jwtBase64Decode(parts[0]));
        // Decode payload
        const payload = JSON.parse(jwtBase64Decode(parts[1]));
        // Signature is the third part (we can't verify it without the secret)
        const signature = parts[2];

        let html = '<div class="jwt-parts">';

        // Header section
        html += `
            <div class="jwt-part">
                <div class="jwt-part-header header">
                    <span>HEADER</span>
                    <button class="jwt-copy-btn" onclick="jwtCopyPart(this, 'header')">Copy</button>
                </div>
                <div class="jwt-part-content">${jwtSyntaxHighlight(JSON.stringify(header, null, 2))}</div>
            </div>
        `;

        // Payload section with claim analysis
        html += `
            <div class="jwt-part">
                <div class="jwt-part-header payload">
                    <span>PAYLOAD</span>
                    <button class="jwt-copy-btn" onclick="jwtCopyPart(this, 'payload')">Copy</button>
                </div>
                <div class="jwt-part-content">${jwtSyntaxHighlight(JSON.stringify(payload, null, 2))}</div>
                ${jwtRenderClaims(payload)}
            </div>
        `;

        // Signature section
        html += `
            <div class="jwt-part">
                <div class="jwt-part-header signature">
                    <span>SIGNATURE</span>
                    <button class="jwt-copy-btn" onclick="jwtCopyPart(this, 'signature')">Copy</button>
                </div>
                <div class="jwt-part-content raw">${signature}</div>
                <div style="padding: 8px 12px; font-size: 11px; color: var(--text-muted);">
                    Algorithm: <strong>${header.alg || 'Unknown'}</strong>
                    ${header.alg ? ` - Signature cannot be verified without the ${header.alg.startsWith('HS') ? 'secret key' : 'public key'}` : ''}
                </div>
            </div>
        `;

        html += '</div>';

        // Store decoded parts for copy function
        widget._decodedHeader = JSON.stringify(header, null, 2);
        widget._decodedPayload = JSON.stringify(payload, null, 2);
        widget._signature = signature;

        results.innerHTML = html;

    } catch (e) {
        results.innerHTML = `<div class="jwt-error">Failed to decode JWT: ${e.message}</div>`;
    }
}

function jwtBase64Decode(str) {
    // Handle URL-safe base64
    let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
    // Add padding if needed
    while (base64.length % 4) {
        base64 += '=';
    }
    return decodeURIComponent(atob(base64).split('').map(c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}

function jwtSyntaxHighlight(json) {
    return json
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
            let cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                    return `<span style="color: #9b59b6">${match}</span>`;
                } else {
                    cls = 'string';
                    return `<span style="color: #27ae60">${match}</span>`;
                }
            } else if (/true|false/.test(match)) {
                return `<span style="color: #e67e22">${match}</span>`;
            } else if (/null/.test(match)) {
                return `<span style="color: #95a5a6">${match}</span>`;
            }
            return `<span style="color: #3498db">${match}</span>`;
        });
}

function jwtRenderClaims(payload) {
    const standardClaims = {
        'iss': 'Issuer',
        'sub': 'Subject',
        'aud': 'Audience',
        'exp': 'Expiration',
        'nbf': 'Not Before',
        'iat': 'Issued At',
        'jti': 'JWT ID'
    };

    const now = Math.floor(Date.now() / 1000);
    let claimsHtml = '<div class="jwt-claims">';

    for (const [key, value] of Object.entries(payload)) {
        let displayValue = value;
        let valueClass = '';

        // Format timestamp claims
        if (['exp', 'nbf', 'iat'].includes(key) && typeof value === 'number') {
            const date = new Date(value * 1000);
            const formatted = date.toLocaleString();

            if (key === 'exp') {
                if (value < now) {
                    displayValue = `${formatted} (EXPIRED)`;
                    valueClass = 'expired';
                } else {
                    const diff = value - now;
                    const hours = Math.floor(diff / 3600);
                    const mins = Math.floor((diff % 3600) / 60);
                    displayValue = `${formatted} (valid for ${hours}h ${mins}m)`;
                    valueClass = 'valid';
                }
            } else if (key === 'nbf') {
                if (value > now) {
                    displayValue = `${formatted} (NOT YET VALID)`;
                    valueClass = 'expired';
                } else {
                    displayValue = `${formatted} (active)`;
                    valueClass = 'valid';
                }
            } else {
                displayValue = formatted;
            }
        } else if (typeof value === 'object') {
            displayValue = JSON.stringify(value);
        }

        const label = standardClaims[key] || key;
        claimsHtml += `
            <div class="jwt-claim">
                <span class="jwt-claim-key">${label}</span>
                <span class="jwt-claim-value ${valueClass}">${displayValue}</span>
            </div>
        `;
    }

    claimsHtml += '</div>';
    return claimsHtml;
}

function jwtCopyPart(btn, part) {
    const widget = btn.closest('.jwt-widget');
    let text = '';
    if (part === 'header') text = widget._decodedHeader;
    else if (part === 'payload') text = widget._decodedPayload;
    else if (part === 'signature') text = widget._signature;

    navigator.clipboard.writeText(text).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = orig, 1500);
    });
}

function jwtLoadSample() {
    const widget = event.target.closest('.jwt-widget');
    const textarea = widget.querySelector('textarea');
    // Sample JWT with typical claims
    const samplePayload = {
        sub: '1234567890',
        name: 'John Doe',
        email: 'john@example.com',
        role: 'admin',
        iat: Math.floor(Date.now() / 1000) - 3600,
        exp: Math.floor(Date.now() / 1000) + 3600,
        iss: 'https://example.com'
    };
    const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' })).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
    const payload = btoa(JSON.stringify(samplePayload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
    const signature = 'SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
    textarea.value = `${header}.${payload}.${signature}`;
    jwtDecode(textarea);
}

function jwtClear() {
    const widget = event.target.closest('.jwt-widget');
    const textarea = widget.querySelector('textarea');
    textarea.value = '';
    jwtDecode(textarea);
}

// Epoch Converter Widget
let epochIntervalId = null;

function epochInit() {
    document.querySelectorAll('.epoch-widget').forEach(widget => {
        // Update current time display
        epochUpdateNow(widget);

        // Update reference values
        epochUpdateReference(widget);

        // Start interval for live updates
        if (!epochIntervalId) {
            epochIntervalId = setInterval(() => {
                document.querySelectorAll('.epoch-widget').forEach(w => epochUpdateNow(w));
            }, 1000);
        }
    });
}

function epochUpdateNow(widget) {
    const nowDisplay = widget.querySelector('.epoch-now-value');
    if (nowDisplay) {
        const now = Math.floor(Date.now() / 1000);
        nowDisplay.textContent = now;
    }
}

function epochUpdateReference(widget) {
    const todayEl = widget.querySelector('.epoch-ref-today');
    const yearEl = widget.querySelector('.epoch-ref-year');

    if (todayEl) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        todayEl.textContent = Math.floor(today.getTime() / 1000);
    }

    if (yearEl) {
        const year = new Date(new Date().getFullYear(), 0, 1);
        yearEl.textContent = Math.floor(year.getTime() / 1000);
    }
}

function epochCopyNow(btn) {
    const widget = btn.closest('.epoch-widget');
    const now = Math.floor(Date.now() / 1000);
    navigator.clipboard.writeText(now.toString());

    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = originalText, 1000);
}

function epochUseNow(btn) {
    const widget = btn.closest('.epoch-widget');
    const input = widget.querySelector('.epoch-timestamp-input');
    const now = Math.floor(Date.now() / 1000);
    input.value = now;
    epochFromTimestamp(input);
}

function epochFromTimestamp(element) {
    const widget = element.closest('.epoch-widget');
    const input = widget.querySelector('.epoch-timestamp-input');
    const unitSelect = widget.querySelector('.epoch-unit-select');
    const resultDiv = widget.querySelector('.epoch-from-ts');

    const value = input.value.trim();
    if (!value) {
        resultDiv.innerHTML = '<span style="color: var(--text-muted);">Enter a timestamp to convert...</span>';
        return;
    }

    const numValue = parseInt(value);
    if (isNaN(numValue)) {
        resultDiv.innerHTML = '<span style="color: var(--error-text);">Invalid number</span>';
        return;
    }

    // Determine if seconds or milliseconds
    let unit = unitSelect?.value || 'auto';
    let timestamp = numValue;

    if (unit === 'auto') {
        // If number is larger than year 3000 in seconds, assume milliseconds
        if (numValue > 32503680000) {
            unit = 'ms';
        } else {
            unit = 's';
        }
    }

    if (unit === 'ms') {
        timestamp = numValue;
    } else {
        timestamp = numValue * 1000;
    }

    const date = new Date(timestamp);

    if (isNaN(date.getTime())) {
        resultDiv.innerHTML = '<span style="color: var(--error-text);">Invalid date</span>';
        return;
    }

    const localStr = date.toLocaleString();
    const utcStr = date.toUTCString();
    const isoStr = date.toISOString();
    const relativeStr = epochRelativeTime(date);

    resultDiv.innerHTML = `
        <div class="result-row">
            <span class="result-label">Local:</span>
            <span class="result-value copyable" onclick="epochCopyValue(this)">${localStr}</span>
        </div>
        <div class="result-row">
            <span class="result-label">UTC:</span>
            <span class="result-value copyable" onclick="epochCopyValue(this)">${utcStr}</span>
        </div>
        <div class="result-row">
            <span class="result-label">ISO 8601:</span>
            <span class="result-value copyable" onclick="epochCopyValue(this)">${isoStr}</span>
        </div>
        <div class="result-row">
            <span class="result-label">Relative:</span>
            <span class="result-value">${relativeStr}</span>
        </div>
        <div class="result-row" style="margin-top: 4px; font-size: 10px; color: var(--text-muted);">
            Detected: ${unit === 'ms' ? 'milliseconds' : 'seconds'}
        </div>
    `;
}

function epochFromDatetime(element) {
    const widget = element.closest('.epoch-widget');
    const dateInput = widget.querySelector('.epoch-date-input');
    const timeInput = widget.querySelector('.epoch-time-input');
    const tzSelect = widget.querySelector('.epoch-tz-select');
    const resultDiv = widget.querySelector('.epoch-from-dt');

    const dateValue = dateInput.value;
    const timeValue = timeInput.value || '00:00:00';

    if (!dateValue) {
        resultDiv.innerHTML = '<span style="color: var(--text-muted);">Select a date to convert...</span>';
        return;
    }

    let date;
    const tz = tzSelect?.value || 'local';

    if (tz === 'utc') {
        date = new Date(`${dateValue}T${timeValue}Z`);
    } else {
        date = new Date(`${dateValue}T${timeValue}`);
    }

    if (isNaN(date.getTime())) {
        resultDiv.innerHTML = '<span style="color: var(--error-text);">Invalid date/time</span>';
        return;
    }

    const seconds = Math.floor(date.getTime() / 1000);
    const milliseconds = date.getTime();

    resultDiv.innerHTML = `
        <div class="result-row">
            <span class="result-label">Seconds:</span>
            <span class="result-value copyable" onclick="epochCopyValue(this)">${seconds}</span>
        </div>
        <div class="result-row">
            <span class="result-label">Milliseconds:</span>
            <span class="result-value copyable" onclick="epochCopyValue(this)">${milliseconds}</span>
        </div>
    `;
}

function epochRelativeTime(date) {
    const now = new Date();
    const diffMs = date.getTime() - now.getTime();
    const diffSec = Math.abs(Math.floor(diffMs / 1000));
    const isFuture = diffMs > 0;

    const units = [
        { name: 'year', seconds: 31536000 },
        { name: 'month', seconds: 2592000 },
        { name: 'week', seconds: 604800 },
        { name: 'day', seconds: 86400 },
        { name: 'hour', seconds: 3600 },
        { name: 'minute', seconds: 60 },
        { name: 'second', seconds: 1 }
    ];

    for (const unit of units) {
        const value = Math.floor(diffSec / unit.seconds);
        if (value >= 1) {
            const plural = value !== 1 ? 's' : '';
            return isFuture
                ? `in ${value} ${unit.name}${plural}`
                : `${value} ${unit.name}${plural} ago`;
        }
    }

    return 'just now';
}

function epochCopyValue(element) {
    const text = element.textContent;
    navigator.clipboard.writeText(text);

    const original = element.textContent;
    element.textContent = 'Copied!';
    element.style.color = 'var(--success-color)';
    setTimeout(() => {
        element.textContent = original;
        element.style.color = '';
    }, 1000);
}

// Code Formatter Widget
function fmtGetToolId(element) {
    const widget = element.closest('.fmt-widget');
    return widget?.closest('.tool')?.getAttribute('data-tool');
}

function fmtGetData(toolId) {
    const customizations = loadToolCustomizations();
    const custom = customizations[toolId] || {};
    return custom.fmtData || { input: '', output: '', format: 'json' };
}

function fmtSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].fmtData = data;
    saveToolCustomizations(customizations);
}

function fmtInit() {
    document.querySelectorAll('.fmt-widget').forEach(widget => {
        const toolId = fmtGetToolId(widget);
        if (!toolId) return;

        const data = fmtGetData(toolId);
        const input = widget.querySelector('.fmt-input');
        const output = widget.querySelector('.fmt-output');

        if (input && data.input) input.value = data.input;
        if (output && data.output) output.value = data.output;

        // Restore format selection
        if (data.format) {
            widget.querySelectorAll('.fmt-format-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase() === data.format);
            });
        }

        // Setup resizer
        fmtSetupResizer(widget);
    });
}

function fmtSetupResizer(widget) {
    const resizer = widget.querySelector('.fmt-resizer');
    const container = widget.querySelector('.fmt-container');
    const leftPane = container.querySelector('.fmt-pane:first-child');
    const rightPane = container.querySelector('.fmt-pane:last-child');

    if (!resizer) return;

    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const total = rect.width - 6; // resizer width
        const leftWidth = Math.max(100, Math.min(x, total - 100));
        const rightWidth = total - leftWidth;
        leftPane.style.flex = `0 0 ${leftWidth}px`;
        rightPane.style.flex = `0 0 ${rightWidth}px`;
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
}

function fmtSetFormat(btn, format) {
    const widget = btn.closest('.fmt-widget');
    widget.querySelectorAll('.fmt-format-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const toolId = fmtGetToolId(widget);
    if (toolId) {
        const data = fmtGetData(toolId);
        data.format = format;
        fmtSaveData(toolId, data);
    }

    fmtUpdateStatus(widget, '');
}

function fmtGetFormat(widget) {
    const activeBtn = widget.querySelector('.fmt-format-btn.active');
    return activeBtn ? activeBtn.textContent.toLowerCase() : 'json';
}

function fmtOnInput(textarea) {
    const widget = textarea.closest('.fmt-widget');
    const toolId = fmtGetToolId(widget);
    if (toolId) {
        const data = fmtGetData(toolId);
        data.input = textarea.value;
        fmtSaveData(toolId, data);
    }
}

function fmtPrettify(btn) {
    const widget = btn.closest('.fmt-widget');
    const format = fmtGetFormat(widget);
    const input = widget.querySelector('.fmt-input').value;
    const output = widget.querySelector('.fmt-output');

    if (!input.trim()) {
        fmtUpdateStatus(widget, 'No input provided', 'error');
        return;
    }

    try {
        let result;
        switch (format) {
            case 'json':
                result = fmtPrettifyJSON(input);
                break;
            case 'xml':
                result = fmtPrettifyXML(input);
                break;
            case 'csv':
                result = fmtPrettifyCSV(input);
                break;
            case 'sql':
                result = fmtPrettifySQL(input);
                break;
            default:
                result = input;
        }
        output.value = result;
        fmtUpdateStatus(widget, `Prettified ${format.toUpperCase()} successfully`, 'success');

        const toolId = fmtGetToolId(widget);
        if (toolId) {
            const data = fmtGetData(toolId);
            data.output = result;
            fmtSaveData(toolId, data);
        }
    } catch (e) {
        fmtUpdateStatus(widget, `Error: ${e.message}`, 'error');
    }
}

function fmtMinify(btn) {
    const widget = btn.closest('.fmt-widget');
    const format = fmtGetFormat(widget);
    const input = widget.querySelector('.fmt-input').value;
    const output = widget.querySelector('.fmt-output');

    if (!input.trim()) {
        fmtUpdateStatus(widget, 'No input provided', 'error');
        return;
    }

    try {
        let result;
        switch (format) {
            case 'json':
                result = fmtMinifyJSON(input);
                break;
            case 'xml':
                result = fmtMinifyXML(input);
                break;
            case 'csv':
                result = fmtMinifyCSV(input);
                break;
            case 'sql':
                result = fmtMinifySQL(input);
                break;
            default:
                result = input;
        }
        output.value = result;
        fmtUpdateStatus(widget, `Minified ${format.toUpperCase()} successfully`, 'success');

        const toolId = fmtGetToolId(widget);
        if (toolId) {
            const data = fmtGetData(toolId);
            data.output = result;
            fmtSaveData(toolId, data);
        }
    } catch (e) {
        fmtUpdateStatus(widget, `Error: ${e.message}`, 'error');
    }
}

function fmtCopy(btn) {
    const widget = btn.closest('.fmt-widget');
    const output = widget.querySelector('.fmt-output').value;

    if (!output) {
        fmtUpdateStatus(widget, 'Nothing to copy', 'error');
        return;
    }

    navigator.clipboard.writeText(output).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = orig, 1500);
    });
}

function fmtSwap(btn) {
    const widget = btn.closest('.fmt-widget');
    const input = widget.querySelector('.fmt-input');
    const output = widget.querySelector('.fmt-output');

    const temp = input.value;
    input.value = output.value;
    output.value = temp;

    const toolId = fmtGetToolId(widget);
    if (toolId) {
        const data = fmtGetData(toolId);
        data.input = input.value;
        data.output = output.value;
        fmtSaveData(toolId, data);
    }

    fmtUpdateStatus(widget, 'Swapped input and output', 'success');
}

function fmtUpdateStatus(widget, message, type = '') {
    const status = widget.querySelector('.fmt-status');
    status.textContent = message;
    status.className = 'fmt-status' + (type ? ` ${type}` : '');
}

// JSON formatting
function fmtPrettifyJSON(input) {
    const obj = JSON.parse(input);
    return JSON.stringify(obj, null, 2);
}

function fmtMinifyJSON(input) {
    const obj = JSON.parse(input);
    return JSON.stringify(obj);
}

// XML formatting
function fmtPrettifyXML(input) {
    // Remove existing formatting
    let xml = input.replace(/>\s+</g, '><').trim();

    // Check for valid XML structure
    if (!xml.startsWith('<')) {
        throw new Error('Invalid XML: must start with <');
    }

    let formatted = '';
    let indent = 0;
    const tab = '  ';

    // Split by tags
    const parts = xml.split(/(<[^>]+>)/);

    for (let part of parts) {
        part = part.trim();
        if (!part) continue;

        if (part.startsWith('</')) {
            // Closing tag
            indent--;
            formatted += tab.repeat(Math.max(0, indent)) + part + '\n';
        } else if (part.startsWith('<?') || part.startsWith('<!')) {
            // XML declaration or doctype
            formatted += part + '\n';
        } else if (part.startsWith('<') && part.endsWith('/>')) {
            // Self-closing tag
            formatted += tab.repeat(indent) + part + '\n';
        } else if (part.startsWith('<')) {
            // Opening tag
            formatted += tab.repeat(indent) + part + '\n';
            indent++;
        } else {
            // Text content
            indent--;
            formatted = formatted.trimEnd() + part + '\n';
            indent++;
        }
    }

    return formatted.trim();
}

function fmtMinifyXML(input) {
    // Remove comments, newlines, and extra whitespace between tags
    return input
        .replace(/<!--[\s\S]*?-->/g, '')  // Remove comments
        .replace(/>\s+</g, '><')          // Remove whitespace between tags
        .replace(/\s+/g, ' ')             // Collapse whitespace
        .trim();
}

// CSV formatting
function fmtPrettifyCSV(input) {
    const lines = input.trim().split(/\r?\n/);
    if (lines.length === 0) return input;

    // Parse CSV properly handling quoted fields
    const rows = lines.map(line => fmtParseCSVLine(line));

    // Find max width for each column
    const colWidths = [];
    for (const row of rows) {
        for (let i = 0; i < row.length; i++) {
            const len = row[i].length;
            if (!colWidths[i] || len > colWidths[i]) {
                colWidths[i] = len;
            }
        }
    }

    // Format with padding
    return rows.map(row =>
        row.map((cell, i) => cell.padEnd(colWidths[i] || 0)).join(' | ')
    ).join('\n');
}

function fmtParseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current.trim());

    return result;
}

function fmtMinifyCSV(input) {
    const lines = input.trim().split(/\r?\n/);
    return lines.map(line => {
        // Parse and re-join to remove padding
        const cells = fmtParseCSVLine(line);
        return cells.map(cell => {
            cell = cell.trim();
            // Re-quote if needed
            if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                return '"' + cell.replace(/"/g, '""') + '"';
            }
            return cell;
        }).join(',');
    }).join('\n');
}

// SQL formatting
function fmtPrettifySQL(input) {
    // Keywords to add newlines before
    const majorKeywords = [
        'SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER BY', 'GROUP BY',
        'HAVING', 'LIMIT', 'OFFSET', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN',
        'INNER JOIN', 'OUTER JOIN', 'FULL JOIN', 'CROSS JOIN',
        'ON', 'SET', 'VALUES', 'INSERT INTO', 'UPDATE', 'DELETE FROM',
        'CREATE TABLE', 'ALTER TABLE', 'DROP TABLE', 'CREATE INDEX',
        'UNION', 'UNION ALL', 'EXCEPT', 'INTERSECT', 'CASE', 'WHEN',
        'THEN', 'ELSE', 'END', 'AS'
    ];

    // Normalize whitespace
    let sql = input.replace(/\s+/g, ' ').trim();

    // Sort keywords by length (longest first) to avoid partial replacements
    const sortedKeywords = majorKeywords.sort((a, b) => b.length - a.length);

    // Add newlines before major keywords (case-insensitive)
    for (const keyword of sortedKeywords) {
        const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
        sql = sql.replace(regex, '\n$1');
    }

    // Indent subqueries
    let result = '';
    let indent = 0;
    const lines = sql.split('\n');

    for (let line of lines) {
        line = line.trim();
        if (!line) continue;

        // Check for opening/closing parens to adjust indent
        const openCount = (line.match(/\(/g) || []).length;
        const closeCount = (line.match(/\)/g) || []).length;

        // Decrease indent for lines starting with )
        if (line.startsWith(')')) indent = Math.max(0, indent - 1);

        result += '  '.repeat(indent) + line.toUpperCase().replace(/\b(SELECT|FROM|WHERE|AND|OR|ORDER BY|GROUP BY|HAVING|JOIN|LEFT|RIGHT|INNER|OUTER|FULL|CROSS|ON|SET|VALUES|INSERT|INTO|UPDATE|DELETE|CREATE|ALTER|DROP|TABLE|INDEX|UNION|ALL|EXCEPT|INTERSECT|CASE|WHEN|THEN|ELSE|END|AS|LIMIT|OFFSET|NULL|NOT|IN|IS|LIKE|BETWEEN)\b/gi,
            match => match.toUpperCase()) + '\n';

        // Increase indent for lines ending with (
        if (line.endsWith('(')) indent++;

        // Adjust for balanced parens
        indent += openCount - closeCount - (line.startsWith(')') ? 0 : 0);
        indent = Math.max(0, indent);
    }

    return result.trim();
}

function fmtMinifySQL(input) {
    return input
        .replace(/--[^\n]*/g, '')          // Remove single-line comments
        .replace(/\/\*[\s\S]*?\*\//g, '')  // Remove multi-line comments
        .replace(/\s+/g, ' ')              // Collapse whitespace
        .replace(/\s*([(),])\s*/g, '$1')   // Remove space around punctuation
        .replace(/\s*([=<>!]+)\s*/g, ' $1 ')  // Normalize operators
        .trim();
}

// Cron Expression Functions
function cronGetToolId(element) {
    const tool = element.closest('.tool');
    return tool ? tool.getAttribute('data-tool') : null;
}

function cronGetData(toolId) {
    const customizations = loadToolCustomizations();
    return (customizations[toolId] && customizations[toolId].cronData) || { expression: '0 9 * * MON-FRI' };
}

function cronSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].cronData = data;
    saveToolCustomizations(customizations);
}

function cronInit() {
    document.querySelectorAll('.cron-widget').forEach(widget => {
        const toolId = cronGetToolId(widget);
        if (!toolId) return;

        const data = cronGetData(toolId);
        const input = widget.querySelector('.cron-input');
        if (input && data.expression) {
            input.value = data.expression;
        }
        cronParse(input);
    });
}

function cronSetPreset(btn, expression) {
    const widget = btn.closest('.cron-widget');
    const input = widget.querySelector('.cron-input');
    input.value = expression;
    cronParse(input);
}

function cronParse(input) {
    const widget = input.closest('.cron-widget');
    const expression = input.value.trim();
    const explanationEl = widget.querySelector('.cron-explanation-text');
    const fieldsEl = widget.querySelector('.cron-fields');
    const scheduleList = widget.querySelector('.cron-schedule-list');
    const scheduleCount = widget.querySelector('.cron-schedule-count');

    // Save the expression
    const toolId = cronGetToolId(widget);
    if (toolId) {
        cronSaveData(toolId, { expression });
    }

    // Parse the expression
    const result = cronParseExpression(expression);

    if (result.error) {
        input.classList.remove('valid');
        input.classList.add('invalid');
        explanationEl.innerHTML = `<span class="cron-error">${result.error}</span>`;
        fieldsEl.innerHTML = '';
        scheduleList.innerHTML = '';
        scheduleCount.textContent = '';
        return;
    }

    input.classList.remove('invalid');
    input.classList.add('valid');

    // Render explanation
    explanationEl.innerHTML = result.explanation;

    // Render field breakdown
    fieldsEl.innerHTML = result.fields.map(f => `
        <div class="cron-field">
            <div class="cron-field-value">${escapeHtml(f.value)}</div>
            <div class="cron-field-name">${f.name}</div>
            <div class="cron-field-desc">${f.desc}</div>
        </div>
    `).join('');

    // Render next runs
    const nextRuns = cronGetNextRuns(result.parsed, 10);
    scheduleCount.textContent = `Next ${nextRuns.length} runs`;
    scheduleList.innerHTML = nextRuns.map((run, i) => `
        <div class="cron-schedule-item">
            <span class="cron-schedule-date">${cronFormatDate(run)}</span>
            <span class="cron-schedule-relative">${cronRelativeTime(run)}</span>
        </div>
    `).join('');
}

function cronParseExpression(expr) {
    const parts = expr.split(/\s+/);
    if (parts.length !== 5) {
        return { error: `Invalid cron expression: expected 5 fields, got ${parts.length}` };
    }

    const fieldDefs = [
        { name: 'Minute', min: 0, max: 59 },
        { name: 'Hour', min: 0, max: 23 },
        { name: 'Day', min: 1, max: 31 },
        { name: 'Month', min: 1, max: 12 },
        { name: 'Weekday', min: 0, max: 7 }
    ];

    const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    const parsed = [];
    const fields = [];

    for (let i = 0; i < 5; i++) {
        const part = parts[i];
        const def = fieldDefs[i];
        const result = cronParseField(part, def.min, def.max, i);

        if (result.error) {
            return { error: `${def.name}: ${result.error}` };
        }

        parsed.push(result.values);
        fields.push({
            value: part,
            name: def.name,
            desc: cronDescribeField(result.values, i, monthNames, dayNames)
        });
    }

    // Build explanation
    const explanation = cronBuildExplanation(parts, parsed, monthNames, dayNames);

    return { parsed, fields, explanation };
}

function cronParseField(field, min, max, fieldIndex) {
    // Handle named values for months and weekdays
    const monthMap = { jan: 1, feb: 2, mar: 3, apr: 4, may: 5, jun: 6, jul: 7, aug: 8, sep: 9, oct: 10, nov: 11, dec: 12 };
    const dayMap = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };

    let normalized = field.toLowerCase();
    if (fieldIndex === 3) { // Month
        for (const [name, val] of Object.entries(monthMap)) {
            normalized = normalized.replace(new RegExp(name, 'gi'), val);
        }
    } else if (fieldIndex === 4) { // Weekday
        for (const [name, val] of Object.entries(dayMap)) {
            normalized = normalized.replace(new RegExp(name, 'gi'), val);
        }
    }

    const values = new Set();

    // Split by comma for lists
    const parts = normalized.split(',');
    for (const part of parts) {
        // Handle step values (*/2 or 1-10/2)
        const stepMatch = part.match(/^(.+)\/(\d+)$/);
        let range = stepMatch ? stepMatch[1] : part;
        const step = stepMatch ? parseInt(stepMatch[2]) : 1;

        if (step < 1) {
            return { error: 'Step must be at least 1' };
        }

        let start, end;

        if (range === '*') {
            start = min;
            end = max;
        } else if (range.includes('-')) {
            const [s, e] = range.split('-').map(Number);
            if (isNaN(s) || isNaN(e)) {
                return { error: 'Invalid range' };
            }
            start = s;
            end = e;
        } else {
            const val = parseInt(range);
            if (isNaN(val)) {
                return { error: `Invalid value: ${range}` };
            }
            start = val;
            end = val;
        }

        // Normalize weekday 7 to 0 (both mean Sunday)
        if (fieldIndex === 4) {
            if (start === 7) start = 0;
            if (end === 7) end = 0;
        }

        // Validate range
        const actualMin = fieldIndex === 4 ? 0 : min;
        const actualMax = fieldIndex === 4 ? 6 : max;
        if (start < actualMin || start > actualMax || end < actualMin || end > actualMax) {
            return { error: `Value out of range (${actualMin}-${actualMax})` };
        }

        // Handle wrap-around for weekdays
        if (start > end && fieldIndex === 4) {
            for (let v = start; v <= 6; v += step) values.add(v);
            for (let v = 0; v <= end; v += step) values.add(v);
        } else if (start > end) {
            return { error: 'Start of range must be less than end' };
        } else {
            for (let v = start; v <= end; v += step) {
                values.add(v);
            }
        }
    }

    return { values: Array.from(values).sort((a, b) => a - b) };
}

function cronDescribeField(values, fieldIndex, monthNames, dayNames) {
    const fieldDefs = [
        { min: 0, max: 59, name: 'minute' },
        { min: 0, max: 23, name: 'hour' },
        { min: 1, max: 31, name: 'day' },
        { min: 1, max: 12, name: 'month' },
        { min: 0, max: 6, name: 'weekday' }
    ];

    const def = fieldDefs[fieldIndex];

    // Check if it's all values (wildcard)
    const allValues = [];
    for (let i = def.min; i <= def.max; i++) allValues.push(i);
    if (values.length === allValues.length && values.every((v, i) => v === allValues[i])) {
        return 'every ' + def.name;
    }

    // Format the values
    if (fieldIndex === 3) { // Month
        return values.map(v => monthNames[v]).join(', ');
    } else if (fieldIndex === 4) { // Weekday
        return values.map(v => dayNames[v]).join(', ');
    } else if (values.length === 1) {
        return 'at ' + values[0];
    } else if (values.length <= 3) {
        return values.join(', ');
    } else {
        return `${values.length} values`;
    }
}

function cronBuildExplanation(parts, parsed, monthNames, dayNames) {
    const [minutes, hours, days, months, weekdays] = parsed;

    let result = 'Runs <strong>';

    // Time description
    const isEveryMinute = minutes.length === 60;
    const isEveryHour = hours.length === 24;

    if (isEveryMinute && isEveryHour) {
        result += 'every minute';
    } else if (isEveryMinute) {
        result += 'every minute';
        if (hours.length === 1) {
            result += ` during hour ${hours[0]}`;
        } else {
            result += ` during hours ${hours.join(', ')}`;
        }
    } else if (isEveryHour) {
        if (minutes.length === 1) {
            result += `at minute ${minutes[0]} of every hour`;
        } else {
            result += `at minutes ${minutes.join(', ')} of every hour`;
        }
    } else {
        // Specific times
        if (hours.length === 1 && minutes.length === 1) {
            result += `at ${String(hours[0]).padStart(2, '0')}:${String(minutes[0]).padStart(2, '0')}`;
        } else if (hours.length <= 3 && minutes.length === 1) {
            const times = hours.map(h => `${String(h).padStart(2, '0')}:${String(minutes[0]).padStart(2, '0')}`);
            result += `at ${times.join(', ')}`;
        } else {
            result += `at minute ${minutes.join(', ')} past hour ${hours.join(', ')}`;
        }
    }

    result += '</strong>';

    // Day/month description
    const isEveryDay = days.length === 31;
    const isEveryMonth = months.length === 12;
    const isEveryWeekday = weekdays.length === 7;

    if (!isEveryDay || !isEveryWeekday) {
        if (!isEveryDay && !isEveryWeekday) {
            result += ` on day ${days.join(', ')} and ${weekdays.map(w => dayNames[w]).join(', ')}`;
        } else if (!isEveryDay) {
            result += ` on day ${days.join(', ')} of the month`;
        } else if (!isEveryWeekday) {
            if (weekdays.length === 5 && !weekdays.includes(0) && !weekdays.includes(6)) {
                result += ' on weekdays';
            } else if (weekdays.length === 2 && weekdays.includes(0) && weekdays.includes(6)) {
                result += ' on weekends';
            } else {
                result += ` on ${weekdays.map(w => dayNames[w]).join(', ')}`;
            }
        }
    }

    if (!isEveryMonth) {
        result += ` in ${months.map(m => monthNames[m]).join(', ')}`;
    }

    return result;
}

function cronGetNextRuns(parsed, count) {
    const [minutes, hours, days, months, weekdays] = parsed;
    const runs = [];
    const now = new Date();
    let current = new Date(now);

    // Start from next minute
    current.setSeconds(0);
    current.setMilliseconds(0);
    current.setMinutes(current.getMinutes() + 1);

    const maxIterations = 100000; // Prevent infinite loops
    let iterations = 0;

    while (runs.length < count && iterations < maxIterations) {
        iterations++;

        // Check if current time matches the cron pattern
        const minute = current.getMinutes();
        const hour = current.getHours();
        const day = current.getDate();
        const month = current.getMonth() + 1;
        const weekday = current.getDay();

        if (months.includes(month) &&
            (days.includes(day) || weekdays.includes(weekday)) &&
            hours.includes(hour) &&
            minutes.includes(minute)) {
            runs.push(new Date(current));
        }

        // Move to next minute
        current.setMinutes(current.getMinutes() + 1);
    }

    return runs;
}

function cronFormatDate(date) {
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const day = days[date.getDay()];
    const month = months[date.getMonth()];
    const dateNum = date.getDate();
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${day}, ${month} ${dateNum}, ${year} ${hours}:${minutes}`;
}

function cronRelativeTime(date) {
    const now = new Date();
    const diffMs = date - now;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 60) {
        return `in ${diffMins} min${diffMins !== 1 ? 's' : ''}`;
    } else if (diffHours < 24) {
        const mins = diffMins % 60;
        return `in ${diffHours}h ${mins}m`;
    } else if (diffDays < 7) {
        return `in ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
    } else {
        const weeks = Math.floor(diffDays / 7);
        return `in ${weeks} week${weeks !== 1 ? 's' : ''}`;
    }
}

// Regex Tester Functions
function regexGetToolId(element) {
    const tool = element.closest('.tool');
    return tool ? tool.getAttribute('data-tool') : null;
}

function regexGetData(toolId) {
    const customizations = loadToolCustomizations();
    return (customizations[toolId] && customizations[toolId].regexData) || {
        pattern: '',
        testString: '',
        flags: { g: true, i: false, m: false, s: false }
    };
}

function regexSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].regexData = data;
    saveToolCustomizations(customizations);
}

function regexInit() {
    document.querySelectorAll('.regex-widget').forEach(widget => {
        const toolId = regexGetToolId(widget);
        if (!toolId) return;

        const data = regexGetData(toolId);
        const patternInput = widget.querySelector('.regex-pattern');
        const testInput = widget.querySelector('.regex-test-string');

        if (patternInput && data.pattern) patternInput.value = data.pattern;
        if (testInput && data.testString) testInput.value = data.testString;

        if (data.flags) {
            widget.querySelectorAll('.regex-flag').forEach(checkbox => {
                const flag = checkbox.getAttribute('data-flag');
                if (flag && data.flags[flag] !== undefined) {
                    checkbox.checked = data.flags[flag];
                }
            });
        }

        regexSetupResizer(widget);
        regexExecute(widget);
    });
}

function regexSetupResizer(widget) {
    const resizer = widget.querySelector('.regex-resizer');
    const container = widget.querySelector('.regex-container');
    const leftPane = container.querySelector('.regex-pane:first-child');
    const rightPane = container.querySelector('.regex-pane:last-child');

    if (!resizer) return;

    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const total = rect.width - 6;
        const leftWidth = Math.max(100, Math.min(x, total - 100));
        const rightWidth = total - leftWidth;
        leftPane.style.flex = `0 0 ${leftWidth}px`;
        rightPane.style.flex = `0 0 ${rightWidth}px`;
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
}

function regexOnInput(element) {
    const widget = element.closest('.regex-widget');
    const toolId = regexGetToolId(widget);

    if (toolId) {
        const data = regexGetData(toolId);
        data.pattern = widget.querySelector('.regex-pattern').value;
        data.testString = widget.querySelector('.regex-test-string').value;
        data.flags = {};
        widget.querySelectorAll('.regex-flag').forEach(checkbox => {
            const flag = checkbox.getAttribute('data-flag');
            if (flag) data.flags[flag] = checkbox.checked;
        });
        regexSaveData(toolId, data);
    }

    regexExecute(widget);
}

function regexGetFlags(widget) {
    let flags = '';
    widget.querySelectorAll('.regex-flag:checked').forEach(checkbox => {
        flags += checkbox.getAttribute('data-flag') || '';
    });
    return flags;
}

function regexExecute(widget) {
    const pattern = widget.querySelector('.regex-pattern').value;
    const testString = widget.querySelector('.regex-test-string').value;
    const resultsDiv = widget.querySelector('.regex-results');
    const statusDiv = widget.querySelector('.regex-status');
    const flags = regexGetFlags(widget);

    if (!pattern) {
        resultsDiv.innerHTML = '<span class="no-match">Enter a regex pattern to see matches</span>';
        statusDiv.textContent = '';
        statusDiv.className = 'regex-status';
        return;
    }

    try {
        const regex = new RegExp(pattern, flags);
        const matches = [];
        let match;

        if (flags.includes('g')) {
            while ((match = regex.exec(testString)) !== null) {
                matches.push({
                    value: match[0],
                    index: match.index,
                    groups: match.slice(1)
                });
                if (match.index === regex.lastIndex) regex.lastIndex++;
            }
        } else {
            match = regex.exec(testString);
            if (match) {
                matches.push({
                    value: match[0],
                    index: match.index,
                    groups: match.slice(1)
                });
            }
        }

        if (matches.length === 0) {
            resultsDiv.innerHTML = '<span class="no-match">No matches found</span>';
            statusDiv.textContent = 'No matches';
            statusDiv.className = 'regex-status';
            return;
        }

        let highlighted = '';
        let lastIndex = 0;
        for (const m of matches) {
            highlighted += regexEscapeHtml(testString.slice(lastIndex, m.index));
            highlighted += `<span class="match-highlight">${regexEscapeHtml(m.value)}</span>`;
            lastIndex = m.index + m.value.length;
        }
        highlighted += regexEscapeHtml(testString.slice(lastIndex));

        let details = '<div class="match-info"><strong>Match Details:</strong>';
        matches.forEach((m, i) => {
            details += `<div class="match-item">`;
            details += `<div class="match-index">Match ${i + 1} at index ${m.index}</div>`;
            details += `<div class="match-value">${regexEscapeHtml(m.value)}</div>`;
            if (m.groups.length > 0) {
                details += '<div class="match-groups">';
                m.groups.forEach((g, gi) => {
                    details += `<div class="group-item">Group ${gi + 1}: ${g !== undefined ? regexEscapeHtml(g) : '<em>undefined</em>'}</div>`;
                });
                details += '</div>';
            }
            details += '</div>';
        });
        details += '</div>';

        resultsDiv.innerHTML = `<div style="white-space:pre-wrap;word-break:break-all;margin-bottom:10px;">${highlighted}</div>${details}`;
        statusDiv.textContent = `${matches.length} match${matches.length !== 1 ? 'es' : ''} found`;
        statusDiv.className = 'regex-status success';

    } catch (e) {
        resultsDiv.innerHTML = `<span class="no-match">Invalid regex: ${regexEscapeHtml(e.message)}</span>`;
        statusDiv.textContent = 'Invalid pattern';
        statusDiv.className = 'regex-status error';
    }
}

function regexEscapeHtml(str) {
    if (!str) return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function regexCopy(btn) {
    const widget = btn.closest('.regex-widget');
    const pattern = widget.querySelector('.regex-pattern').value;
    const flags = regexGetFlags(widget);

    if (!pattern) return;

    const regexString = `/${pattern}/${flags}`;
    navigator.clipboard.writeText(regexString).then(() => {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = orig, 1500);
    });
}

function regexClear(btn) {
    const widget = btn.closest('.regex-widget');
    widget.querySelector('.regex-pattern').value = '';
    widget.querySelector('.regex-test-string').value = '';
    regexOnInput(widget.querySelector('.regex-pattern'));
}

// Content Editor State
let currentEditingTool = null;

function setupContentEditor() {
    const overlay = document.getElementById('contentEditorOverlay');
    const editor = overlay.querySelector('.content-editor');
    const header = overlay.querySelector('.content-editor-header');
    const textarea = document.getElementById('contentEditorTextarea');
    const preview = document.getElementById('contentEditorPreview');
    const titleSpan = document.getElementById('editorToolTitle');
    const closeBtn = overlay.querySelector('.content-editor-close');
    const saveBtn = overlay.querySelector('.content-editor-save');
    const cancelBtn = overlay.querySelector('.content-editor-cancel');
    const resetBtn = overlay.querySelector('.content-editor-reset');
    const resizer = document.getElementById('editorResizer');
    const inputPane = overlay.querySelector('.content-editor-input');
    const previewPane = overlay.querySelector('.content-editor-preview');

    // Live preview
    textarea.addEventListener('input', () => {
        preview.innerHTML = parseMarkdown(textarea.value);
    });

    // Handle pasting images from clipboard
    textarea.addEventListener('paste', (e) => {
        const html = e.clipboardData?.getData('text/html');
        if (!html) return; // No HTML = likely screenshot, ignore

        // Extract image src from pasted HTML
        const match = html.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (match && match[1]) {
            const imageUrl = match[1];
            // Skip data URLs (base64)
            if (imageUrl.startsWith('data:')) return;

            e.preventDefault();
            const cursorPos = textarea.selectionStart;
            const before = textarea.value.substring(0, cursorPos);
            const after = textarea.value.substring(textarea.selectionEnd);
            textarea.value = before + `![image](${imageUrl})` + after;
            textarea.selectionStart = textarea.selectionEnd = cursorPos + `![image](${imageUrl})`.length;
            textarea.dispatchEvent(new Event('input')); // Trigger preview update
        }
    });

    // Close button
    closeBtn.addEventListener('click', () => {
        overlay.classList.remove('open');
        currentEditingTool = null;
    });

    // Cancel button
    cancelBtn.addEventListener('click', () => {
        overlay.classList.remove('open');
        currentEditingTool = null;
    });

    // Save button
    saveBtn.addEventListener('click', () => {
        if (currentEditingTool) {
            const toolId = currentEditingTool;
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].customContent = textarea.value;
            saveToolCustomizations(toolCustomizations);

            // Update the tool content
            const tool = document.querySelector(`[data-tool="${toolId}"]`);
            if (tool) {
                const contentDiv = tool.querySelector('.tool-content');
                contentDiv.innerHTML = `<div class="markdown-content">${parseMarkdown(textarea.value)}</div>`;

                // Auto-resize tool to fit new content
                requestAnimationFrame(() => {
                    autoFitToolContent(tool, false);
                });
            }
        }
        overlay.classList.remove('open');
        currentEditingTool = null;
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
        if (currentEditingTool && confirm('Reset to default content? This will remove your custom content.')) {
            const toolId = currentEditingTool;
            if (toolCustomizations[toolId]) {
                delete toolCustomizations[toolId].customContent;
                saveToolCustomizations(toolCustomizations);
            }

            // Restore default content
            const tool = document.querySelector(`[data-tool="${toolId}"]`);
            if (tool) {
                const content = getToolContent(toolId);
                const contentDiv = tool.querySelector('.tool-content');
                contentDiv.innerHTML = content.html;
            }

            overlay.classList.remove('open');
            currentEditingTool = null;
        }
    });

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.classList.remove('open');
            currentEditingTool = null;
        }
    });

    // Helper to get coords from mouse or touch event (local to this scope)
    function getCoords(e) {
        if (e.touches && e.touches.length > 0) {
            return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
        }
        if (e.changedTouches && e.changedTouches.length > 0) {
            return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
        }
        return { clientX: e.clientX, clientY: e.clientY };
    }

    // Editor dragging
    let editorDrag = { isDragging: false, startX: 0, startY: 0, startLeft: 0, startTop: 0 };

    function startEditorDrag(e) {
        if (e.target.closest('.content-editor-close')) return;
        const coords = getCoords(e);
        editorDrag.isDragging = true;
        editorDrag.startX = coords.clientX;
        editorDrag.startY = coords.clientY;
        const rect = editor.getBoundingClientRect();
        editorDrag.startLeft = rect.left;
        editorDrag.startTop = rect.top;
        e.preventDefault();
    }

    header.addEventListener('mousedown', startEditorDrag);
    header.addEventListener('touchstart', startEditorDrag, { passive: false });

    function moveEditorDrag(e) {
        if (!editorDrag.isDragging) return;
        const coords = getCoords(e);
        const dx = coords.clientX - editorDrag.startX;
        const dy = coords.clientY - editorDrag.startY;
        const newLeft = Math.max(0, Math.min(window.innerWidth - editor.offsetWidth, editorDrag.startLeft + dx));
        const newTop = Math.max(0, Math.min(window.innerHeight - editor.offsetHeight, editorDrag.startTop + dy));
        editor.style.left = newLeft + 'px';
        editor.style.top = newTop + 'px';
    }

    document.addEventListener('mousemove', moveEditorDrag);
    document.addEventListener('touchmove', moveEditorDrag, { passive: false });

    function endEditorDrag() {
        editorDrag.isDragging = false;
    }

    document.addEventListener('mouseup', endEditorDrag);
    document.addEventListener('touchend', endEditorDrag);
    document.addEventListener('touchcancel', endEditorDrag);

    // Resizer for markdown/preview split
    let resizerState = { isResizing: false, startX: 0, startY: 0, startInputWidth: 0, startInputHeight: 0 };

    function startResizerDrag(e) {
        const coords = getCoords(e);
        resizerState.isResizing = true;
        resizerState.startX = coords.clientX;
        resizerState.startY = coords.clientY;
        resizerState.startInputWidth = inputPane.offsetWidth;
        resizerState.startInputHeight = inputPane.offsetHeight;
        resizer.classList.add('active');
        e.preventDefault();
    }

    resizer.addEventListener('mousedown', startResizerDrag);
    resizer.addEventListener('touchstart', startResizerDrag, { passive: false });

    function moveResizerDrag(e) {
        if (!resizerState.isResizing) return;
        const coords = getCoords(e);
        const editorBody = overlay.querySelector('.content-editor-body');

        // Check if we're in mobile vertical layout
        const isMobileLayout = window.innerWidth <= 768;

        if (isMobileLayout) {
            // Vertical resizing on mobile
            const dy = coords.clientY - resizerState.startY;
            const totalHeight = editorBody.offsetHeight - resizer.offsetHeight;
            const newInputHeight = Math.max(100, Math.min(totalHeight - 100, resizerState.startInputHeight + dy));
            const newPreviewHeight = totalHeight - newInputHeight;
            inputPane.style.flex = 'none';
            inputPane.style.height = newInputHeight + 'px';
            previewPane.style.flex = 'none';
            previewPane.style.height = newPreviewHeight + 'px';
        } else {
            // Horizontal resizing on desktop
            const dx = coords.clientX - resizerState.startX;
            const totalWidth = editorBody.offsetWidth - resizer.offsetWidth;
            const newInputWidth = Math.max(200, Math.min(totalWidth - 200, resizerState.startInputWidth + dx));
            const newPreviewWidth = totalWidth - newInputWidth;
            inputPane.style.flex = 'none';
            inputPane.style.width = newInputWidth + 'px';
            previewPane.style.flex = 'none';
            previewPane.style.width = newPreviewWidth + 'px';
        }
    }

    document.addEventListener('mousemove', moveResizerDrag);
    document.addEventListener('touchmove', moveResizerDrag, { passive: false });

    function endResizerDrag() {
        if (resizerState.isResizing) {
            resizerState.isResizing = false;
            resizer.classList.remove('active');
        }
    }

    document.addEventListener('mouseup', endResizerDrag);
    document.addEventListener('touchend', endResizerDrag);
    document.addEventListener('touchcancel', endResizerDrag);

    // Editor window resize
    let editorResize = { isResizing: false, handle: null, startX: 0, startY: 0, startWidth: 0, startHeight: 0 };

    editor.querySelectorAll('.content-editor-resize').forEach(handle => {
        function startEditorResize(e) {
            const coords = getCoords(e);
            editorResize.isResizing = true;
            editorResize.handle = handle.getAttribute('data-resize');
            editorResize.startX = coords.clientX;
            editorResize.startY = coords.clientY;
            editorResize.startWidth = editor.offsetWidth;
            editorResize.startHeight = editor.offsetHeight;
            e.preventDefault();
        }

        handle.addEventListener('mousedown', startEditorResize);
        handle.addEventListener('touchstart', startEditorResize, { passive: false });
    });

    function moveEditorResize(e) {
        if (!editorResize.isResizing) return;
        const coords = getCoords(e);
        const dx = coords.clientX - editorResize.startX;
        const dy = coords.clientY - editorResize.startY;

        if (editorResize.handle.includes('e')) {
            const newWidth = Math.max(500, editorResize.startWidth + dx);
            editor.style.width = newWidth + 'px';
        }
        if (editorResize.handle.includes('s')) {
            const newHeight = Math.max(300, editorResize.startHeight + dy);
            editor.style.height = newHeight + 'px';
        }
    }

    document.addEventListener('mousemove', moveEditorResize);
    document.addEventListener('touchmove', moveEditorResize, { passive: false });

    function endEditorResize() {
        editorResize.isResizing = false;
        editorResize.handle = null;
    }

    document.addEventListener('mouseup', endEditorResize);
    document.addEventListener('touchend', endEditorResize);
    document.addEventListener('touchcancel', endEditorResize);

    // Double-click on tool content to edit
    const toolboard = document.getElementById('toolboard');
    toolboard.addEventListener('dblclick', (e) => {
        // Don't trigger on interactive elements
        if (e.target.closest('input, button, select, textarea, a, .checklist-widget, .calendar-widget, .diff-widget, .seq-widget')) return;

        const toolContent = e.target.closest('.tool-content');
        if (!toolContent) return;

        const tool = toolContent.closest('.tool');
        if (!tool) return;

        const toolId = tool.getAttribute('data-tool');
        if (toolId) {
            e.preventDefault();
            openContentEditor(toolId);
        }
    });
}

function openContentEditor(toolId) {
    const overlay = document.getElementById('contentEditorOverlay');
    const editor = overlay.querySelector('.content-editor');
    const textarea = document.getElementById('contentEditorTextarea');
    const preview = document.getElementById('contentEditorPreview');
    const titleSpan = document.getElementById('editorToolTitle');
    const inputPane = overlay.querySelector('.content-editor-input');
    const previewPane = overlay.querySelector('.content-editor-preview');

    currentEditingTool = toolId;

    // Get tool info
    const custom = toolCustomizations[toolId] || {};
    const content = getToolContent(toolId);
    const displayTitle = custom.title || content.title;

    titleSpan.textContent = displayTitle;

    // Load existing custom content or convert default to markdown hint
    if (custom.customContent) {
        textarea.value = custom.customContent;
    } else {
        // Provide a hint with the tool name
        textarea.value = `# ${content.title}\n\nEdit this content using Markdown.\n\n**Note:** The default content will be replaced with your custom content.`;
    }

    // Reset pane widths to default 50/50
    inputPane.style.flex = '1';
    inputPane.style.width = '';
    previewPane.style.flex = '1';
    previewPane.style.width = '';

    // Center the editor
    editor.style.left = '';
    editor.style.top = '';

    preview.innerHTML = parseMarkdown(textarea.value);
    overlay.classList.add('open');

    // Center after opening (when dimensions are known)
    requestAnimationFrame(() => {
        const editorRect = editor.getBoundingClientRect();
        editor.style.left = (window.innerWidth - editorRect.width) / 2 + 'px';
        editor.style.top = (window.innerHeight - editorRect.height) / 2 + 'px';
    });

    textarea.focus();
}

// Toolboard settings
const DASHBOARD_COLORS = [
    '#2c3e50', '#34495e', '#1a252f', '#2980b9', '#3498db',
    '#8e44ad', '#9b59b6', '#16a085', '#1abc9c', '#27ae60',
    '#d35400', '#e67e22', '#c0392b', '#e74c3c', '#7f8c8d'
];

function loadToolboardSettings() {
    const defaults = { title: 'My Toolboard', color: '#2c3e50', fontFamily: '', fontSize: '' };
    const stored = localStorage.getItem(boardKey('toolboardSettings'));
    if (stored) {
        try {
            return { ...defaults, ...JSON.parse(stored) };
        } catch (e) {
            return defaults;
        }
    }
    return defaults;
}

function saveToolboardSettings(settings) {
    localStorage.setItem(boardKey('toolboardSettings'), JSON.stringify(settings));
    updateStorageIndicator();
}

let toolboardSettings = loadToolboardSettings();

function applyToolboardSettings() {
    const header = document.getElementById('mainHeader');
    const title = document.getElementById('toolboardTitle');
    const titleInput = document.getElementById('toolboardTitleInput');
    const colorPicker = document.getElementById('toolboardColorPicker');
    const fontFamilySelect = document.getElementById('toolboardFontFamily');
    const fontSizeSelect = document.getElementById('toolboardFontSize');
    const toolboard = document.getElementById('toolboard');

    title.textContent = toolboardSettings.title;
    header.style.background = toolboardSettings.color;
    titleInput.value = toolboardSettings.title;

    // Update browser tab title
    document.title = toolboardSettings.title + ' - Toolboard';

    // Populate color picker
    colorPicker.innerHTML = DASHBOARD_COLORS.map(c =>
        `<div class="color-swatch${toolboardSettings.color === c ? ' selected' : ''}" style="background: ${c}" data-color="${c}"></div>`
    ).join('');

    // Apply font settings
    if (fontFamilySelect) fontFamilySelect.value = toolboardSettings.fontFamily || '';
    if (fontSizeSelect) fontSizeSelect.value = toolboardSettings.fontSize || '';

    // Apply board-level fonts to toolboard
    if (toolboardSettings.fontFamily) {
        toolboard.style.fontFamily = toolboardSettings.fontFamily;
    } else {
        toolboard.style.fontFamily = '';
    }
    if (toolboardSettings.fontSize) {
        toolboard.style.fontSize = toolboardSettings.fontSize;
    } else {
        toolboard.style.fontSize = '';
    }

    // Re-apply tool-specific fonts (they override board settings)
    applyAllToolFonts();
}

function applyAllToolFonts() {
    document.querySelectorAll('.tool').forEach(tool => {
        const toolId = tool.getAttribute('data-tool');
        const custom = toolCustomizations[toolId] || {};
        const content = tool.querySelector('.tool-content');
        if (content) {
            if (custom.fontFamily) {
                content.style.fontFamily = custom.fontFamily;
            } else {
                content.style.fontFamily = '';
            }
            if (custom.fontSize) {
                content.style.fontSize = custom.fontSize;
            } else {
                content.style.fontSize = '';
            }
        }
    });
}

function applyToolFont(toolId) {
    const tool = document.querySelector(`.tool[data-tool="${toolId}"]`);
    if (!tool) return;
    const custom = toolCustomizations[toolId] || {};
    const content = tool.querySelector('.tool-content');
    if (content) {
        if (custom.fontFamily) {
            content.style.fontFamily = custom.fontFamily;
        } else {
            content.style.fontFamily = '';
        }
        if (custom.fontSize) {
            content.style.fontSize = custom.fontSize;
        } else {
            content.style.fontSize = '';
        }
    }
}

function setupToolboardSettings() {
    const settingsBtn = document.getElementById('toolboardSettingsBtn');
    const settingsPanel = document.getElementById('toolboardSettings');
    const titleInput = document.getElementById('toolboardTitleInput');
    const colorPicker = document.getElementById('toolboardColorPicker');
    const fontFamilySelect = document.getElementById('toolboardFontFamily');
    const fontSizeSelect = document.getElementById('toolboardFontSize');
    const header = document.getElementById('mainHeader');
    const title = document.getElementById('toolboardTitle');
    const toolboard = document.getElementById('toolboard');

    // Toggle settings panel
    settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close tool settings modal
        document.getElementById('toolSettingsOverlay').classList.remove('open');
        settingsPanel.classList.toggle('open');
    });

    // Title input
    titleInput.addEventListener('input', (e) => {
        toolboardSettings.title = e.target.value;
        title.textContent = e.target.value;
        saveToolboardSettings(toolboardSettings);
        // Update board name to match toolboard title
        renameBoardInSelector();
    });

    // Color picker
    colorPicker.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch')) {
            const color = e.target.getAttribute('data-color');
            toolboardSettings.color = color;
            header.style.background = color;
            colorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            e.target.classList.add('selected');
            saveToolboardSettings(toolboardSettings);
        }
    });

    // Font family select
    fontFamilySelect.addEventListener('change', (e) => {
        toolboardSettings.fontFamily = e.target.value;
        if (e.target.value) {
            toolboard.style.fontFamily = e.target.value;
        } else {
            toolboard.style.fontFamily = '';
        }
        saveToolboardSettings(toolboardSettings);
        applyAllToolFonts(); // Re-apply tool overrides
    });

    // Font size select
    fontSizeSelect.addEventListener('change', (e) => {
        toolboardSettings.fontSize = e.target.value;
        if (e.target.value) {
            toolboard.style.fontSize = e.target.value;
        } else {
            toolboard.style.fontSize = '';
        }
        saveToolboardSettings(toolboardSettings);
        applyAllToolFonts(); // Re-apply tool overrides
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.toolboard-settings') && !e.target.closest('#toolboardSettingsBtn')) {
            settingsPanel.classList.remove('open');
        }
    });
}

// Available colors for tool headers
const HEADER_COLORS = [
    '#8e44ad', '#9b59b6', '#3498db', '#2980b9', '#1abc9c',
    '#16a085', '#27ae60', '#2ecc71', '#f39c12', '#e67e22',
    '#d35400', '#e74c3c', '#c0392b', '#34495e', '#7f8c8d'
];

// Load tool customizations
function loadToolCustomizations() {
    const stored = localStorage.getItem(boardKey('toolCustomizations'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return {};
        }
    }
    return {};
}

// Save tool customizations
function saveToolCustomizations(customizations) {
    localStorage.setItem(boardKey('toolCustomizations'), JSON.stringify(customizations));
    updateStorageIndicator();
}

// Custom tools storage
function loadCustomTools() {
    const stored = localStorage.getItem(boardKey('customTools'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return [];
        }
    }
    return [];
}

function saveCustomTools(tools) {
    localStorage.setItem(boardKey('customTools'), JSON.stringify(tools));
    updateStorageIndicator();
}

// Hidden tools storage (for built-in tools that have been deleted)
function loadHiddenTools() {
    const stored = localStorage.getItem(boardKey('hiddenTools'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return [];
        }
    }
    return [];
}

function saveHiddenTools(tools) {
    localStorage.setItem(boardKey('hiddenTools'), JSON.stringify(tools));
    updateStorageIndicator();
}

let toolCustomizations = loadToolCustomizations();
let customTools = loadCustomTools();
let hiddenTools = loadHiddenTools();

// Create a tool element
function createTool(toolId) {
    const tool = document.createElement('div');
    tool.className = 'tool';
    tool.setAttribute('data-tool', toolId);

    const content = getToolContent(toolId);
    if (!content) return null;

    // Get customizations for this tool
    const custom = toolCustomizations[toolId] || {};
    const displayTitle = custom.title || content.title;
    const headerColor = custom.color || null;
    const isMinimized = custom.minimized || false;
    const isCustomTool = customTools.includes(toolId);

    tool.innerHTML = `
        <div class="tool-header"${headerColor ? ` style="background: ${headerColor}"` : ''}>
            <span class="tool-title">${displayTitle}</span>
            <div class="header-buttons">
                <button class="header-btn minimize-btn${isMinimized ? ' minimized' : ''}" title="Minimize">&#9650;</button>
                <button class="header-btn fullscreen-btn" title="Fullscreen"><svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="0" y="0" width="12" height="12" rx="1" stroke="currentColor" stroke-width="4" fill="none"/></svg></button>
                <button class="header-btn settings-btn" title="Settings">&#9881;</button>
            </div>
        </div>
        <div class="tool-content">
            ${custom.customContent ? `<div class="markdown-content">${parseMarkdown(custom.customContent)}</div>` : content.html}
        </div>
        <div class="resize-handle resize-handle-n" data-resize="n"></div>
        <div class="resize-handle resize-handle-s" data-resize="s"></div>
        <div class="resize-handle resize-handle-e" data-resize="e"></div>
        <div class="resize-handle resize-handle-w" data-resize="w"></div>
        <div class="resize-handle resize-handle-nw" data-resize="nw"></div>
        <div class="resize-handle resize-handle-ne" data-resize="ne"></div>
        <div class="resize-handle resize-handle-sw" data-resize="sw"></div>
        <div class="resize-handle resize-handle-se" data-resize="se"></div>
    `;

    // Apply minimized state
    if (isMinimized) {
        tool.classList.add('minimized');
    }

    // Apply position and size
    const pos = positions[toolId] || { x: 20, y: 20, z: 1 };
    tool.style.left = pos.x + 'px';
    tool.style.top = pos.y + 'px';
    tool.style.zIndex = pos.z || 1;

    // Apply saved dimensions if they exist
    if (pos.width) {
        tool.style.width = pos.width + 'px';
    }
    if (pos.height) {
        tool.style.height = pos.height + 'px';
    }

    // Apply tool-specific fonts
    const toolContent = tool.querySelector('.tool-content');
    if (toolContent) {
        if (custom.fontFamily) {
            toolContent.style.fontFamily = custom.fontFamily;
        }
        if (custom.fontSize) {
            toolContent.style.fontSize = custom.fontSize;
        }
    }

    return tool;
}

// Get content for each tool
function getToolContent(toolId) {
    // All tools are custom tools in the generic toolboard
    if (customTools.includes(toolId)) {
        const custom = toolCustomizations[toolId] || {};

        // Check if this tool uses a template with HTML content
        if (custom.templateId && NOTE_TEMPLATES[custom.templateId]) {
            const template = NOTE_TEMPLATES[custom.templateId];
            const isHtml = template.content.trim().startsWith('<');
            if (isHtml) {
                return {
                    title: custom.title || template.title,
                    html: template.content
                };
            }
        }

        return {
            title: custom.title || 'New Tool',
            html: custom.customContent ? `<div class="markdown-content">${parseMarkdown(custom.customContent)}</div>` : '<p>Click the settings gear and "Edit Content" to add content to this tool.</p>'
        };
    }
    return null;
}

// Helper to get coordinates from mouse or touch event
function getEventCoords(e) {
    if (e.touches && e.touches.length > 0) {
        return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
    }
    if (e.changedTouches && e.changedTouches.length > 0) {
        return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
    }
    return { clientX: e.clientX, clientY: e.clientY };
}

// Free-form Drag functionality
function setupDragging() {
    const toolboard = document.getElementById('toolboard');

    // Start drag handler (mouse and touch)
    function startDrag(e) {
        const header = e.target.closest('.tool-header');
        if (!header) return;

        // Don't drag if clicking buttons
        if (e.target.closest('.header-btn')) return;

        const tool = header.closest('.tool');
        if (!tool) return;

        e.preventDefault();

        const coords = getEventCoords(e);

        // Bring to front
        maxZ++;
        tool.style.zIndex = maxZ;

        const toolId = tool.getAttribute('data-tool');
        positions[toolId] = positions[toolId] || { x: 0, y: 0, z: 1 };
        positions[toolId].z = maxZ;

        // Start dragging
        dragState.isDragging = true;
        dragState.tool = tool;
        dragState.startX = coords.clientX;
        dragState.startY = coords.clientY;
        dragState.offsetX = tool.offsetLeft;
        dragState.offsetY = tool.offsetTop;

        tool.classList.add('dragging');
        document.body.classList.add('is-dragging');
    }

    // Mouse/touch down on tool header starts drag
    toolboard.addEventListener('mousedown', startDrag);
    toolboard.addEventListener('touchstart', startDrag, { passive: false });

    // Move handler (mouse and touch)
    function moveDrag(e) {
        if (!dragState.isDragging) return;

        const coords = getEventCoords(e);
        const dx = coords.clientX - dragState.startX;
        const dy = coords.clientY - dragState.startY;

        let newX = Math.max(0, dragState.offsetX + dx);
        let newY = Math.max(0, dragState.offsetY + dy);

        // Get snap positions
        const snapped = getSnapPosition(dragState.tool, newX, newY);
        newX = snapped.x;
        newY = snapped.y;

        dragState.tool.style.left = newX + 'px';
        dragState.tool.style.top = newY + 'px';

        // Show/hide snap guides
        updateSnapGuides(snapped.guides);
    }

    // Mouse/touch move updates position with snapping
    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchmove', moveDrag, { passive: false });

    // End drag handler (mouse and touch)
    function endDrag() {
        if (!dragState.isDragging) return;

        const tool = dragState.tool;
        const toolId = tool.getAttribute('data-tool');

        // Save position (preserve existing width/height if set)
        const existing = positions[toolId] || {};
        positions[toolId] = {
            x: tool.offsetLeft,
            y: tool.offsetTop,
            z: parseInt(tool.style.zIndex) || 1,
            width: existing.width || tool.offsetWidth,
            height: existing.height || tool.offsetHeight
        };
        savePositions(positions);

        tool.classList.remove('dragging');
        document.body.classList.remove('is-dragging');
        dragState.isDragging = false;
        dragState.tool= null;

        // Hide snap guides
        updateSnapGuides([]);
    }

    // Mouse/touch up ends drag and saves position
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
    document.addEventListener('touchcancel', endDrag);

    // Click on tool brings it to front
    toolboard.addEventListener('mousedown', (e) => {
        const tool = e.target.closest('.tool');
        if (!tool) return;

        // Only bring to front if not clicking header (header handles its own)
        if (!e.target.closest('.tool-header')) {
            maxZ++;
            tool.style.zIndex = maxZ;
            const toolId = tool.getAttribute('data-tool');
            positions[toolId] = positions[toolId] || { x: tool.offsetLeft, y: tool.offsetTop, z: 1 };
            positions[toolId].z = maxZ;
            savePositions(positions);
        }
    });
}

// Resize functionality
function setupResizing() {
    const toolboard = document.getElementById('toolboard');

    // Double-click/double-tap on resize handle for auto-resize
    toolboard.addEventListener('dblclick', (e) => {
        const handle = e.target.closest('.resize-handle');
        if (!handle) return;

        const tool = handle.closest('.tool');
        if (!tool) return;

        e.preventDefault();
        e.stopPropagation();

        const handleType = handle.getAttribute('data-resize');
        autoResizeTool(tool, handleType);
    });

    // Start resize handler (mouse and touch)
    function startResize(e) {
        const handle = e.target.closest('.resize-handle');
        if (!handle) return;

        const tool = handle.closest('.tool');
        if (!tool) return;

        e.preventDefault();
        e.stopPropagation();

        const coords = getEventCoords(e);

        // Bring to front
        maxZ++;
        tool.style.zIndex = maxZ;

        const toolId = tool.getAttribute('data-tool');
        positions[toolId] = positions[toolId] || { x: 0, y: 0, z: 1 };
        positions[toolId].z = maxZ;

        // Start resizing
        resizeState.isResizing = true;
        resizeState.tool = tool;
        resizeState.handle = handle.getAttribute('data-resize');
        resizeState.startX = coords.clientX;
        resizeState.startY = coords.clientY;
        resizeState.startWidth = tool.offsetWidth;
        resizeState.startHeight = tool.offsetHeight;
        resizeState.startLeft = tool.offsetLeft;
        resizeState.startTop = tool.offsetTop;

        handle.classList.add('active');
        tool.classList.add('resizing');
        document.body.classList.add('is-resizing');
    }

    // Mouse/touch down on resize handle starts resize
    toolboard.addEventListener('mousedown', startResize);
    toolboard.addEventListener('touchstart', startResize, { passive: false });

    // Move resize handler (mouse and touch)
    function moveResize(e) {
        if (!resizeState.isResizing) return;

        const coords = getEventCoords(e);
        const dx = coords.clientX - resizeState.startX;
        const dy = coords.clientY - resizeState.startY;
        const tool = resizeState.tool;
        const handle = resizeState.handle;

        let newWidth = resizeState.startWidth;
        let newHeight = resizeState.startHeight;
        let newLeft = resizeState.startLeft;
        let newTop = resizeState.startTop;

        const minWidth = 150;
        const minHeight = 100;

        // Handle resize based on which handle is being dragged
        if (handle.includes('e')) {
            newWidth = Math.max(minWidth, resizeState.startWidth + dx);
        }
        if (handle.includes('w')) {
            const proposedWidth = resizeState.startWidth - dx;
            if (proposedWidth >= minWidth) {
                newWidth = proposedWidth;
                newLeft = resizeState.startLeft + dx;
            }
        }
        if (handle.includes('s')) {
            newHeight = Math.max(minHeight, resizeState.startHeight + dy);
        }
        if (handle.includes('n')) {
            const proposedHeight = resizeState.startHeight - dy;
            if (proposedHeight >= minHeight) {
                newHeight = proposedHeight;
                newTop = resizeState.startTop + dy;
            }
        }

        // Apply snapping for resize edges
        const snapped = getResizeSnapPosition(tool, newLeft, newTop, newWidth, newHeight, handle);

        tool.style.width = snapped.width + 'px';
        tool.style.height = snapped.height + 'px';
        tool.style.left = snapped.left + 'px';
        tool.style.top = snapped.top + 'px';

        updateSnapGuides(snapped.guides);
    }

    // Mouse/touch move updates size
    document.addEventListener('mousemove', moveResize);
    document.addEventListener('touchmove', moveResize, { passive: false });

    // End resize handler (mouse and touch)
    function endResize() {
        if (!resizeState.isResizing) return;

        const tool = resizeState.tool;
        const toolId = tool.getAttribute('data-tool');

        // Save position and dimensions
        positions[toolId] = {
            x: tool.offsetLeft,
            y: tool.offsetTop,
            z: parseInt(tool.style.zIndex) || 1,
            width: tool.offsetWidth,
            height: tool.offsetHeight
        };
        savePositions(positions);

        // Clean up
        document.querySelectorAll('.resize-handle.active').forEach(h => h.classList.remove('active'));
        tool.classList.remove('resizing');
        document.body.classList.remove('is-resizing');
        resizeState.isResizing = false;
        resizeState.tool= null;
        resizeState.handle = null;

        updateSnapGuides([]);
    }

    // Mouse/touch up ends resize and saves dimensions
    document.addEventListener('mouseup', endResize);
    document.addEventListener('touchend', endResize);
    document.addEventListener('touchcancel', endResize);
}

// Auto-fit tool to its content (used on initial render)
function autoFitToolContent(tool, skipAnimation = false) {
    const toolId = tool.getAttribute('data-tool');
    const content = tool.querySelector('.tool-content');
    const header = tool.querySelector('.tool-header');

    if (!content || !header) return;

    // Temporarily remove constraints to measure natural size
    const originalWidth = tool.style.width;
    const originalHeight = tool.style.height;
    tool.style.width = 'auto';
    tool.style.height = 'auto';
    content.style.overflow = 'visible';

    // Force reflow
    tool.offsetHeight;

    // Measure natural dimensions with reasonable bounds
    const newWidth = Math.max(200, Math.min(600, content.scrollWidth + 30));
    const newHeight = Math.max(120, Math.min(500, content.scrollHeight + header.offsetHeight + 20));

    // Restore overflow
    content.style.overflow = '';

    // Apply dimensions
    if (!skipAnimation) {
        tool.style.transition = 'width 0.2s ease, height 0.2s ease';
    }

    tool.style.width = newWidth + 'px';
    tool.style.height = newHeight + 'px';

    if (!skipAnimation) {
        setTimeout(() => {
            tool.style.transition = '';
        }, 200);
    }

    // Save dimensions
    const existing = positions[toolId] || { x: tool.offsetLeft, y: tool.offsetTop, z: 1 };
    positions[toolId] = {
        x: existing.x,
        y: existing.y,
        z: existing.z,
        width: newWidth,
        height: newHeight
    };
    savePositions(positions);
}

// Auto-resize tool to fit content
function autoResizeTool(tool, handleType) {
    const toolId = tool.getAttribute('data-tool');
    const content = tool.querySelector('.tool-content');
    const header = tool.querySelector('.tool-header');

    // Determine which dimensions to auto-resize
    const autoWidth = handleType.includes('e') || handleType.includes('w');
    const autoHeight = handleType.includes('s') || handleType.includes('n');

    // Store current dimensions
    const currentWidth = tool.style.width;
    const currentHeight = tool.style.height;

    // Temporarily remove constraints to measure natural size
    if (autoWidth) {
        tool.style.width = 'auto';
        content.style.overflow = 'visible';
    }
    if (autoHeight) {
        tool.style.height = 'auto';
        content.style.overflow = 'visible';
    }

    // Force reflow
    tool.offsetHeight;

    // Measure natural dimensions
    let newWidth = tool.offsetWidth;
    let newHeight = tool.offsetHeight;

    // Add some padding for comfortable viewing
    if (autoWidth) {
        newWidth = Math.max(150, Math.min(800, content.scrollWidth + 30));
    }
    if (autoHeight) {
        newHeight = Math.max(100, Math.min(600, content.scrollHeight + header.offsetHeight + 10));
    }

    // Restore overflow
    content.style.overflow = '';

    // Apply new dimensions with animation
    tool.style.transition = 'width 0.2s ease, height 0.2s ease';

    if (autoWidth) {
        tool.style.width = newWidth + 'px';
    } else {
        tool.style.width = currentWidth;
    }

    if (autoHeight) {
        tool.style.height = newHeight + 'px';
    } else {
        tool.style.height = currentHeight;
    }

    // Remove transition after animation
    setTimeout(() => {
        tool.style.transition = '';
    }, 200);

    // Save new dimensions
    const existing = positions[toolId] || { x: tool.offsetLeft, y: tool.offsetTop, z: 1 };
    positions[toolId] = {
        x: existing.x,
        y: existing.y,
        z: existing.z,
        width: autoWidth ? newWidth : (existing.width || tool.offsetWidth),
        height: autoHeight ? newHeight : (existing.height || tool.offsetHeight)
    };
    savePositions(positions);
}

// Snapping for resize operations
function getResizeSnapPosition(tool, left, top, width, height, handle) {
    const toolboard = document.getElementById('toolboard');
    const tools = toolboard.querySelectorAll('.tool');

    const right = left + width;
    const bottom = top + height;

    let snapLeft = left;
    let snapTop = top;
    let snapWidth = width;
    let snapHeight = height;
    const guides = [];

    // Collect edges from other tools
    const verticalEdges = [0];
    const horizontalEdges = [0];

    tools.forEach(s => {
        if (s === tool) return;

        const sLeft = s.offsetLeft;
        const sTop = s.offsetTop;
        const sRight = sLeft + s.offsetWidth;
        const sBottom = sTop + s.offsetHeight;

        verticalEdges.push(sLeft, sRight);
        horizontalEdges.push(sTop, sBottom);
    });

    // Snap right edge (when resizing east)
    if (handle.includes('e')) {
        for (const edge of verticalEdges) {
            if (Math.abs(right - edge) < SNAP_THRESHOLD) {
                snapWidth = edge - left;
                guides.push({ type: 'vertical', pos: edge });
                break;
            }
        }
    }

    // Snap left edge (when resizing west)
    if (handle.includes('w')) {
        for (const edge of verticalEdges) {
            if (Math.abs(left - edge) < SNAP_THRESHOLD) {
                const diff = left - edge;
                snapLeft = edge;
                snapWidth = width + diff;
                guides.push({ type: 'vertical', pos: edge });
                break;
            }
        }
    }

    // Snap bottom edge (when resizing south)
    if (handle.includes('s')) {
        for (const edge of horizontalEdges) {
            if (Math.abs(bottom - edge) < SNAP_THRESHOLD) {
                snapHeight = edge - top;
                guides.push({ type: 'horizontal', pos: edge });
                break;
            }
        }
    }

    // Snap top edge (when resizing north)
    if (handle.includes('n')) {
        for (const edge of horizontalEdges) {
            if (Math.abs(top - edge) < SNAP_THRESHOLD) {
                const diff = top - edge;
                snapTop = edge;
                snapHeight = height + diff;
                guides.push({ type: 'horizontal', pos: edge });
                break;
            }
        }
    }

    return {
        left: Math.max(0, snapLeft),
        top: Math.max(0, snapTop),
        width: Math.max(150, snapWidth),
        height: Math.max(100, snapHeight),
        guides
    };
}

// Snapping functionality
function getSnapPosition(draggedTool, x, y) {
    const toolboard = document.getElementById('toolboard');
    const tools = toolboard.querySelectorAll('.tool');
    const width = draggedTool.offsetWidth;
    const height = draggedTool.offsetHeight;

    // Dragged tool edges
    const dragLeft = x;
    const dragRight = x + width;
    const dragTop = y;
    const dragBottom = y + height;

    let snapX = x;
    let snapY = y;
    let bestDiffX = SNAP_THRESHOLD;
    let bestDiffY = SNAP_THRESHOLD;
    const guides = [];

    // Collect all edges from other tools
    const verticalEdges = [0]; // Toolboard left edge
    const horizontalEdges = [0]; // Toolboard top edge

    tools.forEach(t => {
        if (t === draggedTool) return;

        const left = t.offsetLeft;
        const top = t.offsetTop;
        const right = left + t.offsetWidth;
        const bottom = top + t.offsetHeight;

        verticalEdges.push(left, right);
        horizontalEdges.push(top, bottom);
    });

    // Find best vertical snap (X position)
    for (const edge of verticalEdges) {
        // Snap left edge of dragged to this edge
        const diffLeft = Math.abs(dragLeft - edge);
        if (diffLeft < bestDiffX) {
            bestDiffX = diffLeft;
            snapX = edge;
        }

        // Snap right edge of dragged to this edge
        const diffRight = Math.abs(dragRight - edge);
        if (diffRight < bestDiffX) {
            bestDiffX = diffRight;
            snapX = edge - width;
        }
    }

    // Find best horizontal snap (Y position)
    for (const edge of horizontalEdges) {
        // Snap top edge of dragged to this edge
        const diffTop = Math.abs(dragTop - edge);
        if (diffTop < bestDiffY) {
            bestDiffY = diffTop;
            snapY = edge;
        }

        // Snap bottom edge of dragged to this edge
        const diffBottom = Math.abs(dragBottom - edge);
        if (diffBottom < bestDiffY) {
            bestDiffY = diffBottom;
            snapY = edge - height;
        }
    }

    // Add guides for snapped edges
    if (bestDiffX < SNAP_THRESHOLD) {
        // Determine which edge we snapped to
        const snappedEdge = (snapX === x) ? snapX : snapX + width;
        guides.push({ type: 'vertical', pos: snappedEdge });
    }

    if (bestDiffY < SNAP_THRESHOLD) {
        const snappedEdge = (snapY === y) ? snapY : snapY + height;
        guides.push({ type: 'horizontal', pos: snappedEdge });
    }

    return { x: Math.max(0, snapX), y: Math.max(0, snapY), guides };
}

function updateSnapGuides(guides) {
    // Remove existing guides
    document.querySelectorAll('.snap-guide').forEach(el => el.remove());

    if (guides.length === 0) return;

    const toolboard = document.getElementById('toolboard');

    guides.forEach(guide => {
        const el = document.createElement('div');
        el.className = 'snap-guide';

        if (guide.type === 'vertical') {
            el.style.cssText = `
                position: absolute;
                left: ${guide.pos}px;
                top: 0;
                width: 2px;
                height: 100%;
                background: #3498db;
                pointer-events: none;
                z-index: 9999;
            `;
        } else {
            el.style.cssText = `
                position: absolute;
                left: 0;
                top: ${guide.pos}px;
                width: 100%;
                height: 2px;
                background: #3498db;
                pointer-events: none;
                z-index: 9999;
            `;
        }

        toolboard.appendChild(el);
    });
}

// Import/Export functionality
function setupImportExport() {
    const modal = document.getElementById('importExportModal');
    const closeBtn = modal.querySelector('.import-export-close');
    const tabs = modal.querySelectorAll('.import-export-tab');
    const exportTool = document.getElementById('exportTool');
    const importTool = document.getElementById('importTool');

    // Open modal
    document.getElementById('importExportBtn').onclick = () => {
        populateExportLists();
        modal.classList.add('open');
    };

    // Close modal
    closeBtn.onclick = () => modal.classList.remove('open');
    modal.onclick = (e) => {
        if (e.target === modal) modal.classList.remove('open');
    };

    const restoreTool = document.getElementById('restoreTool');

    // Tab switching
    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            exportTool.classList.remove('active');
            importTool.classList.remove('active');
            restoreTool.classList.remove('active');

            if (tab.dataset.tab === 'export') {
                exportTool.classList.add('active');
            } else if (tab.dataset.tab === 'import') {
                importTool.classList.add('active');
            } else if (tab.dataset.tab === 'restore') {
                restoreTool.classList.add('active');
                populateHiddenNotesList();
            }
        };
    });

    // Export buttons
    document.getElementById('exportSelectedTools').onclick = exportTools;
    document.getElementById('exportSelectedBoards').onclick = exportBoards;
    document.getElementById('exportBoardAsHTML').onclick = exportBoardAsHTML;
    document.getElementById('exportBoardAsPNG').onclick = exportBoardAsPNG;

    // Import
    document.getElementById('importDataBtn').onclick = importData;
    document.getElementById('importFileInput').onchange = handleFileImport;

    // Restore
    document.getElementById('restoreSelectedTools').onclick = restoreSelectedTools;
}

// Feature Selection Modal
function setupFeatureSelect() {
    const modal = document.getElementById('featureSelectModal');
    const closeBtn = modal.querySelector('.feature-select-close');
    const list = document.getElementById('featureSelectList');

    // Close modal
    closeBtn.onclick = () => modal.classList.remove('open');
    modal.onclick = (e) => {
        if (e.target === modal) modal.classList.remove('open');
    };

    // Populate list
    populateFeatureList();

    // Handle feature selection
    list.addEventListener('click', (e) => {
        const item = e.target.closest('.feature-select-item');
        if (!item) return;

        const templateId = item.getAttribute('data-template');
        modal.classList.remove('open');
        createNoteWithTemplate(templateId);
    });
}

function populateFeatureList() {
    const list = document.getElementById('featureSelectList');
    list.innerHTML = Object.values(NOTE_TEMPLATES).map(template => `
        <div class="feature-select-item" data-template="${template.id}">
            <div class="feature-select-icon">${template.icon}</div>
            <div class="feature-select-info">
                <div class="feature-select-name">${template.name}</div>
                <div class="feature-select-description">${template.description}</div>
            </div>
        </div>
    `).join('');
}

function openFeatureSelectModal() {
    const modal = document.getElementById('featureSelectModal');
    modal.classList.add('open');
}

function createNoteWithTemplate(templateId) {
    const template = NOTE_TEMPLATES[templateId];
    if (!template) return;

    // Generate unique ID
    const toolId = 'custom-' + Date.now();

    // Add to custom notes list
    customTools.push(toolId);
    saveCustomTools(customTools);

    // Determine if content is HTML or Markdown
    const isHtml = template.content.trim().startsWith('<');

    // Initialize customizations with template content
    toolCustomizations[toolId] = {
        title: template.title,
        templateId: templateId, // Store template ID for HTML templates
        customContent: isHtml ? '' : template.content // Only store markdown in customContent
    };
    saveToolCustomizations(toolCustomizations);

    // Create and add the note to the toolboard
    const tool = createTool(toolId);
    if (tool) {
        const toolboard = document.getElementById('toolboard');
        toolboard.appendChild(tool);

        // Position it in a visible area with slight offset from others
        const offset = customTools.length * 20;
        tool.style.left = (100 + offset) + 'px';
        tool.style.top = (100 + offset) + 'px';

        // Bring to front
        maxZ++;
        tool.style.zIndex = maxZ;

        // Call onInit first if specified, then auto-fit after dynamic content renders
        const doAutoFit = () => {
            requestAnimationFrame(() => {
                autoFitToolContent(tool, false);

                // Update position with auto-fit dimensions
                positions[toolId] = {
                    x: 100 + offset,
                    y: 100 + offset,
                    width: tool.offsetWidth,
                    height: tool.offsetHeight,
                    z: maxZ
                };
                savePositions(positions);
            });
        };

        if (template.onInit && typeof window[template.onInit] === 'function') {
            // Call onInit first, then auto-fit after dynamic content has rendered
            setTimeout(() => {
                window[template.onInit]();
                // Wait for dynamic content to render before auto-fitting
                setTimeout(doAutoFit, 50);
            }, 50);
        } else {
            // No onInit, auto-fit immediately
            doAutoFit();
        }

        // For blank tools, open the content editor immediately
        if (templateId === 'blank') {
            openContentEditor(toolId);
        }
    }
}

function populateExportLists() {
    // Populate notes list (exclude hidden notes)
    const notesList = document.getElementById('exportToolsList');
    const visibleBuiltIn = SECTIONS.filter(id => !hiddenTools.includes(id));
    const allNotes = [...visibleBuiltIn, ...customTools];

    notesList.innerHTML = `
        <label class="select-all-row">
            <input type="checkbox" id="selectAllNotes"> <strong>Select All</strong>
        </label>
        ${allNotes.map(toolId => {
            const custom = toolCustomizations[toolId] || {};
            const content = getToolContent(toolId);
            const title = custom.title || (content ? content.title : toolId);
            const isCustom = customTools.includes(toolId);
            return `<label>
                <input type="checkbox" class="tool-checkbox" value="${toolId}">
                ${title}${isCustom ? ' <em>(custom)</em>' : ''}
            </label>`;
        }).join('')}
    `;

    // Select all for notes
    document.getElementById('selectAllNotes').onchange = (e) => {
        notesList.querySelectorAll('.tool-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
        });
    };

    // Populate boards list
    const boardsList = document.getElementById('exportBoardsList');
    boardsList.innerHTML = `
        <label class="select-all-row">
            <input type="checkbox" id="selectAllBoards"> <strong>Select All</strong>
        </label>
        ${boards.map(board => `<label>
            <input type="checkbox" class="board-checkbox" value="${board.id}"${board.id === currentBoardId ? ' checked' : ''}>
            ${board.name}${board.id === currentBoardId ? ' <em>(current)</em>' : ''}
        </label>`).join('')}
    `;

    // Select all for boards
    document.getElementById('selectAllBoards').onchange = (e) => {
        boardsList.querySelectorAll('.board-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
        });
    };
}

function populateHiddenNotesList() {
    const list = document.getElementById('hiddenToolsList');
    const resultDiv = document.getElementById('restoreResult');
    resultDiv.innerHTML = '';

    if (hiddenTools.length === 0) {
        list.innerHTML = '<p style="color: #7f8c8d; padding: 10px;">No hidden notes. All built-in notes are visible.</p>';
        return;
    }

    list.innerHTML = `
        <label class="select-all-row">
            <input type="checkbox" id="selectAllHidden"> <strong>Select All</strong>
        </label>
        ${hiddenTools.map(toolId => {
            const content = getToolContent(toolId);
            const title = content ? content.title : toolId;
            return `<label>
                <input type="checkbox" class="hidden-note-checkbox" value="${toolId}">
                ${title}
            </label>`;
        }).join('')}
    `;

    document.getElementById('selectAllHidden').onchange = (e) => {
        list.querySelectorAll('.hidden-note-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
        });
    };
}

function restoreSelectedTools() {
    const checkboxes = document.querySelectorAll('.hidden-note-checkbox:checked');
    const resultDiv = document.getElementById('restoreResult');

    if (checkboxes.length === 0) {
        alert('Please select at least one note to restore.');
        return;
    }

    const notesToRestore = [];
    checkboxes.forEach(cb => {
        notesToRestore.push(cb.value);
    });

    // Remove from hidden notes
    hiddenTools = hiddenTools.filter(id => !notesToRestore.includes(id));
    saveHiddenTools(hiddenTools);

    // Refresh UI
    renderToolboard();
    populateHiddenNotesList();
    populateExportLists();

    resultDiv.className = 'import-result success';
    resultDiv.textContent = `Successfully restored ${notesToRestore.length} note(s).`;
}

function exportTools() {
    const checkboxes = document.querySelectorAll('.tool-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one note to export.');
        return;
    }

    const exportData = {
        type: 'tools',
        exportedAt: new Date().toISOString(),
        tools: []
    };

    checkboxes.forEach(cb => {
        const toolId = cb.value;
        const toolData = {
            id: toolId,
            isCustom: customTools.includes(toolId),
            customizations: toolCustomizations[toolId] || {},
            position: positions[toolId] || null
        };
        exportData.tools.push(toolData);
    });

    downloadJSON(exportData, `tools-export-${getTimestamp()}.json`);
}

function exportBoards() {
    const checkboxes = document.querySelectorAll('.board-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one board to export.');
        return;
    }

    const exportData = {
        type: 'boards',
        exportedAt: new Date().toISOString(),
        boards: []
    };

    checkboxes.forEach(cb => {
        const boardId = cb.value;
        const board = boards.find(b => b.id === boardId);

        // Get board-specific data
        const boardData = {
            id: boardId,
            name: board.name,
            variables: JSON.parse(localStorage.getItem(`finance_${boardId}_variables`) || 'null'),
            positions: JSON.parse(localStorage.getItem(`finance_${boardId}_positions`) || '{}'),
            toolCustomizations: JSON.parse(localStorage.getItem(`finance_${boardId}_toolCustomizations`) || '{}'),
            customTools: JSON.parse(localStorage.getItem(`finance_${boardId}_customTools`) || '[]'),
            hiddenTools: JSON.parse(localStorage.getItem(`finance_${boardId}_hiddenTools`) || '[]'),
            toolboardSettings: JSON.parse(localStorage.getItem(`finance_${boardId}_toolboardSettings`) || 'null')
        };

        exportData.boards.push(boardData);
    });

    downloadJSON(exportData, `boards-export-${getTimestamp()}.json`);
}

function getTimestamp() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() +
        pad(now.getMonth() + 1) +
        pad(now.getDate()) +
        pad(now.getHours()) +
        pad(now.getMinutes()) +
        pad(now.getSeconds());
}

function downloadJSON(data, filename) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportBoardAsHTML() {
    // Get current board data
    const boardTitle = document.getElementById('toolboardTitle').textContent || 'toolboard';
    const safeTitle = boardTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();

    const embeddedData = {
        boards: [{ id: 'default', name: boardTitle }],
        currentBoard: 'default',
        variables: variables,
        positions: positions,
        toolCustomizations: toolCustomizations,
        customTools: customTools,
        hiddenTools: hiddenTools,
        toolboardSettings: toolboardSettings
    };

    // Close modal before capturing HTML
    const modal = document.getElementById('importExportModal');
    modal.classList.remove('open');

    // Get the full HTML of the current document
    const originalHTML = document.documentElement.outerHTML;

    // Reopen modal briefly so user sees it close after download
    modal.classList.add('open');

    // Create the embedded data script that will auto-import on load
    // Note: <\/script> is escaped to prevent breaking the outer script block
    const embedScript = '<scr' + 'ipt id="embedded-board-data" type="application/json">\n' +
        JSON.stringify(embeddedData, null, 2) +
        '\n<\/scr' + 'ipt>\n' +
        '<scr' + 'ipt>\n' +
        '// Auto-import embedded board data on load\n' +
        '(function() {\n' +
        '    var dataScript = document.getElementById("embedded-board-data");\n' +
        '    if (!dataScript) return;\n' +
        '    try {\n' +
        '        var data = JSON.parse(dataScript.textContent);\n' +
        '        localStorage.setItem("financeBoards", JSON.stringify(data.boards));\n' +
        '        localStorage.setItem("financeCurrentBoard", "default");\n' +
        '        localStorage.setItem("finance_default_variables", JSON.stringify(data.variables));\n' +
        '        localStorage.setItem("finance_default_positions", JSON.stringify(data.positions));\n' +
        '        localStorage.setItem("finance_default_toolCustomizations", JSON.stringify(data.toolCustomizations));\n' +
        '        localStorage.setItem("finance_default_customTools", JSON.stringify(data.customTools));\n' +
        '        localStorage.setItem("finance_default_hiddenTools", JSON.stringify(data.hiddenTools));\n' +
        '        localStorage.setItem("finance_default_toolboardSettings", JSON.stringify(data.toolboardSettings));\n' +
        '        dataScript.remove();\n' +
        '    } catch (e) { console.error("Failed to import embedded board data:", e); }\n' +
        '})();\n' +
        '<\/scr' + 'ipt>\n';

    // Insert the embed script just before </head>
    const htmlContent = '<!DOCTYPE html>\n' + originalHTML.replace('</head>', embedScript + '</head>');

    // Download
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${safeTitle}-${getTimestamp()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Close modal
    document.getElementById('importExportModal').classList.remove('open');
}

function exportBoardAsPNG() {
    // Load html2canvas dynamically if not already loaded
    if (typeof html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = () => captureAndDownloadPNG();
        script.onerror = () => alert('Failed to load image export library. Please check your internet connection.');
        document.head.appendChild(script);
    } else {
        captureAndDownloadPNG();
    }
}

function captureAndDownloadPNG() {
    const boardTitle = document.getElementById('toolboardTitle').textContent || 'toolboard';
    const safeTitle = boardTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();

    // Close modal first so it's not in the screenshot
    document.getElementById('importExportModal').classList.remove('open');

    // Small delay to let the modal close
    setTimeout(() => {
        // Capture the entire page
        html2canvas(document.body, {
            backgroundColor: getComputedStyle(document.body).backgroundColor || '#1a1a2e',
            scale: 2, // Higher quality
            useCORS: true,
            logging: false,
            windowWidth: document.documentElement.scrollWidth,
            windowHeight: document.documentElement.scrollHeight
        }).then(canvas => {
            // Download the image
            const link = document.createElement('a');
            link.download = `${safeTitle}-${getTimestamp()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error('PNG export error:', err);
            alert('Failed to export as PNG. Please try again.');
        });
    }, 100);
}

function handleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        document.getElementById('importTextarea').value = event.target.result;
    };
    reader.readAsText(file);
}

function importData() {
    const textarea = document.getElementById('importTextarea');
    const resultDiv = document.getElementById('importResult');

    try {
        const data = JSON.parse(textarea.value);

        if (data.type === 'tools' || data.type === 'notes') {
            importTools(data);
            resultDiv.className = 'import-result success';
            const toolsList = data.tools || data.notes;
            resultDiv.textContent = `Successfully imported ${toolsList.length} tool(s).`;
        } else if (data.type === 'boards') {
            importBoards(data);
            resultDiv.className = 'import-result success';
            resultDiv.textContent = `Successfully imported ${data.boards.length} board(s).`;
        } else {
            throw new Error('Unknown export format. Expected "tools" or "boards" type.');
        }

        // Refresh the UI
        renderToolboard();
        populateBoardSelector();
        populateExportLists();

    } catch (err) {
        resultDiv.className = 'import-result error';
        resultDiv.textContent = `Error: ${err.message}`;
    }
}

function importTools(data) {
    const toolsList = data.tools || data.notes; // Support both new and old format
    toolsList.forEach(toolData => {
        let toolId = toolData.id;

        // If it's a custom tool, check for conflicts
        if (toolData.isCustom) {
            // Generate new ID if already exists
            if (customTools.includes(toolId)) {
                toolId = 'custom-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            }
            // Add to custom tools
            if (!customTools.includes(toolId)) {
                customTools.push(toolId);
            }
        }

        // Import customizations
        if (toolData.customizations && Object.keys(toolData.customizations).length > 0) {
            toolCustomizations[toolId] = { ...toolData.customizations };
        }

        // Import position (with offset if position exists)
        if (toolData.position) {
            const pos = { ...toolData.position };
            // Offset if position already taken
            if (positions[toolId]) {
                pos.x = (pos.x || 0) + 30;
                pos.y = (pos.y || 0) + 30;
            }
            pos.z = ++maxZ;
            positions[toolId] = pos;
        }
    });

    // Save changes
    saveCustomTools(customTools);
    saveToolCustomizations(toolCustomizations);
    savePositions(positions);
}

function importBoards(data) {
    data.boards.forEach(boardData => {
        let boardId = boardData.id;

        // Check for conflicts and generate new ID if needed
        if (boards.some(b => b.id === boardId)) {
            boardId = 'board-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
        }

        // Add board to list
        boards.push({
            id: boardId,
            name: boardData.name || 'Imported Board'
        });

        // Save board-specific data
        if (boardData.variables) {
            localStorage.setItem(`finance_${boardId}_variables`, JSON.stringify(boardData.variables));
        }
        if (boardData.positions) {
            localStorage.setItem(`finance_${boardId}_positions`, JSON.stringify(boardData.positions));
        }
        if (boardData.toolCustomizations) {
            localStorage.setItem(`finance_${boardId}_toolCustomizations`, JSON.stringify(boardData.toolCustomizations));
        }
        if (boardData.customTools) {
            localStorage.setItem(`finance_${boardId}_customTools`, JSON.stringify(boardData.customTools));
        }
        if (boardData.hiddenTools) {
            localStorage.setItem(`finance_${boardId}_hiddenTools`, JSON.stringify(boardData.hiddenTools));
        }
        if (boardData.toolboardSettings) {
            localStorage.setItem(`finance_${boardId}_toolboardSettings`, JSON.stringify(boardData.toolboardSettings));
        }
    });

    // Save updated boards list
    saveBoards(boards);
}

function setupButtons() {
    document.getElementById('addToolBtn').onclick = addNewNote;

    // Delete board button
    document.getElementById('deleteBoardBtn').onclick = deleteCurrentBoard;

    // Board selector
    document.getElementById('boardSelector').onchange = (e) => {
        const value = e.target.value;
        if (value === '__new__') {
            createNewBoard();
        } else {
            switchToBoard(value);
        }
    };
}

// Add a new custom note - now shows feature selection modal
function addNewNote() {
    openFeatureSelectModal();
}

// Delete a custom note
function deleteTool(toolId) {
    const isCustom = customTools.includes(toolId);
    const isBuiltIn = SECTIONS.includes(toolId);

    if (!isCustom && !isBuiltIn) return;

    const message = isCustom
        ? 'Delete this note? This cannot be undone.'
        : 'Hide this note? You can restore it later from the Import/Export menu.';

    if (confirm(message)) {
        if (isCustom) {
            // Remove from customTools array
            customTools = customTools.filter(id => id !== toolId);
            saveCustomTools(customTools);

            // Remove customizations
            delete toolCustomizations[toolId];
            saveToolCustomizations(toolCustomizations);

            // Remove position data
            delete positions[toolId];
            savePositions(positions);
        } else {
            // Hide built-in note
            if (!hiddenTools.includes(toolId)) {
                hiddenTools.push(toolId);
                saveHiddenTools(hiddenTools);
            }
        }

        // Remove from DOM
        const tool = document.querySelector(`[data-tool="${toolId}"]`);
        if (tool) {
            tool.remove();
        }
    }
}

// Duplicate a tool
function duplicateTool(toolId) {
    const sourceCustom = toolCustomizations[toolId] || {};
    const sourcePos = positions[toolId] || { x: 50, y: 50 };

    // Generate new tool ID
    const newToolId = 'tool_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Add to custom tools
    customTools.push(newToolId);
    saveCustomTools(customTools);

    // Copy customizations (deep clone)
    toolCustomizations[newToolId] = JSON.parse(JSON.stringify(sourceCustom));
    toolCustomizations[newToolId].title = (sourceCustom.title || 'Tool') + ' (Copy)';
    saveToolCustomizations(toolCustomizations);

    // Set position offset from original
    positions[newToolId] = {
        x: sourcePos.x + 30,
        y: sourcePos.y + 30,
        z: ++maxZ,
        width: sourcePos.width,
        height: sourcePos.height
    };
    savePositions(positions);

    // Create and add the tool to DOM
    const tool = createTool(newToolId);
    if (tool) {
        document.getElementById('toolboard').appendChild(tool);
        // Initialize if it's a checklist or calculator
        initializeCalculators();
    }
}

// Export a tool as HTML file
function exportToolAsHtml(toolId) {
    const custom = toolCustomizations[toolId] || {};
    const content = getToolContent(toolId);
    const title = custom.title || content.title || 'Tool';
    const headerColor = custom.color || '#34495e';

    // Check if this is an interactive tool that needs the full app
    const noteEl = document.querySelector(`[data-tool="${toolId}"]`);
    const contentEl = noteEl?.querySelector('.tool-content');
    const isInteractiveTool = contentEl?.querySelector('.seq-widget, .diff-widget, .calendar-widget, .loan-calc-widget, .jwt-widget');

    if (isInteractiveTool) {
        // Use full-app export for interactive tools
        exportToolAsFullHtml(toolId, title);
        return;
    }

    // Simple export for static content
    let bodyContent = '';

    if (contentEl) {
        bodyContent = contentEl.innerHTML;
    }

    // If it's a checklist, render it nicely for export
    if (custom.checklistItems && custom.checklistItems.length > 0) {
        bodyContent = renderChecklistForExport(custom.checklistItems);
    }

    const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(title)}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        .tool {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }
        .tool-header {
            background: ${headerColor};
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
        }
        .tool-content {
            padding: 20px;
        }
        h1, h2, h3, h4, h5, h6 { margin: 1em 0 0.5em; color: #2c3e50; }
        p { margin: 0.5em 0; }
        ul, ol { margin: 0.5em 0; padding-left: 1.5em; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
        pre { background: #f4f4f4; padding: 12px; border-radius: 4px; overflow-x: auto; }
        pre code { background: none; padding: 0; }
        table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
        blockquote { border-left: 3px solid #3498db; margin: 1em 0; padding-left: 1em; color: #666; }
        a { color: #3498db; }
        img { max-width: 100%; height: auto; }
        .checklist { list-style: none; padding: 0; }
        .checklist-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .checklist-item:last-child { border-bottom: none; }
        .status { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .status.completed { background: #27ae60; border-color: #27ae60; color: white; }
        .status.in_progress { background: #f39c12; border-color: #f39c12; color: white; font-size: 10px; }
        .item-text { flex: 1; }
        .item-text.completed { text-decoration: line-through; color: #999; }
        .subitems { margin-left: 30px; padding-left: 10px; border-left: 2px solid #eee; }
        .exported-date { text-align: center; color: #999; font-size: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="tool">
        <div class="tool-header">${escapeHtml(title)}</div>
        <div class="tool-content">
            ${bodyContent}
            <div class="exported-date">Exported from Toolboard.me on ${new Date().toLocaleDateString()}</div>
        </div>
    </div>
</body>
</html>`;

    // Download the file
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Export interactive tool as full standalone HTML (like board export but single tool)
function exportToolAsFullHtml(toolId, title) {
    const custom = toolCustomizations[toolId] || {};
    const pos = positions[toolId] || {};

    // Create minimal data for just this one tool
    const embeddedData = {
        boards: [{ id: 'default', name: title }],
        currentBoard: 'default',
        variables: {},
        positions: {
            [toolId]: {
                x: 50,
                y: 20,
                w: pos.w || 500,
                h: pos.h || 400,
                z: 1
            }
        },
        toolCustomizations: {
            [toolId]: custom
        },
        customTools: customTools.includes(toolId) ? [toolId] : [],
        hiddenTools: customTools.filter(id => id !== toolId),
        toolboardSettings: {
            title: title,
            color: custom.color || toolboardSettings.color || '#34495e'
        }
    };

    // Close any open modals
    document.querySelectorAll('.modal.open, .tool-settings.open').forEach(m => m.classList.remove('open'));

    // Get the full HTML of the current document
    const originalHTML = document.documentElement.outerHTML;

    // Create the embedded data script that will auto-import on load
    const embedScript = '<scr' + 'ipt id="embedded-tool-data" type="application/json">\n' +
        JSON.stringify(embeddedData, null, 2) +
        '\n<\/scr' + 'ipt>\n' +
        '<scr' + 'ipt>\n' +
        '// Auto-import embedded tool data on load\n' +
        '(function() {\n' +
        '    var dataScript = document.getElementById("embedded-tool-data");\n' +
        '    if (!dataScript) return;\n' +
        '    try {\n' +
        '        var data = JSON.parse(dataScript.textContent);\n' +
        '        localStorage.setItem("financeBoards", JSON.stringify(data.boards));\n' +
        '        localStorage.setItem("financeCurrentBoard", "default");\n' +
        '        localStorage.setItem("finance_default_variables", JSON.stringify(data.variables));\n' +
        '        localStorage.setItem("finance_default_positions", JSON.stringify(data.positions));\n' +
        '        localStorage.setItem("finance_default_toolCustomizations", JSON.stringify(data.toolCustomizations));\n' +
        '        localStorage.setItem("finance_default_customTools", JSON.stringify(data.customTools));\n' +
        '        localStorage.setItem("finance_default_hiddenTools", JSON.stringify(data.hiddenTools));\n' +
        '        localStorage.setItem("finance_default_toolboardSettings", JSON.stringify(data.toolboardSettings));\n' +
        '        dataScript.remove();\n' +
        '    } catch (e) { console.error("Failed to import embedded tool data:", e); }\n' +
        '})();\n' +
        '<\/scr' + 'ipt>\n';

    // Insert the embed script just before </head>
    const htmlContent = '<!DOCTYPE html>\n' + originalHTML.replace('</head>', embedScript + '</head>');

    // Download
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Render checklist items for HTML export
function renderChecklistForExport(items, isSublist = false) {
    const listClass = isSublist ? 'subitems' : 'checklist';
    let html = `<ul class="${listClass}">`;

    items.forEach(item => {
        const status = item.status || 'pending';
        const statusIcon = status === 'completed' ? '✓' : (status === 'in_progress' ? '▶' : '');
        const textClass = status === 'completed' ? 'completed' : '';

        html += `<li class="checklist-item">
            <span class="status ${status}">${statusIcon}</span>
            <span class="item-text ${textClass}">${escapeHtml(item.text)}</span>
        </li>`;

        if (item.children && item.children.length > 0) {
            html += renderChecklistForExport(item.children, true);
        }
    });

    html += '</ul>';
    return html;
}

// Export a note as PNG image
async function exportToolAsPng(toolId) {
    const noteEl = document.querySelector(`[data-tool="${toolId}"]`);
    if (!noteEl) return;

    const custom = toolCustomizations[toolId] || {};
    const content = getToolContent(toolId);
    const title = custom.title || content.title || 'Note';

    // Store original styles
    const originalPosition = noteEl.style.position;
    const originalTransform = noteEl.style.transform;
    const originalBoxShadow = noteEl.style.boxShadow;

    try {
        // Temporarily adjust note for better capture
        noteEl.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';

        // Use html2canvas to capture the note
        const canvas = await html2canvas(noteEl, {
            backgroundColor: null,
            scale: 2, // Higher resolution
            logging: false,
            useCORS: true,
            allowTaint: true
        });

        // Restore original styles
        noteEl.style.position = originalPosition;
        noteEl.style.transform = originalTransform;
        noteEl.style.boxShadow = originalBoxShadow;

        // Convert to PNG and download
        const link = document.createElement('a');
        link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (error) {
        // Restore original styles on error
        noteEl.style.position = originalPosition;
        noteEl.style.transform = originalTransform;
        noteEl.style.boxShadow = originalBoxShadow;

        console.error('Error exporting note as PNG:', error);
        alert('Failed to export note as PNG. Please try again.');
    }
}

// Board management functions
function populateBoardSelector() {
    const selector = document.getElementById('boardSelector');
    selector.innerHTML = '';

    boards.forEach(board => {
        const option = document.createElement('option');
        option.value = board.id;
        option.textContent = board.name;
        if (board.id === currentBoardId) {
            option.selected = true;
        }
        selector.appendChild(option);
    });

    // Add "New Board" option
    const newOption = document.createElement('option');
    newOption.value = '__new__';
    newOption.textContent = '+ New Board...';
    selector.appendChild(newOption);

    // Update delete button state
    updateDeleteBoardButton();
}

function updateDeleteBoardButton() {
    const deleteBtn = document.getElementById('deleteBoardBtn');
    // Disable delete if only one board exists
    deleteBtn.disabled = boards.length <= 1;
}

function createNewBoard() {
    const name = prompt('Enter name for new board:', 'New Board');
    if (!name) {
        // Reset selector to current board
        document.getElementById('boardSelector').value = currentBoardId;
        return;
    }

    const newBoardId = 'board-' + Date.now();
    boards.push({ id: newBoardId, name: name });
    saveBoards(boards);

    // Initialize toolboard settings with the provided name
    localStorage.setItem(`finance_${newBoardId}_toolboardSettings`, JSON.stringify({ title: name, color: '#2c3e50' }));

    // Switch to the new board
    switchToBoard(newBoardId);
}

function switchToBoard(boardId) {
    if (boardId === currentBoardId) return;

    currentBoardId = boardId;
    setCurrentBoardId(boardId);

    // Reload all board-specific data
    variables = loadVariables();
    positions = loadPositions();
    toolCustomizations = loadToolCustomizations();
    customTools = loadCustomTools();
    hiddenTools = loadHiddenTools();
    toolboardSettings = loadToolboardSettings();
    maxZ = Math.max(...Object.values(positions).map(p => p.z || 1), 1);

    // Update UI
    populateBoardSelector();
    applyToolboardSettings();
    renderToolboard();
}

function deleteCurrentBoard() {
    if (boards.length <= 1) {
        alert('Cannot delete the last board.');
        return;
    }

    const currentBoard = boards.find(b => b.id === currentBoardId);
    if (!confirm(`Delete board "${currentBoard.name}"? This cannot be undone.`)) {
        return;
    }

    // Remove board-specific data from localStorage
    localStorage.removeItem(boardKey('variables'));
    localStorage.removeItem(boardKey('positions'));
    localStorage.removeItem(boardKey('toolCustomizations'));
    localStorage.removeItem(boardKey('customTools'));
    localStorage.removeItem(boardKey('hiddenTools'));
    localStorage.removeItem(boardKey('toolboardSettings'));

    // Remove from boards array
    boards = boards.filter(b => b.id !== currentBoardId);
    saveBoards(boards);

    // Switch to first available board
    switchToBoard(boards[0].id);
}

function renameBoardInSelector() {
    const currentBoard = boards.find(b => b.id === currentBoardId);
    if (currentBoard && toolboardSettings.title !== currentBoard.name) {
        currentBoard.name = toolboardSettings.title;
        saveBoards(boards);
        populateBoardSelector();
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
