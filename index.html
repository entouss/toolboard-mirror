<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter&family=Lato&family=Montserrat&family=Nunito&family=Open+Sans&family=Poppins&family=Roboto&family=Source+Sans+Pro&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%20300%20300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22board%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%22300%22%20y2%3D%22300%22%20gradientUnits%3D%22userSpaceOnUse%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%233d4555%22%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%231e2230%22%2F%3E%3C%2FlinearGradient%3E%3CradialGradient%20id%3D%22vignette%22%20cx%3D%220.45%22%20cy%3D%220.4%22%20r%3D%220.65%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23fff%22%20stop-opacity%3D%220.03%22%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23000%22%20stop-opacity%3D%220.2%22%2F%3E%3C%2FradialGradient%3E%3Cpattern%20id%3D%22holes%22%20x%3D%2215%22%20y%3D%2215%22%20width%3D%2230%22%20height%3D%2230%22%20patternUnits%3D%22userSpaceOnUse%22%3E%3Ccircle%20cx%3D%2210%22%20cy%3D%2210%22%20r%3D%228%22%20fill%3D%22%2314171e%22%2F%3E%3C%2Fpattern%3E%3CclipPath%20id%3D%22hole-clip%22%3E%3Crect%20x%3D%228%22%20y%3D%228%22%20width%3D%22274%22%20height%3D%22274%22%20rx%3D%2220%22%2F%3E%3C%2FclipPath%3E%3ClinearGradient%20id%3D%22amber%22%20x1%3D%22145%22%20y1%3D%2215%22%20x2%3D%22165%22%20y2%3D%22280%22%20gradientUnits%3D%22userSpaceOnUse%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23fef3c7%22%2F%3E%3Cstop%20offset%3D%2225%25%22%20stop-color%3D%22%23fcd34d%22%2F%3E%3Cstop%20offset%3D%2260%25%22%20stop-color%3D%22%23f59e0b%22%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23d97706%22%2F%3E%3C%2FlinearGradient%3E%3Cfilter%20id%3D%22bloom%22%20x%3D%22-50%25%22%20y%3D%22-50%25%22%20width%3D%22200%25%22%20height%3D%22200%25%22%3E%3CfeGaussianBlur%20stdDeviation%3D%2218%22%2F%3E%3C%2Ffilter%3E%3Cfilter%20id%3D%22glow%22%20x%3D%22-15%25%22%20y%3D%22-15%25%22%20width%3D%22130%25%22%20height%3D%22130%25%22%3E%3CfeGaussianBlur%20in%3D%22SourceGraphic%22%20stdDeviation%3D%222%22%20result%3D%22blur%22%2F%3E%3CfeMerge%3E%3CfeMergeNode%20in%3D%22blur%22%2F%3E%3CfeMergeNode%20in%3D%22SourceGraphic%22%2F%3E%3C%2FfeMerge%3E%3C%2Ffilter%3E%3C%2Fdefs%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20rx%3D%2226%22%20fill%3D%22url%28%23board%29%22%2F%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20rx%3D%2226%22%20fill%3D%22url%28%23vignette%29%22%2F%3E%3Crect%20x%3D%221%22%20y%3D%221%22%20width%3D%22298%22%20height%3D%22298%22%20rx%3D%2225%22%20fill%3D%22none%22%20stroke%3D%22%234c566a%22%20stroke-width%3D%221.2%22%20opacity%3D%220.35%22%2F%3E%3Cg%20clip-path%3D%22url%28%23hole-clip%29%22%3E%3Crect%20x%3D%225%22%20y%3D%225%22%20width%3D%22290%22%20height%3D%22290%22%20fill%3D%22url%28%23holes%29%22%2F%3E%3C%2Fg%3E%3Cg%20filter%3D%22url%28%23bloom%29%22%20opacity%3D%220.18%22%3E%3Crect%20x%3D%2215%22%20y%3D%2212%22%20width%3D%22260%22%20height%3D%2282%22%20rx%3D%2210%22%20fill%3D%22%23fbbf24%22%2F%3E%3Crect%20x%3D%22105%22%20y%3D%2282%22%20width%3D%2280%22%20height%3D%22195%22%20rx%3D%2210%22%20fill%3D%22%23f59e0b%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22url%28%23amber%29%22%20filter%3D%22url%28%23glow%29%22%3E%3Ccircle%20cx%3D%2225%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2255%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2285%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22205%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22235%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22265%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2225%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2255%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2285%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22205%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22235%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22265%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2225%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2255%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2285%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22205%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22235%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22265%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22115%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22115%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22115%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22145%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22145%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22145%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22175%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22175%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22175%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22205%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22205%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22205%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22235%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22235%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22235%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22265%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22265%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22265%22%20r%3D%2210%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22%23fff%22%20opacity%3D%220.3%22%3E%3Ccircle%20cx%3D%2222%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2252%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2282%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22202%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22232%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22262%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2222%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2252%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2282%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22202%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22232%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22262%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2222%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2252%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2282%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22202%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22232%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22262%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22112%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22112%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22112%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22142%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22142%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22142%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22172%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22172%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22172%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22202%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22202%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22202%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22232%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22232%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22232%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22262%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22262%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22262%22%20r%3D%224%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E">
    <style>
:root {
    --bg-primary: #f5f5f5;
    --bg-secondary: white;
    --bg-tertiary: #f8f9fa;
    --bg-header: #2c3e50;
    --bg-tool-header: #34495e;
    --text-primary: #333;
    --text-secondary: #666;
    --text-muted: #7f8c8d;
    --text-heading: #2c3e50;
    --border-color: #ddd;
    --border-light: #eee;
    --shadow-light: rgba(0,0,0,0.1);
    --shadow-medium: rgba(0,0,0,0.15);
    --shadow-heavy: rgba(0,0,0,0.25);
    --overlay-bg: rgba(0,0,0,0.5);
    --code-bg: #f4f4f4;
    --table-stripe: #f8f9fa;
    --table-hover: #e8f4fd;
    --input-bg: white;
    --success-bg: #d4edda;
    --success-text: #155724;
    --error-bg: #f8d7da;
    --error-text: #721c24;
}

body.dark-mode {
    --bg-primary: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-tertiary: #1f2940;
    --bg-header: #0f0f23;
    --bg-tool-header: #1f2940;
    --text-primary: #e4e4e7;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --text-heading: #e4e4e7;
    --border-color: #3f3f46;
    --border-light: #27272a;
    --shadow-light: rgba(0,0,0,0.3);
    --shadow-medium: rgba(0,0,0,0.4);
    --shadow-heavy: rgba(0,0,0,0.5);
    --overlay-bg: rgba(0,0,0,0.7);
    --code-bg: #27272a;
    --table-stripe: #1f2940;
    --table-hover: #2d3a52;
    --input-bg: #1f2940;
    --success-bg: #064e3b;
    --success-text: #6ee7b7;
    --error-bg: #7f1d1d;
    --error-text: #fca5a5;
}

/* Dark mode scrollbar */
body.dark-mode ::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

body.dark-mode ::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

body.dark-mode ::-webkit-scrollbar-thumb {
    background: #4a4a5a;
    border-radius: 5px;
}

body.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: #5a5a6a;
}

body.dark-mode {
    scrollbar-color: #4a4a5a var(--bg-secondary);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--bg-primary);
    min-height: 100vh;
    font-size: 12px;
    color: var(--text-primary);
    transition: background 0.3s, color 0.3s;
    overscroll-behavior: none;
}

/* Prevent pull-to-refresh and overscroll when dragging */
html {
    overscroll-behavior: none;
}

/* Prevent scrolling when actively dragging/resizing */
body.is-dragging,
body.is-resizing {
    overflow: hidden;
    touch-action: none;
}

header {
    background: var(--bg-header);
    color: white;
    padding: 6px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10002;
    transition: background 0.3s;
}

header h1 {
    font-size: 1.5rem;
}

.board-selector-trigger {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: background 0.15s;
}

.board-selector-trigger:hover {
    background: rgba(255,255,255,0.15);
}

.board-selector-trigger::after {
    content: ' \25BE';
    font-size: 10px;
    opacity: 0.7;
}

#deleteAllBtn {
    font-size: 16px;
    line-height: 1;
}

#deleteAllBtn:hover {
    background: rgba(231, 76, 60, 0.7);
}

.header-section {
    display: flex;
    align-items: center;
    gap: 6px;
}

.header-section-board {
    flex: 1;
    min-width: 0;
}

.header-section-notes {
    flex: 0 0 auto;
}

.header-section-page {
    flex: 0 0 auto;
}

.header-settings-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}

.header-settings-btn:hover {
    background: rgba(255,255,255,0.3);
}

.toolboard-version {
    font-size: 10px;
    opacity: 0.7;
    font-weight: normal;
    margin-left: 8px;
    background: rgba(255,255,255,0.15);
    padding: 2px 8px;
    border-radius: 10px;
}

.toolboard-settings {
    position: absolute;
    top: 100%;
    left: 20px;
    background: var(--bg-secondary);
    border-radius: 6px;
    box-shadow: 0 4px 20px var(--shadow-heavy);
    padding: 12px;
    z-index: 10001;
    min-width: 250px;
    display: none;
    color: var(--text-primary);
}

.toolboard-settings.open {
    display: block;
}

.toolboard-settings label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.toolboard-settings input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.toolboard-settings input[type="text"]:focus {
    outline: none;
    border-color: #3498db;
}

.font-select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
    cursor: pointer;
}

.font-select:focus {
    outline: none;
    border-color: #3498db;
}

.header-section-notes,
.header-section-page {
    border-left: 1px solid rgba(255,255,255,0.15);
    padding-left: 6px;
}

.storage-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 52px;
    height: 24px;
    padding: 0 5px;
    background: rgba(255,255,255,0.15);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.storage-indicator:hover {
    background: rgba(255,255,255,0.25);
}

.storage-bar {
    width: 100%;
    height: 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
    overflow: hidden;
}

.storage-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s, background 0.3s;
}

.storage-bar-fill.low { background: #27ae60; }
.storage-bar-fill.medium { background: #f39c12; }
.storage-bar-fill.high { background: #e74c3c; }

.storage-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.storage-modal {
    background: var(--bg-secondary);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px var(--shadow-heavy);
}

.storage-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
}

.storage-modal-header h3 {
    margin: 0;
    font-size: 16px;
    color: var(--text-primary);
}

.storage-modal-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.storage-modal-header button:hover {
    color: var(--text-primary);
}

.storage-modal-body {
    padding: 15px 20px;
    overflow-y: auto;
}

.storage-total {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 15px;
    padding: 10px;
    background: var(--bg-tertiary);
    border-radius: 4px;
}

.storage-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

.storage-table th,
.storage-table td {
    padding: 8px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}

.storage-table th {
    font-weight: 600;
    color: var(--text-muted);
    background: var(--bg-tertiary);
}

.storage-table td:first-child {
    color: var(--text-primary);
    word-break: break-all;
}

.storage-table td:last-child {
    color: var(--text-secondary);
    white-space: nowrap;
    text-align: right;
}

.storage-table tr {
    position: relative;
}

.storage-table .storage-desc {
    color: var(--text-muted);
    font-style: italic;
    font-size: 11px;
}

.storage-table tr .storage-preview {
    display: none;
    position: absolute;
    left: 0;
    top: 100%;
    z-index: 10001;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 11px;
    font-family: monospace;
    color: var(--text-secondary);
    max-width: 420px;
    max-height: 160px;
    overflow: hidden;
    white-space: pre-wrap;
    word-break: break-all;
    box-shadow: 0 4px 12px var(--shadow-heavy);
    pointer-events: none;
}

.storage-table tbody tr:hover .storage-preview {
    display: block;
}

.storage-link {
    color: #3498db;
    cursor: pointer;
    text-decoration: none;
}

.storage-link:hover {
    text-decoration: underline;
}

.storage-tool-list {
    margin: 2px 0 0 8px;
    padding: 0;
    list-style: none;
    font-size: 11px;
}

.storage-tool-list li {
    padding: 1px 0;
    color: var(--text-secondary);
}

.storage-tool-list li .storage-link {
    font-size: 11px;
}

@keyframes tool-highlight-pulse {
    0%   { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
    40%  { box-shadow: 0 0 0 8px rgba(52, 152, 219, 0.4); }
    80%  { box-shadow: 0 0 0 12px rgba(52, 152, 219, 0); }
    100% { box-shadow: 0 2px 10px var(--shadow-light); }
}

.tool-highlight {
    animation: tool-highlight-pulse 0.6s ease-out 3;
    z-index: 9999 !important;
}


/* Board Manager Popup */
.board-manager-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.board-manager-overlay.open {
    display: flex;
}

.board-manager-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 400px;
    max-width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-heavy) 0 8px 30px;
    overflow: hidden;
}

.board-manager-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
}

.board-manager-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
}

.board-manager-close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0 4px;
    line-height: 1;
    border-radius: 4px;
    transition: background 0.15s, color 0.15s;
}

.board-manager-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.board-manager-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
}

.board-manager-item {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    cursor: pointer;
    gap: 8px;
    transition: background 0.1s;
    position: relative;
}

.board-manager-item:hover {
    background: var(--bg-tertiary);
}

.board-manager-item.active {
    border-left: 3px solid var(--accent, #3498db);
    padding-left: 17px;
}

.board-manager-item-name {
    flex: 1;
    font-size: 0.95rem;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.board-manager-item.active .board-manager-item-name {
    font-weight: 600;
}

.board-manager-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s;
}

.board-manager-item:hover .board-manager-actions {
    opacity: 1;
}

.board-manager-actions button {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1;
    transition: background 0.15s, color 0.15s;
}

.board-manager-actions button:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.board-manager-actions button.board-manager-delete-btn:hover {
    background: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
}

.board-manager-rename-input {
    flex: 1;
    padding: 4px 8px;
    border: 2px solid #3498db;
    border-radius: 4px;
    font-size: 0.95rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    outline: none;
    font-family: inherit;
}

.board-manager-confirm-row {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    gap: 8px;
    background: rgba(231, 76, 60, 0.08);
    border-left: 3px solid #e74c3c;
    padding-left: 17px;
}

.board-manager-confirm-row span {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.board-manager-confirm-row button {
    padding: 4px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.15s;
}

.board-manager-confirm-delete {
    background: #e74c3c;
    color: white;
}

.board-manager-confirm-delete:hover {
    background: #c0392b;
}

.board-manager-confirm-cancel {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.board-manager-confirm-cancel:hover {
    background: var(--border-color);
}

.board-manager-footer {
    padding: 12px 20px;
    border-top: 1px solid var(--border-color);
}

.board-manager-new-btn {
    width: 100%;
    padding: 10px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    background: transparent;
    color: var(--text-muted);
    font-size: 0.9rem;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
}

.board-manager-new-btn:hover {
    border-color: #3498db;
    color: #3498db;
    background: rgba(52, 152, 219, 0.05);
}

.board-manager-new-input-row {
    display: flex;
    align-items: center;
    padding: 10px 20px;
    gap: 8px;
}

.board-manager-new-input-row input {
    flex: 1;
    padding: 6px 10px;
    border: 2px solid #3498db;
    border-radius: 4px;
    font-size: 0.95rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    outline: none;
    font-family: inherit;
}

@media (hover: none) {
    .board-manager-actions {
        opacity: 1;
    }
}

#editVariablesBtn {
    background: #3498db;
    color: white;
}

#editVariablesBtn:hover {
    background: #2980b9;
}


/* Import/Export Modal */
.import-export-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.import-export-modal.open {
    display: flex;
}

.import-export-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.import-export-content h2 {
    margin-bottom: 15px;
    color: var(--text-heading);
}

.import-export-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 10px;
}

.import-export-tab {
    padding: 8px 16px;
    border: none;
    background: var(--bg-tertiary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-primary);
}

.import-export-tab.active {
    background: #3498db;
    color: white;
}

.import-export-tool {
    display: none;
    margin-bottom: 15px;
}

.import-export-tool.active {
    display: block;
}

.import-export-tool h3 {
    margin-bottom: 10px;
    color: var(--text-heading);
    font-size: 14px;
}

.export-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 10px;
}

.export-option label {
    flex: 1;
}

.export-btn, .import-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

.export-btn {
    background: #27ae60;
    color: white;
}

.export-btn:hover {
    background: #219a52;
}

.import-btn {
    background: #3498db;
    color: white;
}

.import-btn:hover {
    background: #2980b9;
}

.checkbox-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
    background: var(--bg-tertiary);
}

.checkbox-list label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    cursor: pointer;
    color: var(--text-primary);
}

.checkbox-list label:hover {
    background: var(--table-hover);
}

.import-textarea {
    width: 100%;
    height: 150px;
    font-family: monospace;
    font-size: 12px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    resize: vertical;
    margin-bottom: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.import-file-input {
    margin-bottom: 10px;
}

.import-export-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.import-export-close:hover {
    color: var(--text-heading);
}

.select-all-row {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
    margin-bottom: 8px;
}

.import-result {
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 13px;
}

.import-result.success {
    background: var(--success-bg);
    color: var(--success-text);
}

.import-result.error {
    background: var(--error-bg);
    color: var(--error-text);
}

main#toolboard {
    position: relative;
    min-height: calc(100vh - 60px);
    padding: 20px;
}

.tool {
    position: absolute;
    background: var(--bg-secondary);
    border-radius: 8px;
    box-shadow: 0 2px 10px var(--shadow-light);
    overflow: visible;
    transition: box-shadow 0.2s, background 0.3s;
    min-width: 150px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
}

/* Resize handles */
.resize-handle {
    position: absolute;
    background: transparent;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.15s, background 0.15s;
    touch-action: none;
}

.tool:hover .resize-handle,
.tool:active .resize-handle {
    opacity: 1;
}

.resize-handle:hover {
    background: rgba(52, 152, 219, 0.4);
}

.resize-handle.active {
    background: rgba(52, 152, 219, 0.6);
    opacity: 1;
}

/* Corner handles */
.resize-handle-nw {
    top: -4px;
    left: -4px;
    width: 12px;
    height: 12px;
    cursor: nw-resize;
    border-radius: 4px 0 0 0;
}

.resize-handle-ne {
    top: -4px;
    right: -4px;
    width: 12px;
    height: 12px;
    cursor: ne-resize;
    border-radius: 0 4px 0 0;
}

.resize-handle-sw {
    bottom: -4px;
    left: -4px;
    width: 12px;
    height: 12px;
    cursor: sw-resize;
    border-radius: 0 0 0 4px;
}

.resize-handle-se {
    bottom: -4px;
    right: -4px;
    width: 12px;
    height: 12px;
    cursor: se-resize;
    border-radius: 0 0 4px 0;
}

/* Visible resize grip indicator on SE corner */
.resize-handle-se::after {
    content: '';
    position: absolute;
    right: 2px;
    bottom: 2px;
    width: 8px;
    height: 8px;
    border-right: 2px solid rgba(52, 152, 219, 0.5);
    border-bottom: 2px solid rgba(52, 152, 219, 0.5);
    opacity: 0;
    transition: opacity 0.15s;
}

.tool:hover .resize-handle-se::after {
    opacity: 1;
}

/* Edge handles */
.resize-handle-n {
    top: -4px;
    left: 12px;
    right: 12px;
    height: 8px;
    cursor: n-resize;
}

.resize-handle-s {
    bottom: -4px;
    left: 12px;
    right: 12px;
    height: 8px;
    cursor: s-resize;
}

.resize-handle-w {
    top: 12px;
    bottom: 12px;
    left: -4px;
    width: 8px;
    cursor: w-resize;
}

.resize-handle-e {
    top: 12px;
    bottom: 12px;
    right: -4px;
    width: 8px;
    cursor: e-resize;
}

.tool:hover {
    box-shadow: 0 4px 20px var(--shadow-medium);
}

.tool.dragging {
    opacity: 0.9;
    box-shadow: 0 8px 30px var(--shadow-heavy);
    z-index: 1000 !important;
}

.tool-header {
    background: var(--bg-tool-header);
    color: white;
    padding: 6px 12px;
    font-weight: bold;
    font-size: 0.95rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    user-select: none;
    flex-shrink: 0;
    border-radius: 8px 8px 0 0;
    transition: background 0.3s;
}

.tool-header:active {
    cursor: grabbing;
}

.tool-header {
    touch-action: none;
}

.tool-header .drag-handle {
    opacity: 0.7;
}

.tool-header .header-buttons {
    display: flex;
    gap: 4px;
    align-items: center;
}

.tool-header .header-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.15s, background 0.15s;
    padding: 0;
}

.tool:hover .header-btn {
    opacity: 1;
}

.header-btn:hover {
    background: rgba(255,255,255,0.35);
}

.header-btn.delete-btn:hover {
    background: rgba(231, 76, 60, 0.7);
}

.tool.minimized .tool-content {
    display: none;
}

.tool.minimized {
    min-height: auto !important;
    height: auto !important;
}

.tool.minimized .resize-handle {
    display: none;
}

.tool.minimized .tool-header {
    border-radius: 8px;
}

.tool:hover .minimize-btn.minimized {
    opacity: 0.5;
}

/* Fullscreen mode */
.tool.fullscreen {
    position: fixed !important;
    top: 56px !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: calc(100vh - 56px) !important;
    z-index: 10001 !important;
    border-radius: 0 !important;
    margin: 0 !important;
}

.tool.fullscreen .tool-header {
    border-radius: 0;
}

.tool.fullscreen .tool-content {
    max-height: calc(100vh - 56px - 36px);
    overflow: auto;
}

.tool.fullscreen .resize-handle {
    display: none;
}

.fullscreen-btn.active {
    background: rgba(255,255,255,0.4);
}

/* Fullscreen overlay backdrop */
.fullscreen-backdrop {
    display: none;
    position: fixed;
    top: 56px;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10000;
}

.fullscreen-backdrop.active {
    display: block;
}

/* Tool settings popup - modal style */
.tool-settings-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.tool-settings-overlay.open {
    display: flex;
}

.tool-settings {
    background: var(--bg-secondary);
    border-radius: 8px;
    box-shadow: 0 4px 20px var(--shadow-heavy);
    padding: 20px;
    min-width: 280px;
    max-width: 90%;
    color: var(--text-primary);
    font-weight: normal;
}

.tool-settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-light);
}

.tool-settings-header h3 {
    margin: 0;
    font-size: 16px;
    color: var(--text-heading);
}

.tool-settings-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    line-height: 1;
}

.tool-settings-close:hover {
    color: var(--text-primary);
}

.tool-settings label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.tool-settings input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-primary);
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 10px;
}

.tool-settings input[type="text"]:focus {
    outline: none;
    border-color: #3498db;
}

.color-picker-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.color-swatch {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.1s, border-color 0.1s;
}

.color-swatch:hover {
    transform: scale(1.15);
}

.color-swatch.selected {
    border-color: #333;
}

/* Content editor */
.edit-content-btn {
    width: 100%;
    padding: 6px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.edit-content-btn:hover {
    background: #2980b9;
}

.duplicate-tool-btn {
    width: 100%;
    padding: 6px 12px;
    background: #9b59b6;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.duplicate-tool-btn:hover {
    background: #8e44ad;
}

.export-tool-btn {
    width: 100%;
    padding: 6px 12px;
    background: #1abc9c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.export-tool-btn:hover {
    background: #16a085;
}

.export-png-btn {
    width: 100%;
    padding: 6px 12px;
    background: #e67e22;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.export-png-btn:hover {
    background: #d35400;
}

.delete-tool-btn {
    width: 100%;
    padding: 6px 12px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    margin-top: 4px;
}

.delete-tool-btn:hover {
    background: #c0392b;
}

.content-editor-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 20000;
    align-items: center;
    justify-content: center;
}

.content-editor-overlay.open {
    display: flex;
}

.content-editor {
    background: var(--bg-secondary);
    border-radius: 8px;
    width: 95%;
    max-width: 1400px;
    height: 90vh;
    min-width: 500px;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: absolute;
    box-shadow: 0 10px 50px var(--shadow-heavy);
}

.content-editor-resize {
    position: absolute;
    background: transparent;
    z-index: 10;
    touch-action: none;
}

.content-editor-resize-e {
    top: 10px;
    bottom: 10px;
    right: -4px;
    width: 8px;
    cursor: e-resize;
}

.content-editor-resize-s {
    left: 10px;
    right: 10px;
    bottom: -4px;
    height: 8px;
    cursor: s-resize;
}

.content-editor-resize-se {
    right: -4px;
    bottom: -4px;
    width: 16px;
    height: 16px;
    cursor: se-resize;
}

.content-editor-header {
    padding: 15px 20px;
    background: var(--bg-tool-header);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    user-select: none;
    touch-action: none;
}

.content-editor-header:active {
    cursor: grabbing;
}

.content-editor-header h3 {
    margin: 0;
    font-size: 1rem;
    pointer-events: none;
}

.content-editor-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
}

.content-editor-body {
    display: flex;
    flex: 1;
    min-height: 0;
}

.content-editor-input {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.content-editor-resizer {
    width: 6px;
    background: var(--border-color);
    cursor: col-resize;
    flex-shrink: 0;
    transition: background 0.15s;
    touch-action: none;
}

.content-editor-resizer:hover,
.content-editor-resizer.active {
    background: #3498db;
}

.content-editor-preview {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.content-editor-label {
    padding: 8px 12px;
    background: var(--bg-tertiary);
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 500;
    border-bottom: 1px solid var(--border-color);
}

.editor-action-btn {
    padding: 2px 8px;
    font-size: 11px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    white-space: nowrap;
}

.editor-action-btn:hover {
    background: var(--bg-hover, var(--border-color));
    color: var(--text-primary);
}

.content-editor-find-replace {
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
}

.find-replace-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
}

.find-replace-row input[type="text"] {
    flex: 1;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
    padding: 3px 6px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    outline: none;
    min-width: 0;
}

.find-replace-row input[type="text"]:focus {
    border-color: var(--accent, #4fc3f7);
}

.find-replace-row button {
    padding: 2px 8px;
    font-size: 11px;
    border-radius: 3px;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    white-space: nowrap;
}

.find-replace-row button:hover {
    background: var(--bg-hover, var(--border-color));
}

.find-replace-row label {
    font-size: 11px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 2px;
    cursor: pointer;
    white-space: nowrap;
}

#editorFindInfo {
    font-size: 11px;
    color: var(--text-secondary);
    min-width: 60px;
    text-align: center;
    white-space: nowrap;
}

#editorFindToggleReplace {
    font-size: 9px;
    padding: 2px 4px;
    line-height: 1;
}

.content-editor-textarea {
    flex: 1;
    border: none;
    padding: 12px;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 12px;
    resize: none;
    outline: none;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.content-editor-preview-area {
    flex: 1;
    padding: 12px;
    overflow: auto;
    font-size: 12px;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.content-editor-footer {
    padding: 12px 20px;
    background: var(--bg-tertiary);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.content-editor-footer button {
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.content-editor-save {
    background: #27ae60;
    color: white;
}

.content-editor-save:hover {
    background: #219a52;
}

.content-editor-reset {
    background: #e74c3c;
    color: white;
}

.content-editor-reset:hover {
    background: #c0392b;
}

.content-editor-cancel {
    background: #95a5a6;
    color: white;
}

.content-editor-cancel:hover {
    background: #7f8c8d;
}

/* Markdown rendered styles */
.markdown-content h1, .markdown-content h2, .markdown-content h3,
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    margin-top: 0.5em;
    margin-bottom: 0.3em;
    color: var(--text-heading);
}

.markdown-content h1 { font-size: 1.4em; }
.markdown-content h2 { font-size: 1.2em; }
.markdown-content h3 { font-size: 1.1em; }

.markdown-content p {
    margin: 0.5em 0;
}

.markdown-content ul, .markdown-content ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}

.markdown-content code {
    background: var(--code-bg);
    padding: 2px 5px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.9em;
}

.markdown-content pre {
    background: var(--code-bg);
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
}

.markdown-content pre code {
    background: none;
    padding: 0;
}

.markdown-content blockquote {
    border-left: 3px solid #3498db;
    margin: 0.5em 0;
    padding-left: 1em;
    color: var(--text-secondary);
}

.markdown-content hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 1em 0;
}

.markdown-content strong {
    font-weight: 600;
}

.markdown-content a {
    color: #3498db;
}

.markdown-content img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    margin: 0.5em 0;
    display: block;
}

.markdown-content table {
    margin: 0.5em 0;
}

.tool-content {
    padding: 15px;
    overflow: auto;
    flex: 1;
    min-height: 0;
}

.tool.resizing {
    user-select: none;
}

.tool.resizing .tool-content {
    pointer-events: none;
}

/* Tables */
table {
    border-collapse: collapse;
    width: 100%;
    font-size: 11px;
}

th, td {
    border: 1px solid var(--border-color);
    padding: 6px 8px;
    text-align: left;
}

th {
    background: var(--bg-tertiary);
    font-weight: 600;
}

tr:nth-child(even) {
    background: var(--table-stripe);
}

tr:hover {
    background: var(--table-hover);
}

/* Checklist Widget */
.checklist-items {
    list-style: none;
    padding: 0;
    margin: 0;
}

.checklist-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    margin-bottom: 2px;
    transition: background 0.15s, opacity 0.15s, box-shadow 0.15s;
}

.checklist-item:hover {
    background: var(--table-hover);
}

.checklist-item.dragging {
    opacity: 0.5;
    box-shadow: 0 2px 8px var(--shadow-medium);
}

.checklist-item.drag-over {
    border-top: 2px solid #3498db;
    margin-top: -2px;
}

.checklist-item.completed {
    opacity: 0.6;
}

.checklist-item.completed .checklist-text {
    text-decoration: line-through;
    color: var(--text-muted);
}

.checklist-item.in_progress .checklist-status {
    background: #f39c12;
    border-color: #f39c12;
}

.checklist-item.in_progress .checklist-status::after {
    content: '▶';
    color: white;
    font-size: 9px;
    margin-left: 1px;
}

.checklist-drag {
    cursor: grab;
    color: var(--text-muted);
    font-size: 12px;
    padding: 2px;
    opacity: 0.4;
    transition: opacity 0.15s;
}

.checklist-item:hover .checklist-drag {
    opacity: 1;
}

.checklist-drag:active {
    cursor: grabbing;
}

.checklist-status {
    width: 18px;
    height: 18px;
    min-width: 18px;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    background: transparent;
}

.checklist-status:hover {
    border-color: #3498db;
}

.checklist-item.completed .checklist-status {
    background: #27ae60;
    border-color: #27ae60;
}

.checklist-item.completed .checklist-status::after {
    content: '✓';
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.checklist-text {
    flex: 1;
    font-size: 13px;
    word-break: break-word;
    cursor: text;
    padding: 2px 4px;
    border-radius: 3px;
    min-height: 1.4em;
}

.checklist-text:hover {
    background: rgba(0,0,0,0.05);
}

.checklist-text:focus {
    outline: none;
    background: var(--input-bg);
    box-shadow: 0 0 0 2px #3498db;
}

.checklist-actions {
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
}

.checklist-item:hover .checklist-actions {
    opacity: 1;
}

.checklist-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 5px;
    border-radius: 3px;
    transition: color 0.15s, background 0.15s;
}

.checklist-btn:hover {
    background: rgba(0,0,0,0.1);
    color: var(--text-primary);
}

.checklist-btn.delete:hover {
    color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
}

/* Sub-items */
.checklist-subitems {
    list-style: none;
    padding: 0;
    margin: 4px 0 0 24px;
    border-left: 2px solid var(--border-light);
    padding-left: 8px;
}

.checklist-subitems .checklist-item {
    background: transparent;
    padding: 4px 6px;
    margin-bottom: 2px;
}

.checklist-subitems .checklist-item:hover {
    background: var(--bg-tertiary);
}


.checklist-input:focus {
    outline: none;
    border-color: #3498db;
}

.checklist-markdown-editor {
    width: 100%;
    min-height: 150px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 13px;
    line-height: 1.6;
    background: var(--input-bg);
    color: var(--text-primary);
    resize: vertical;
    box-sizing: border-box;
    tab-size: 2;
}

.checklist-markdown-editor:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.checklist-md-btn {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 3px;
    transition: all 0.15s;
    white-space: nowrap;
}

.checklist-md-btn:hover {
    border-color: #3498db;
    color: #3498db;
}

.checklist-md-btn.active {
    background: #3498db;
    border-color: #3498db;
    color: white;
}

/* Random Picker */
.picker-widget {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 10px;
}

.picker-input-row {
    display: flex;
    gap: 8px;
}

.picker-input-row input {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.picker-input-row button {
    padding: 8px 14px;
    background: #9b59b6;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

.picker-input-row button:hover {
    background: #8e44ad;
}

.picker-items {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    min-height: 20px;
}

.picker-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--bg-tertiary, rgba(0,0,0,0.08));
    border-radius: 12px;
    font-size: 12px;
    color: var(--text-primary);
}

.picker-chip .picker-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.picker-chip .picker-remove {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 0 2px;
    line-height: 1;
}

.picker-chip .picker-remove:hover {
    color: #e74c3c;
}

.picker-wheel-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    margin: 10px 0;
}

.picker-wheel-container {
    position: relative;
    width: 260px;
    height: 260px;
}

.picker-wheel-svg {
    width: 260px;
    height: 260px;
    transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}

.picker-wheel-svg.spinning {
    transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}

.picker-pointer {
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 20px solid #e74c3c;
    z-index: 2;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
}

.picker-result {
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    min-height: 28px;
    color: var(--text-primary);
    margin-top: 8px;
}

.picker-result.highlight {
    animation: pickerPulse 0.6s ease-out;
}

@keyframes pickerPulse {
    0% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); opacity: 1; }
}

.picker-spin-btn {
    padding: 10px 32px;
    font-size: 15px;
    font-weight: 600;
    background: #9b59b6;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    align-self: center;
    transition: background 0.15s;
}

.picker-spin-btn:hover {
    background: #8e44ad;
}

.picker-spin-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.picker-empty-msg {
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
    padding: 30px 0;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: var(--overlay-bg);
    overflow: auto;
}

.modal-content {
    background: var(--bg-secondary);
    margin: 50px auto;
    padding: 20px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 8px;
}

.modal-content h2 {
    margin-bottom: 20px;
}

.close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: var(--text-secondary);
}

.close:hover {
    color: #e74c3c;
}

/* Stopwatch Widget */
.stopwatch-widget {
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.sw-display {
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    font-size: 36px;
    font-weight: bold;
    letter-spacing: 2px;
    color: var(--text-primary);
    text-align: center;
    padding: 10px 0;
}

.sw-display .sw-ms {
    font-size: 20px;
    opacity: 0.6;
}

.sw-buttons {
    display: flex;
    gap: 8px;
}

.sw-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 5px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    min-width: 70px;
}

.sw-btn:disabled {
    opacity: 0.4;
    cursor: default;
}

.sw-start {
    background: #27ae60;
    color: white;
}

.sw-start.running {
    background: #e74c3c;
}

.sw-lap {
    background: #3498db;
    color: white;
}

.sw-reset {
    background: #95a5a6;
    color: white;
}

.sw-laps {
    width: 100%;
    max-height: 180px;
    overflow-y: auto;
    font-size: 12px;
}

.sw-laps table {
    width: 100%;
    border-collapse: collapse;
}

.sw-laps th, .sw-laps td {
    padding: 4px 8px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.sw-laps th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 11px;
    position: sticky;
    top: 0;
    background: var(--bg-primary);
}

.sw-laps td {
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
}

.sw-laps .sw-lap-best {
    color: #27ae60;
    font-weight: 600;
}

.sw-laps .sw-lap-worst {
    color: #e74c3c;
    font-weight: 600;
}

/* Calendar Widget Styles */
.tool-content:has(.calendar-widget) {
    display: flex;
    flex-direction: column;
}

.calendar-widget {
    padding: 10px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    min-height: 0;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    gap: 10px;
    flex-shrink: 0;
}

.calendar-year-nav {
    display: flex;
    align-items: center;
    gap: 8px;
}

.calendar-year-nav button {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 14px;
}

.calendar-year-nav button:hover {
    background: var(--table-hover);
}

.calendar-year-nav span {
    font-weight: 600;
    font-size: 16px;
    min-width: 50px;
    text-align: center;
}

.calendar-manage-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 11px;
}

.calendar-manage-btn:hover {
    background: #2980b9;
}

.calendar-year-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 12px;
    flex: 1;
    min-height: 0;
}

.calendar-month {
    background: var(--bg-tertiary);
    border-radius: 6px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.calendar-month-name {
    font-weight: 600;
    text-align: center;
    margin-bottom: 6px;
    font-size: 11px;
    color: var(--text-heading);
    flex-shrink: 0;
    border-radius: 3px;
    padding: 2px 4px;
    transition: background 0.15s;
}

.calendar-month-name:hover {
    background: var(--table-hover);
    color: #3498db;
}

.calendar-month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 1px;
    flex: 1;
    min-height: 0;
}

.calendar-dow {
    text-align: center;
    font-size: 8px;
    color: var(--text-muted);
    padding: 2px 0;
}

.calendar-day {
    text-align: center;
    padding: 2px;
    font-size: 9px;
    position: relative;
    min-height: 16px;
    border-radius: 2px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.calendar-day:hover {
    background: var(--table-hover);
}

.calendar-day.other-month {
    cursor: default;
}

.calendar-day.today {
    background: #3498db;
    color: white;
    border-radius: 50%;
    font-weight: 600;
}

.calendar-day.other-month {
    color: var(--text-muted);
    opacity: 0.4;
}

.calendar-event-dots {
    display: flex;
    justify-content: center;
    gap: 1px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
}

.calendar-event-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
}

.calendar-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border-light);
    font-size: 11px;
    flex-shrink: 0;
}

.calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.calendar-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.calendar-legend-count {
    color: var(--text-muted);
    margin-left: 2px;
}

/* Calendar View Toggle */
.calendar-view-toggle {
    display: flex;
    gap: 4px;
}

.calendar-view-btn {
    padding: 4px 10px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 11px;
    border-radius: 4px;
}

.calendar-view-btn:first-child {
    border-radius: 4px 0 0 4px;
}

.calendar-view-btn:last-child {
    border-radius: 0 4px 4px 0;
}

.calendar-view-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

/* Month View */
.calendar-month-view {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
}

.calendar-month-view.active {
    display: flex;
}

.calendar-year-grid.hidden {
    display: none;
}

.calendar-month-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 12px;
}

.calendar-month-nav button {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 4px 10px;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 14px;
}

.calendar-month-nav button:hover {
    background: var(--table-hover);
}

.calendar-month-nav .calendar-month-title {
    font-weight: 600;
    font-size: 16px;
    min-width: 150px;
    text-align: center;
}

.calendar-month-nav .calendar-today-btn {
    background: #27ae60;
    color: white;
    border: none;
    font-size: 10px;
    padding: 4px 8px;
}

.calendar-month-detail {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 4px;
    min-height: 0;
}

.calendar-month-detail .calendar-dow {
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    padding: 8px 4px;
}

.calendar-month-detail .calendar-day-cell {
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 4px;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    cursor: pointer;
}

.calendar-month-detail .calendar-day-cell:hover {
    background: var(--table-hover);
}

.calendar-month-detail .calendar-day-cell.other-month {
    opacity: 0.4;
    background: transparent;
}

.calendar-month-detail .calendar-day-cell.today {
    box-shadow: inset 0 0 0 2px #3498db;
}

.calendar-day-number {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-primary);
}

.calendar-day-cell.today .calendar-day-number {
    background: #3498db;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.calendar-day-events {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.calendar-day-event {
    font-size: 9px;
    padding: 2px 4px;
    border-radius: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: white;
}

.calendar-day-more {
    font-size: 9px;
    color: var(--text-muted);
    text-align: center;
}

/* Calendar Management Modal */
.calendar-manage-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10020;
    justify-content: center;
    align-items: center;
}

.calendar-manage-modal.open {
    display: flex;
}

.calendar-manage-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 450px;
    max-height: 80vh;
    overflow-y: auto;
}

.calendar-manage-content h3 {
    margin-bottom: 15px;
    color: var(--text-heading);
}

.calendar-manage-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.calendar-manage-close:hover {
    color: var(--text-heading);
}

.calendar-list {
    margin-bottom: 15px;
}

.calendar-list-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    margin-bottom: 8px;
}

.calendar-list-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
}

.calendar-list-name {
    flex: 1;
    font-weight: 500;
}

.calendar-list-count {
    color: var(--text-muted);
    font-size: 11px;
}

.calendar-list-remove {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
}

.calendar-list-remove:hover {
    background: rgba(231, 76, 60, 0.1);
    border-radius: 4px;
}

.calendar-add-form {
    border-top: 1px solid var(--border-light);
    padding-top: 15px;
}

.calendar-add-form h4 {
    margin-bottom: 10px;
    font-size: 13px;
    color: var(--text-heading);
}

.calendar-add-row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.calendar-add-name {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.calendar-color-picker {
    display: flex;
    gap: 4px;
    margin-bottom: 10px;
}

.calendar-color-option {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
}

.calendar-color-option:hover {
    transform: scale(1.1);
}

.calendar-color-option.selected {
    border-color: var(--text-heading);
}

.calendar-add-btn {
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 12px;
}

.calendar-add-btn:hover {
    background: #229954;
}

.calendar-import-section {
    border-top: 1px solid var(--border-light);
    padding-top: 15px;
    margin-top: 15px;
}

.calendar-import-section h4 {
    margin-bottom: 10px;
    font-size: 13px;
    color: var(--text-heading);
}

.calendar-import-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.calendar-import-file {
    flex: 1;
}

.calendar-import-select {
    padding: 6px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 12px;
    background: var(--input-bg);
    color: var(--text-primary);
}

/* Calendar Day Tooltip */
.calendar-day-tooltip {
    position: absolute;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 8px;
    min-width: 150px;
    max-width: 250px;
    z-index: 10030;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 11px;
}

.calendar-day-tooltip-date {
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-heading);
}

.calendar-day-tooltip-event {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 0;
}

.calendar-day-tooltip-text {
    flex: 1;
}

.calendar-event-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 0 4px;
    line-height: 1;
    opacity: 0.5;
}

.calendar-event-delete:hover {
    color: #e74c3c;
    opacity: 1;
}

.calendar-day-tooltip-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
}

.calendar-day-add-form {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-light);
}

.calendar-day-add-input {
    flex: 1;
    min-width: 0;
    padding: 4px 6px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    font-size: 11px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.calendar-day-add-select {
    padding: 4px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
    font-size: 10px;
    background: var(--input-bg);
    color: var(--text-primary);
    max-width: 80px;
}

.calendar-day-add-btn {
    padding: 4px 8px;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
}

.calendar-day-add-btn:hover {
    background: #229954;
}

/* Feature Selection Modal */
.feature-select-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 10010;
    justify-content: center;
    align-items: center;
}

.feature-select-modal.open {
    display: flex;
}

.feature-select-content {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

.feature-select-content h2 {
    margin-bottom: 15px;
    color: var(--text-heading);
}

.feature-select-close {
    float: right;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
}

.feature-select-close:hover {
    color: var(--text-heading);
}

.feature-select-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.feature-select-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
}

.feature-select-item:hover {
    background: var(--bg-tertiary);
    border-color: #3498db;
}

.feature-select-item:active {
    background: var(--table-hover);
}

.feature-select-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
    flex-shrink: 0;
}

.feature-select-info {
    flex: 1;
}

.feature-select-name {
    font-weight: 600;
    color: var(--text-heading);
    margin-bottom: 2px;
}

.feature-select-description {
    font-size: 11px;
    color: var(--text-muted);
}

/* Feature Select Tabs */
.feature-select-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.feature-tab {
    flex: 1;
    padding: 10px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    transition: color 0.2s, border-color 0.2s;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.feature-tab:hover {
    color: var(--text-primary);
}

.feature-tab.active {
    color: #3498db;
    border-bottom-color: #3498db;
}

.feature-tab-content {
    display: none;
}

.feature-tab-content.active {
    display: block;
}

/* Feature Search and Filter */
.feature-search-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.feature-search-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
}

.feature-search-input:focus {
    outline: none;
    border-color: #3498db;
}

.feature-toolbox-filter {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 13px;
    background: var(--input-bg);
    color: var(--text-primary);
    cursor: pointer;
}

/* Toolbox Group Header */
.toolbox-group {
    margin-bottom: 20px;
}

.toolbox-group-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--border-light);
}

.toolbox-group-icon {
    font-size: 18px;
}

.toolbox-group-name {
    font-weight: 600;
    color: var(--text-heading);
    font-size: 14px;
}

.toolbox-group-count {
    font-size: 11px;
    color: var(--text-muted);
    margin-left: auto;
}

/* Toolboxes List */
.toolboxes-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.toolbox-card {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-tertiary);
}

.toolbox-card-icon {
    font-size: 28px;
    width: 45px;
    text-align: center;
    flex-shrink: 0;
}

.toolbox-card-info {
    flex: 1;
}

.toolbox-card-name {
    font-weight: 600;
    color: var(--text-heading);
    font-size: 15px;
    margin-bottom: 4px;
}

.toolbox-card-description {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.toolbox-card-tools {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 10px;
}

.toolbox-tool-preview {
    font-size: 11px;
    padding: 2px 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    color: var(--text-secondary);
}

.toolbox-add-all-btn {
    padding: 6px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
}

.toolbox-add-all-btn:hover {
    background: #2980b9;
}

/* Board Templates List */
.board-templates-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.board-template-card {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-tertiary);
}

.board-template-icon {
    font-size: 28px;
    width: 45px;
    text-align: center;
    flex-shrink: 0;
}

.board-template-info {
    flex: 1;
}

.board-template-name {
    font-weight: 600;
    color: var(--text-heading);
    font-size: 15px;
    margin-bottom: 4px;
}

.board-template-description {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.board-template-tools {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 10px;
}

.board-template-tool-preview {
    font-size: 11px;
    padding: 2px 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    color: var(--text-secondary);
}

.board-template-use-btn {
    padding: 6px 12px;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
}

.board-template-use-btn:hover {
    background: #219a52;
}

.feature-no-results {
    text-align: center;
    padding: 30px;
    color: var(--text-muted);
}

/* Number formatting */
.currency::before {
    content: '$';
}

.percent::after {
    content: '%';
}

/* Snap guides */
.snap-guide {
    opacity: 0.8;
    box-shadow: 0 0 4px rgba(52, 152, 219, 0.8);
}

.tool.snapping {
    transition: none;
}

/* Responsive */
@media (max-width: 768px) {
    header {
        padding: 8px 10px;
        gap: 8px;
    }

    .header-section {
        gap: 4px;
    }

    .header-section-board img {
        width: 24px !important;
        height: 24px !important;
    }

    .board-selector-trigger {
        font-size: 1rem;
        max-width: 150px;
    }

    .toolboard-version {
        display: none;
    }

    .storage-indicator {
        display: none;
    }

    main#toolboard {
        padding: 10px;
    }

    main#toolboard.mobile-layout {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-height: auto;
    }

    main#toolboard.mobile-layout .tool {
        position: static !important;
        width: 100% !important;
        height: auto !important;
        left: auto !important;
        top: auto !important;
        z-index: auto !important;
        transform: none !important;
        min-width: unset;
        min-height: unset;
    }

    main#toolboard.mobile-layout .tool .tool-content {
        max-height: 400px;
        overflow: auto;
    }

    main#toolboard.mobile-layout .tool.minimized .tool-content {
        display: none;
        max-height: unset;
    }

    main#toolboard.mobile-layout .resize-handle {
        display: none !important;
    }

    main#toolboard.mobile-layout .snap-guide {
        display: none !important;
    }

    .tool {
        min-width: 120px;
        min-height: 80px;
    }

    .tool-header {
        padding: 8px 10px;
        font-size: 0.85rem;
    }

    /* Larger touch targets for resize handles on mobile */
    .resize-handle {
        opacity: 0.5;
    }

    .resize-handle-nw,
    .resize-handle-ne,
    .resize-handle-sw,
    .resize-handle-se {
        width: 24px;
        height: 24px;
    }

    .resize-handle-nw {
        top: -8px;
        left: -8px;
    }

    .resize-handle-ne {
        top: -8px;
        right: -8px;
    }

    .resize-handle-sw {
        bottom: -8px;
        left: -8px;
    }

    .resize-handle-se {
        bottom: -8px;
        right: -8px;
        /* Add visible indicator for primary resize handle */
        background: rgba(52, 152, 219, 0.3);
        border-radius: 0 0 8px 0;
    }

    .resize-handle-n,
    .resize-handle-s {
        height: 16px;
        left: 24px;
        right: 24px;
    }

    .resize-handle-n {
        top: -8px;
    }

    .resize-handle-s {
        bottom: -8px;
    }

    .resize-handle-w,
    .resize-handle-e {
        width: 16px;
        top: 24px;
        bottom: 24px;
    }

    .resize-handle-w {
        left: -8px;
    }

    .resize-handle-e {
        right: -8px;
    }

    /* Content editor adjustments for mobile */
    .content-editor {
        width: 100% !important;
        height: 100vh !important;
        max-width: 100% !important;
        min-width: unset !important;
        border-radius: 0;
        left: 0 !important;
        top: 0 !important;
    }

    .content-editor-body {
        flex-direction: column;
    }

    .content-editor-resizer {
        width: 100%;
        height: 6px;
        cursor: row-resize;
    }

    .content-editor-input,
    .content-editor-preview {
        min-width: 100%;
        min-height: 150px;
    }

    /* Tool settings modal adjustments */
    .tool-settings {
        width: 90%;
        max-width: 320px;
    }

    /* Import/Export modal adjustments */
    .import-export-content {
        width: 95%;
        max-height: 90vh;
        padding: 15px;
    }

    /* Better tap feedback */
    .tool-header .header-btn {
        opacity: 1;
        width: 28px;
        height: 28px;
    }

    .toolboard-settings {
        left: 10px;
        right: 10px;
        min-width: unset;
    }
}

/* Extra small screens (portrait phones) */
@media (max-width: 480px) {
    header {
        padding: 6px 8px;
        gap: 6px;
    }

    .board-selector-trigger {
        font-size: 0.85rem;
        max-width: 110px;
    }

    .header-settings-btn {
        width: 32px;
        height: 32px;
    }

    .header-section {
        gap: 3px;
    }

    .header-section-notes,
    .header-section-page {
        padding-left: 4px;
    }

    .board-manager-content {
        max-width: 95%;
        max-height: 90vh;
    }

    .board-manager-actions {
        opacity: 1;
    }

}

/* Touch-specific improvements */
@media (pointer: coarse) {
    .tool-header {
        cursor: grab;
        -webkit-user-select: none;
        user-select: none;
    }

    .resize-handle {
        opacity: 0.6;
    }

    .resize-handle-se {
        background: rgba(52, 152, 219, 0.4);
    }

    .tool-header .header-btn {
        opacity: 1;
    }
}

/* Command-palette tool search */
.tool-search-overlay {
    position: fixed;
    inset: 0;
    background: var(--overlay-bg);
    display: flex;
    justify-content: center;
    padding-top: 20vh;
    z-index: 10010;
}
.tool-search-modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    width: 500px;
    max-width: 94vw;
    max-height: 420px;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-heavy) 0 8px 30px;
    overflow: hidden;
    align-self: flex-start;
}
.tool-search-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    gap: 10px;
}
.tool-search-header svg {
    flex-shrink: 0;
    color: var(--text-muted);
}
.tool-search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 16px;
    color: var(--text-primary);
    font-family: inherit;
}
.tool-search-input::placeholder { color: var(--text-muted); }
.tool-search-kbd {
    font-size: 11px;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 2px 6px;
    flex-shrink: 0;
}
.tool-search-results {
    overflow-y: auto;
    flex: 1;
}
.tool-search-item {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    cursor: pointer;
    gap: 10px;
    transition: background 0.1s;
}
.tool-search-item:hover, .tool-search-item.active {
    background: var(--table-hover);
}
.tool-search-item-title {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 500;
}
.tool-search-item-board {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: auto;
    flex-shrink: 0;
}
.tool-search-empty {
    padding: 24px 16px;
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
}
.tool-search-hint {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 16px;
    border-top: 1px solid var(--border-color);
    font-size: 11px;
    color: var(--text-muted);
}
.tool-search-hint kbd {
    font-size: 11px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 3px;
    padding: 1px 5px;
    font-family: inherit;
}
    </style>
</head>
<body>
    <header id="mainHeader">
        <div class="header-section header-section-board">
            <a href="https://toolboard.me" title="Visit Toolboard.me"><img alt="Toolboard Logo" style="width: 24px; height: 24px;" src="data:image/svg+xml,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%20300%20300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22board%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%22300%22%20y2%3D%22300%22%20gradientUnits%3D%22userSpaceOnUse%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%233d4555%22%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%231e2230%22%2F%3E%3C%2FlinearGradient%3E%3CradialGradient%20id%3D%22vignette%22%20cx%3D%220.45%22%20cy%3D%220.4%22%20r%3D%220.65%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23fff%22%20stop-opacity%3D%220.03%22%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23000%22%20stop-opacity%3D%220.2%22%2F%3E%3C%2FradialGradient%3E%3Cpattern%20id%3D%22holes%22%20x%3D%2215%22%20y%3D%2215%22%20width%3D%2230%22%20height%3D%2230%22%20patternUnits%3D%22userSpaceOnUse%22%3E%3Ccircle%20cx%3D%2210%22%20cy%3D%2210%22%20r%3D%228%22%20fill%3D%22%2314171e%22%2F%3E%3C%2Fpattern%3E%3CclipPath%20id%3D%22hole-clip%22%3E%3Crect%20x%3D%228%22%20y%3D%228%22%20width%3D%22274%22%20height%3D%22274%22%20rx%3D%2220%22%2F%3E%3C%2FclipPath%3E%3ClinearGradient%20id%3D%22amber%22%20x1%3D%22145%22%20y1%3D%2215%22%20x2%3D%22165%22%20y2%3D%22280%22%20gradientUnits%3D%22userSpaceOnUse%22%3E%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23fef3c7%22%2F%3E%3Cstop%20offset%3D%2225%25%22%20stop-color%3D%22%23fcd34d%22%2F%3E%3Cstop%20offset%3D%2260%25%22%20stop-color%3D%22%23f59e0b%22%2F%3E%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23d97706%22%2F%3E%3C%2FlinearGradient%3E%3Cfilter%20id%3D%22bloom%22%20x%3D%22-50%25%22%20y%3D%22-50%25%22%20width%3D%22200%25%22%20height%3D%22200%25%22%3E%3CfeGaussianBlur%20stdDeviation%3D%2218%22%2F%3E%3C%2Ffilter%3E%3Cfilter%20id%3D%22glow%22%20x%3D%22-15%25%22%20y%3D%22-15%25%22%20width%3D%22130%25%22%20height%3D%22130%25%22%3E%3CfeGaussianBlur%20in%3D%22SourceGraphic%22%20stdDeviation%3D%222%22%20result%3D%22blur%22%2F%3E%3CfeMerge%3E%3CfeMergeNode%20in%3D%22blur%22%2F%3E%3CfeMergeNode%20in%3D%22SourceGraphic%22%2F%3E%3C%2FfeMerge%3E%3C%2Ffilter%3E%3C%2Fdefs%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20rx%3D%2226%22%20fill%3D%22url%28%23board%29%22%2F%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20rx%3D%2226%22%20fill%3D%22url%28%23vignette%29%22%2F%3E%3Crect%20x%3D%221%22%20y%3D%221%22%20width%3D%22298%22%20height%3D%22298%22%20rx%3D%2225%22%20fill%3D%22none%22%20stroke%3D%22%234c566a%22%20stroke-width%3D%221.2%22%20opacity%3D%220.35%22%2F%3E%3Cg%20clip-path%3D%22url%28%23hole-clip%29%22%3E%3Crect%20x%3D%225%22%20y%3D%225%22%20width%3D%22290%22%20height%3D%22290%22%20fill%3D%22url%28%23holes%29%22%2F%3E%3C%2Fg%3E%3Cg%20filter%3D%22url%28%23bloom%29%22%20opacity%3D%220.18%22%3E%3Crect%20x%3D%2215%22%20y%3D%2212%22%20width%3D%22260%22%20height%3D%2282%22%20rx%3D%2210%22%20fill%3D%22%23fbbf24%22%2F%3E%3Crect%20x%3D%22105%22%20y%3D%2282%22%20width%3D%2280%22%20height%3D%22195%22%20rx%3D%2210%22%20fill%3D%22%23f59e0b%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22url%28%23amber%29%22%20filter%3D%22url%28%23glow%29%22%3E%3Ccircle%20cx%3D%2225%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2255%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2285%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22205%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22235%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22265%22%20cy%3D%2225%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2225%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2255%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2285%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22205%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22235%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22265%22%20cy%3D%2255%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2225%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2255%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%2285%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22205%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22235%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22265%22%20cy%3D%2285%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22115%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22115%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22115%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22145%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22145%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22145%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22175%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22175%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22175%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22205%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22205%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22205%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22235%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22235%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22235%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22115%22%20cy%3D%22265%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22145%22%20cy%3D%22265%22%20r%3D%2210%22%2F%3E%3Ccircle%20cx%3D%22175%22%20cy%3D%22265%22%20r%3D%2210%22%2F%3E%3C%2Fg%3E%3Cg%20fill%3D%22%23fff%22%20opacity%3D%220.3%22%3E%3Ccircle%20cx%3D%2222%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2252%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2282%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22202%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22232%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22262%22%20cy%3D%2222%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2222%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2252%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2282%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22202%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22232%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22262%22%20cy%3D%2252%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2222%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2252%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%2282%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22202%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22232%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22262%22%20cy%3D%2282%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22112%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22112%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22112%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22142%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22142%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22142%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22172%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22172%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22172%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22202%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22202%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22202%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22232%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22232%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22232%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22112%22%20cy%3D%22262%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22142%22%20cy%3D%22262%22%20r%3D%224%22%2F%3E%3Ccircle%20cx%3D%22172%22%20cy%3D%22262%22%20r%3D%224%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E"></a>
            <h1 id="toolboardTitle" style="display:none;">My Toolboard</h1>
            <button id="boardSelectorTrigger" class="board-selector-trigger" title="Manage Boards"></button>
            <button id="toolboardSettingsBtn" class="header-settings-btn" title="Edit Toolboard">&#8942;</button>
            <span id="toolboardVersion" class="toolboard-version"></span>
        </div>
        <div class="header-section header-section-notes">
            <button id="addToolBtn" class="header-settings-btn" title="Add Tool">+</button>
            <button id="minimizeAllBtn" class="header-settings-btn" title="Minimize/Maximize All">&#8211;</button>
            <button id="deleteAllBtn" class="header-settings-btn" title="Delete All Tools">&times;</button>
        </div>
        <div class="header-section header-section-page">
            <button id="searchToolBtn" class="header-settings-btn" title="Search tools (Ctrl+K)">&#128269;</button>
            <button id="darkModeToggle" class="header-settings-btn" title="Toggle Dark Mode">&#9790;</button>
            <div id="storageIndicator" class="storage-indicator" title="localStorage usage"></div>
            <button id="importExportBtn" class="header-settings-btn" title="Import/Export">&#8693;</button>
        </div>
        <div id="toolboardSettings" class="toolboard-settings">
            <label>Board Title</label>
            <input type="text" id="toolboardTitleInput" placeholder="Board title">
            <label>Header Color</label>
            <div class="color-picker-row" id="toolboardColorPicker"></div>
            <label>Board Font</label>
            <select id="toolboardFontFamily" class="font-select">
                <option value="">System Default</option>
                <option value="Inter, sans-serif">Inter</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Monaco', monospace">Monaco</option>
                <option value="'Fira Code', monospace">Fira Code</option>
            </select>
            <label>Font Size</label>
            <select id="toolboardFontSize" class="font-select">
                <option value="">Default</option>
                <option value="11px">Small (11px)</option>
                <option value="13px">Medium (13px)</option>
                <option value="14px">Large (14px)</option>
                <option value="16px">X-Large (16px)</option>
                <option value="18px">XX-Large (18px)</option>
            </select>
        </div>
    </header>

    <!-- Board Manager Popup -->
    <div id="boardManagerOverlay" class="board-manager-overlay">
        <div class="board-manager-content">
            <div class="board-manager-header">
                <span class="board-manager-title">Boards</span>
                <button class="board-manager-close" title="Close">&times;</button>
            </div>
            <div id="boardManagerList" class="board-manager-list"></div>
            <div class="board-manager-footer">
                <button id="boardManagerNewBtn" class="board-manager-new-btn">+ New Board</button>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div id="importExportModal" class="import-export-modal">
        <div class="import-export-content">
            <span class="import-export-close">&times;</span>
            <h2>Import / Export</h2>

            <div class="import-export-tabs">
                <button class="import-export-tab active" data-tab="export">Export</button>
                <button class="import-export-tab" data-tab="import">Import</button>
            </div>

            <!-- Export Tool -->
            <div id="exportTool" class="import-export-tool active">
                <h3>Export Tools</h3>
                <div id="exportToolsList" class="checkbox-list"></div>
                <button id="exportSelectedTools" class="export-btn">Export Selected Tools</button>

                <h3 style="margin-top: 15px;">Export Boards</h3>
                <div id="exportBoardsList" class="checkbox-list"></div>
                <button id="exportSelectedBoards" class="export-btn">Export Selected Boards</button>

                <h3 style="margin-top: 15px;">Export Current Board View</h3>
                <p style="color: #7f8c8d; margin-bottom: 10px; font-size: 12px;">Export the current board as a standalone file.</p>
                <div style="display: flex; gap: 10px;">
                    <button id="exportBoardAsHTML" class="export-btn">Export as HTML</button>
                    <button id="exportBoardAsPNG" class="export-btn">Export as PNG</button>
                </div>
            </div>

            <!-- Import Tool -->
            <div id="importTool" class="import-export-tool">
                <h3>Import from File</h3>
                <input type="file" id="importFileInput" class="import-file-input" accept=".json">

                <h3>Or Paste JSON</h3>
                <textarea id="importTextarea" class="import-textarea" placeholder="Paste JSON data here..."></textarea>

                <button id="importDataBtn" class="import-btn">Import Data</button>
                <div id="importResult"></div>
            </div>

        </div>
    </div>

    <!-- Fullscreen backdrop -->
    <div id="fullscreenBackdrop" class="fullscreen-backdrop"></div>

    <!-- Tool search overlay -->
    <div id="toolSearchOverlay" class="tool-search-overlay" style="display:none">
        <div class="tool-search-modal">
            <div class="tool-search-header">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
                <input id="toolSearchInput" class="tool-search-input" type="text" placeholder="Search tools across all boards..." autocomplete="off">
                <span class="tool-search-kbd">ESC</span>
            </div>
            <div id="toolSearchResults" class="tool-search-results"></div>
            <div class="tool-search-hint">
                <span><kbd>&uarr;</kbd><kbd>&darr;</kbd> navigate</span>
                <span><kbd>Enter</kbd> open</span>
                <span><kbd>Esc</kbd> close</span>
            </div>
        </div>
    </div>

    <main id="toolboard">
        <!-- Tools will be dynamically generated -->
    </main>

    <!-- Content Editor Modal -->
    <div id="contentEditorOverlay" class="content-editor-overlay">
        <div class="content-editor">
            <div class="content-editor-header">
                <h3>Edit Content: <span id="editorToolTitle"></span></h3>
                <button class="content-editor-close">&times;</button>
            </div>
            <div class="content-editor-body">
                <div class="content-editor-input">
                    <div class="content-editor-label" style="display:flex;align-items:center;justify-content:space-between;">
                        <label id="editorPlainTextToggle" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" id="editorPlainTextCheckbox"> Plain text
                        </label>
                        <div style="display:flex;gap:4px;">
                            <button id="editorSortLinesBtn" class="editor-action-btn" title="Sort lines A-Z (Ctrl+Shift+S)">Sort</button>
                            <button id="editorReverseSortBtn" class="editor-action-btn" title="Sort lines Z-A (Ctrl+Shift+R)">Reverse</button>
                            <button id="editorUniqueLinesBtn" class="editor-action-btn" title="Remove duplicate lines (Ctrl+Shift+U)">Unique</button>
                        </div>
                    </div>
                    <div class="content-editor-find-replace" id="editorFindReplace" style="display:none;">
                        <div class="find-replace-row">
                            <button id="editorFindToggleReplace" title="Toggle Replace">&#9654;</button>
                            <input type="text" id="editorFindInput" placeholder="Find">
                            <span id="editorFindInfo">No results</span>
                            <button id="editorFindPrev" title="Previous (Shift+Enter)">&#9650;</button>
                            <button id="editorFindNext" title="Next (Enter)">&#9660;</button>
                            <label><input type="checkbox" id="editorFindCaseSensitive"> Aa</label>
                            <button id="editorFindClose" title="Close (Esc)">&times;</button>
                        </div>
                        <div class="find-replace-row" id="editorReplaceRow" style="display:none;">
                            <span style="width:22px;flex-shrink:0;"></span>
                            <input type="text" id="editorReplaceInput" placeholder="Replace">
                            <button id="editorReplaceBtn">Replace</button>
                            <button id="editorReplaceAllBtn">All</button>
                        </div>
                    </div>
                    <textarea class="content-editor-textarea" id="contentEditorTextarea" placeholder="Enter markdown content..."></textarea>
                </div>
                <div class="content-editor-resizer" id="editorResizer"></div>
                <div class="content-editor-preview">
                    <div class="content-editor-label">Preview</div>
                    <div class="content-editor-preview-area markdown-content" id="contentEditorPreview"></div>
                </div>
            </div>
            <div class="content-editor-footer">
                <button class="content-editor-reset">Reset to Default</button>
                <button class="content-editor-cancel">Cancel</button>
                <button class="content-editor-save">Save</button>
            </div>
            <div class="content-editor-resize content-editor-resize-e" data-resize="e"></div>
            <div class="content-editor-resize content-editor-resize-s" data-resize="s"></div>
            <div class="content-editor-resize content-editor-resize-se" data-resize="se"></div>
        </div>
    </div>

    <!-- Feature Selection Modal -->
    <div id="featureSelectModal" class="feature-select-modal">
        <div class="feature-select-content">
            <span class="feature-select-close">&times;</span>
            <h2>Add to Board</h2>

            <div class="feature-select-tabs">
                <button class="feature-tab active" data-tab="tools">Tools</button>
                <button class="feature-tab" data-tab="toolboxes">Toolboxes</button>
                <button class="feature-tab" data-tab="templates">Board Templates</button>
            </div>

            <!-- Tools Tab -->
            <div id="featureToolsTab" class="feature-tab-content active">
                <div class="feature-search-row">
                    <input type="text" id="featureSearchInput" class="feature-search-input" placeholder="Search tools...">
                    <select id="featureToolboxFilter" class="feature-toolbox-filter">
                        <option value="all">All Toolboxes</option>
                    </select>
                </div>
                <div id="featureSelectList" class="feature-select-list"></div>
            </div>

            <!-- Toolboxes Tab -->
            <div id="featureToolboxesTab" class="feature-tab-content">
                <div id="toolboxesList" class="toolboxes-list"></div>
            </div>

            <!-- Board Templates Tab -->
            <div id="featureTemplatesTab" class="feature-tab-content">
                <div id="boardTemplatesList" class="board-templates-list"></div>
            </div>
        </div>
    </div>

    <!-- Tool Settings Modal -->
    <div id="toolSettingsOverlay" class="tool-settings-overlay">
        <div class="tool-settings">
            <div class="tool-settings-header">
                <h3>Tool Settings</h3>
                <button class="tool-settings-close">&times;</button>
            </div>
            <label>Title</label>
            <input type="text" id="toolSettingsTitleInput" class="title-input" placeholder="Tool title">
            <label>Color</label>
            <div class="color-picker-row" id="toolSettingsColorPicker"></div>
            <label>Font Family</label>
            <select id="toolSettingsFontFamily" class="font-select">
                <option value="">Use Board Default</option>
                <option value="Inter, sans-serif">Inter</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Monaco', monospace">Monaco</option>
                <option value="'Fira Code', monospace">Fira Code</option>
            </select>
            <label>Font Size</label>
            <select id="toolSettingsFontSize" class="font-select">
                <option value="">Use Board Default</option>
                <option value="10px">X-Small (10px)</option>
                <option value="11px">Small (11px)</option>
                <option value="12px">Medium (12px)</option>
                <option value="13px">Large (13px)</option>
                <option value="14px">X-Large (14px)</option>
                <option value="16px">XX-Large (16px)</option>
            </select>
            <button class="edit-content-btn" id="toolSettingsEditBtn">Edit Content</button>
            <button class="duplicate-tool-btn" id="toolSettingsDuplicateBtn">Duplicate Tool</button>
            <button class="export-tool-btn" id="toolSettingsExportBtn">Export as HTML</button>
            <button class="export-png-btn" id="toolSettingsExportPngBtn">Export as PNG</button>
            <button class="delete-tool-btn" id="toolSettingsDeleteBtn">Hide Tool</button>
        </div>
    </div>

    <script>
// Default variables - empty for generic toolboard, import a board to add data
const DEFAULT_VARIABLES = {};

// Built-in tools - empty for generic toolboard, import tools/boards to add
const SECTIONS = [];

// Generate default positions (empty for generic toolboard)
function generateDefaultPositions() {
    return {};
}

const DEFAULT_POSITIONS = generateDefaultPositions();

// Utility: HTML escape function
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

// Utility: Parse markdown using marked library
function parseMarkdown(text) {
    if (!text) return '';
    return marked.parse(text, { breaks: true });
}

// Tool templates for feature selection
const NOTE_TEMPLATES = {
    'blank': {
        id: 'blank',
        name: 'Note',
        description: 'A blank note for freeform text and ideas',
        icon: '📝',
        title: 'New Tool',
        content: ''
    },
    'dynamic-investment-calculator': {
        id: 'dynamic-investment-calculator',
        name: 'Investment Growth Calculator',
        description: 'Interactive calculator with inputs for initial amount, monthly contribution, rate, and years',
        icon: '📈',
        title: 'Investment Growth Calculator',
        content: `<div class="calc-widget">
<div class="calc-grid">
<div>
<label>Initial Investment</label>
<input type="number" id="growthInitial" value="10000" oninput="calculateGrowth()">
</div>
<div>
<label>Monthly Contribution</label>
<input type="number" id="growthMonthly" value="500" oninput="calculateGrowth()">
</div>
<div>
<label>Annual Return (%)</label>
<input type="number" id="growthRate" value="7" step="0.1" oninput="calculateGrowth()">
</div>
<div>
<label>Years</label>
<input type="number" id="growthYears" value="30" oninput="calculateGrowth()">
</div>
</div>
<div style="margin-bottom:15px;">
<label>Compounding</label>
<div class="calc-toggle">
<label><input type="radio" name="growthCompound" value="monthly" checked onchange="calculateGrowth()"><span>Monthly</span></label>
<label><input type="radio" name="growthCompound" value="annual" onchange="calculateGrowth()"><span>Annual</span></label>
</div>
</div>
<div id="growthResults"></div>
</div>`,
        onInit: 'calculateGrowth'
    },
    'simple-calculator': {
        id: 'simple-calculator',
        name: 'Simple Calculator',
        description: 'Basic arithmetic calculator for quick math',
        icon: '🔢',
        title: 'Calculator',
        content: `<div style="background:#2c3e50;padding:15px;border-radius:8px;max-width:240px;">
<input type="text" id="calcDisplay" value="0" readonly style="width:100%;padding:12px;font-size:24px;text-align:right;border:none;border-radius:4px;margin-bottom:10px;background:#ecf0f1;font-family:monospace;">
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
<button onclick="calcClear()" style="grid-column:span 2;padding:15px;font-size:16px;border:none;border-radius:4px;background:#e74c3c;color:white;cursor:pointer;">C</button>
<button onclick="calcBackspace()" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#95a5a6;color:white;cursor:pointer;">⌫</button>
<button onclick="calcOp('/')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">÷</button>
<button onclick="calcNum('7')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">7</button>
<button onclick="calcNum('8')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">8</button>
<button onclick="calcNum('9')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">9</button>
<button onclick="calcOp('*')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">×</button>
<button onclick="calcNum('4')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">4</button>
<button onclick="calcNum('5')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">5</button>
<button onclick="calcNum('6')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">6</button>
<button onclick="calcOp('-')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">−</button>
<button onclick="calcNum('1')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">1</button>
<button onclick="calcNum('2')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">2</button>
<button onclick="calcNum('3')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">3</button>
<button onclick="calcOp('+')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#3498db;color:white;cursor:pointer;">+</button>
<button onclick="calcNum('0')" style="grid-column:span 2;padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">0</button>
<button onclick="calcNum('.')" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#ecf0f1;cursor:pointer;">.</button>
<button onclick="calcEquals()" style="padding:15px;font-size:16px;border:none;border-radius:4px;background:#27ae60;color:white;cursor:pointer;">=</button>
</div>
</div>`,
        onInit: 'calcInit'
    },
    'dynamic-tax-calculator': {
        id: 'dynamic-tax-calculator',
        name: 'Tax Calculator',
        description: 'Interactive calculator for estimating federal income tax',
        icon: '🧾',
        title: 'Tax Calculator',
        content: `<div class="calc-widget">
<div class="calc-grid">
<div>
<label>Annual Income</label>
<input type="number" id="taxIncome" value="75000" oninput="calculateTax()">
</div>
<div>
<label>Filing Status</label>
<select id="taxStatus" onchange="calculateTax()">
<option value="single">Single</option>
<option value="married">Married Filing Jointly</option>
</select>
</div>
</div>
<div id="taxResults"></div>
</div>`,
        onInit: 'calculateTax'
    },
    'loan-calculator': {
        id: 'loan-calculator',
        name: 'Loan Calculator',
        description: 'Calculate monthly payments, total interest, and amortization',
        icon: '🏦',
        title: 'Loan Calculator',
        content: `<div class="calc-widget">
<div class="calc-grid">
<div>
<label>Loan Amount</label>
<input type="number" id="loanAmount" value="300000" oninput="calculateLoan()">
</div>
<div>
<label>Interest Rate (%)</label>
<input type="number" id="loanRate" value="6.5" step="0.125" oninput="calculateLoan()">
</div>
<div>
<label>Loan Term (years)</label>
<input type="number" id="loanYears" value="30" oninput="calculateLoan()">
</div>
<div>
<label>Extra Monthly Payment</label>
<input type="number" id="loanExtra" value="0" oninput="calculateLoan()">
</div>
</div>
<div id="loanResults"></div>
</div>`,
        onInit: 'calculateLoan'
    },
    'checklist': {
        id: 'checklist',
        name: 'Checklist',
        description: 'Interactive checklist with add, check, and delete functionality',
        icon: '✅',
        title: 'Checklist',
        content: `<div class="checklist-widget" style="padding:10px;">
<div style="display:flex;gap:8px;margin-bottom:12px;">
<input type="text" class="checklist-input" placeholder="Add new item..." style="flex:1;padding:8px 10px;border:1px solid var(--border-color);border-radius:4px;font-size:13px;background:var(--input-bg);color:var(--text-primary);">
<button onclick="checklistAddItem(this)" style="padding:8px 14px;background:#27ae60;color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px;">Add</button>
</div>
<ul class="checklist-items" style="list-style:none;padding:0;margin:0;"></ul>
<textarea class="checklist-markdown-editor" style="display:none;"></textarea>
<div class="checklist-summary" style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border-light);font-size:11px;color:var(--text-muted);display:flex;align-items:center;justify-content:space-between;">
<span class="checklist-summary-text"></span>
<button class="checklist-md-btn" onclick="checklistToggleMarkdown(this)" title="Edit as markdown">✎ Markdown</button>
</div>
</div>`,
        onInit: 'checklistInit'
    },
    'random-picker': {
        id: 'random-picker',
        name: 'Random Picker',
        description: 'Spin the wheel to randomly pick from a list of options',
        icon: '🎲',
        title: 'Random Picker',
        content: `<div class="picker-widget">
<div class="picker-input-row">
<input type="text" class="picker-input" placeholder="Add an option..." onkeydown="if(event.key==='Enter'){pickerAddItem(this.nextElementSibling);event.preventDefault();}">
<button onclick="pickerAddItem(this)">Add</button>
</div>
<div class="picker-items"></div>
<div class="picker-wheel-area">
<div class="picker-wheel-container">
<div class="picker-pointer"></div>
<svg class="picker-wheel-svg" viewBox="0 0 260 260"></svg>
</div>
<div class="picker-result"></div>
</div>
<button class="picker-spin-btn" onclick="pickerSpin(this)">Spin!</button>
</div>`,
        onInit: 'pickerInit'
    },
    'calendar': {
        id: 'calendar',
        name: 'Calendar',
        description: 'Year view calendar with .ics import and event tracking',
        icon: '📅',
        title: 'Calendar ' + new Date().getFullYear(),
        content: `<div class="calendar-widget">
<div class="calendar-header">
<div class="calendar-view-toggle">
<button class="calendar-view-btn active" onclick="calendarSetView(this, 'year')">Year</button>
<button class="calendar-view-btn" onclick="calendarSetView(this, 'month')">Month</button>
</div>
<div class="calendar-year-nav">
<button onclick="calendarPrevYear(this)">&lt;</button>
<span class="calendar-year-display">${new Date().getFullYear()}</span>
<button onclick="calendarNextYear(this)">&gt;</button>
</div>
<button class="calendar-manage-btn" onclick="calendarOpenManage(this)">Manage</button>
</div>
<div class="calendar-year-grid"></div>
<div class="calendar-month-view">
<div class="calendar-month-nav">
<button onclick="calendarPrevMonth(this)">&lt;</button>
<span class="calendar-month-title"></span>
<button onclick="calendarNextMonth(this)">&gt;</button>
<button class="calendar-today-btn" onclick="calendarGoToToday(this)">Today</button>
</div>
<div class="calendar-month-detail"></div>
</div>
<div class="calendar-legend"></div>
</div>`,
        onInit: 'calendarInit'
    },
    'diff-viewer': {
        id: 'diff-viewer',
        name: 'Diff Viewer',
        description: 'Compare two texts with visual diff highlighting',
        icon: '🔀',
        title: 'Text Diff',
        content: `<div class="diff-widget">
<div class="diff-toolbar">
<div class="diff-mode-toggle">
<button class="diff-mode-btn active" onclick="diffSetMode(this, 'edit')">Edit</button>
<button class="diff-mode-btn" onclick="diffSetMode(this, 'view')">View</button>
</div>
<div class="diff-view-options">
<button class="diff-view-btn active" onclick="diffSetView(this, 'split')">Split</button>
<button class="diff-view-btn" onclick="diffSetView(this, 'unified')">Unified</button>
<label class="diff-whitespace-toggle">
<input type="checkbox" onchange="diffToggleWhitespace(this)">
Hide Whitespace
</label>
</div>
</div>
<div class="diff-edit-container">
<div class="diff-edit-pane">
<label>Original</label>
<textarea placeholder="Enter original text..." oninput="diffOnInput(this, 'original')" onscroll="diffSyncScroll(this, 'original')"></textarea>
</div>
<div class="diff-edit-resizer"></div>
<div class="diff-edit-pane">
<label>Modified</label>
<textarea placeholder="Enter modified text..." oninput="diffOnInput(this, 'modified')" onscroll="diffSyncScroll(this, 'modified')"></textarea>
</div>
</div>
<div class="diff-view-container">
<div class="diff-output"></div>
</div>
<div class="diff-stats"></div>
</div>`,
        onInit: 'diffInit'
    },
    'sequence-diagram': {
        id: 'sequence-diagram',
        name: 'Sequence Diagram',
        description: 'Create sequence diagrams from simple text notation',
        icon: '📊',
        title: 'Sequence Diagram',
        content: `<div class="seq-widget">
<div class="seq-toolbar">
<div class="seq-mode-toggle">
<button class="seq-mode-btn" onclick="seqSetMode(this, 'edit')">Edit</button>
<button class="seq-mode-btn active" onclick="seqSetMode(this, 'split')">Split</button>
<button class="seq-mode-btn" onclick="seqSetMode(this, 'view')">View</button>
</div>
<button class="seq-help-btn" onclick="seqShowHelp(this)">? Syntax Help</button>
</div>
<div class="seq-edit-container">
<textarea placeholder="Enter sequence diagram notation..." oninput="seqOnInput(this)"></textarea>
</div>
<div class="seq-split-container active">
<div class="seq-edit-pane">
<textarea placeholder="Enter sequence diagram notation...

Example:
Alice -> Bob: Hello
Bob --> Alice: Hi there!
Bob -> Charlie: Forward
Charlie --> Bob: Reply" oninput="seqOnInput(this)"></textarea>
</div>
<div class="seq-split-resizer"></div>
<div class="seq-view-pane">
<div class="seq-diagram"></div>
</div>
</div>
<div class="seq-view-container">
<div class="seq-diagram"></div>
</div>
<div class="seq-help-text">
<code>A -> B: msg</code> | <code>Note over A: text</code> | Colors: <code>[red]</code> or <code>[line:red, text:blue]</code>
</div>
</div>`,
        onInit: 'seqInit'
    },
    'jwt-decoder': {
        id: 'jwt-decoder',
        name: 'JWT Decoder',
        description: 'Decode and inspect JSON Web Tokens',
        icon: '🔐',
        title: 'JWT Decoder',
        content: `<div class="jwt-widget">
<div class="jwt-input-section">
<label>Paste JWT Token</label>
<div class="jwt-toolbar">
<button class="jwt-sample-btn" onclick="jwtLoadSample()">Load Sample</button>
<button class="jwt-sample-btn" onclick="jwtClear()">Clear</button>
</div>
<textarea placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c" oninput="jwtDecode(this)"></textarea>
</div>
<div class="jwt-output-section">
<div class="jwt-results"></div>
</div>
</div>`,
        onInit: 'jwtInit'
    },
    'code-formatter': {
        id: 'code-formatter',
        name: 'Code Formatter',
        description: 'Prettify or minify JSON, XML, CSV, and SQL',
        icon: '🎨',
        title: 'Code Formatter',
        content: `<div class="fmt-widget">
<div class="fmt-toolbar">
<div class="fmt-format-toggle">
<button class="fmt-format-btn active" onclick="fmtSetFormat(this, 'json')">JSON</button>
<button class="fmt-format-btn" onclick="fmtSetFormat(this, 'xml')">XML</button>
<button class="fmt-format-btn" onclick="fmtSetFormat(this, 'csv')">CSV</button>
<button class="fmt-format-btn" onclick="fmtSetFormat(this, 'sql')">SQL</button>
</div>
<div class="fmt-actions">
<button class="fmt-action-btn" onclick="fmtPrettify(this)">Prettify</button>
<button class="fmt-action-btn" onclick="fmtMinify(this)">Minify</button>
<button class="fmt-action-btn" onclick="fmtCopy(this)">Copy</button>
<button class="fmt-action-btn" onclick="fmtSwap(this)">Swap</button>
</div>
</div>
<div class="fmt-container">
<div class="fmt-pane">
<label>Input</label>
<textarea class="fmt-input" placeholder="Paste your code here..." oninput="fmtOnInput(this)"></textarea>
</div>
<div class="fmt-resizer"></div>
<div class="fmt-pane">
<label>Output</label>
<textarea class="fmt-output" readonly placeholder="Formatted output will appear here..."></textarea>
</div>
</div>
<div class="fmt-status"></div>
</div>`,
        onInit: 'fmtInit'
    },
    'cron-expression': {
        id: 'cron-expression',
        name: 'Cron Expression',
        description: 'Interactive cron expression parser with schedule preview',
        icon: '⏰',
        title: 'Cron Expression',
        content: `<div class="cron-widget">
<div class="cron-input-section">
<div class="cron-input-row">
<input type="text" class="cron-input" placeholder="* * * * *" value="0 9 * * MON-FRI" oninput="cronParse(this)">
</div>
<div class="cron-presets">
<button class="cron-preset-btn" onclick="cronSetPreset(this, '* * * * *')">Every minute</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 * * * *')">Every hour</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 0 * * *')">Daily midnight</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 9 * * MON-FRI')">Weekdays 9am</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 0 * * 0')">Weekly Sunday</button>
<button class="cron-preset-btn" onclick="cronSetPreset(this, '0 0 1 * *')">Monthly 1st</button>
</div>
</div>
<div class="cron-explanation">
<div class="cron-explanation-text"></div>
</div>
<div class="cron-fields"></div>
<div class="cron-schedule">
<div class="cron-schedule-header">
<span class="cron-schedule-title">Next scheduled runs</span>
<span class="cron-schedule-count"></span>
</div>
<div class="cron-schedule-list"></div>
</div>
</div>`,
        onInit: 'cronInit'
    },
    'regex-tester': {
        id: 'regex-tester',
        name: 'Regex Tester',
        description: 'Test regular expressions with real-time matching and highlighting',
        icon: '🔍',
        title: 'Regex Tester',
        content: `<div class="regex-widget">
<div class="regex-toolbar">
<div class="regex-flags">
<label title="Global - find all matches"><input type="checkbox" class="regex-flag" data-flag="g" checked onchange="regexOnInput(this)"> g</label>
<label title="Case insensitive"><input type="checkbox" class="regex-flag" data-flag="i" onchange="regexOnInput(this)"> i</label>
<label title="Multiline - ^ and $ match line boundaries"><input type="checkbox" class="regex-flag" data-flag="m" onchange="regexOnInput(this)"> m</label>
<label title="Dot matches newlines"><input type="checkbox" class="regex-flag" data-flag="s" onchange="regexOnInput(this)"> s</label>
</div>
<div class="regex-actions">
<button class="regex-action-btn" onclick="regexCopy(this)">Copy Regex</button>
<button class="regex-action-btn" onclick="regexClear(this)">Clear</button>
</div>
</div>
<div class="regex-input-row">
<label>Pattern</label>
<input type="text" class="regex-pattern" placeholder="Enter regex pattern..." oninput="regexOnInput(this)">
</div>
<div class="regex-container">
<div class="regex-pane">
<label>Test String</label>
<textarea class="regex-test-string" placeholder="Enter text to test against..." oninput="regexOnInput(this)"></textarea>
</div>
<div class="regex-resizer"></div>
<div class="regex-pane regex-results-pane">
<label>Match Results</label>
<div class="regex-results"></div>
</div>
</div>
<div class="regex-status"></div>
</div>`,
        onInit: 'regexInit'
    },
    'epoch-converter': {
        id: 'epoch-converter',
        name: 'Epoch Converter',
        description: 'Convert between Unix timestamps and human-readable dates',
        icon: '⏱️',
        title: 'Epoch Converter',
        content: `<div class="epoch-widget">
<div class="epoch-section">
<label>Current Time</label>
<div class="epoch-current">
<span class="epoch-now-value">-</span>
<button class="epoch-action-btn" onclick="epochCopyNow(this)">Copy</button>
<button class="epoch-action-btn" onclick="epochUseNow(this)">Use</button>
</div>
</div>
<div class="epoch-section">
<label>Unix Timestamp (seconds or milliseconds)</label>
<div class="epoch-input-row">
<input type="text" class="epoch-timestamp-input" placeholder="e.g. 1700000000 or 1700000000000" oninput="epochFromTimestamp(this)">
<select class="epoch-unit-select" onchange="epochFromTimestamp(this)">
<option value="auto">Auto-detect</option>
<option value="s">Seconds</option>
<option value="ms">Milliseconds</option>
</select>
</div>
<div class="epoch-result epoch-from-ts"></div>
</div>
<div class="epoch-section">
<label>Human Date/Time</label>
<div class="epoch-datetime-inputs">
<input type="date" class="epoch-date-input" oninput="epochFromDatetime(this)">
<input type="time" class="epoch-time-input" step="1" oninput="epochFromDatetime(this)">
<select class="epoch-tz-select" onchange="epochFromDatetime(this)">
<option value="local">Local Time</option>
<option value="utc">UTC</option>
</select>
</div>
<div class="epoch-result epoch-from-dt"></div>
</div>
<div class="epoch-section">
<label>Quick Reference</label>
<div class="epoch-reference">
<div class="epoch-ref-item"><span>Start of today:</span><code class="epoch-ref-today">-</code></div>
<div class="epoch-ref-item"><span>Start of year:</span><code class="epoch-ref-year">-</code></div>
<div class="epoch-ref-item"><span>Unix epoch:</span><code>0 (Jan 1, 1970 00:00:00 UTC)</code></div>
</div>
</div>
</div>`,
        onInit: 'epochInit'
    },
    'stopwatch': {
        id: 'stopwatch',
        name: 'Stopwatch',
        description: 'Stopwatch with lap times',
        icon: '⏱️',
        title: 'Stopwatch',
        content: `<div class="stopwatch-widget">
<div class="sw-display">00:00:00<span class="sw-ms">.000</span></div>
<div class="sw-buttons">
<button class="sw-btn sw-start" onclick="swToggle(this)">Start</button>
<button class="sw-btn sw-lap" onclick="swLap(this)" disabled>Lap</button>
<button class="sw-btn sw-reset" onclick="swReset(this)" disabled>Reset</button>
</div>
<div class="sw-laps"></div>
</div>`,
        onInit: 'stopwatchInit'
    }
};

// ============================================================
// Plugin Registry System
// ============================================================
const PluginRegistry = {
    tools: new Map(),
    toolboxes: new Map(),
    boards: new Map(),

    // Register a tool plugin
    registerTool(plugin) {
        if (!plugin.id) {
            console.error('Plugin tool missing required id:', plugin);
            return false;
        }
        // Normalize plugin structure
        const normalizedPlugin = {
            id: plugin.id,
            name: plugin.name || plugin.id,
            description: plugin.description || '',
            icon: plugin.icon || '📝',
            version: plugin.version || '1.0.0',
            toolbox: plugin.toolbox || 'uncategorized',
            tags: plugin.tags || [],
            title: plugin.title || plugin.name || plugin.id,
            content: plugin.content || '',
            contentType: plugin.contentType || (plugin.content && plugin.content.trim().startsWith('<') ? 'html' : 'markdown'),
            onInit: plugin.onInit || null,
            styles: plugin.styles || '',
            defaultWidth: plugin.defaultWidth || null,
            defaultHeight: plugin.defaultHeight || null,
            templateId: plugin.templateId || null,
            defaultContent: plugin.defaultContent || null,
            source: plugin.source || 'embedded' // 'embedded' or 'external'
        };
        this.tools.set(plugin.id, normalizedPlugin);
        return true;
    },

    // Register a toolbox plugin
    registerToolbox(plugin) {
        if (!plugin.id) {
            console.error('Plugin toolbox missing required id:', plugin);
            return false;
        }
        const normalizedPlugin = {
            id: plugin.id,
            name: plugin.name || plugin.id,
            description: plugin.description || '',
            icon: plugin.icon || '📦',
            color: plugin.color || '#3498db',
            version: plugin.version || '1.0.0',
            tools: plugin.tools || [],
            source: plugin.source || 'embedded'
        };
        this.toolboxes.set(plugin.id, normalizedPlugin);
        return true;
    },

    // Register a board template plugin
    registerBoard(plugin) {
        if (!plugin.id) {
            console.error('Plugin board missing required id:', plugin);
            return false;
        }
        const normalizedPlugin = {
            id: plugin.id,
            name: plugin.name || plugin.id,
            description: plugin.description || '',
            icon: plugin.icon || '📋',
            version: plugin.version || '1.0.0',
            settings: plugin.settings || {},
            tools: plugin.tools || [],
            source: plugin.source || 'embedded'
        };
        this.boards.set(plugin.id, normalizedPlugin);
        return true;
    },

    // Getters
    getTool(id) {
        return this.tools.get(id) || null;
    },

    getToolbox(id) {
        return this.toolboxes.get(id) || null;
    },

    getBoard(id) {
        return this.boards.get(id) || null;
    },

    // Get all tools for a specific toolbox
    getToolsByToolbox(toolboxId) {
        const results = [];
        for (const tool of this.tools.values()) {
            if (tool.toolbox === toolboxId) {
                results.push(tool);
            }
        }
        return results;
    },

    // Search tools by name, description, or tags
    searchTools(query) {
        const q = query.toLowerCase();
        const results = [];
        for (const tool of this.tools.values()) {
            const nameMatch = tool.name.toLowerCase().includes(q);
            const descMatch = tool.description.toLowerCase().includes(q);
            const tagMatch = tool.tags.some(tag => tag.toLowerCase().includes(q));
            if (nameMatch || descMatch || tagMatch) {
                results.push(tool);
            }
        }
        return results;
    },

    // Get all tools as array
    getAllTools() {
        return Array.from(this.tools.values());
    },

    // Get all toolboxes as array
    getAllToolboxes() {
        return Array.from(this.toolboxes.values());
    },

    // Get all boards as array
    getAllBoards() {
        return Array.from(this.boards.values());
    },

    // Export plugins used by a set of tool IDs for HTML embedding
    exportForEmbed(toolIds) {
        const exportedTools = [];
        const exportedToolboxes = new Set();

        for (const toolId of toolIds) {
            const tool = this.getTool(toolId);
            if (tool) {
                exportedTools.push(tool);
                if (tool.toolbox) {
                    exportedToolboxes.add(tool.toolbox);
                }
            }
        }

        const toolboxes = [];
        for (const toolboxId of exportedToolboxes) {
            const toolbox = this.getToolbox(toolboxId);
            if (toolbox) {
                toolboxes.push(toolbox);
            }
        }

        return { tools: exportedTools, toolboxes };
    }
};

// ============================================================
// Plugin Loader System (for external plugins)
// ============================================================
const PluginLoader = {
    STORAGE_KEY: 'toolboard_pluginUrls',
    loadedUrls: new Set(),

    // Get plugin URLs from localStorage
    getPluginUrls() {
        // Skip external plugins if this is an exported HTML (embedded data present)
        console.log('[PluginLoader] TOOLBOARD_EMBEDDED:', window.TOOLBOARD_EMBEDDED);
        if (window.TOOLBOARD_EMBEDDED) {
            console.log('[PluginLoader] Skipping external plugins - embedded mode');
            return [];
        }
        try {
            const stored = localStorage.getItem(this.STORAGE_KEY);
            const urls = stored ? JSON.parse(stored) : [];
            console.log('[PluginLoader] Loading plugins from localStorage:', urls);
            return urls;
        } catch (e) {
            console.error('Error reading plugin URLs:', e);
            return [];
        }
    },

    // Save plugin URLs to localStorage
    savePluginUrls(urls) {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(urls));
        updateStorageIndicator();
    },

    // Add a new plugin URL
    addPluginUrl(url) {
        const urls = this.getPluginUrls();
        if (!urls.includes(url)) {
            urls.push(url);
            this.savePluginUrls(urls);
            return true;
        }
        return false;
    },

    // Remove a plugin URL
    removePluginUrl(url) {
        const urls = this.getPluginUrls();
        const index = urls.indexOf(url);
        if (index !== -1) {
            urls.splice(index, 1);
            this.savePluginUrls(urls);
            return true;
        }
        return false;
    },

    // Load a plugin from URL (returns a promise)
    loadFromUrl(url) {
        return new Promise((resolve, reject) => {
            if (this.loadedUrls.has(url)) {
                resolve({ url, status: 'already_loaded' });
                return;
            }

            const script = document.createElement('script');
            script.src = url;
            script.async = true;

            script.onload = () => {
                this.loadedUrls.add(url);
                console.log('Plugin loaded:', url);
                resolve({ url, status: 'loaded' });
            };

            script.onerror = (e) => {
                console.error('Failed to load plugin:', url, e);
                reject({ url, status: 'error', error: e });
            };

            document.head.appendChild(script);
        });
    },

    // Load all external plugins from localStorage
    async loadAllExternal() {
        const urls = this.getPluginUrls();
        const results = { loaded: [], failed: [] };

        for (const url of urls) {
            try {
                const result = await this.loadFromUrl(url);
                results.loaded.push(result);
            } catch (error) {
                results.failed.push(error);
            }
        }

        return results;
    },

    // Get list of loaded plugin URLs
    getLoadedUrls() {
        return Array.from(this.loadedUrls);
    }
};

// ============================================================
// Register Core Toolboxes (Productivity and Core only)
// Developer Tools and Finance are available as external plugins
// ============================================================
PluginRegistry.registerToolbox({
    id: 'productivity',
    name: 'Productivity',
    description: 'General productivity tools',
    icon: '📋',
    color: '#9b59b6',
    tools: ['simple-calculator', 'checklist', 'random-picker', 'calendar', 'stopwatch']
});

PluginRegistry.registerToolbox({
    id: 'core',
    name: 'Core',
    description: 'Basic toolboard tools',
    icon: '📝',
    color: '#7f8c8d',
    tools: ['blank']
});

// ============================================================
// Register Core Tools from NOTE_TEMPLATES
// Only registers productivity and core tools; dev/finance tools
// are available via external plugins
// ============================================================
(function registerCoreTools() {
    // Tools to register (productivity + core only)
    const coreToolIds = ['blank', 'simple-calculator', 'checklist', 'random-picker', 'calendar', 'stopwatch'];

    // Toolbox mappings
    const toolboxMap = {
        'blank': 'core',
        'simple-calculator': 'productivity',
        'checklist': 'productivity',
        'random-picker': 'productivity',
        'calendar': 'productivity',
        'stopwatch': 'productivity'
    };

    // Tag mappings
    const tagsMap = {
        'blank': ['blank', 'empty', 'new'],
        'simple-calculator': ['math', 'arithmetic', 'numbers'],
        'checklist': ['todo', 'tasks', 'list'],
        'random-picker': ['random', 'picker', 'spin', 'wheel', 'choose', 'chores', 'games'],
        'calendar': ['date', 'events', 'schedule', 'ics'],
        'stopwatch': ['timer', 'time', 'lap', 'clock']
    };

    for (const id of coreToolIds) {
        const template = NOTE_TEMPLATES[id];
        if (template) {
            PluginRegistry.registerTool({
                id: id,
                name: template.name,
                description: template.description,
                icon: template.icon,
                toolbox: toolboxMap[id] || 'uncategorized',
                tags: tagsMap[id] || [],
                title: template.title,
                content: template.content,
                onInit: template.onInit,
                source: 'embedded'
            });
        }
    }
})();

// Board management
function loadBoards() {
    const stored = localStorage.getItem('financeBoards');
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return [{ id: 'default', name: 'Toolboard' }];
        }
    }
    return [{ id: 'default', name: 'Toolboard' }];
}

function saveBoards(boards) {
    localStorage.setItem('financeBoards', JSON.stringify(boards));
    updateStorageIndicator();
}

function getCurrentBoardId() {
    return localStorage.getItem('financeCurrentBoard') || 'default';
}

function setCurrentBoardId(boardId) {
    localStorage.setItem('financeCurrentBoard', boardId);
}

let boards = loadBoards();
let currentBoardId = getCurrentBoardId();

// Migrate old data to new board-specific format (one-time migration)
function migrateOldData() {
    // Check if migration already done
    if (localStorage.getItem('financeMigrationDone')) return;

    // Map of old keys to new key suffixes
    const migrations = {
        'financeVariables': 'variables',
        'financeNotePositions': 'positions',
        'financeNoteCustomizations': 'toolCustomizations',
        'financeCustomNotes': 'customTools',
        'financeToolboardSettings': 'toolboardSettings'
    };

    let hadOldData = false;
    for (const [oldKey, newSuffix] of Object.entries(migrations)) {
        const oldData = localStorage.getItem(oldKey);
        if (oldData) {
            hadOldData = true;
            // Copy to default board
            localStorage.setItem(`finance_default_${newSuffix}`, oldData);
            // Remove old key
            localStorage.removeItem(oldKey);
        }
    }

    if (hadOldData) {
        console.log('Migrated old data to default board');
    }

    localStorage.setItem('financeMigrationDone', 'true');
}

migrateOldData();

// Helper to get board-specific storage key
function boardKey(key) {
    return `finance_${currentBoardId}_${key}`;
}

// Load variables from localStorage or use defaults
function loadVariables() {
    const stored = localStorage.getItem(boardKey('variables'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            console.error('Error parsing stored variables:', e);
            return DEFAULT_VARIABLES;
        }
    }
    return DEFAULT_VARIABLES;
}

// Save variables to localStorage
function saveVariables(variables) {
    localStorage.setItem(boardKey('variables'), JSON.stringify(variables));
    updateStorageIndicator();
}

// Load tool positions from localStorage or use defaults
function loadPositions() {
    const stored = localStorage.getItem(boardKey('positions'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            console.error('Error parsing stored positions:', e);
            return { ...DEFAULT_POSITIONS };
        }
    }
    return { ...DEFAULT_POSITIONS };
}

// Save tool positions to localStorage
function savePositions(positions) {
    localStorage.setItem(boardKey('positions'), JSON.stringify(positions));
    updateStorageIndicator();
}

// Reset everything
function resetVariables() {
    localStorage.removeItem(boardKey('variables'));
    updateStorageIndicator();
    return DEFAULT_VARIABLES;
}

function resetPositions() {
    localStorage.removeItem(boardKey('positions'));
    updateStorageIndicator();
    return { ...generateDefaultPositions() };
}

// Helper functions for calculations
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-US').format(Math.round(num));
}

// Main application
let variables = loadVariables();
let positions = loadPositions();
let maxZ = Math.max(...Object.values(positions).map(p => p.z || 1), 1);

// Snap threshold in pixels
const SNAP_THRESHOLD = 15;

// Drag state
let dragState = {
    isDragging: false,
    tool: null,
    startX: 0,
    startY: 0,
    offsetX: 0,
    offsetY: 0
};

// Resize state
let resizeState = {
    isResizing: false,
    tool: null,
    handle: null,
    startX: 0,
    startY: 0,
    startWidth: 0,
    startHeight: 0,
    startLeft: 0,
    startTop: 0
};

// Dark mode setup
function setupDarkMode() {
    const toggle = document.getElementById('darkModeToggle');
    const stored = localStorage.getItem('toolboard_darkMode');

    // Apply stored preference or check system preference
    if (stored === 'true' || (stored === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-mode');
        toggle.innerHTML = '&#9788;'; // Sun icon for light mode
        toggle.title = 'Switch to Light Mode';
    }

    toggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('toolboard_darkMode', isDark);
        toggle.innerHTML = isDark ? '&#9788;' : '&#9790;'; // Sun or Moon
        toggle.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    });
}

// Initialize the toolboard
async function init() {
    setupDarkMode();

    // Load external plugins before rendering
    try {
        const results = await PluginLoader.loadAllExternal();
        if (results.failed.length > 0) {
            console.warn('Some plugins failed to load:', results.failed);
        }
    } catch (e) {
        console.error('Error loading external plugins:', e);
    }

    populateBoardSelector();
    applyToolboardSettings();
    setupToolboardSettings();
    renderToolboard();
    setupDragging();
    setupResizing();
    setupResponsiveLayout();
    setupToolControls();
    setupContentEditor();
    setupButtons();
    setupBoardManager();
    setupToolSearch();
    setupImportExport();
    setupFeatureSelect();
    setupPluginSettings();
    displayVersion();
    updateStorageIndicator();
}

// Display Toolboard version based on file modification date
function displayVersion() {
    const versionEl = document.getElementById('toolboardVersion');
    if (versionEl) {
        const lastMod = new Date(document.lastModified);
        const version = lastMod.toISOString().slice(0, 10).replace(/-/g, '.');
        versionEl.textContent = 'v' + version;
        versionEl.title = 'Toolboard version (last modified: ' + lastMod.toLocaleString() + ')';
    }
}

// Display localStorage usage and quota
function updateStorageIndicator() {
    const indicator = document.getElementById('storageIndicator');
    if (!indicator) return;

    // Calculate total localStorage size
    let totalSize = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            totalSize += key.length + localStorage[key].length;
        }
    }
    const usedKB = (totalSize * 2) / 1024; // UTF-16 = 2 bytes per char
    const usedMB = usedKB / 1024;

    // Estimate quota (typically 5-10MB, test by trying to write)
    let quotaMB = 5; // Default assumption
    try {
        // Try to detect actual quota by attempting storage
        const testKey = '__storage_test__';
        const testData = 'x'.repeat(1024 * 1024); // 1MB test
        let canStore = true;
        for (let i = 0; i < 10 && canStore; i++) {
            try {
                localStorage.setItem(testKey + i, testData);
                localStorage.removeItem(testKey + i);
            } catch (e) {
                quotaMB = usedMB + i;
                canStore = false;
            }
        }
        if (canStore) quotaMB = 10; // Could store 10MB, assume 10MB quota
    } catch (e) {
        // Ignore test errors
    }

    const percent = Math.min(100, (usedMB / quotaMB) * 100);
    const levelClass = percent < 50 ? 'low' : percent < 80 ? 'medium' : 'high';

    // Format display
    const usedDisplay = usedKB < 1024
        ? usedKB.toFixed(1) + ' KB'
        : usedMB.toFixed(2) + ' MB';
    const quotaDisplay = quotaMB + ' MB';

    indicator.innerHTML = `
        <div class="storage-bar">
            <div class="storage-bar-fill ${levelClass}" style="width: ${percent}%"></div>
        </div>
    `;
    indicator.title = `${usedDisplay} / ${quotaDisplay} (${percent.toFixed(1)}%)\nClick for details`;

    // Add click handler to show details
    indicator.onclick = showStorageDetails;
}

function navigateToTool(boardId, toolId) {
    // Close the storage modal
    const overlay = document.querySelector('.storage-modal-overlay');
    if (overlay) overlay.remove();

    // Switch board if needed
    if (boardId !== currentBoardId) {
        switchToBoard(boardId);
    }

    // Find and highlight the tool
    setTimeout(() => {
        const toolEl = document.querySelector(`.tool[data-tool="${toolId}"]`);
        if (!toolEl) return;

        // Scroll into view
        toolEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

        // Bring to front
        toolEl.style.zIndex = ++maxZ;

        // Add highlight animation
        toolEl.classList.add('tool-highlight');
        toolEl.addEventListener('animationend', () => {
            toolEl.classList.remove('tool-highlight');
        }, { once: true });
    }, 100);
}

// --- Command-palette tool search ---

function getAllToolsAcrossBoards() {
    const results = [];
    const seen = new Set();

    for (const board of boards) {
        // For the current board use in-memory data; for others read from localStorage
        let boardCustomTools, boardToolCustomizations;
        if (board.id === currentBoardId) {
            boardCustomTools = customTools;
            boardToolCustomizations = toolCustomizations;
        } else {
            try {
                boardCustomTools = JSON.parse(localStorage.getItem(`finance_${board.id}_customTools`) || '[]');
            } catch { boardCustomTools = []; }
            try {
                boardToolCustomizations = JSON.parse(localStorage.getItem(`finance_${board.id}_toolCustomizations`) || '{}');
            } catch { boardToolCustomizations = {}; }
        }

        // Hidden tools for this board
        let boardHiddenTools;
        if (board.id === currentBoardId) {
            boardHiddenTools = hiddenTools;
        } else {
            try {
                boardHiddenTools = JSON.parse(localStorage.getItem(`finance_${board.id}_hiddenTools`) || '[]');
            } catch { boardHiddenTools = []; }
        }

        function getContentText(custom, pluginTool) {
            const raw = custom.customContent || (pluginTool ? pluginTool.content : '') || '';
            return raw.replace(/<[^>]*>/g, ' ');
        }

        // Built-in (SECTIONS) tools
        for (const toolId of SECTIONS) {
            if (boardHiddenTools.includes(toolId)) continue;
            const key = board.id + ':' + toolId;
            if (seen.has(key)) continue;
            seen.add(key);
            const custom = boardToolCustomizations[toolId] || {};
            const pluginTool = PluginRegistry.getTool(toolId);
            const title = custom.title || (pluginTool ? pluginTool.title || pluginTool.name : toolId);
            results.push({ boardId: board.id, boardName: board.name, toolId, title, content: getContentText(custom, pluginTool) });
        }

        // Custom tools
        for (const toolId of boardCustomTools) {
            const key = board.id + ':' + toolId;
            if (seen.has(key)) continue;
            seen.add(key);
            const custom = boardToolCustomizations[toolId] || {};
            const pluginTool = PluginRegistry.getTool(toolId);
            const title = custom.title || (pluginTool ? pluginTool.title || pluginTool.name : null) || 'New Tool';
            results.push({ boardId: board.id, boardName: board.name, toolId, title, content: getContentText(custom, pluginTool) });
        }
    }

    return results;
}

function openToolSearch() {
    const overlay = document.getElementById('toolSearchOverlay');
    const input = document.getElementById('toolSearchInput');
    overlay.style.display = 'flex';
    input.value = '';
    updateToolSearchResults('');
    input.focus();
}

function closeToolSearch() {
    document.getElementById('toolSearchOverlay').style.display = 'none';
}

function updateToolSearchResults(query) {
    const container = document.getElementById('toolSearchResults');
    const allTools = getAllToolsAcrossBoards();
    const q = query.toLowerCase().trim();
    const filtered = q
        ? allTools.filter(t =>
            t.title.toLowerCase().includes(q) ||
            t.boardName.toLowerCase().includes(q) ||
            t.toolId.toLowerCase().includes(q) ||
            t.content.toLowerCase().includes(q))
        : allTools;

    if (filtered.length === 0) {
        container.innerHTML = '<div class="tool-search-empty">No tools found</div>';
        return;
    }

    container.innerHTML = filtered.map((t, i) =>
        `<div class="tool-search-item${i === 0 ? ' active' : ''}" data-board="${escapeHtml(t.boardId)}" data-tool="${escapeHtml(t.toolId)}">
            <span class="tool-search-item-title">${escapeHtml(t.title)}</span>
            <span class="tool-search-item-board">${escapeHtml(t.boardName)}</span>
        </div>`
    ).join('');
}

function selectToolSearchResult(el) {
    if (!el) return;
    const boardId = el.getAttribute('data-board');
    const toolId = el.getAttribute('data-tool');
    closeToolSearch();
    navigateToTool(boardId, toolId);
}

function toolSearchKeyHandler(e) {
    const container = document.getElementById('toolSearchResults');
    const items = container.querySelectorAll('.tool-search-item');
    if (!items.length) return;

    const activeItem = container.querySelector('.tool-search-item.active');
    let idx = Array.from(items).indexOf(activeItem);

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (activeItem) activeItem.classList.remove('active');
        idx = (idx + 1) % items.length;
        items[idx].classList.add('active');
        items[idx].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (activeItem) activeItem.classList.remove('active');
        idx = (idx - 1 + items.length) % items.length;
        items[idx].classList.add('active');
        items[idx].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter') {
        e.preventDefault();
        selectToolSearchResult(activeItem);
    }
}

function setupToolSearch() {
    const btn = document.getElementById('searchToolBtn');
    const overlay = document.getElementById('toolSearchOverlay');
    const input = document.getElementById('toolSearchInput');

    btn.addEventListener('click', openToolSearch);

    // Close on backdrop click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeToolSearch();
    });

    // Filter on input
    input.addEventListener('input', () => {
        updateToolSearchResults(input.value);
    });

    // Keyboard navigation inside input
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            e.preventDefault();
            closeToolSearch();
        } else {
            toolSearchKeyHandler(e);
        }
    });

    // Click on result
    document.getElementById('toolSearchResults').addEventListener('click', (e) => {
        const item = e.target.closest('.tool-search-item');
        if (item) selectToolSearchResult(item);
    });

    // Global Cmd/Ctrl+K shortcut
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (overlay.style.display === 'none') {
                openToolSearch();
            } else {
                closeToolSearch();
            }
        }
    });
}

function parseStorageKey(key) {
    // Map known global keys
    const globalKeys = {
        'financeBoards': { desc: 'All boards list' },
        'financeCurrentBoard': { desc: 'Active board ID' },
        'financeMigrationDone': { desc: 'Migration flag' },
        'toolboard_pluginUrls': { desc: 'Plugin URLs' },
        'toolboard_darkMode': { desc: 'Dark mode preference' }
    };
    if (globalKeys[key]) return globalKeys[key];

    // Match board-specific keys: finance_{boardId}_{suffix}
    const match = key.match(/^finance_(.+?)_(variables|positions|toolCustomizations|customTools|hiddenTools|toolboardSettings)$/);
    if (match) {
        const boardId = match[1];
        const suffix = match[2];
        const board = boards.find(b => b.id === boardId);
        const boardName = board ? board.name : boardId;
        const suffixLabels = {
            'variables': 'Variables',
            'positions': 'Tool positions & sizes',
            'toolCustomizations': 'Tool settings (titles, colors, content)',
            'customTools': 'Custom tool IDs',
            'hiddenTools': 'Hidden tool IDs',
            'toolboardSettings': 'Board settings'
        };
        return { boardId, boardName, suffix, desc: suffixLabels[suffix] || suffix };
    }

    // Generic finance_ prefix
    if (key.startsWith('finance_')) {
        const rest = key.replace(/^finance_/, '');
        const parts = rest.split('_');
        if (parts.length >= 2) {
            const boardId = parts[0];
            const board = boards.find(b => b.id === boardId);
            const boardName = board ? board.name : boardId;
            return { boardId, boardName, desc: parts.slice(1).join('_') };
        }
    }

    return {};
}

function getToolNamesFromKey(key, parsed) {
    // For keys that contain per-tool data, extract tool IDs and their display names
    if (!parsed.boardId || !parsed.suffix) return [];
    if (parsed.suffix !== 'toolCustomizations' && parsed.suffix !== 'positions') return [];

    try {
        const val = localStorage.getItem(key);
        if (!val) return [];
        const data = JSON.parse(val);
        if (typeof data !== 'object' || Array.isArray(data)) return [];

        // Read customizations for this board to get tool titles
        let customs = data;
        if (parsed.suffix === 'positions') {
            const customKey = `finance_${parsed.boardId}_toolCustomizations`;
            try {
                customs = JSON.parse(localStorage.getItem(customKey) || '{}');
            } catch { customs = {}; }
        }

        return Object.keys(data).map(toolId => ({
            toolId,
            name: (customs[toolId] && customs[toolId].title) || toolId
        }));
    } catch {
        return [];
    }
}

function getStoragePreview(key) {
    try {
        const val = localStorage.getItem(key);
        if (!val) return '';
        const parsed = JSON.parse(val);
        let preview = JSON.stringify(parsed, null, 2);
        if (preview.length > 300) preview = preview.slice(0, 300) + '\u2026';
        return preview;
    } catch {
        const val = localStorage.getItem(key) || '';
        if (val.length > 300) return val.slice(0, 300) + '\u2026';
        return val;
    }
}

function showStorageDetails() {
    // Gather storage breakdown
    const items = [];
    let totalSize = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            const size = (key.length + localStorage[key].length) * 2;
            totalSize += size;
            items.push({ key, size });
        }
    }
    items.sort((a, b) => b.size - a.size);

    const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    };

    let html = `
        <div class="storage-modal-overlay" onclick="this.remove()">
            <div class="storage-modal" onclick="event.stopPropagation()">
                <div class="storage-modal-header">
                    <h3>localStorage Usage</h3>
                    <button onclick="this.closest('.storage-modal-overlay').remove()">&times;</button>
                </div>
                <div class="storage-modal-body">
                    <div class="storage-total">Total: ${formatSize(totalSize)}</div>
                    <table class="storage-table">
                        <thead><tr><th>Key</th><th>Size</th></tr></thead>
                        <tbody>
                            ${items.slice(0, 50).map(item => {
                                const parsed = parseStorageKey(item.key);
                                const preview = escapeHtml(getStoragePreview(item.key));
                                const tools = getToolNamesFromKey(item.key, parsed);

                                // Build description with clickable board link
                                let descHtml = '';
                                if (parsed.boardId) {
                                    descHtml = `<br><span class="storage-desc"><span class="storage-link" onclick="navigateToTool('${escapeHtml(parsed.boardId)}')">${escapeHtml(parsed.boardName)}</span> \u2023 ${escapeHtml(parsed.desc)}</span>`;
                                } else if (parsed.desc) {
                                    descHtml = `<br><span class="storage-desc">${escapeHtml(parsed.desc)}</span>`;
                                }

                                // Build per-tool list with clickable links
                                let toolListHtml = '';
                                if (tools.length > 0) {
                                    const maxShow = 8;
                                    const shown = tools.slice(0, maxShow);
                                    toolListHtml = `<ul class="storage-tool-list">${shown.map(t =>
                                        `<li><span class="storage-link" onclick="navigateToTool('${escapeHtml(parsed.boardId)}','${escapeHtml(t.toolId)}')">${escapeHtml(t.name)}</span></li>`
                                    ).join('')}${tools.length > maxShow ? `<li>... and ${tools.length - maxShow} more tools</li>` : ''}</ul>`;
                                }

                                return `
                                <tr>
                                    <td title="${escapeHtml(item.key)}">
                                        ${item.key.length > 40 ? escapeHtml(item.key.slice(0, 40)) + '...' : escapeHtml(item.key)}
                                        ${descHtml}
                                        ${toolListHtml}
                                        ${preview ? `<div class="storage-preview">${preview}</div>` : ''}
                                    </td>
                                    <td>${formatSize(item.size)}</td>
                                </tr>`;
                            }).join('')}
                            ${items.length > 50 ? `<tr><td colspan="2">... and ${items.length - 50} more items</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}

// Responsive layout: stack tools vertically on narrow screens
function setupResponsiveLayout() {
    const MOBILE_BREAKPOINT = 768;
    const toolboard = document.getElementById('toolboard');
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`);

    function applyLayout(mobile) {
        if (mobile) {
            toolboard.classList.add('mobile-layout');
        } else {
            toolboard.classList.remove('mobile-layout');
            // Restore original positions from inline styles (already set by createTool)
            document.querySelectorAll('.tool').forEach(tool => {
                const toolId = tool.getAttribute('data-tool');
                const pos = positions[toolId];
                if (pos) {
                    tool.style.left = pos.x + 'px';
                    tool.style.top = pos.y + 'px';
                    tool.style.zIndex = pos.z || 1;
                    if (pos.width) tool.style.width = pos.width + 'px';
                    if (pos.height) tool.style.height = pos.height + 'px';
                }
            });
        }
    }

    applyLayout(mql.matches);
    mql.addEventListener('change', (e) => applyLayout(e.matches));
}

// Setup tool minimize and settings controls
let currentSettingsToolId = null;

function setupToolControls() {
    const toolboard = document.getElementById('toolboard');
    const settingsOverlay = document.getElementById('toolSettingsOverlay');
    const settingsTitleInput = document.getElementById('toolSettingsTitleInput');
    const settingsColorPicker = document.getElementById('toolSettingsColorPicker');
    const settingsFontFamily = document.getElementById('toolSettingsFontFamily');
    const settingsFontSize = document.getElementById('toolSettingsFontSize');
    const settingsEditBtn = document.getElementById('toolSettingsEditBtn');
    const settingsDuplicateBtn = document.getElementById('toolSettingsDuplicateBtn');
    const settingsExportBtn = document.getElementById('toolSettingsExportBtn');
    const settingsExportPngBtn = document.getElementById('toolSettingsExportPngBtn');
    const settingsDeleteBtn = document.getElementById('toolSettingsDeleteBtn');
    const settingsCloseBtn = settingsOverlay.querySelector('.tool-settings-close');

    // Populate color picker
    settingsColorPicker.innerHTML = HEADER_COLORS.map(c =>
        `<div class="color-swatch" style="background: ${c}" data-color="${c}"></div>`
    ).join('');

    // Minimize button
    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.minimize-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            const toolId = tool.getAttribute('data-tool');
            const btn = e.target.closest('.minimize-btn');

            tool.classList.toggle('minimized');
            btn.classList.toggle('minimized');

            // Save state
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].minimized = tool.classList.contains('minimized');
            saveToolCustomizations(toolCustomizations);
        }
    });

    // Delete button
    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.delete-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            if (!tool) return;
            const toolId = tool.getAttribute('data-tool');
            deleteTool(toolId);
        }
    });

    // Fullscreen button
    const fullscreenBackdrop = document.getElementById('fullscreenBackdrop');
    let currentFullscreenTool = null;

    function exitFullscreen() {
        if (currentFullscreenTool) {
            currentFullscreenTool.classList.remove('fullscreen');
            const btn = currentFullscreenTool.querySelector('.fullscreen-btn');
            if (btn) btn.classList.remove('active');
            fullscreenBackdrop.classList.remove('active');
            currentFullscreenTool = null;
        }
    }

    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.fullscreen-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            const btn = e.target.closest('.fullscreen-btn');

            if (tool.classList.contains('fullscreen')) {
                exitFullscreen();
            } else {
                // Exit any existing fullscreen first
                exitFullscreen();
                tool.classList.add('fullscreen');
                btn.classList.add('active');
                fullscreenBackdrop.classList.add('active');
                currentFullscreenTool = tool;
            }
        }
    });

    // Click backdrop to exit fullscreen
    fullscreenBackdrop.addEventListener('click', exitFullscreen);

    // ESC key to exit fullscreen
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentFullscreenTool) {
            exitFullscreen();
        }
    });

    // Settings button - open modal
    toolboard.addEventListener('click', (e) => {
        if (e.target.closest('.settings-btn')) {
            e.stopPropagation();
            const tool = e.target.closest('.tool');
            const toolId = tool.getAttribute('data-tool');
            currentSettingsToolId = toolId;

            // Bring tool to front
            let highestZ = 0;
            document.querySelectorAll('.tool').forEach(s => {
                const z = parseInt(s.style.zIndex) || 0;
                if (z > highestZ) highestZ = z;
            });
            maxZ = highestZ + 1;
            tool.style.zIndex = maxZ;
            positions[toolId] = positions[toolId] || {};
            positions[toolId].z = maxZ;

            // Populate modal with current tool settings
            const custom = toolCustomizations[toolId] || {};
            const content = getToolContent(toolId);
            const displayTitle = custom.title || content.title;
            const headerColor = custom.color || null;
            const isCustomTool = customTools.includes(toolId);

            settingsTitleInput.value = displayTitle;
            settingsDeleteBtn.textContent = isCustomTool ? 'Delete Tool' : 'Hide Tool';

            // Update color picker selection
            settingsColorPicker.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.toggle('selected', s.getAttribute('data-color') === headerColor);
            });

            // Update font selects
            settingsFontFamily.value = custom.fontFamily || '';
            settingsFontSize.value = custom.fontSize || '';

            // Open modal
            settingsOverlay.classList.add('open');
        }
    });

    // Close modal
    function closeSettingsModal() {
        settingsOverlay.classList.remove('open');
        currentSettingsToolId = null;
    }

    settingsCloseBtn.addEventListener('click', closeSettingsModal);

    // Close on overlay background click
    settingsOverlay.addEventListener('click', (e) => {
        if (e.target === settingsOverlay) {
            closeSettingsModal();
        }
    });

    // Color swatch click in modal
    settingsColorPicker.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch') && currentSettingsToolId) {
            e.stopPropagation();
            const toolId = currentSettingsToolId;
            const tool = document.querySelector(`.tool[data-tool="${toolId}"]`);
            const color = e.target.getAttribute('data-color');
            const header = tool.querySelector('.tool-header');

            // Update UI
            header.style.background = color;
            settingsColorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            e.target.classList.add('selected');

            // Save
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].color = color;
            saveToolCustomizations(toolCustomizations);
        }
    });

    // Title input change in modal
    settingsTitleInput.addEventListener('input', (e) => {
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            const tool = document.querySelector(`.tool[data-tool="${toolId}"]`);
            const titleSpan = tool.querySelector('.tool-title');
            const newTitle = e.target.value;

            // Update UI
            titleSpan.textContent = newTitle;

            // Save
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].title = newTitle;
            saveToolCustomizations(toolCustomizations);
        }
    });

    // Font family change in modal
    settingsFontFamily.addEventListener('change', (e) => {
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].fontFamily = e.target.value;
            saveToolCustomizations(toolCustomizations);
            applyToolFont(toolId);
        }
    });

    // Font size change in modal
    settingsFontSize.addEventListener('change', (e) => {
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].fontSize = e.target.value;
            saveToolCustomizations(toolCustomizations);
            applyToolFont(toolId);
        }
    });

    // Edit content button in modal
    settingsEditBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            openContentEditor(toolId);
        }
    });

    // Duplicate tool button in modal
    settingsDuplicateBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            duplicateTool(toolId);
        }
    });

    // Export tool button in modal
    settingsExportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            exportToolAsHtml(toolId);
        }
    });

    // Export tool as PNG button in modal
    settingsExportPngBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            exportToolAsPng(toolId);
        }
    });

    // Delete tool button in modal
    settingsDeleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (currentSettingsToolId) {
            const toolId = currentSettingsToolId;
            closeSettingsModal();
            deleteTool(toolId);
        }
    });

    // Prevent dragging when interacting with header buttons
    toolboard.addEventListener('mousedown', (e) => {
        if (e.target.closest('.header-btn')) {
            e.stopPropagation();
        }
    });
}

// Render all tools
function renderToolboard() {
    const toolboard = document.getElementById('toolboard');
    toolboard.innerHTML = '';

    const toolsToAutoFit = [];

    // Render built-in tools (excluding hidden ones)
    SECTIONS.forEach(toolId => {
        if (hiddenTools.includes(toolId)) return;
        const tool = createTool(toolId);
        if (tool) {
            toolboard.appendChild(tool);
            // Check if tool needs auto-fitting (no saved dimensions and has content)
            const pos = positions[toolId];
            const custom = toolCustomizations[toolId] || {};
            if ((!pos || (!pos.width && !pos.height)) && custom.customContent) {
                toolsToAutoFit.push(tool);
            }
        }
    });

    // Render custom tools
    customTools.forEach(toolId => {
        const tool = createTool(toolId);
        if (tool) {
            toolboard.appendChild(tool);
            // Check if tool needs auto-fitting (no saved dimensions)
            const pos = positions[toolId];
            const custom = toolCustomizations[toolId] || {};
            if ((!pos || (!pos.width && !pos.height)) && (custom.customContent || custom.templateId)) {
                toolsToAutoFit.push(tool);
            }
        }
    });

    // Initialize dynamic calculators if present
    initializeCalculators();

    // Auto-fit tools after DOM is ready
    if (toolsToAutoFit.length > 0) {
        requestAnimationFrame(() => {
            toolsToAutoFit.forEach(tool => autoFitToolContent(tool, true));
        });
    }
}

function initializeCalculators() {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
        if (document.querySelector('.checklist-widget')) checklistInit();
        if (document.querySelector('.calendar-widget')) calendarInit();

        // Initialize all tools that have an onInit function
        document.querySelectorAll('.tool').forEach(tool => {
            const toolId = tool.getAttribute('data-tool');
            const custom = toolCustomizations[toolId] || {};

            // Check if this tool uses a template with onInit
            if (custom.templateId) {
                // Check NOTE_TEMPLATES first
                let template = NOTE_TEMPLATES[custom.templateId];
                // Also check PluginRegistry for external plugins
                if (!template) {
                    template = PluginRegistry.getTool(custom.templateId);
                }
                if (template && template.onInit && typeof window[template.onInit] === 'function') {
                    window[template.onInit]();
                }
            }
        });
    }, 50);
}


// Checklist Widget Functions
let checklistDragState = { dragging: null, toolId: null, parentIdx: null };

function checklistGetToolId(element) {
    const tool = element.closest('.tool');
    return tool ? tool.getAttribute('data-tool') : null;
}

function checklistGetData(toolId) {
    const custom = toolCustomizations[toolId] || {};
    // Migrate old format: convert completed boolean to status
    let items = custom.checklistItems || [];
    items = items.map(item => {
        if (typeof item.completed === 'boolean' && !item.status) {
            return { ...item, status: item.completed ? 'completed' : 'pending', children: item.children || [] };
        }
        return { ...item, children: item.children || [] };
    });
    return items;
}

function checklistSaveData(toolId, items) {
    toolCustomizations[toolId] = toolCustomizations[toolId] || {};
    toolCustomizations[toolId].checklistItems = items;
    saveToolCustomizations(toolCustomizations);
}

function checklistInit() {
    document.querySelectorAll('.checklist-widget').forEach(widget => {
        const toolId = checklistGetToolId(widget);
        if (toolId) {
            checklistRender(widget, toolId);
        }
    });
}

function checklistRenderItem(item, idx, parentIdx = null) {
    const statusClass = item.status || 'pending';
    const path = parentIdx !== null ? `${parentIdx}.${idx}` : `${idx}`;
    const isSubitem = parentIdx !== null;

    let childrenHtml = '';
    if (!isSubitem && item.children && item.children.length > 0) {
        childrenHtml = `<ul class="checklist-subitems">${item.children.map((child, cIdx) =>
            checklistRenderItem(child, cIdx, idx)
        ).join('')}</ul>`;
    }

    return `
        <div class="checklist-item-wrapper" data-path="${path}">
            <li class="checklist-item ${statusClass}" data-path="${path}" draggable="true"
                ondragstart="checklistDragStart(event, '${path}')"
                ondragover="checklistDragOver(event)"
                ondragleave="checklistDragLeave(event)"
                ondrop="checklistDrop(event, '${path}')">
                <span class="checklist-drag">⋮⋮</span>
                <span class="checklist-status" onclick="checklistCycleStatus(this, '${path}')" title="Click to change status"></span>
                <span class="checklist-text" contenteditable="true"
                    onblur="checklistUpdateText(this, '${path}')"
                    onkeydown="checklistTextKeydown(event, this)">${escapeHtml(item.text)}</span>
                <span class="checklist-actions">
                    ${!isSubitem ? `<button class="checklist-btn" onclick="checklistAddSub(this, ${idx})" title="Add sub-item">+</button>` : ''}
                    <button class="checklist-btn delete" onclick="checklistDelete(this, '${path}')" title="Delete">×</button>
                </span>
            </li>
            ${childrenHtml}
        </div>
    `;
}

function checklistRender(widget, toolId) {
    const items = checklistGetData(toolId);
    const listEl = widget.querySelector('.checklist-items');
    const summaryEl = widget.querySelector('.checklist-summary');

    if (!listEl) return;

    listEl.innerHTML = items.map((item, idx) => checklistRenderItem(item, idx)).join('');

    // Update summary with all items including children
    let total = 0, completed = 0, inProgress = 0;
    const countItems = (arr) => {
        arr.forEach(item => {
            total++;
            if (item.status === 'completed') completed++;
            else if (item.status === 'in_progress') inProgress++;
            if (item.children) countItems(item.children);
        });
    };
    countItems(items);

    const summaryText = summaryEl.querySelector('.checklist-summary-text');
    if (summaryText) {
        if (total > 0) {
            let summary = `${completed}/${total} done`;
            if (inProgress > 0) summary += ` · ${inProgress} in progress`;
            summaryText.textContent = summary;
        } else {
            summaryText.textContent = 'No items yet';
        }
    }
}

function checklistGetItemByPath(items, path) {
    const parts = path.split('.').map(Number);
    let item = items[parts[0]];
    if (parts.length > 1 && item && item.children) {
        item = item.children[parts[1]];
    }
    return item;
}

function checklistSetItemByPath(items, path, value) {
    const parts = path.split('.').map(Number);
    if (parts.length === 1) {
        if (value === null) {
            items.splice(parts[0], 1);
        } else {
            items[parts[0]] = value;
        }
    } else if (items[parts[0]] && items[parts[0]].children) {
        if (value === null) {
            items[parts[0]].children.splice(parts[1], 1);
        } else {
            items[parts[0]].children[parts[1]] = value;
        }
    }
}

function checklistAddItem(btn) {
    const widget = btn.closest('.checklist-widget');
    const input = widget.querySelector('.checklist-input');
    const toolId = checklistGetToolId(widget);

    if (!toolId || !input.value.trim()) return;

    const items = checklistGetData(toolId);
    items.push({ text: input.value.trim(), status: 'pending', children: [] });
    checklistSaveData(toolId, items);

    input.value = '';
    checklistRender(widget, toolId);
}

function checklistAddSub(el, parentIdx) {
    const widget = el.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    if (!items[parentIdx].children) items[parentIdx].children = [];
    items[parentIdx].children.push({ text: 'New sub-item', status: 'pending' });
    checklistSaveData(toolId, items);
    checklistRender(widget, toolId);

    // Focus the new item for editing
    setTimeout(() => {
        const newItem = widget.querySelector(`[data-path="${parentIdx}.${items[parentIdx].children.length - 1}"] .checklist-text`);
        if (newItem) {
            newItem.focus();
            document.execCommand('selectAll', false, null);
        }
    }, 10);
}

function checklistCycleStatus(el, path) {
    const widget = el.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    const item = checklistGetItemByPath(items, path);
    if (!item) return;

    // Cycle: pending -> in_progress -> completed -> pending
    const cycle = { 'pending': 'in_progress', 'in_progress': 'completed', 'completed': 'pending' };
    item.status = cycle[item.status] || 'pending';

    checklistSaveData(toolId, items);
    checklistRender(widget, toolId);
}

function checklistUpdateText(el, path) {
    const widget = el.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    const item = checklistGetItemByPath(items, path);
    if (!item) return;

    const newText = el.textContent.trim();
    if (newText && newText !== item.text) {
        item.text = newText;
        checklistSaveData(toolId, items);
    } else if (!newText) {
        el.textContent = item.text; // Restore if empty
    }
}

function checklistTextKeydown(e, el) {
    if (e.key === 'Enter') {
        e.preventDefault();
        el.blur();
    } else if (e.key === 'Escape') {
        const widget = el.closest('.checklist-widget');
        const toolId = checklistGetToolId(widget);
        const path = el.closest('.checklist-item').dataset.path;
        const items = checklistGetData(toolId);
        const item = checklistGetItemByPath(items, path);
        if (item) el.textContent = item.text;
        el.blur();
    }
}

function checklistDelete(btn, path) {
    const widget = btn.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const items = checklistGetData(toolId);
    checklistSetItemByPath(items, path, null);
    checklistSaveData(toolId, items);
    checklistRender(widget, toolId);
}

// Drag and drop for reordering
function checklistDragStart(e, path) {
    const widget = e.target.closest('.checklist-widget');
    checklistDragState.dragging = path;
    checklistDragState.toolId = checklistGetToolId(widget);
    checklistDragState.parentIdx = path.includes('.') ? parseInt(path.split('.')[0]) : null;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function checklistDragOver(e) {
    e.preventDefault();
    const item = e.target.closest('.checklist-item');
    if (item && !item.classList.contains('dragging')) {
        item.classList.add('drag-over');
    }
}

function checklistDragLeave(e) {
    const item = e.target.closest('.checklist-item');
    if (item) item.classList.remove('drag-over');
}

function checklistDrop(e, targetPath) {
    e.preventDefault();
    const targetItem = e.target.closest('.checklist-item');
    if (targetItem) targetItem.classList.remove('drag-over');

    const sourcePath = checklistDragState.dragging;
    const toolId = checklistDragState.toolId;

    if (!sourcePath || !toolId || sourcePath === targetPath) {
        checklistDragState = { dragging: null, toolId: null, parentIdx: null };
        return;
    }

    // Only allow reordering within same level (both top-level or both same parent)
    const sourceParent = sourcePath.includes('.') ? sourcePath.split('.')[0] : null;
    const targetParent = targetPath.includes('.') ? targetPath.split('.')[0] : null;

    if (sourceParent !== targetParent) {
        checklistDragState = { dragging: null, toolId: null, parentIdx: null };
        return;
    }

    const items = checklistGetData(toolId);
    const sourceIdx = parseInt(sourcePath.split('.').pop());
    const targetIdx = parseInt(targetPath.split('.').pop());

    let arr = items;
    if (sourceParent !== null) {
        arr = items[parseInt(sourceParent)].children;
    }

    // Move item
    const [moved] = arr.splice(sourceIdx, 1);
    arr.splice(targetIdx > sourceIdx ? targetIdx : targetIdx, 0, moved);

    checklistSaveData(toolId, items);

    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .checklist-widget`);
    if (widget) checklistRender(widget, toolId);

    checklistDragState = { dragging: null, toolId: null, parentIdx: null };
}

document.addEventListener('dragend', (e) => {
    document.querySelectorAll('.checklist-item.dragging').forEach(el => el.classList.remove('dragging'));
    document.querySelectorAll('.checklist-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    checklistDragState = { dragging: null, toolId: null, parentIdx: null };
});

// Add enter key support for checklist input
document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.classList.contains('checklist-input')) {
        e.preventDefault();
        const widget = e.target.closest('.checklist-widget');
        const addBtn = widget.querySelector('button[onclick*="checklistAddItem"]');
        if (addBtn) checklistAddItem(addBtn);
    }
});

// Checklist Markdown editing
function checklistToMarkdown(items) {
    let lines = [];
    items.forEach(item => {
        const prefix = item.status === 'completed' ? 'x' : item.status === 'in_progress' ? '+' : '-';
        lines.push(`${prefix} ${item.text}`);
        if (item.children && item.children.length > 0) {
            item.children.forEach(child => {
                const childPrefix = child.status === 'completed' ? 'x' : child.status === 'in_progress' ? '+' : '-';
                lines.push(`  ${childPrefix} ${child.text}`);
            });
        }
    });
    return lines.join('\n');
}

function checklistFromMarkdown(text) {
    const lines = text.split('\n');
    const items = [];
    let currentParent = null;

    lines.forEach(line => {
        const indentedMatch = line.match(/^(\s{2,})([-x+])\s+(.+)/);
        const topMatch = line.match(/^([-x+])\s+(.+)/);

        if (indentedMatch && currentParent) {
            const marker = indentedMatch[2];
            const itemText = indentedMatch[3].trim();
            const status = marker === 'x' ? 'completed' : marker === '+' ? 'in_progress' : 'pending';
            currentParent.children.push({ text: itemText, status: status });
        } else if (topMatch) {
            const marker = topMatch[1];
            const itemText = topMatch[2].trim();
            const status = marker === 'x' ? 'completed' : marker === '+' ? 'in_progress' : 'pending';
            currentParent = { text: itemText, status: status, children: [] };
            items.push(currentParent);
        }
    });
    return items;
}

function checklistToggleMarkdown(btn) {
    const widget = btn.closest('.checklist-widget');
    const toolId = checklistGetToolId(widget);
    if (!toolId) return;

    const listEl = widget.querySelector('.checklist-items');
    const editor = widget.querySelector('.checklist-markdown-editor');
    const inputRow = widget.querySelector('.checklist-input')?.parentElement;
    const isEditing = editor.style.display !== 'none';

    if (isEditing) {
        // Save markdown back to items
        const items = checklistFromMarkdown(editor.value);
        checklistSaveData(toolId, items);
        editor.style.display = 'none';
        listEl.style.display = '';
        if (inputRow) inputRow.style.display = '';
        btn.classList.remove('active');
        btn.textContent = '✎ Markdown';
        checklistRender(widget, toolId);
    } else {
        // Convert items to markdown and show editor
        const items = checklistGetData(toolId);
        editor.value = checklistToMarkdown(items);
        editor.style.display = '';
        listEl.style.display = 'none';
        if (inputRow) inputRow.style.display = 'none';
        btn.classList.add('active');
        btn.textContent = '✓ Apply';
        editor.focus();
    }
}

// Random Picker
const PICKER_COLORS = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#e91e63', '#00bcd4'];

function pickerGetToolId(el) {
    const tool = el.closest('.tool');
    return tool ? tool.getAttribute('data-tool') : null;
}

function pickerGetData(toolId) {
    const custom = toolCustomizations[toolId] || {};
    return custom.pickerItems || [];
}

function pickerSaveData(toolId, items) {
    toolCustomizations[toolId] = toolCustomizations[toolId] || {};
    toolCustomizations[toolId].pickerItems = items;
    saveToolCustomizations(toolCustomizations);
}

function pickerInit() {
    document.querySelectorAll('.picker-widget').forEach(widget => {
        const toolId = pickerGetToolId(widget);
        if (toolId) {
            pickerRender(widget, toolId);
        }
    });
}

function pickerRender(widget, toolId) {
    const items = pickerGetData(toolId);
    const chipsEl = widget.querySelector('.picker-items');
    const spinBtn = widget.querySelector('.picker-spin-btn');

    // Render chips
    chipsEl.innerHTML = items.map((item, idx) =>
        `<span class="picker-chip">
            <span class="picker-dot" style="background:${PICKER_COLORS[idx % PICKER_COLORS.length]}"></span>
            ${escapeHtml(item)}
            <button class="picker-remove" onclick="pickerRemoveItem(this,${idx})">×</button>
        </span>`
    ).join('');

    // Draw wheel
    pickerDrawWheel(widget, items);

    // Enable/disable spin
    spinBtn.disabled = items.length < 2;
}

function pickerAddItem(btn) {
    const widget = btn.closest('.picker-widget');
    const input = widget.querySelector('.picker-input');
    const toolId = pickerGetToolId(widget);

    if (!toolId || !input.value.trim()) return;

    const items = pickerGetData(toolId);
    items.push(input.value.trim());
    pickerSaveData(toolId, items);

    input.value = '';
    pickerRender(widget, toolId);
    input.focus();
}

function pickerRemoveItem(btn, idx) {
    const widget = btn.closest('.picker-widget');
    const toolId = pickerGetToolId(widget);
    if (!toolId) return;

    const items = pickerGetData(toolId);
    items.splice(idx, 1);
    pickerSaveData(toolId, items);
    pickerRender(widget, toolId);
}

function pickerSpin(btn) {
    const widget = btn.closest('.picker-widget');
    const toolId = pickerGetToolId(widget);
    if (!toolId) return;

    const items = pickerGetData(toolId);
    if (items.length < 2) return;

    const svg = widget.querySelector('.picker-wheel-svg');
    const resultEl = widget.querySelector('.picker-result');
    btn.disabled = true;

    // Pick random winner
    const winnerIdx = Math.floor(Math.random() * items.length);

    // Calculate target angle: segment center should land at top (under pointer)
    const segAngle = 360 / items.length;
    // Segments are drawn clockwise from top (12 o'clock).
    // Pointer is at top. We rotate clockwise, so the winner segment center
    // needs to end up at top. Segment i center is at i*segAngle + segAngle/2.
    // We need to rotate so that center comes to 360 (top).
    const targetAngle = 360 - (winnerIdx * segAngle + segAngle / 2);

    // Add multiple full rotations for effect
    const spins = 5 + Math.floor(Math.random() * 3); // 5-7 full spins
    const totalRotation = spins * 360 + targetAngle;

    // Reset transition, set starting rotation to 0
    svg.style.transition = 'none';
    svg.style.transform = 'rotate(0deg)';

    // Force reflow
    svg.offsetHeight;

    // Apply spin
    svg.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
    svg.style.transform = `rotate(${totalRotation}deg)`;

    resultEl.textContent = '';
    resultEl.classList.remove('highlight');

    setTimeout(() => {
        resultEl.textContent = items[winnerIdx];
        resultEl.classList.add('highlight');
        btn.disabled = false;

        // Normalize rotation for next spin
        svg.style.transition = 'none';
        svg.style.transform = `rotate(${targetAngle}deg)`;
    }, 4100);
}

function pickerDrawWheel(widget, items) {
    const svg = widget.querySelector('.picker-wheel-svg');
    if (!svg) return;

    const cx = 130, cy = 130, r = 120;

    if (items.length === 0) {
        svg.innerHTML = `<circle cx="${cx}" cy="${cy}" r="${r}" fill="var(--bg-tertiary, #eee)" stroke="var(--border-color)" stroke-width="2"/>
            <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" fill="var(--text-muted)" font-size="14">Add options above</text>`;
        return;
    }

    if (items.length === 1) {
        svg.innerHTML = `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${PICKER_COLORS[0]}" stroke="white" stroke-width="2"/>
            <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="14" font-weight="600">${escapeHtml(items[0])}</text>`;
        return;
    }

    const segAngle = (2 * Math.PI) / items.length;
    let html = '';

    for (let i = 0; i < items.length; i++) {
        // Start from top (12 o'clock = -90deg)
        const startAngle = i * segAngle - Math.PI / 2;
        const endAngle = (i + 1) * segAngle - Math.PI / 2;

        const x1 = cx + r * Math.cos(startAngle);
        const y1 = cy + r * Math.sin(startAngle);
        const x2 = cx + r * Math.cos(endAngle);
        const y2 = cy + r * Math.sin(endAngle);

        const largeArc = segAngle > Math.PI ? 1 : 0;
        const color = PICKER_COLORS[i % PICKER_COLORS.length];

        html += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} Z" fill="${color}" stroke="white" stroke-width="2"/>`;

        // Label at midpoint of segment
        const midAngle = startAngle + segAngle / 2;
        const labelR = r * 0.65;
        const lx = cx + labelR * Math.cos(midAngle);
        const ly = cy + labelR * Math.sin(midAngle);

        // Rotate text to align with segment
        const textAngle = (midAngle * 180) / Math.PI + 90;

        // Truncate long labels
        const label = items[i].length > 12 ? items[i].slice(0, 11) + '…' : items[i];

        html += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="${items.length > 8 ? 10 : 12}" font-weight="600" transform="rotate(${textAngle},${lx},${ly})">${escapeHtml(label)}</text>`;
    }

    // Center circle
    html += `<circle cx="${cx}" cy="${cy}" r="18" fill="white" stroke="var(--border-color)" stroke-width="2"/>`;
    html += `<circle cx="${cx}" cy="${cy}" r="6" fill="#333"/>`;

    svg.innerHTML = html;

    // Reset rotation
    svg.style.transition = 'none';
    svg.style.transform = 'rotate(0deg)';
}

// Simple Calculator State
let calcState = { current: '0', previous: '', operator: '', newNumber: true };

function calcInit() {
    calcState = { current: '0', previous: '', operator: '', newNumber: true };
    const display = document.getElementById('calcDisplay');
    if (display) {
        display.value = '0';
        // Add keyboard support
        display.removeAttribute('readonly');
        display.addEventListener('keydown', calcKeyHandler);
        display.addEventListener('input', calcInputHandler);
        display.focus();
    }
}

function calcKeyHandler(e) {
    const key = e.key;

    // Prevent default for keys we handle
    if (/^[0-9.]$/.test(key) || ['+', '-', '*', '/', 'Enter', 'Escape', 'Backspace', '='].includes(key)) {
        e.preventDefault();
    }

    if (/^[0-9.]$/.test(key)) {
        calcNum(key);
    } else if (['+', '-', '*', '/'].includes(key)) {
        calcOp(key);
    } else if (key === 'Enter' || key === '=') {
        calcEquals();
    } else if (key === 'Escape' || key === 'Delete') {
        calcClear();
    } else if (key === 'Backspace') {
        calcBackspace();
    }
}

function calcInputHandler(e) {
    // Reset display to current state (prevent direct typing)
    const display = document.getElementById('calcDisplay');
    if (display) display.value = calcState.current;
}

function calcNum(num) {
    const display = document.getElementById('calcDisplay');
    if (!display) return;

    if (calcState.newNumber) {
        calcState.current = (num === '.') ? '0.' : num;
        calcState.newNumber = false;
    } else {
        if (num === '.' && calcState.current.includes('.')) return;
        calcState.current += num;
    }
    display.value = calcState.current;
}

function calcOp(op) {
    const display = document.getElementById('calcDisplay');
    if (!display) return;

    if (calcState.operator && !calcState.newNumber) {
        calcEquals();
    }
    calcState.previous = calcState.current;
    calcState.operator = op;
    calcState.newNumber = true;
}

function calcEquals() {
    const display = document.getElementById('calcDisplay');
    if (!display || !calcState.operator) return;

    const prev = parseFloat(calcState.previous);
    const curr = parseFloat(calcState.current);
    let result;

    switch (calcState.operator) {
        case '+': result = prev + curr; break;
        case '-': result = prev - curr; break;
        case '*': result = prev * curr; break;
        case '/': result = curr !== 0 ? prev / curr : 'Error'; break;
        default: return;
    }

    calcState.current = typeof result === 'number' ? String(Math.round(result * 1e10) / 1e10) : result;
    calcState.operator = '';
    calcState.newNumber = true;
    display.value = calcState.current;
}

function calcClear() {
    calcInit();
}

function calcBackspace() {
    const display = document.getElementById('calcDisplay');
    if (!display) return;

    if (calcState.current.length > 1) {
        calcState.current = calcState.current.slice(0, -1);
    } else {
        calcState.current = '0';
        calcState.newNumber = true;
    }
    display.value = calcState.current;
}


// Calendar Widget
// ============================================================
// Stopwatch Widget
// ============================================================
const swInstances = new Map();

function swGetWidget(el) {
    return el.closest('.stopwatch-widget');
}

function swGetToolId(el) {
    const tool = el.closest('.tool');
    return tool ? tool.dataset.tool : null;
}

function swGetState(toolId) {
    if (!swInstances.has(toolId)) {
        swInstances.set(toolId, { running: false, elapsed: 0, startTime: 0, timer: null, laps: [] });
    }
    return swInstances.get(toolId);
}

function swFormatTime(ms) {
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    const millis = ms % 1000;
    const hh = String(h).padStart(2, '0');
    const mm = String(m).padStart(2, '0');
    const ss = String(s).padStart(2, '0');
    const ms3 = String(millis).padStart(3, '0');
    return { main: `${hh}:${mm}:${ss}`, ms: `.${ms3}` };
}

function swUpdateDisplay(widget, ms) {
    const display = widget.querySelector('.sw-display');
    const t = swFormatTime(ms);
    display.innerHTML = `${t.main}<span class="sw-ms">${t.ms}</span>`;
}

function swTick(toolId, widget) {
    const state = swGetState(toolId);
    if (!state.running) return;
    state.elapsed = Date.now() - state.startTime;
    swUpdateDisplay(widget, state.elapsed);
    state.timer = requestAnimationFrame(() => swTick(toolId, widget));
}

function swToggle(btn) {
    const widget = swGetWidget(btn);
    const toolId = swGetToolId(btn);
    const state = swGetState(toolId);
    const lapBtn = widget.querySelector('.sw-lap');
    const resetBtn = widget.querySelector('.sw-reset');

    if (state.running) {
        // Stop
        state.running = false;
        cancelAnimationFrame(state.timer);
        state.elapsed = Date.now() - state.startTime;
        btn.textContent = 'Start';
        btn.classList.remove('running');
        lapBtn.disabled = true;
        resetBtn.disabled = false;
    } else {
        // Start
        state.startTime = Date.now() - state.elapsed;
        state.running = true;
        btn.textContent = 'Stop';
        btn.classList.add('running');
        lapBtn.disabled = false;
        resetBtn.disabled = true;
        swTick(toolId, widget);
    }
}

function swLap(btn) {
    const widget = swGetWidget(btn);
    const toolId = swGetToolId(btn);
    const state = swGetState(toolId);
    if (!state.running) return;

    const lapTime = state.elapsed;
    const prevTotal = state.laps.length > 0 ? state.laps[state.laps.length - 1].total : 0;
    const split = lapTime - prevTotal;
    state.laps.push({ total: lapTime, split: split });
    swRenderLaps(widget, state);
}

function swReset(btn) {
    const widget = swGetWidget(btn);
    const toolId = swGetToolId(btn);
    const state = swGetState(toolId);

    state.running = false;
    cancelAnimationFrame(state.timer);
    state.elapsed = 0;
    state.laps = [];

    swUpdateDisplay(widget, 0);
    widget.querySelector('.sw-laps').innerHTML = '';
    const startBtn = widget.querySelector('.sw-start');
    startBtn.textContent = 'Start';
    startBtn.classList.remove('running');
    widget.querySelector('.sw-lap').disabled = true;
    btn.disabled = true;
}

function swRenderLaps(widget, state) {
    const container = widget.querySelector('.sw-laps');
    if (state.laps.length === 0) { container.innerHTML = ''; return; }

    const splits = state.laps.map(l => l.split);
    const bestSplit = Math.min(...splits);
    const worstSplit = Math.max(...splits);
    const showBestWorst = state.laps.length >= 3;

    let html = '<table><thead><tr><th>#</th><th>Lap</th><th>Total</th></tr></thead><tbody>';
    for (let i = state.laps.length - 1; i >= 0; i--) {
        const lap = state.laps[i];
        const splitT = swFormatTime(lap.split);
        const totalT = swFormatTime(lap.total);
        let cls = '';
        if (showBestWorst && lap.split === bestSplit) cls = 'sw-lap-best';
        else if (showBestWorst && lap.split === worstSplit) cls = 'sw-lap-worst';
        html += `<tr class="${cls}"><td>${i + 1}</td><td>${splitT.main}<span class="sw-ms">${splitT.ms}</span></td><td>${totalT.main}<span class="sw-ms">${totalT.ms}</span></td></tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
}

function stopwatchInit() {
    document.querySelectorAll('.stopwatch-widget').forEach(widget => {
        const toolId = swGetToolId(widget);
        if (toolId) swUpdateDisplay(widget, 0);
    });
}

const CALENDAR_COLORS = [
    '#3498db', '#e74c3c', '#27ae60', '#9b59b6',
    '#f39c12', '#1abc9c', '#e67e22', '#34495e'
];

const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const DAY_NAMES = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

function calendarGetToolId(widget) {
    const tool = widget.closest('.tool');
    return tool ? tool.dataset.tool: null;
}

function calendarGetData(toolId) {
    const customizations = loadToolCustomizations();
    const custom = customizations[toolId] || {};
    const data = custom.calendarData || { calendars: [], events: [] };
    return data;
}

function calendarSaveData(toolId, data) {
    const customizations = loadToolCustomizations();
    if (!customizations[toolId]) customizations[toolId] = {};
    customizations[toolId].calendarData = data;
    saveToolCustomizations(customizations);
}

function calendarInit() {
    document.querySelectorAll('.calendar-widget').forEach(widget => {
        const toolId = calendarGetToolId(widget);
        if (!toolId) return;

        const data = calendarGetData(toolId);
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    });
}

function calendarRender(widget, toolId, year) {
    const data = calendarGetData(toolId);
    const grid = widget.querySelector('.calendar-year-grid');
    const legend = widget.querySelector('.calendar-legend');
    const yearDisplay = widget.querySelector('.calendar-year-display');

    if (yearDisplay) yearDisplay.textContent = year;

    // Render 12 months in year grid
    let html = '';
    for (let month = 0; month < 12; month++) {
        html += calendarRenderMonth(year, month, data);
    }
    grid.innerHTML = html;

    // Also update month view if it exists and has data
    const monthView = widget.querySelector('.calendar-month-view');
    if (monthView && widget.dataset.viewMonth !== undefined) {
        calendarRenderMonthView(widget, toolId);
    }

    // Render legend with event counts
    const counts = calendarCountByType(data, year);
    let legendHtml = '';
    data.calendars.forEach(cal => {
        const count = counts[cal.id] || 0;
        legendHtml += `<div class="calendar-legend-item">
            <span class="calendar-legend-dot" style="background:${cal.color}"></span>
            <span>${cal.name}</span>
            <span class="calendar-legend-count">${count}</span>
        </div>`;
    });
    legend.innerHTML = legendHtml;
}

function calendarRenderMonth(year, month, data) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDow = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
    const todayDate = today.getDate();

    let html = `<div class="calendar-month">
        <div class="calendar-month-name" onclick="calendarGoToMonth(this, ${year}, ${month})" style="cursor:pointer" title="Click for month view">${MONTH_NAMES[month]}</div>
        <div class="calendar-month-grid">`;

    // Day of week headers
    DAY_NAMES.forEach(d => {
        html += `<div class="calendar-dow">${d}</div>`;
    });

    // Empty cells before first day
    for (let i = 0; i < startDow; i++) {
        html += `<div class="calendar-day other-month"></div>`;
    }

    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = calendarGetEventsForDate(data, dateStr);
        const isToday = isCurrentMonth && day === todayDate;

        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (dayEvents.length > 0) classes += ' has-events';

        html += `<div class="${classes}" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            ${day}`;

        if (dayEvents.length > 0) {
            html += `<div class="calendar-event-dots">`;
            // Show up to 3 dots
            const uniqueCals = [...new Set(dayEvents.map(e => e.calendarId))];
            uniqueCals.slice(0, 3).forEach(calId => {
                const cal = data.calendars.find(c => c.id === calId);
                if (cal) {
                    html += `<span class="calendar-event-dot" style="background:${cal.color}"></span>`;
                }
            });
            html += `</div>`;
        }

        html += `</div>`;
    }

    html += `</div></div>`;
    return html;
}

function calendarGetEventsForDate(data, dateStr) {
    return data.events.filter(event => {
        // Check if date falls within event range or matches single day
        const startDate = event.startDate.split('T')[0];
        const endDate = event.endDate ? event.endDate.split('T')[0] : startDate;
        return dateStr >= startDate && dateStr <= endDate;
    });
}

function calendarCountByType(data, year) {
    const counts = {};
    data.calendars.forEach(cal => counts[cal.id] = 0);

    const yearStart = new Date(year, 0, 1);
    const yearEnd = new Date(year, 11, 31);

    data.events.forEach(event => {
        if (!counts.hasOwnProperty(event.calendarId)) return;

        const startDate = new Date(event.startDate.split('T')[0]);
        const endDate = new Date((event.endDate || event.startDate).split('T')[0]);

        // Clamp to year boundaries
        const countStart = startDate < yearStart ? yearStart : startDate;
        const countEnd = endDate > yearEnd ? yearEnd : endDate;

        if (countStart <= countEnd) {
            // Count number of days
            const days = Math.round((countEnd - countStart) / (1000 * 60 * 60 * 24)) + 1;
            counts[event.calendarId] += days;
        }
    });

    return counts;
}

function calendarCountTotal(data) {
    const counts = {};
    data.calendars.forEach(cal => counts[cal.id] = 0);

    data.events.forEach(event => {
        if (!counts.hasOwnProperty(event.calendarId)) return;

        const startDate = new Date(event.startDate.split('T')[0]);
        const endDate = new Date((event.endDate || event.startDate).split('T')[0]);

        // Count number of days
        const days = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        counts[event.calendarId] += days;
    });

    return counts;
}

function calendarPrevYear(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const yearDisplay = widget.querySelector('.calendar-year-display');
    const year = parseInt(yearDisplay.textContent) - 1;
    calendarRender(widget, toolId, year);
}

function calendarNextYear(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const yearDisplay = widget.querySelector('.calendar-year-display');
    const year = parseInt(yearDisplay.textContent) + 1;
    calendarRender(widget, toolId, year);
}

function calendarSetView(btn, view) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);

    // Update toggle buttons
    widget.querySelectorAll('.calendar-view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const yearGrid = widget.querySelector('.calendar-year-grid');
    const monthView = widget.querySelector('.calendar-month-view');
    const yearNav = widget.querySelector('.calendar-year-nav');

    if (view === 'month') {
        yearGrid.classList.add('hidden');
        monthView.classList.add('active');
        yearNav.style.display = 'none';

        // Initialize month view with current month if not set
        if (!widget.dataset.viewMonth) {
            const now = new Date();
            widget.dataset.viewMonth = now.getMonth();
            widget.dataset.viewYear = now.getFullYear();
        }
        calendarRenderMonthView(widget, toolId);
    } else {
        yearGrid.classList.remove('hidden');
        monthView.classList.remove('active');
        yearNav.style.display = 'flex';
    }
}

function calendarPrevMonth(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    let month = parseInt(widget.dataset.viewMonth);
    let year = parseInt(widget.dataset.viewYear);

    month--;
    if (month < 0) {
        month = 11;
        year--;
    }

    widget.dataset.viewMonth = month;
    widget.dataset.viewYear = year;
    calendarRenderMonthView(widget, toolId);
}

function calendarNextMonth(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    let month = parseInt(widget.dataset.viewMonth);
    let year = parseInt(widget.dataset.viewYear);

    month++;
    if (month > 11) {
        month = 0;
        year++;
    }

    widget.dataset.viewMonth = month;
    widget.dataset.viewYear = year;
    calendarRenderMonthView(widget, toolId);
}

function calendarGoToMonth(el, year, month) {
    const widget = el.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);

    // Set the month/year
    widget.dataset.viewMonth = month;
    widget.dataset.viewYear = year;

    // Switch to month view
    const monthBtn = widget.querySelector('.calendar-view-btn:last-child');
    calendarSetView(monthBtn, 'month');
}

function calendarGoToToday(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const now = new Date();

    widget.dataset.viewMonth = now.getMonth();
    widget.dataset.viewYear = now.getFullYear();
    calendarRenderMonthView(widget, toolId);
}

function calendarRenderMonthView(widget, toolId) {
    const data = calendarGetData(toolId);
    const month = parseInt(widget.dataset.viewMonth);
    const year = parseInt(widget.dataset.viewYear);

    const monthTitle = widget.querySelector('.calendar-month-title');
    const monthDetail = widget.querySelector('.calendar-month-detail');

    monthTitle.textContent = `${MONTH_NAMES[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDow = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
    const todayDate = today.getDate();

    let html = '';

    // Day of week headers
    DAY_NAMES.forEach(d => {
        html += `<div class="calendar-dow">${d}</div>`;
    });

    // Days from previous month
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startDow - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const prevMonth = month === 0 ? 11 : month - 1;
        const prevYear = month === 0 ? year - 1 : year;
        const dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        html += `<div class="calendar-day-cell other-month" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            <div class="calendar-day-number">${day}</div>
        </div>`;
    }

    // Days of current month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = calendarGetEventsForDate(data, dateStr);
        const isToday = isCurrentMonth && day === todayDate;

        let classes = 'calendar-day-cell';
        if (isToday) classes += ' today';

        html += `<div class="${classes}" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            <div class="calendar-day-number">${day}</div>
            <div class="calendar-day-events">`;

        // Show up to 3 events
        dayEvents.slice(0, 3).forEach(event => {
            const cal = data.calendars.find(c => c.id === event.calendarId);
            const color = cal ? cal.color : '#999';
            html += `<div class="calendar-day-event" style="background:${color}" title="${event.summary}">${event.summary}</div>`;
        });

        if (dayEvents.length > 3) {
            html += `<div class="calendar-day-more">+${dayEvents.length - 3} more</div>`;
        }

        html += `</div></div>`;
    }

    // Days from next month to fill the grid
    const totalCells = startDow + daysInMonth;
    const remainingCells = (7 - (totalCells % 7)) % 7;
    for (let day = 1; day <= remainingCells; day++) {
        const nextMonth = month === 11 ? 0 : month + 1;
        const nextYear = month === 11 ? year + 1 : year;
        const dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        html += `<div class="calendar-day-cell other-month" data-date="${dateStr}" onclick="calendarShowDayEvents(this, '${dateStr}')">
            <div class="calendar-day-number">${day}</div>
        </div>`;
    }

    monthDetail.innerHTML = html;
}

function calendarShowDayEvents(dayEl, dateStr) {
    // Remove existing tooltip
    document.querySelectorAll('.calendar-day-tooltip').forEach(t => t.remove());

    const widget = dayEl.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const data = calendarGetData(toolId);
    const events = calendarGetEventsForDate(data, dateStr);

    const date = new Date(dateStr + 'T00:00:00');
    const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

    let html = `<div class="calendar-day-tooltip" data-tool-id="${toolId}" data-date="${dateStr}">
        <div class="calendar-day-tooltip-date">${dateFormatted}</div>`;

    events.forEach(event => {
        const cal = data.calendars.find(c => c.id === event.calendarId);
        const color = cal ? cal.color : '#999';
        html += `<div class="calendar-day-tooltip-event">
            <span class="calendar-day-tooltip-dot" style="background:${color}"></span>
            <span class="calendar-day-tooltip-text">${event.summary}</span>
            <button class="calendar-event-delete" onclick="calendarDeleteEvent('${event.uid}')" title="Delete event">&times;</button>
        </div>`;
    });

    // Add event form
    if (data.calendars.length > 0) {
        const calendarOptions = data.calendars.map(cal =>
            `<option value="${cal.id}">${cal.name}</option>`
        ).join('');
        html += `<div class="calendar-day-add-form">
            <input type="text" class="calendar-day-add-input" placeholder="New event..." id="calendarDayEventTitle">
            <select class="calendar-day-add-select" id="calendarDayEventCalendar">${calendarOptions}</select>
            <button class="calendar-day-add-btn" onclick="calendarAddEventFromDay(this)">+</button>
        </div>`;
    } else {
        html += `<div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Add a calendar first to create events</div>`;
    }

    html += `</div>`;

    const tooltip = document.createElement('div');
    tooltip.innerHTML = html;
    const tooltipEl = tooltip.firstChild;
    document.body.appendChild(tooltipEl);

    // Position tooltip
    const rect = dayEl.getBoundingClientRect();
    let left = rect.left + window.scrollX;
    let top = rect.bottom + window.scrollY + 5;

    // Adjust if tooltip would go off-screen
    tooltipEl.style.left = left + 'px';
    tooltipEl.style.top = top + 'px';

    // Focus the input and add Enter key support
    setTimeout(() => {
        const input = tooltipEl.querySelector('.calendar-day-add-input');
        if (input) {
            input.focus();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const btn = tooltipEl.querySelector('.calendar-day-add-btn');
                    if (btn) btn.click();
                }
            });
        }
    }, 0);

    // Close on click outside
    const closeHandler = (e) => {
        if (!tooltipEl.contains(e.target) && e.target !== dayEl) {
            tooltipEl.remove();
            document.removeEventListener('click', closeHandler);
        }
    };
    setTimeout(() => document.addEventListener('click', closeHandler), 0);
}

function calendarOpenManage(btn) {
    const widget = btn.closest('.calendar-widget');
    const toolId = calendarGetToolId(widget);
    const data = calendarGetData(toolId);

    // Create modal if it doesn't exist
    let modal = document.getElementById('calendarManageModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'calendarManageModal';
        modal.className = 'calendar-manage-modal';
        modal.innerHTML = `
            <div class="calendar-manage-content">
                <span class="calendar-manage-close" onclick="calendarCloseManage()">&times;</span>
                <h3>Manage Calendars</h3>
                <div class="calendar-list" id="calendarManageList"></div>
                <div class="calendar-add-form">
                    <h4>Add New Calendar</h4>
                    <div class="calendar-add-row">
                        <input type="text" class="calendar-add-name" id="calendarAddName" placeholder="Calendar name...">
                    </div>
                    <div class="calendar-color-picker" id="calendarColorPicker"></div>
                    <button class="calendar-add-btn" onclick="calendarAddCalendar()">Add Calendar</button>
                </div>
                <div class="calendar-import-section">
                    <h4>Add Event</h4>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">Title:</label>
                        <input type="text" class="calendar-add-name" id="calendarEventTitle" placeholder="Event title..." style="flex:1;">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">Start:</label>
                        <input type="date" class="calendar-add-name" id="calendarEventStart" style="flex:1;">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">End:</label>
                        <input type="date" class="calendar-add-name" id="calendarEventEnd" style="flex:1;">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">Calendar:</label>
                        <select class="calendar-import-select" id="calendarEventCalendar" style="flex:1;"></select>
                    </div>
                    <button class="calendar-add-btn" onclick="calendarAddEvent()">Add Event</button>
                </div>
                <div class="calendar-import-section">
                    <h4>Import .ics</h4>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">From file:</label>
                        <input type="file" class="calendar-import-file" id="calendarImportFile" accept=".ics">
                    </div>
                    <div class="calendar-import-row" style="margin-bottom:8px;">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">From URL:</label>
                        <input type="text" class="calendar-add-name" id="calendarImportUrl" placeholder="https://example.com/calendar.ics" style="flex:1;">
                        <button class="calendar-add-btn" onclick="calendarImportFromUrl()" style="padding:6px 10px;">Fetch</button>
                    </div>
                    <div class="calendar-import-row">
                        <label style="font-size:11px;color:var(--text-muted);min-width:60px;">To calendar:</label>
                        <select class="calendar-import-select" id="calendarImportSelect"></select>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // File import handler
        document.getElementById('calendarImportFile').addEventListener('change', calendarHandleFileImport);
    }

    modal.dataset.toolId = toolId;
    modal.classList.add('open');

    // Render color picker
    const colorPicker = document.getElementById('calendarColorPicker');
    colorPicker.innerHTML = CALENDAR_COLORS.map((color, i) =>
        `<div class="calendar-color-option${i === 0 ? ' selected' : ''}"
             style="background:${color}"
             data-color="${color}"
             onclick="calendarSelectColor(this)"></div>`
    ).join('');

    // Render calendar list
    calendarRenderManageList(data);
}

function calendarCloseManage() {
    const modal = document.getElementById('calendarManageModal');
    if (modal) modal.classList.remove('open');
}

function calendarSelectColor(el) {
    document.querySelectorAll('.calendar-color-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
}

function calendarRenderManageList(data) {
    const list = document.getElementById('calendarManageList');
    const importSelect = document.getElementById('calendarImportSelect');
    const eventSelect = document.getElementById('calendarEventCalendar');

    if (data.calendars.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);font-size:12px;">No calendars yet. Add one below.</p>';
        const emptyOption = '<option value="">Add a calendar first</option>';
        importSelect.innerHTML = emptyOption;
        eventSelect.innerHTML = emptyOption;
        importSelect.disabled = true;
        eventSelect.disabled = true;
    } else {
        const counts = calendarCountTotal(data);

        list.innerHTML = data.calendars.map(cal => `
            <div class="calendar-list-item">
                <span class="calendar-list-color" style="background:${cal.color}"></span>
                <span class="calendar-list-name">${cal.name}</span>
                <span class="calendar-list-count">${counts[cal.id] || 0} days</span>
                <button class="calendar-list-remove" onclick="calendarRemoveCalendar('${cal.id}')">&times;</button>
            </div>
        `).join('');

        const calendarOptions = data.calendars.map(cal =>
            `<option value="${cal.id}">${cal.name}</option>`
        ).join('');
        importSelect.innerHTML = calendarOptions;
        eventSelect.innerHTML = calendarOptions;
        importSelect.disabled = false;
        eventSelect.disabled = false;
    }
}

function calendarAddCalendar() {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;
    const nameInput = document.getElementById('calendarAddName');
    const colorEl = document.querySelector('.calendar-color-option.selected');

    const name = nameInput.value.trim();
    if (!name) {
        nameInput.focus();
        return;
    }

    const color = colorEl ? colorEl.dataset.color : CALENDAR_COLORS[0];
    const data = calendarGetData(toolId);

    const newCal = {
        id: 'cal_' + Date.now(),
        name: name,
        color: color
    };

    data.calendars.push(newCal);
    calendarSaveData(toolId, data);

    nameInput.value = '';
    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarAddEvent() {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;

    const titleInput = document.getElementById('calendarEventTitle');
    const startInput = document.getElementById('calendarEventStart');
    const endInput = document.getElementById('calendarEventEnd');
    const calendarSelect = document.getElementById('calendarEventCalendar');

    const title = titleInput.value.trim();
    const startDate = startInput.value;
    const endDate = endInput.value || startDate;
    const calendarId = calendarSelect.value;

    if (!title) {
        titleInput.focus();
        return;
    }

    if (!startDate) {
        startInput.focus();
        return;
    }

    if (!calendarId) {
        alert('Please create a calendar first.');
        return;
    }

    const data = calendarGetData(toolId);

    const newEvent = {
        uid: 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        calendarId: calendarId,
        summary: title,
        startDate: startDate,
        endDate: endDate
    };

    data.events.push(newEvent);
    calendarSaveData(toolId, data);

    // Clear inputs
    titleInput.value = '';
    startInput.value = '';
    endInput.value = '';

    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarAddEventFromDay(btn) {
    const tooltip = btn.closest('.calendar-day-tooltip');
    const toolId = tooltip.dataset.toolId;
    const dateStr = tooltip.dataset.date;

    const titleInput = tooltip.querySelector('.calendar-day-add-input');
    const calendarSelect = tooltip.querySelector('.calendar-day-add-select');

    const title = titleInput.value.trim();
    const calendarId = calendarSelect.value;

    if (!title) {
        titleInput.focus();
        return;
    }

    const data = calendarGetData(toolId);

    const newEvent = {
        uid: 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        calendarId: calendarId,
        summary: title,
        startDate: dateStr,
        endDate: dateStr
    };

    data.events.push(newEvent);
    calendarSaveData(toolId, data);

    // Close tooltip
    tooltip.remove();

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarDeleteEvent(eventUid) {
    const tooltip = document.querySelector('.calendar-day-tooltip');
    if (!tooltip) return;

    const toolId = tooltip.dataset.toolId;
    const dateStr = tooltip.dataset.date;
    const data = calendarGetData(toolId);

    data.events = data.events.filter(e => e.uid !== eventUid);
    calendarSaveData(toolId, data);

    // Close tooltip
    tooltip.remove();

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarRemoveCalendar(calId) {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;
    const data = calendarGetData(toolId);

    data.calendars = data.calendars.filter(c => c.id !== calId);
    data.events = data.events.filter(e => e.calendarId !== calId);
    calendarSaveData(toolId, data);

    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }
}

function calendarHandleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
        const content = evt.target.result;
        calendarImportICS(content);
    };
    reader.readAsText(file);

    // Clear the input
    e.target.value = '';
}

async function calendarImportFromUrl() {
    const urlInput = document.getElementById('calendarImportUrl');
    const url = urlInput.value.trim();

    if (!url) {
        urlInput.focus();
        return;
    }

    // Validate URL
    try {
        new URL(url);
    } catch {
        alert('Please enter a valid URL.');
        return;
    }

    const select = document.getElementById('calendarImportSelect');
    if (!select.value) {
        alert('Please create a calendar first before importing events.');
        return;
    }

    // Show loading state
    const fetchBtn = document.querySelector('.calendar-import-section .calendar-add-btn');
    const originalText = fetchBtn.textContent;
    fetchBtn.textContent = 'Fetching...';
    fetchBtn.disabled = true;

    try {
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const content = await response.text();

        if (!content.includes('BEGIN:VCALENDAR')) {
            throw new Error('The URL does not appear to contain valid ICS data.');
        }

        calendarImportICS(content);
        urlInput.value = '';
    } catch (error) {
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            alert('Could not fetch the URL. This may be due to CORS restrictions. Try downloading the .ics file and importing it manually.');
        } else {
            alert('Error fetching calendar: ' + error.message);
        }
    } finally {
        fetchBtn.textContent = originalText;
        fetchBtn.disabled = false;
    }
}

function calendarImportICS(content) {
    const modal = document.getElementById('calendarManageModal');
    const toolId = modal.dataset.toolId;
    const select = document.getElementById('calendarImportSelect');
    const calendarId = select.value;

    if (!calendarId) {
        alert('Please create a calendar first before importing events.');
        return;
    }

    const events = parseICSContent(content, calendarId);

    if (events.length === 0) {
        alert('No events found in the ICS file.');
        return;
    }

    const data = calendarGetData(toolId);

    // Add events (avoiding duplicates by UID)
    const existingUids = new Set(data.events.map(e => e.uid));
    let added = 0;

    events.forEach(event => {
        if (!existingUids.has(event.uid)) {
            data.events.push(event);
            existingUids.add(event.uid);
            added++;
        }
    });

    calendarSaveData(toolId, data);
    calendarRenderManageList(data);

    // Re-render calendar
    const widget = document.querySelector(`.tool[data-tool="${toolId}"] .calendar-widget`);
    if (widget) {
        const year = parseInt(widget.querySelector('.calendar-year-display')?.textContent) || new Date().getFullYear();
        calendarRender(widget, toolId, year);
    }

    alert(`Imported ${added} event(s).`);
}

function parseICSContent(text, calendarId) {
    const events = [];
    const lines = text.replace(/\r\n /g, '').replace(/\r/g, '\n').split('\n');

    let inEvent = false;
    let currentEvent = {};

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (line === 'BEGIN:VEVENT') {
            inEvent = true;
            currentEvent = { calendarId };
        } else if (line === 'END:VEVENT') {
            if (currentEvent.startDate && currentEvent.summary) {
                if (!currentEvent.uid) {
                    currentEvent.uid = 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                if (!currentEvent.endDate) {
                    currentEvent.endDate = currentEvent.startDate;
                }
                events.push(currentEvent);
            }
            inEvent = false;
            currentEvent = {};
        } else if (inEvent) {
            const colonIndex = line.indexOf(':');
            if (colonIndex === -1) continue;

            let key = line.substring(0, colonIndex);
            const value = line.substring(colonIndex + 1);

            // Handle parameters in key (e.g., DTSTART;VALUE=DATE:20240101)
            const semiIndex = key.indexOf(';');
            if (semiIndex !== -1) {
                key = key.substring(0, semiIndex);
            }

            switch (key) {
                case 'UID':
                    currentEvent.uid = value;
                    break;
                case 'SUMMARY':
                    currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, '\n');
                    break;
                case 'DTSTART':
                    currentEvent.startDate = parseICSDate(value);
                    break;
                case 'DTEND':
                    // ICS end dates are exclusive for all-day events
                    // If date-only (length 8), subtract one day
                    const cleanedEnd = value.replace('Z', '');
                    if (cleanedEnd.length === 8) {
                        const d = new Date(
                            parseInt(cleanedEnd.substring(0, 4)),
                            parseInt(cleanedEnd.substring(4, 6)) - 1,
                            parseInt(cleanedEnd.substring(6, 8))
                        );
                        d.setDate(d.getDate() - 1);
                        currentEvent.endDate = d.toISOString().split('T')[0];
                    } else {
                        currentEvent.endDate = parseICSDate(value);
                    }
                    break;
                case 'RRULE':
                    // Basic recurring event support - expand first year of occurrences
                    currentEvent.rrule = value;
                    break;
            }
        }
    }

    // Expand recurring events for current year
    const expandedEvents = [];
    events.forEach(event => {
        if (event.rrule) {
            const expanded = expandRRULE(event);
            expandedEvents.push(...expanded);
        } else {
            expandedEvents.push(event);
        }
    });

    return expandedEvents;
}

function parseICSDate(value) {
    // Handle formats: 20240115, 20240115T103000, 20240115T103000Z
    const cleaned = value.replace('Z', '');

    if (cleaned.length === 8) {
        // Date only: YYYYMMDD
        return `${cleaned.substring(0, 4)}-${cleaned.substring(4, 6)}-${cleaned.substring(6, 8)}`;
    } else if (cleaned.length >= 15) {
        // DateTime: YYYYMMDDTHHMMSS
        return `${cleaned.substring(0, 4)}-${cleaned.substring(4, 6)}-${cleaned.substring(6, 8)}T${cleaned.substring(9, 11)}:${cleaned.substring(11, 13)}:${cleaned.substring(13, 15)}`;
    }

    return value;
}

function expandRRULE(event) {
    const events = [event];
    const rrule = event.rrule;

    // Parse RRULE components
    const parts = {};
    rrule.split(';').forEach(part => {
        const [key, val] = part.split('=');
        parts[key] = val;
    });

    if (!parts.FREQ) return events;

    const startDate = new Date(event.startDate);
    const endDate = event.endDate ? new Date(event.endDate) : new Date(event.startDate);
    const duration = endDate - startDate;

    const count = parts.COUNT ? parseInt(parts.COUNT) : 52; // Default to 1 year of weekly events
    const interval = parts.INTERVAL ? parseInt(parts.INTERVAL) : 1;

    let until = parts.UNTIL ? new Date(parseICSDate(parts.UNTIL)) : null;
    if (!until) {
        until = new Date(startDate);
        until.setFullYear(until.getFullYear() + 1);
    }

    let currentDate = new Date(startDate);
    let occurrences = 1;

    while (occurrences < count && currentDate < until) {
        // Advance to next occurrence
        switch (parts.FREQ) {
            case 'DAILY':
                currentDate.setDate(currentDate.getDate() + interval);
                break;
            case 'WEEKLY':
                currentDate.setDate(currentDate.getDate() + (7 * interval));
                break;
            case 'MONTHLY':
                currentDate.setMonth(currentDate.getMonth() + interval);
                break;
            case 'YEARLY':
                currentDate.setFullYear(currentDate.getFullYear() + interval);
                break;
            default:
                return events;
        }

        if (currentDate > until) break;

        const newEndDate = new Date(currentDate.getTime() + duration);
        events.push({
            ...event,
            uid: event.uid + '_' + occurrences,
            startDate: currentDate.toISOString().split('T')[0],
            endDate: newEndDate.toISOString().split('T')[0],
            rrule: undefined
        });

        occurrences++;
    }

    return events;
}


// Content Editor State
let currentEditingTool = null;

function setupContentEditor() {
    const overlay = document.getElementById('contentEditorOverlay');
    const editor = overlay.querySelector('.content-editor');
    const header = overlay.querySelector('.content-editor-header');
    const textarea = document.getElementById('contentEditorTextarea');
    const preview = document.getElementById('contentEditorPreview');
    const titleSpan = document.getElementById('editorToolTitle');
    const closeBtn = overlay.querySelector('.content-editor-close');
    const saveBtn = overlay.querySelector('.content-editor-save');
    const cancelBtn = overlay.querySelector('.content-editor-cancel');
    const resetBtn = overlay.querySelector('.content-editor-reset');
    const resizer = document.getElementById('editorResizer');
    const inputPane = overlay.querySelector('.content-editor-input');
    const previewPane = overlay.querySelector('.content-editor-preview');
    const plainTextCheckbox = document.getElementById('editorPlainTextCheckbox');

    function updateEditorPreview() {
        preview.innerHTML = renderToolContent(textarea.value, plainTextCheckbox.checked);
    }

    // Live preview
    textarea.addEventListener('input', updateEditorPreview);

    // Plain text toggle
    plainTextCheckbox.addEventListener('change', updateEditorPreview);

    // Handle pasting images from clipboard
    textarea.addEventListener('paste', (e) => {
        const html = e.clipboardData?.getData('text/html');
        if (!html) return; // No HTML = likely screenshot, ignore

        // Extract image src from pasted HTML
        const match = html.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (match && match[1]) {
            const imageUrl = match[1];
            // Skip data URLs (base64)
            if (imageUrl.startsWith('data:')) return;

            e.preventDefault();
            const cursorPos = textarea.selectionStart;
            const before = textarea.value.substring(0, cursorPos);
            const after = textarea.value.substring(textarea.selectionEnd);
            textarea.value = before + `![image](${imageUrl})` + after;
            textarea.selectionStart = textarea.selectionEnd = cursorPos + `![image](${imageUrl})`.length;
            textarea.dispatchEvent(new Event('input')); // Trigger preview update
        }
    });

    // --- Find & Replace ---
    const findBar = document.getElementById('editorFindReplace');
    const findInput = document.getElementById('editorFindInput');
    const findInfo = document.getElementById('editorFindInfo');
    const findPrevBtn = document.getElementById('editorFindPrev');
    const findNextBtn = document.getElementById('editorFindNext');
    const findCloseBtn = document.getElementById('editorFindClose');
    const findToggleReplace = document.getElementById('editorFindToggleReplace');
    const findCaseSensitive = document.getElementById('editorFindCaseSensitive');
    const replaceRow = document.getElementById('editorReplaceRow');
    const replaceInput = document.getElementById('editorReplaceInput');
    const replaceBtn = document.getElementById('editorReplaceBtn');
    const replaceAllBtn = document.getElementById('editorReplaceAllBtn');

    let findMatches = [];
    let currentMatchIndex = -1;

    function openFindReplace(showReplace) {
        findBar.style.display = '';
        if (showReplace) {
            replaceRow.style.display = '';
            findToggleReplace.innerHTML = '&#9660;';
        } else {
            replaceRow.style.display = 'none';
            findToggleReplace.innerHTML = '&#9654;';
        }
        // Prefill from selection
        const sel = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        if (sel && sel.indexOf('\n') === -1) {
            findInput.value = sel;
        }
        findInput.focus();
        findInput.select();
        performFind();
    }

    function closeFindReplace() {
        findBar.style.display = 'none';
        findMatches = [];
        currentMatchIndex = -1;
        textarea.focus();
    }

    function performFind() {
        findMatches = [];
        currentMatchIndex = -1;
        const query = findInput.value;
        if (!query) {
            findInfo.textContent = 'No results';
            return;
        }
        const text = textarea.value;
        const caseSensitive = findCaseSensitive.checked;
        const searchText = caseSensitive ? text : text.toLowerCase();
        const searchQuery = caseSensitive ? query : query.toLowerCase();
        let pos = 0;
        while (pos <= searchText.length - searchQuery.length) {
            const idx = searchText.indexOf(searchQuery, pos);
            if (idx === -1) break;
            findMatches.push({ start: idx, end: idx + searchQuery.length });
            pos = idx + 1;
        }
        if (findMatches.length === 0) {
            findInfo.textContent = 'No results';
            return;
        }
        // Find match at or after cursor
        const cursor = textarea.selectionStart;
        currentMatchIndex = 0;
        for (let i = 0; i < findMatches.length; i++) {
            if (findMatches[i].start >= cursor) {
                currentMatchIndex = i;
                break;
            }
        }
        selectMatch(currentMatchIndex, false);
    }

    function selectMatch(index, focusTextarea) {
        if (index < 0 || index >= findMatches.length) return;
        currentMatchIndex = index;
        const m = findMatches[index];
        textarea.setSelectionRange(m.start, m.end);
        // Scroll textarea so the match is visible
        // Temporarily collapse to start to force browser scroll, then restore
        textarea.blur();
        textarea.setSelectionRange(m.start, m.start);
        textarea.focus();
        textarea.setSelectionRange(m.start, m.end);
        if (!focusTextarea) {
            findInput.focus();
        }
        findInfo.textContent = `${index + 1} of ${findMatches.length}`;
    }

    function findNextMatch() {
        if (findMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex + 1) % findMatches.length;
        selectMatch(currentMatchIndex, true);
    }

    function findPrevMatch() {
        if (findMatches.length === 0) return;
        currentMatchIndex = (currentMatchIndex - 1 + findMatches.length) % findMatches.length;
        selectMatch(currentMatchIndex, true);
    }

    function replaceCurrentMatch() {
        if (currentMatchIndex < 0 || currentMatchIndex >= findMatches.length) return;
        const m = findMatches[currentMatchIndex];
        const val = textarea.value;
        textarea.value = val.substring(0, m.start) + replaceInput.value + val.substring(m.end);
        textarea.dispatchEvent(new Event('input'));
        // Keep cursor at end of replacement
        const newCursor = m.start + replaceInput.value.length;
        textarea.setSelectionRange(newCursor, newCursor);
        performFind();
    }

    function replaceAllMatches() {
        if (findMatches.length === 0) return;
        const replacement = replaceInput.value;
        let val = textarea.value;
        // Replace from end to start to preserve indices
        for (let i = findMatches.length - 1; i >= 0; i--) {
            const m = findMatches[i];
            val = val.substring(0, m.start) + replacement + val.substring(m.end);
        }
        textarea.value = val;
        textarea.dispatchEvent(new Event('input'));
        performFind();
    }

    // Find input events
    findInput.addEventListener('input', performFind);
    findCaseSensitive.addEventListener('change', performFind);
    findNextBtn.addEventListener('click', findNextMatch);
    findPrevBtn.addEventListener('click', findPrevMatch);
    findCloseBtn.addEventListener('click', closeFindReplace);

    findToggleReplace.addEventListener('click', () => {
        if (replaceRow.style.display === 'none') {
            replaceRow.style.display = '';
            findToggleReplace.innerHTML = '&#9660;';
        } else {
            replaceRow.style.display = 'none';
            findToggleReplace.innerHTML = '&#9654;';
        }
    });

    replaceBtn.addEventListener('click', replaceCurrentMatch);
    replaceAllBtn.addEventListener('click', replaceAllMatches);

    findInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            findNextMatch();
        } else if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault();
            findPrevMatch();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeFindReplace();
        }
    });

    replaceInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            replaceCurrentMatch();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeFindReplace();
        }
    });

    // --- Sort & Unique Lines ---
    const sortLinesBtn = document.getElementById('editorSortLinesBtn');
    const reverseSortBtn = document.getElementById('editorReverseSortBtn');
    const uniqueLinesBtn = document.getElementById('editorUniqueLinesBtn');

    function applyToLines(fn) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const hasSelection = start !== end;

        if (hasSelection) {
            // Expand selection to full lines
            const val = textarea.value;
            const lineStart = val.lastIndexOf('\n', start - 1) + 1;
            let lineEnd = val.indexOf('\n', end);
            if (lineEnd === -1) lineEnd = val.length;

            const selectedText = val.substring(lineStart, lineEnd);
            const lines = selectedText.split('\n');
            const result = fn(lines);
            const newText = val.substring(0, lineStart) + result.join('\n') + val.substring(lineEnd);
            textarea.value = newText;
            textarea.selectionStart = lineStart;
            textarea.selectionEnd = lineStart + result.join('\n').length;
        } else {
            const lines = textarea.value.split('\n');
            const result = fn(lines);
            textarea.value = result.join('\n');
        }
        textarea.dispatchEvent(new Event('input'));
    }

    function sortLines() {
        applyToLines(lines => [...lines].sort((a, b) => a.localeCompare(b)));
    }

    function reverseSortLines() {
        applyToLines(lines => [...lines].sort((a, b) => b.localeCompare(a)));
    }

    function uniqueLines() {
        applyToLines(lines => {
            const seen = new Set();
            return lines.filter(line => {
                if (seen.has(line)) return false;
                seen.add(line);
                return true;
            });
        });
    }

    sortLinesBtn.addEventListener('click', sortLines);
    reverseSortBtn.addEventListener('click', reverseSortLines);
    uniqueLinesBtn.addEventListener('click', uniqueLines);

    textarea.addEventListener('keydown', (e) => {
        const mod = e.metaKey || e.ctrlKey;
        if (mod && e.shiftKey && e.key === 's') {
            e.preventDefault();
            sortLines();
        } else if (mod && e.shiftKey && e.key === 'r') {
            e.preventDefault();
            reverseSortLines();
        } else if (mod && e.shiftKey && e.key === 'u') {
            e.preventDefault();
            uniqueLines();
        } else if (mod && e.key === 'f') {
            e.preventDefault();
            openFindReplace(false);
        } else if (mod && e.key === 'h') {
            e.preventDefault();
            openFindReplace(true);
        } else if (e.key === 'Escape' && findBar.style.display !== 'none') {
            e.preventDefault();
            closeFindReplace();
        }
    });

    // Close button
    closeBtn.addEventListener('click', () => {
        closeFindReplace();
        overlay.classList.remove('open');
        currentEditingTool = null;
    });

    // Cancel button
    cancelBtn.addEventListener('click', () => {
        closeFindReplace();
        overlay.classList.remove('open');
        currentEditingTool = null;
    });

    // Save button
    saveBtn.addEventListener('click', () => {
        if (currentEditingTool) {
            const toolId = currentEditingTool;
            toolCustomizations[toolId] = toolCustomizations[toolId] || {};
            toolCustomizations[toolId].customContent = textarea.value;
            toolCustomizations[toolId].plainText = plainTextCheckbox.checked;
            saveToolCustomizations(toolCustomizations);

            // Update the tool content
            const tool = document.querySelector(`[data-tool="${toolId}"]`);
            if (tool) {
                const contentDiv = tool.querySelector('.tool-content');
                contentDiv.innerHTML = renderToolContent(textarea.value, plainTextCheckbox.checked);

                // Auto-resize tool to fit new content
                requestAnimationFrame(() => {
                    autoFitToolContent(tool, false);
                });
            }
        }
        overlay.classList.remove('open');
        currentEditingTool = null;
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
        if (currentEditingTool && confirm('Reset to default content? This will remove your custom content.')) {
            const toolId = currentEditingTool;
            if (toolCustomizations[toolId]) {
                delete toolCustomizations[toolId].customContent;
                saveToolCustomizations(toolCustomizations);
            }

            // Restore default content
            const tool = document.querySelector(`[data-tool="${toolId}"]`);
            if (tool) {
                const content = getToolContent(toolId);
                const contentDiv = tool.querySelector('.tool-content');
                contentDiv.innerHTML = content.html;
            }

            overlay.classList.remove('open');
            currentEditingTool = null;
        }
    });

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.classList.remove('open');
            currentEditingTool = null;
        }
    });

    // Helper to get coords from mouse or touch event (local to this scope)
    function getCoords(e) {
        if (e.touches && e.touches.length > 0) {
            return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
        }
        if (e.changedTouches && e.changedTouches.length > 0) {
            return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
        }
        return { clientX: e.clientX, clientY: e.clientY };
    }

    // Editor dragging
    let editorDrag = { isDragging: false, startX: 0, startY: 0, startLeft: 0, startTop: 0 };

    function startEditorDrag(e) {
        if (e.target.closest('.content-editor-close')) return;
        const coords = getCoords(e);
        editorDrag.isDragging = true;
        editorDrag.startX = coords.clientX;
        editorDrag.startY = coords.clientY;
        const rect = editor.getBoundingClientRect();
        editorDrag.startLeft = rect.left;
        editorDrag.startTop = rect.top;
        e.preventDefault();
    }

    header.addEventListener('mousedown', startEditorDrag);
    header.addEventListener('touchstart', startEditorDrag, { passive: false });

    function moveEditorDrag(e) {
        if (!editorDrag.isDragging) return;
        const coords = getCoords(e);
        const dx = coords.clientX - editorDrag.startX;
        const dy = coords.clientY - editorDrag.startY;
        const newLeft = Math.max(0, Math.min(window.innerWidth - editor.offsetWidth, editorDrag.startLeft + dx));
        const newTop = Math.max(0, Math.min(window.innerHeight - editor.offsetHeight, editorDrag.startTop + dy));
        editor.style.left = newLeft + 'px';
        editor.style.top = newTop + 'px';
    }

    document.addEventListener('mousemove', moveEditorDrag);
    document.addEventListener('touchmove', moveEditorDrag, { passive: false });

    function endEditorDrag() {
        editorDrag.isDragging = false;
    }

    document.addEventListener('mouseup', endEditorDrag);
    document.addEventListener('touchend', endEditorDrag);
    document.addEventListener('touchcancel', endEditorDrag);

    // Resizer for markdown/preview split
    let resizerState = { isResizing: false, startX: 0, startY: 0, startInputWidth: 0, startInputHeight: 0 };

    function startResizerDrag(e) {
        const coords = getCoords(e);
        resizerState.isResizing = true;
        resizerState.startX = coords.clientX;
        resizerState.startY = coords.clientY;
        resizerState.startInputWidth = inputPane.offsetWidth;
        resizerState.startInputHeight = inputPane.offsetHeight;
        resizer.classList.add('active');
        e.preventDefault();
    }

    resizer.addEventListener('mousedown', startResizerDrag);
    resizer.addEventListener('touchstart', startResizerDrag, { passive: false });

    function moveResizerDrag(e) {
        if (!resizerState.isResizing) return;
        const coords = getCoords(e);
        const editorBody = overlay.querySelector('.content-editor-body');

        // Check if we're in mobile vertical layout
        const isMobileLayout = window.innerWidth <= 768;

        if (isMobileLayout) {
            // Vertical resizing on mobile
            const dy = coords.clientY - resizerState.startY;
            const totalHeight = editorBody.offsetHeight - resizer.offsetHeight;
            const newInputHeight = Math.max(100, Math.min(totalHeight - 100, resizerState.startInputHeight + dy));
            const newPreviewHeight = totalHeight - newInputHeight;
            inputPane.style.flex = 'none';
            inputPane.style.height = newInputHeight + 'px';
            previewPane.style.flex = 'none';
            previewPane.style.height = newPreviewHeight + 'px';
        } else {
            // Horizontal resizing on desktop
            const dx = coords.clientX - resizerState.startX;
            const totalWidth = editorBody.offsetWidth - resizer.offsetWidth;
            const newInputWidth = Math.max(200, Math.min(totalWidth - 200, resizerState.startInputWidth + dx));
            const newPreviewWidth = totalWidth - newInputWidth;
            inputPane.style.flex = 'none';
            inputPane.style.width = newInputWidth + 'px';
            previewPane.style.flex = 'none';
            previewPane.style.width = newPreviewWidth + 'px';
        }
    }

    document.addEventListener('mousemove', moveResizerDrag);
    document.addEventListener('touchmove', moveResizerDrag, { passive: false });

    function endResizerDrag() {
        if (resizerState.isResizing) {
            resizerState.isResizing = false;
            resizer.classList.remove('active');
        }
    }

    document.addEventListener('mouseup', endResizerDrag);
    document.addEventListener('touchend', endResizerDrag);
    document.addEventListener('touchcancel', endResizerDrag);

    // Editor window resize
    let editorResize = { isResizing: false, handle: null, startX: 0, startY: 0, startWidth: 0, startHeight: 0 };

    editor.querySelectorAll('.content-editor-resize').forEach(handle => {
        function startEditorResize(e) {
            const coords = getCoords(e);
            editorResize.isResizing = true;
            editorResize.handle = handle.getAttribute('data-resize');
            editorResize.startX = coords.clientX;
            editorResize.startY = coords.clientY;
            editorResize.startWidth = editor.offsetWidth;
            editorResize.startHeight = editor.offsetHeight;
            e.preventDefault();
        }

        handle.addEventListener('mousedown', startEditorResize);
        handle.addEventListener('touchstart', startEditorResize, { passive: false });
    });

    function moveEditorResize(e) {
        if (!editorResize.isResizing) return;
        const coords = getCoords(e);
        const dx = coords.clientX - editorResize.startX;
        const dy = coords.clientY - editorResize.startY;

        if (editorResize.handle.includes('e')) {
            const newWidth = Math.max(500, editorResize.startWidth + dx);
            editor.style.width = newWidth + 'px';
        }
        if (editorResize.handle.includes('s')) {
            const newHeight = Math.max(300, editorResize.startHeight + dy);
            editor.style.height = newHeight + 'px';
        }
    }

    document.addEventListener('mousemove', moveEditorResize);
    document.addEventListener('touchmove', moveEditorResize, { passive: false });

    function endEditorResize() {
        editorResize.isResizing = false;
        editorResize.handle = null;
    }

    document.addEventListener('mouseup', endEditorResize);
    document.addEventListener('touchend', endEditorResize);
    document.addEventListener('touchcancel', endEditorResize);

    // Double-click on tool content to edit
    const toolboard = document.getElementById('toolboard');
    toolboard.addEventListener('dblclick', (e) => {
        // Don't trigger on interactive elements
        if (e.target.closest('input, button, select, textarea, a, .checklist-widget, .calendar-widget, .diff-widget, .seq-widget')) return;

        const toolContent = e.target.closest('.tool-content');
        if (!toolContent) return;

        const tool = toolContent.closest('.tool');
        if (!tool) return;

        const toolId = tool.getAttribute('data-tool');
        if (toolId) {
            e.preventDefault();
            openContentEditor(toolId);
        }
    });
}

function openContentEditor(toolId) {
    const overlay = document.getElementById('contentEditorOverlay');
    const editor = overlay.querySelector('.content-editor');
    const textarea = document.getElementById('contentEditorTextarea');
    const preview = document.getElementById('contentEditorPreview');
    const titleSpan = document.getElementById('editorToolTitle');
    const inputPane = overlay.querySelector('.content-editor-input');
    const previewPane = overlay.querySelector('.content-editor-preview');

    currentEditingTool = toolId;

    // Reset find/replace bar
    document.getElementById('editorFindReplace').style.display = 'none';
    document.getElementById('editorReplaceRow').style.display = 'none';
    document.getElementById('editorFindToggleReplace').innerHTML = '&#9654;';
    document.getElementById('editorFindInput').value = '';
    document.getElementById('editorReplaceInput').value = '';
    document.getElementById('editorFindInfo').textContent = 'No results';

    // Get tool info
    const custom = toolCustomizations[toolId] || {};
    const content = getToolContent(toolId);
    const displayTitle = custom.title || content.title;

    titleSpan.textContent = displayTitle;

    // Load plain text toggle state
    const plainTextCheckbox = document.getElementById('editorPlainTextCheckbox');
    plainTextCheckbox.checked = !!custom.plainText;

    // Load existing custom content or convert default to markdown hint
    if (custom.customContent) {
        textarea.value = custom.customContent;
    } else {
        // Provide a hint with the tool name
        textarea.value = `# ${content.title}\n\nEdit this content using Markdown.\n\n**Note:** The default content will be replaced with your custom content.`;
    }

    // Reset pane widths to default 50/50
    inputPane.style.flex = '1';
    inputPane.style.width = '';
    previewPane.style.flex = '1';
    previewPane.style.width = '';

    // Center the editor
    editor.style.left = '';
    editor.style.top = '';

    preview.innerHTML = renderToolContent(textarea.value, plainTextCheckbox.checked);
    overlay.classList.add('open');

    // Center after opening (when dimensions are known)
    requestAnimationFrame(() => {
        const editorRect = editor.getBoundingClientRect();
        editor.style.left = (window.innerWidth - editorRect.width) / 2 + 'px';
        editor.style.top = (window.innerHeight - editorRect.height) / 2 + 'px';
    });

    textarea.focus();
}

// Toolboard settings
const DASHBOARD_COLORS = [
    '#2c3e50', '#34495e', '#1a252f', '#2980b9', '#3498db',
    '#8e44ad', '#9b59b6', '#16a085', '#1abc9c', '#27ae60',
    '#d35400', '#e67e22', '#c0392b', '#e74c3c', '#7f8c8d'
];

function loadToolboardSettings() {
    const defaults = { title: 'My Toolboard', color: '#2c3e50', fontFamily: '', fontSize: '' };
    const stored = localStorage.getItem(boardKey('toolboardSettings'));
    if (stored) {
        try {
            return { ...defaults, ...JSON.parse(stored) };
        } catch (e) {
            return defaults;
        }
    }
    return defaults;
}

function saveToolboardSettings(settings) {
    localStorage.setItem(boardKey('toolboardSettings'), JSON.stringify(settings));
    updateStorageIndicator();
}

let toolboardSettings = loadToolboardSettings();

function applyToolboardSettings() {
    const header = document.getElementById('mainHeader');
    const title = document.getElementById('toolboardTitle');
    const titleInput = document.getElementById('toolboardTitleInput');
    const colorPicker = document.getElementById('toolboardColorPicker');
    const fontFamilySelect = document.getElementById('toolboardFontFamily');
    const fontSizeSelect = document.getElementById('toolboardFontSize');
    const toolboard = document.getElementById('toolboard');

    title.textContent = toolboardSettings.title;
    header.style.background = toolboardSettings.color;
    titleInput.value = toolboardSettings.title;

    // Update boards array and trigger label
    const board = boards.find(b => b.id === currentBoardId);
    if (board) board.name = toolboardSettings.title;
    updateBoardSelectorLabel();

    // Update browser tab title
    document.title = toolboardSettings.title + ' - Toolboard';

    // Populate color picker
    colorPicker.innerHTML = DASHBOARD_COLORS.map(c =>
        `<div class="color-swatch${toolboardSettings.color === c ? ' selected' : ''}" style="background: ${c}" data-color="${c}"></div>`
    ).join('');

    // Apply font settings
    if (fontFamilySelect) fontFamilySelect.value = toolboardSettings.fontFamily || '';
    if (fontSizeSelect) fontSizeSelect.value = toolboardSettings.fontSize || '';

    // Apply board-level fonts to toolboard
    if (toolboardSettings.fontFamily) {
        toolboard.style.fontFamily = toolboardSettings.fontFamily;
    } else {
        toolboard.style.fontFamily = '';
    }
    if (toolboardSettings.fontSize) {
        toolboard.style.fontSize = toolboardSettings.fontSize;
    } else {
        toolboard.style.fontSize = '';
    }

    // Re-apply tool-specific fonts (they override board settings)
    applyAllToolFonts();
}

function applyAllToolFonts() {
    document.querySelectorAll('.tool').forEach(tool => {
        const toolId = tool.getAttribute('data-tool');
        const custom = toolCustomizations[toolId] || {};
        const content = tool.querySelector('.tool-content');
        if (content) {
            if (custom.fontFamily) {
                content.style.fontFamily = custom.fontFamily;
            } else {
                content.style.fontFamily = '';
            }
            if (custom.fontSize) {
                content.style.fontSize = custom.fontSize;
            } else {
                content.style.fontSize = '';
            }
        }
    });
}

function applyToolFont(toolId) {
    const tool = document.querySelector(`.tool[data-tool="${toolId}"]`);
    if (!tool) return;
    const custom = toolCustomizations[toolId] || {};
    const content = tool.querySelector('.tool-content');
    if (content) {
        if (custom.fontFamily) {
            content.style.fontFamily = custom.fontFamily;
        } else {
            content.style.fontFamily = '';
        }
        if (custom.fontSize) {
            content.style.fontSize = custom.fontSize;
        } else {
            content.style.fontSize = '';
        }
    }
}

function setupToolboardSettings() {
    const settingsBtn = document.getElementById('toolboardSettingsBtn');
    const settingsPanel = document.getElementById('toolboardSettings');
    const titleInput = document.getElementById('toolboardTitleInput');
    const colorPicker = document.getElementById('toolboardColorPicker');
    const fontFamilySelect = document.getElementById('toolboardFontFamily');
    const fontSizeSelect = document.getElementById('toolboardFontSize');
    const header = document.getElementById('mainHeader');
    const title = document.getElementById('toolboardTitle');
    const toolboard = document.getElementById('toolboard');

    // Toggle settings panel
    settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close tool settings modal
        document.getElementById('toolSettingsOverlay').classList.remove('open');
        settingsPanel.classList.toggle('open');
    });

    // Title input
    titleInput.addEventListener('input', (e) => {
        toolboardSettings.title = e.target.value;
        title.textContent = e.target.value;
        saveToolboardSettings(toolboardSettings);
        // Update board name to match toolboard title
        renameBoardInSelector();
    });

    // Color picker
    colorPicker.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch')) {
            const color = e.target.getAttribute('data-color');
            toolboardSettings.color = color;
            header.style.background = color;
            colorPicker.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            e.target.classList.add('selected');
            saveToolboardSettings(toolboardSettings);
        }
    });

    // Font family select
    fontFamilySelect.addEventListener('change', (e) => {
        toolboardSettings.fontFamily = e.target.value;
        if (e.target.value) {
            toolboard.style.fontFamily = e.target.value;
        } else {
            toolboard.style.fontFamily = '';
        }
        saveToolboardSettings(toolboardSettings);
        applyAllToolFonts(); // Re-apply tool overrides
    });

    // Font size select
    fontSizeSelect.addEventListener('change', (e) => {
        toolboardSettings.fontSize = e.target.value;
        if (e.target.value) {
            toolboard.style.fontSize = e.target.value;
        } else {
            toolboard.style.fontSize = '';
        }
        saveToolboardSettings(toolboardSettings);
        applyAllToolFonts(); // Re-apply tool overrides
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.toolboard-settings') && !e.target.closest('#toolboardSettingsBtn')) {
            settingsPanel.classList.remove('open');
        }
    });
}

// Available colors for tool headers
const HEADER_COLORS = [
    '#8e44ad', '#9b59b6', '#3498db', '#2980b9', '#1abc9c',
    '#16a085', '#27ae60', '#2ecc71', '#f39c12', '#e67e22',
    '#d35400', '#e74c3c', '#c0392b', '#34495e', '#7f8c8d'
];

// Load tool customizations
function loadToolCustomizations() {
    const stored = localStorage.getItem(boardKey('toolCustomizations'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return {};
        }
    }
    return {};
}

// Save tool customizations
function saveToolCustomizations(customizations) {
    localStorage.setItem(boardKey('toolCustomizations'), JSON.stringify(customizations));
    updateStorageIndicator();
}

// Custom tools storage
function loadCustomTools() {
    const stored = localStorage.getItem(boardKey('customTools'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return [];
        }
    }
    return [];
}

function saveCustomTools(tools) {
    localStorage.setItem(boardKey('customTools'), JSON.stringify(tools));
    updateStorageIndicator();
}

// Hidden tools storage (for built-in tools that have been deleted)
function loadHiddenTools() {
    const stored = localStorage.getItem(boardKey('hiddenTools'));
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch (e) {
            return [];
        }
    }
    return [];
}

function saveHiddenTools(tools) {
    localStorage.setItem(boardKey('hiddenTools'), JSON.stringify(tools));
    updateStorageIndicator();
}

let toolCustomizations = loadToolCustomizations();
let customTools = loadCustomTools();
let hiddenTools = loadHiddenTools();

// Create a tool element
function createTool(toolId) {
    const tool = document.createElement('div');
    tool.className = 'tool';
    tool.setAttribute('data-tool', toolId);

    const content = getToolContent(toolId);
    if (!content) return null;

    // Get customizations for this tool
    const custom = toolCustomizations[toolId] || {};
    const displayTitle = custom.title || content.title;
    const headerColor = custom.color || null;
    const isMinimized = custom.minimized || false;
    const isCustomTool = customTools.includes(toolId);

    tool.innerHTML = `
        <div class="tool-header"${headerColor ? ` style="background: ${headerColor}"` : ''}>
            <span class="tool-title">${displayTitle}</span>
            <div class="header-buttons">
                <button class="header-btn minimize-btn${isMinimized ? ' minimized' : ''}" title="Minimize">&#8211;</button>
                <button class="header-btn fullscreen-btn" title="Fullscreen"><svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="0" y="0" width="12" height="12" rx="1" stroke="currentColor" stroke-width="4" fill="none"/></svg></button>
                <button class="header-btn settings-btn" title="Settings">&#8942;</button>
                <button class="header-btn delete-btn" title="Delete">&times;</button>
            </div>
        </div>
        <div class="tool-content">
            ${custom.customContent ? renderToolContent(custom.customContent, custom.plainText) : content.html}
        </div>
        <div class="resize-handle resize-handle-n" data-resize="n"></div>
        <div class="resize-handle resize-handle-s" data-resize="s"></div>
        <div class="resize-handle resize-handle-e" data-resize="e"></div>
        <div class="resize-handle resize-handle-w" data-resize="w"></div>
        <div class="resize-handle resize-handle-nw" data-resize="nw"></div>
        <div class="resize-handle resize-handle-ne" data-resize="ne"></div>
        <div class="resize-handle resize-handle-sw" data-resize="sw"></div>
        <div class="resize-handle resize-handle-se" data-resize="se"></div>
    `;

    // Apply minimized state
    if (isMinimized) {
        tool.classList.add('minimized');
    }

    // Apply position and size
    const pos = positions[toolId] || { x: 20, y: 20, z: 1 };
    tool.style.left = pos.x + 'px';
    tool.style.top = pos.y + 'px';
    tool.style.zIndex = pos.z || 1;

    // Apply saved dimensions if they exist
    if (pos.width) {
        tool.style.width = pos.width + 'px';
    }
    if (pos.height) {
        tool.style.height = pos.height + 'px';
    }

    // Apply tool-specific fonts
    const toolContent = tool.querySelector('.tool-content');
    if (toolContent) {
        if (custom.fontFamily) {
            toolContent.style.fontFamily = custom.fontFamily;
        }
        if (custom.fontSize) {
            toolContent.style.fontSize = custom.fontSize;
        }
    }

    return tool;
}

function renderToolContent(text, plainText) {
    if (plainText) {
        return `<pre style="white-space:pre-wrap;word-wrap:break-word;margin:0;font-family:inherit;font-size:inherit;">${escapeHtml(text)}</pre>`;
    }
    return `<div class="markdown-content">${parseMarkdown(text)}</div>`;
}

// Get content for each tool
function getToolContent(toolId) {
    // All tools are custom tools in the generic toolboard
    if (customTools.includes(toolId)) {
        const custom = toolCustomizations[toolId] || {};

        // Check if this tool uses a template with HTML content
        if (custom.templateId && (NOTE_TEMPLATES[custom.templateId] || PluginRegistry.getTool(custom.templateId))) {
            const template = NOTE_TEMPLATES[custom.templateId] || PluginRegistry.getTool(custom.templateId);
            const isHtml = template.content.trim().startsWith('<');
            if (isHtml) {
                return {
                    title: custom.title || template.title,
                    html: template.content
                };
            }
        }

        return {
            title: custom.title || 'New Tool',
            html: custom.customContent ? renderToolContent(custom.customContent, custom.plainText) : '<p>Click the settings gear and "Edit Content" to add content to this tool.</p>'
        };
    }
    return null;
}

// Helper to get coordinates from mouse or touch event
function getEventCoords(e) {
    if (e.touches && e.touches.length > 0) {
        return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
    }
    if (e.changedTouches && e.changedTouches.length > 0) {
        return { clientX: e.changedTouches[0].clientX, clientY: e.changedTouches[0].clientY };
    }
    return { clientX: e.clientX, clientY: e.clientY };
}

// Free-form Drag functionality
function setupDragging() {
    const toolboard = document.getElementById('toolboard');

    // Start drag handler (mouse and touch)
    function startDrag(e) {
        // Don't drag in mobile layout
        if (document.getElementById('toolboard').classList.contains('mobile-layout')) return;

        const header = e.target.closest('.tool-header');
        if (!header) return;

        // Don't drag if clicking buttons
        if (e.target.closest('.header-btn')) return;

        const tool = header.closest('.tool');
        if (!tool) return;

        e.preventDefault();

        const coords = getEventCoords(e);

        // Bring to front
        maxZ++;
        tool.style.zIndex = maxZ;

        const toolId = tool.getAttribute('data-tool');
        positions[toolId] = positions[toolId] || { x: 0, y: 0, z: 1 };
        positions[toolId].z = maxZ;

        // Start dragging
        dragState.isDragging = true;
        dragState.tool = tool;
        dragState.startX = coords.clientX;
        dragState.startY = coords.clientY;
        dragState.offsetX = tool.offsetLeft;
        dragState.offsetY = tool.offsetTop;

        tool.classList.add('dragging');
        document.body.classList.add('is-dragging');
    }

    // Mouse/touch down on tool header starts drag
    toolboard.addEventListener('mousedown', startDrag);
    toolboard.addEventListener('touchstart', startDrag, { passive: false });

    // Move handler (mouse and touch)
    function moveDrag(e) {
        if (!dragState.isDragging) return;

        const coords = getEventCoords(e);
        const dx = coords.clientX - dragState.startX;
        const dy = coords.clientY - dragState.startY;

        let newX = Math.max(0, dragState.offsetX + dx);
        let newY = Math.max(0, dragState.offsetY + dy);

        // Get snap positions
        const snapped = getSnapPosition(dragState.tool, newX, newY);
        newX = snapped.x;
        newY = snapped.y;

        dragState.tool.style.left = newX + 'px';
        dragState.tool.style.top = newY + 'px';

        // Show/hide snap guides
        updateSnapGuides(snapped.guides);
    }

    // Mouse/touch move updates position with snapping
    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchmove', moveDrag, { passive: false });

    // End drag handler (mouse and touch)
    function endDrag() {
        if (!dragState.isDragging) return;

        const tool = dragState.tool;
        const toolId = tool.getAttribute('data-tool');

        // Save position (preserve existing width/height if set)
        const existing = positions[toolId] || {};
        positions[toolId] = {
            x: tool.offsetLeft,
            y: tool.offsetTop,
            z: parseInt(tool.style.zIndex) || 1,
            width: existing.width || tool.offsetWidth,
            height: existing.height || tool.offsetHeight
        };
        savePositions(positions);

        tool.classList.remove('dragging');
        document.body.classList.remove('is-dragging');
        dragState.isDragging = false;
        dragState.tool= null;

        // Hide snap guides
        updateSnapGuides([]);
    }

    // Mouse/touch up ends drag and saves position
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
    document.addEventListener('touchcancel', endDrag);

    // Click on tool brings it to front
    toolboard.addEventListener('mousedown', (e) => {
        const tool = e.target.closest('.tool');
        if (!tool) return;

        // Only bring to front if not clicking header (header handles its own)
        if (!e.target.closest('.tool-header')) {
            maxZ++;
            tool.style.zIndex = maxZ;
            const toolId = tool.getAttribute('data-tool');
            positions[toolId] = positions[toolId] || { x: tool.offsetLeft, y: tool.offsetTop, z: 1 };
            positions[toolId].z = maxZ;
            savePositions(positions);
        }
    });
}

// Resize functionality
function setupResizing() {
    const toolboard = document.getElementById('toolboard');

    // Double-click/double-tap on resize handle for auto-resize
    toolboard.addEventListener('dblclick', (e) => {
        const handle = e.target.closest('.resize-handle');
        if (!handle) return;

        const tool = handle.closest('.tool');
        if (!tool) return;

        e.preventDefault();
        e.stopPropagation();

        const handleType = handle.getAttribute('data-resize');
        autoResizeTool(tool, handleType);
    });

    // Start resize handler (mouse and touch)
    function startResize(e) {
        if (document.getElementById('toolboard').classList.contains('mobile-layout')) return;

        const handle = e.target.closest('.resize-handle');
        if (!handle) return;

        const tool = handle.closest('.tool');
        if (!tool) return;

        e.preventDefault();
        e.stopPropagation();

        const coords = getEventCoords(e);

        // Bring to front
        maxZ++;
        tool.style.zIndex = maxZ;

        const toolId = tool.getAttribute('data-tool');
        positions[toolId] = positions[toolId] || { x: 0, y: 0, z: 1 };
        positions[toolId].z = maxZ;

        // Start resizing
        resizeState.isResizing = true;
        resizeState.tool = tool;
        resizeState.handle = handle.getAttribute('data-resize');
        resizeState.startX = coords.clientX;
        resizeState.startY = coords.clientY;
        resizeState.startWidth = tool.offsetWidth;
        resizeState.startHeight = tool.offsetHeight;
        resizeState.startLeft = tool.offsetLeft;
        resizeState.startTop = tool.offsetTop;

        handle.classList.add('active');
        tool.classList.add('resizing');
        document.body.classList.add('is-resizing');
    }

    // Mouse/touch down on resize handle starts resize
    toolboard.addEventListener('mousedown', startResize);
    toolboard.addEventListener('touchstart', startResize, { passive: false });

    // Move resize handler (mouse and touch)
    function moveResize(e) {
        if (!resizeState.isResizing) return;

        const coords = getEventCoords(e);
        const dx = coords.clientX - resizeState.startX;
        const dy = coords.clientY - resizeState.startY;
        const tool = resizeState.tool;
        const handle = resizeState.handle;

        let newWidth = resizeState.startWidth;
        let newHeight = resizeState.startHeight;
        let newLeft = resizeState.startLeft;
        let newTop = resizeState.startTop;

        const minWidth = 150;
        const minHeight = 100;

        // Handle resize based on which handle is being dragged
        if (handle.includes('e')) {
            newWidth = Math.max(minWidth, resizeState.startWidth + dx);
        }
        if (handle.includes('w')) {
            const proposedWidth = resizeState.startWidth - dx;
            if (proposedWidth >= minWidth) {
                newWidth = proposedWidth;
                newLeft = resizeState.startLeft + dx;
            }
        }
        if (handle.includes('s')) {
            newHeight = Math.max(minHeight, resizeState.startHeight + dy);
        }
        if (handle.includes('n')) {
            const proposedHeight = resizeState.startHeight - dy;
            if (proposedHeight >= minHeight) {
                newHeight = proposedHeight;
                newTop = resizeState.startTop + dy;
            }
        }

        // Apply snapping for resize edges
        const snapped = getResizeSnapPosition(tool, newLeft, newTop, newWidth, newHeight, handle);

        tool.style.width = snapped.width + 'px';
        tool.style.height = snapped.height + 'px';
        tool.style.left = snapped.left + 'px';
        tool.style.top = snapped.top + 'px';

        updateSnapGuides(snapped.guides);
    }

    // Mouse/touch move updates size
    document.addEventListener('mousemove', moveResize);
    document.addEventListener('touchmove', moveResize, { passive: false });

    // End resize handler (mouse and touch)
    function endResize() {
        if (!resizeState.isResizing) return;

        const tool = resizeState.tool;
        const toolId = tool.getAttribute('data-tool');

        // Save position and dimensions
        positions[toolId] = {
            x: tool.offsetLeft,
            y: tool.offsetTop,
            z: parseInt(tool.style.zIndex) || 1,
            width: tool.offsetWidth,
            height: tool.offsetHeight
        };
        savePositions(positions);

        // Clean up
        document.querySelectorAll('.resize-handle.active').forEach(h => h.classList.remove('active'));
        tool.classList.remove('resizing');
        document.body.classList.remove('is-resizing');
        resizeState.isResizing = false;
        resizeState.tool= null;
        resizeState.handle = null;

        updateSnapGuides([]);
    }

    // Mouse/touch up ends resize and saves dimensions
    document.addEventListener('mouseup', endResize);
    document.addEventListener('touchend', endResize);
    document.addEventListener('touchcancel', endResize);
}

// Auto-fit tool to its content (used on initial render)
function autoFitToolContent(tool, skipAnimation = false) {
    const toolId = tool.getAttribute('data-tool');
    const content = tool.querySelector('.tool-content');
    const header = tool.querySelector('.tool-header');

    if (!content || !header) return;

    // Temporarily remove constraints to measure natural size
    const originalWidth = tool.style.width;
    const originalHeight = tool.style.height;
    tool.style.width = 'auto';
    tool.style.height = 'auto';
    content.style.overflow = 'visible';

    // Force reflow
    tool.offsetHeight;

    // Measure natural dimensions with reasonable bounds
    const newWidth = Math.max(200, Math.min(600, content.scrollWidth + 30));
    const newHeight = Math.max(120, Math.min(500, content.scrollHeight + header.offsetHeight + 20));

    // Restore overflow
    content.style.overflow = '';

    // Apply dimensions
    if (!skipAnimation) {
        tool.style.transition = 'width 0.2s ease, height 0.2s ease';
    }

    tool.style.width = newWidth + 'px';
    tool.style.height = newHeight + 'px';

    if (!skipAnimation) {
        setTimeout(() => {
            tool.style.transition = '';
        }, 200);
    }

    // Save dimensions
    const existing = positions[toolId] || { x: tool.offsetLeft, y: tool.offsetTop, z: 1 };
    positions[toolId] = {
        x: existing.x,
        y: existing.y,
        z: existing.z,
        width: newWidth,
        height: newHeight
    };
    savePositions(positions);
}

// Auto-resize tool to fit content
function autoResizeTool(tool, handleType) {
    const toolId = tool.getAttribute('data-tool');
    const content = tool.querySelector('.tool-content');
    const header = tool.querySelector('.tool-header');

    // Determine which dimensions to auto-resize
    const autoWidth = handleType.includes('e') || handleType.includes('w');
    const autoHeight = handleType.includes('s') || handleType.includes('n');

    // Store current dimensions
    const currentWidth = tool.style.width;
    const currentHeight = tool.style.height;

    // Temporarily remove constraints to measure natural size
    if (autoWidth) {
        tool.style.width = 'auto';
        content.style.overflow = 'visible';
    }
    if (autoHeight) {
        tool.style.height = 'auto';
        content.style.overflow = 'visible';
    }

    // Force reflow
    tool.offsetHeight;

    // Measure natural dimensions
    let newWidth = tool.offsetWidth;
    let newHeight = tool.offsetHeight;

    // Add some padding for comfortable viewing
    if (autoWidth) {
        newWidth = Math.max(150, Math.min(800, content.scrollWidth + 30));
    }
    if (autoHeight) {
        newHeight = Math.max(100, Math.min(600, content.scrollHeight + header.offsetHeight + 10));
    }

    // Restore overflow
    content.style.overflow = '';

    // Apply new dimensions with animation
    tool.style.transition = 'width 0.2s ease, height 0.2s ease';

    if (autoWidth) {
        tool.style.width = newWidth + 'px';
    } else {
        tool.style.width = currentWidth;
    }

    if (autoHeight) {
        tool.style.height = newHeight + 'px';
    } else {
        tool.style.height = currentHeight;
    }

    // Remove transition after animation
    setTimeout(() => {
        tool.style.transition = '';
    }, 200);

    // Save new dimensions
    const existing = positions[toolId] || { x: tool.offsetLeft, y: tool.offsetTop, z: 1 };
    positions[toolId] = {
        x: existing.x,
        y: existing.y,
        z: existing.z,
        width: autoWidth ? newWidth : (existing.width || tool.offsetWidth),
        height: autoHeight ? newHeight : (existing.height || tool.offsetHeight)
    };
    savePositions(positions);
}

// Snapping for resize operations
function getResizeSnapPosition(tool, left, top, width, height, handle) {
    const toolboard = document.getElementById('toolboard');
    const tools = toolboard.querySelectorAll('.tool');

    const right = left + width;
    const bottom = top + height;

    let snapLeft = left;
    let snapTop = top;
    let snapWidth = width;
    let snapHeight = height;
    const guides = [];

    // Collect edges from other tools
    const verticalEdges = [0];
    const horizontalEdges = [0];

    tools.forEach(s => {
        if (s === tool) return;

        const sLeft = s.offsetLeft;
        const sTop = s.offsetTop;
        const sRight = sLeft + s.offsetWidth;
        const sBottom = sTop + s.offsetHeight;

        verticalEdges.push(sLeft, sRight);
        horizontalEdges.push(sTop, sBottom);
    });

    // Snap right edge (when resizing east)
    if (handle.includes('e')) {
        for (const edge of verticalEdges) {
            if (Math.abs(right - edge) < SNAP_THRESHOLD) {
                snapWidth = edge - left;
                guides.push({ type: 'vertical', pos: edge });
                break;
            }
        }
    }

    // Snap left edge (when resizing west)
    if (handle.includes('w')) {
        for (const edge of verticalEdges) {
            if (Math.abs(left - edge) < SNAP_THRESHOLD) {
                const diff = left - edge;
                snapLeft = edge;
                snapWidth = width + diff;
                guides.push({ type: 'vertical', pos: edge });
                break;
            }
        }
    }

    // Snap bottom edge (when resizing south)
    if (handle.includes('s')) {
        for (const edge of horizontalEdges) {
            if (Math.abs(bottom - edge) < SNAP_THRESHOLD) {
                snapHeight = edge - top;
                guides.push({ type: 'horizontal', pos: edge });
                break;
            }
        }
    }

    // Snap top edge (when resizing north)
    if (handle.includes('n')) {
        for (const edge of horizontalEdges) {
            if (Math.abs(top - edge) < SNAP_THRESHOLD) {
                const diff = top - edge;
                snapTop = edge;
                snapHeight = height + diff;
                guides.push({ type: 'horizontal', pos: edge });
                break;
            }
        }
    }

    return {
        left: Math.max(0, snapLeft),
        top: Math.max(0, snapTop),
        width: Math.max(150, snapWidth),
        height: Math.max(100, snapHeight),
        guides
    };
}

// Snapping functionality
function getSnapPosition(draggedTool, x, y) {
    const toolboard = document.getElementById('toolboard');
    const tools = toolboard.querySelectorAll('.tool');
    const width = draggedTool.offsetWidth;
    const height = draggedTool.offsetHeight;

    // Dragged tool edges
    const dragLeft = x;
    const dragRight = x + width;
    const dragTop = y;
    const dragBottom = y + height;

    let snapX = x;
    let snapY = y;
    let bestDiffX = SNAP_THRESHOLD;
    let bestDiffY = SNAP_THRESHOLD;
    const guides = [];

    // Collect all edges from other tools
    const verticalEdges = [0]; // Toolboard left edge
    const horizontalEdges = [0]; // Toolboard top edge

    tools.forEach(t => {
        if (t === draggedTool) return;

        const left = t.offsetLeft;
        const top = t.offsetTop;
        const right = left + t.offsetWidth;
        const bottom = top + t.offsetHeight;

        verticalEdges.push(left, right);
        horizontalEdges.push(top, bottom);
    });

    // Find best vertical snap (X position)
    for (const edge of verticalEdges) {
        // Snap left edge of dragged to this edge
        const diffLeft = Math.abs(dragLeft - edge);
        if (diffLeft < bestDiffX) {
            bestDiffX = diffLeft;
            snapX = edge;
        }

        // Snap right edge of dragged to this edge
        const diffRight = Math.abs(dragRight - edge);
        if (diffRight < bestDiffX) {
            bestDiffX = diffRight;
            snapX = edge - width;
        }
    }

    // Find best horizontal snap (Y position)
    for (const edge of horizontalEdges) {
        // Snap top edge of dragged to this edge
        const diffTop = Math.abs(dragTop - edge);
        if (diffTop < bestDiffY) {
            bestDiffY = diffTop;
            snapY = edge;
        }

        // Snap bottom edge of dragged to this edge
        const diffBottom = Math.abs(dragBottom - edge);
        if (diffBottom < bestDiffY) {
            bestDiffY = diffBottom;
            snapY = edge - height;
        }
    }

    // Add guides for snapped edges
    if (bestDiffX < SNAP_THRESHOLD) {
        // Determine which edge we snapped to
        const snappedEdge = (snapX === x) ? snapX : snapX + width;
        guides.push({ type: 'vertical', pos: snappedEdge });
    }

    if (bestDiffY < SNAP_THRESHOLD) {
        const snappedEdge = (snapY === y) ? snapY : snapY + height;
        guides.push({ type: 'horizontal', pos: snappedEdge });
    }

    return { x: Math.max(0, snapX), y: Math.max(0, snapY), guides };
}

function updateSnapGuides(guides) {
    // Remove existing guides
    document.querySelectorAll('.snap-guide').forEach(el => el.remove());

    if (guides.length === 0) return;

    const toolboard = document.getElementById('toolboard');

    guides.forEach(guide => {
        const el = document.createElement('div');
        el.className = 'snap-guide';

        if (guide.type === 'vertical') {
            el.style.cssText = `
                position: absolute;
                left: ${guide.pos}px;
                top: 0;
                width: 2px;
                height: 100%;
                background: #3498db;
                pointer-events: none;
                z-index: 9999;
            `;
        } else {
            el.style.cssText = `
                position: absolute;
                left: 0;
                top: ${guide.pos}px;
                width: 100%;
                height: 2px;
                background: #3498db;
                pointer-events: none;
                z-index: 9999;
            `;
        }

        toolboard.appendChild(el);
    });
}

// Import/Export functionality
function setupImportExport() {
    const modal = document.getElementById('importExportModal');
    const closeBtn = modal.querySelector('.import-export-close');
    const tabs = modal.querySelectorAll('.import-export-tab');
    const exportTool = document.getElementById('exportTool');
    const importTool = document.getElementById('importTool');

    // Open modal
    document.getElementById('importExportBtn').onclick = () => {
        populateExportLists();
        modal.classList.add('open');
    };

    // Close modal
    closeBtn.onclick = () => modal.classList.remove('open');
    modal.onclick = (e) => {
        if (e.target === modal) modal.classList.remove('open');
    };

    // Tab switching
    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            exportTool.classList.remove('active');
            importTool.classList.remove('active');

            if (tab.dataset.tab === 'export') {
                exportTool.classList.add('active');
            } else if (tab.dataset.tab === 'import') {
                importTool.classList.add('active');
            }
        };
    });

    // Export buttons
    document.getElementById('exportSelectedTools').onclick = exportTools;
    document.getElementById('exportSelectedBoards').onclick = exportBoards;
    document.getElementById('exportBoardAsHTML').onclick = exportBoardAsHTML;
    document.getElementById('exportBoardAsPNG').onclick = exportBoardAsPNG;

    // Import
    document.getElementById('importDataBtn').onclick = importData;
    document.getElementById('importFileInput').onchange = handleFileImport;
}

// Feature Selection Modal
function setupFeatureSelect() {
    const modal = document.getElementById('featureSelectModal');
    const closeBtn = modal.querySelector('.feature-select-close');
    const list = document.getElementById('featureSelectList');
    const tabs = modal.querySelectorAll('.feature-tab');
    const searchInput = document.getElementById('featureSearchInput');
    const toolboxFilter = document.getElementById('featureToolboxFilter');

    // Close modal
    closeBtn.onclick = () => modal.classList.remove('open');
    modal.onclick = (e) => {
        if (e.target === modal) modal.classList.remove('open');
    };

    // Tab switching
    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            // Switch tab content
            document.querySelectorAll('.feature-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            const tabName = tab.dataset.tab;
            if (tabName === 'tools') {
                document.getElementById('featureToolsTab').classList.add('active');
            } else if (tabName === 'toolboxes') {
                document.getElementById('featureToolboxesTab').classList.add('active');
                populateToolboxesList();
            } else if (tabName === 'templates') {
                document.getElementById('featureTemplatesTab').classList.add('active');
                populateBoardTemplatesList();
            }
        };
    });

    // Populate toolbox filter dropdown
    populateToolboxFilter();

    // Populate list
    populateFeatureList();

    // Search and filter handlers
    searchInput.oninput = () => populateFeatureList();
    toolboxFilter.onchange = () => populateFeatureList();

    // Handle tool selection
    list.addEventListener('click', (e) => {
        const item = e.target.closest('.feature-select-item');
        if (!item) return;

        const templateId = item.getAttribute('data-template');
        modal.classList.remove('open');
        createNoteWithTemplate(templateId);
    });

    // Handle toolbox "Add All" button clicks
    document.getElementById('toolboxesList').addEventListener('click', (e) => {
        const btn = e.target.closest('.toolbox-add-all-btn');
        if (!btn) return;

        const toolboxId = btn.getAttribute('data-toolbox');
        addAllToolsFromToolbox(toolboxId);
        modal.classList.remove('open');
    });

    // Handle board template "Use Template" button clicks
    document.getElementById('boardTemplatesList').addEventListener('click', (e) => {
        const btn = e.target.closest('.board-template-use-btn');
        if (!btn) return;

        const boardId = btn.getAttribute('data-board');
        instantiateBoardTemplate(boardId);
        modal.classList.remove('open');
    });
}

function populateToolboxFilter() {
    const filter = document.getElementById('featureToolboxFilter');
    const toolboxes = PluginRegistry.getAllToolboxes();

    filter.innerHTML = '<option value="all">All Toolboxes</option>' +
        toolboxes.map(tb => `<option value="${tb.id}">${tb.icon} ${tb.name}</option>`).join('');
}

function populateFeatureList() {
    const list = document.getElementById('featureSelectList');
    const searchQuery = document.getElementById('featureSearchInput').value.toLowerCase();
    const toolboxFilter = document.getElementById('featureToolboxFilter').value;

    // Get all tools from registry
    let tools = PluginRegistry.getAllTools();

    // Apply search filter
    if (searchQuery) {
        tools = tools.filter(tool => {
            const nameMatch = tool.name.toLowerCase().includes(searchQuery);
            const descMatch = tool.description.toLowerCase().includes(searchQuery);
            const tagMatch = tool.tags.some(tag => tag.toLowerCase().includes(searchQuery));
            return nameMatch || descMatch || tagMatch;
        });
    }

    // Apply toolbox filter
    if (toolboxFilter !== 'all') {
        tools = tools.filter(tool => tool.toolbox === toolboxFilter);
    }

    if (tools.length === 0) {
        list.innerHTML = '<div class="feature-no-results">No tools found matching your search.</div>';
        return;
    }

    // Group by toolbox if no filter applied
    if (toolboxFilter === 'all' && !searchQuery) {
        const grouped = {};
        tools.forEach(tool => {
            const tbId = tool.toolbox || 'uncategorized';
            if (!grouped[tbId]) grouped[tbId] = [];
            grouped[tbId].push(tool);
        });

        let html = '';
        for (const [toolboxId, toolboxTools] of Object.entries(grouped)) {
            const toolbox = PluginRegistry.getToolbox(toolboxId);
            const tbName = toolbox ? toolbox.name : 'Other';
            const tbIcon = toolbox ? toolbox.icon : '📦';

            html += `
                <div class="toolbox-group">
                    <div class="toolbox-group-header">
                        <span class="toolbox-group-icon">${tbIcon}</span>
                        <span class="toolbox-group-name">${tbName}</span>
                        <span class="toolbox-group-count">${toolboxTools.length} tools</span>
                    </div>
                    <div class="feature-select-list">
                        ${toolboxTools.map(tool => createToolItemHtml(tool)).join('')}
                    </div>
                </div>
            `;
        }
        list.innerHTML = html;
    } else {
        // Flat list for filtered results
        list.innerHTML = tools.map(tool => createToolItemHtml(tool)).join('');
    }
}

function createToolItemHtml(tool) {
    return `
        <div class="feature-select-item" data-template="${tool.id}">
            <div class="feature-select-icon">${tool.icon}</div>
            <div class="feature-select-info">
                <div class="feature-select-name">${tool.name}</div>
                <div class="feature-select-description">${tool.description}</div>
            </div>
        </div>
    `;
}

function populateToolboxesList() {
    const list = document.getElementById('toolboxesList');
    const toolboxes = PluginRegistry.getAllToolboxes();

    if (toolboxes.length === 0) {
        list.innerHTML = '<div class="feature-no-results">No toolboxes available.</div>';
        return;
    }

    list.innerHTML = toolboxes.map(toolbox => {
        const tools = PluginRegistry.getToolsByToolbox(toolbox.id);
        const toolPreviews = tools.slice(0, 5).map(t => `<span class="toolbox-tool-preview">${t.icon} ${t.name}</span>`).join('');
        const moreCount = tools.length > 5 ? `<span class="toolbox-tool-preview">+${tools.length - 5} more</span>` : '';

        return `
            <div class="toolbox-card">
                <div class="toolbox-card-icon">${toolbox.icon}</div>
                <div class="toolbox-card-info">
                    <div class="toolbox-card-name">${toolbox.name}</div>
                    <div class="toolbox-card-description">${toolbox.description}</div>
                    <div class="toolbox-card-tools">${toolPreviews}${moreCount}</div>
                    <button class="toolbox-add-all-btn" data-toolbox="${toolbox.id}">Add All ${tools.length} Tools</button>
                </div>
            </div>
        `;
    }).join('');
}

function populateBoardTemplatesList() {
    const list = document.getElementById('boardTemplatesList');
    const boardTemplates = PluginRegistry.getAllBoards();

    if (boardTemplates.length === 0) {
        list.innerHTML = '<div class="feature-no-results">No board templates available. Add external plugins to get templates.</div>';
        return;
    }

    list.innerHTML = boardTemplates.map(board => {
        const toolPreviews = board.tools.slice(0, 4).map(t => {
            const tool = PluginRegistry.getTool(t.toolId);
            return tool ? `<span class="board-template-tool-preview">${tool.icon} ${tool.name}</span>` : '';
        }).join('');
        const moreCount = board.tools.length > 4 ? `<span class="board-template-tool-preview">+${board.tools.length - 4} more</span>` : '';

        return `
            <div class="board-template-card">
                <div class="board-template-icon">${board.icon}</div>
                <div class="board-template-info">
                    <div class="board-template-name">${board.name}</div>
                    <div class="board-template-description">${board.description}</div>
                    <div class="board-template-tools">${toolPreviews}${moreCount}</div>
                    <button class="board-template-use-btn" data-board="${board.id}">Use This Template</button>
                </div>
            </div>
        `;
    }).join('');
}

function addAllToolsFromToolbox(toolboxId) {
    const tools = PluginRegistry.getToolsByToolbox(toolboxId);
    tools.forEach(tool => {
        createNoteWithTemplate(tool.id);
    });
}

// Board Template System
function instantiateBoardTemplate(boardId) {
    const board = PluginRegistry.getBoard(boardId);
    if (!board) {
        console.error('Board template not found:', boardId);
        return;
    }

    // Create a new board with the template settings
    const newBoardId = 'board-' + Date.now();
    const boardName = board.settings.title || board.name;

    // Add board to list
    boards.push({
        id: newBoardId,
        name: boardName
    });
    saveBoards(boards);

    // Switch to new board
    currentBoardId = newBoardId;
    setCurrentBoardId(newBoardId);

    // Initialize empty state for the new board
    variables = {};
    positions = {};
    toolCustomizations = {};
    customTools = [];
    hiddenTools = [];
    toolboardSettings = {
        title: boardName,
        color: board.settings.color || null,
        fontFamily: board.settings.fontFamily || '',
        fontSize: board.settings.fontSize || ''
    };

    // Create tools from template
    board.tools.forEach(toolConfig => {
        const template = PluginRegistry.getTool(toolConfig.toolId);
        if (!template) {
            console.warn('Tool not found for template:', toolConfig.toolId);
            return;
        }

        const toolId = toolConfig.instanceId || ('custom-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5));

        // Add to custom tools
        customTools.push(toolId);

        // Set position from template
        if (toolConfig.position) {
            positions[toolId] = {
                x: toolConfig.position.x || 20,
                y: toolConfig.position.y || 20,
                z: toolConfig.position.z || 100,
                width: toolConfig.position.width || template.defaultWidth || undefined,
                height: toolConfig.position.height || template.defaultHeight || undefined
            };
        }

        // Set customizations
        const isHtml = template.content && template.content.trim().startsWith('<');
        const effectiveTemplateId = template.templateId || toolConfig.toolId;
        toolCustomizations[toolId] = {
            title: toolConfig.title || template.title,
            templateId: effectiveTemplateId,
            customContent: toolConfig.customContent || template.defaultContent || (isHtml ? '' : template.content),
            color: toolConfig.color || null,
            fontFamily: toolConfig.fontFamily || '',
            fontSize: toolConfig.fontSize || ''
        };
    });

    // Update maxZ
    maxZ = Math.max(...Object.values(positions).map(p => p.z || 1), 100);

    // Save all the data
    saveVariables(variables);
    savePositions(positions);
    saveToolCustomizations(toolCustomizations);
    saveCustomTools(customTools);
    saveHiddenTools(hiddenTools);
    saveToolboardSettings(toolboardSettings);

    // Refresh UI
    populateBoardSelector();
    applyToolboardSettings();
    renderToolboard();
}

// Plugin Settings UI
function setupPluginSettings() {
    // Plugin settings will be accessible via the toolboard settings panel
    // Add a "Manage Plugins" button
    const settingsPanel = document.getElementById('toolboardSettings');
    if (!settingsPanel) return;

    // Check if button already exists
    if (document.getElementById('managePluginsBtn')) return;

    const pluginBtn = document.createElement('button');
    pluginBtn.id = 'managePluginsBtn';
    pluginBtn.textContent = 'Manage Plugins';
    pluginBtn.className = 'plugin-manage-btn';
    pluginBtn.style.cssText = 'margin-top: 15px; padding: 8px 12px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;';
    pluginBtn.onclick = openPluginSettingsModal;
    settingsPanel.appendChild(pluginBtn);
}

const OFFICIAL_PLUGINS = [
    { category: 'Toolboxes', items: [
        { icon: '🛠️', name: 'Developer Tools', desc: 'JWT, Regex, Code Formatter, Cron, Epoch, Diff, Sequence Diagram', url: 'plugins/toolboxes/developer-tools.js' },
        { icon: '💰', name: 'Finance Tools', desc: 'Investment, Tax, Loan calculators', url: 'plugins/toolboxes/finance-tools.js' },
        { icon: '📋', name: 'Productivity Tools', desc: 'Pomodoro Timer and core productivity tools', url: 'plugins/toolboxes/productivity-tools.js' },
        { icon: '📦', name: 'Example Toolbox', desc: 'Sample toolbox plugin for reference', url: 'plugins/toolboxes/example-toolbox.js' },
    ]},
    { category: 'Tools', items: [
        { icon: '📱', name: 'QR Code Generator', desc: 'Generate QR codes from text, URLs, WiFi, and more', url: 'plugins/tools/qr-code-generator.js' },
        { icon: '🆔', name: 'UUID Generator', desc: 'Generate UUIDs v4 (random) and v7 (timestamp-sorted)', url: 'plugins/tools/uuid-generator.js' },
        { icon: '🎨', name: 'Color Picker', desc: 'Color wheel with alpha, hex/rgba/hsla values', url: 'plugins/tools/color-picker.js' },
        { icon: '🔡', name: 'Case Converter', desc: 'Convert between camelCase, snake_case, kebab-case, PascalCase, and more', url: 'plugins/tools/case-converter.js' },
        { icon: '⏩', name: 'Playback Speed Calculator', desc: 'Calculate duration and time saved at different playback speeds', url: 'plugins/tools/playback-speed-calculator.js' },
        { icon: '😎', name: 'Emoticon Picker', desc: 'Browse and copy emojis, kaomoji, and text emoticons', url: 'plugins/tools/emoticon-picker.js' },
        { icon: '🔌', name: 'Example Tool', desc: 'Sample tool plugin for reference', url: 'plugins/tools/example-tool.js' },
        { icon: '🌐', name: 'HTTP Request Builder', desc: 'HTTP request builder for testing API endpoints', url: 'plugins/tools/http-request-builder.js' },
    ]},
    { category: 'Board Templates', items: [
        { icon: '📖', name: 'Git Cheat Sheet', desc: 'Quick-reference cards for everyday git commands', url: 'plugins/boards/git-cheat-sheet.js' },
    ]},
];

function renderOfficialPlugins() {
    const container = document.getElementById('officialPluginsList');
    if (!container) return;
    container.innerHTML = OFFICIAL_PLUGINS.map(group =>
        `<div class="official-plugin-category">${group.category}</div>` +
        group.items.map(p =>
            `<div class="official-plugin-item">
                <span class="official-plugin-icon">${p.icon}</span>
                <div class="official-plugin-info">
                    <span class="official-plugin-name">${p.name}</span>
                    <span class="official-plugin-desc">${p.desc}</span>
                </div>
                <button class="official-plugin-add-btn" data-url="${p.url}">Add</button>
            </div>`
        ).join('')
    ).join('');
}

function openPluginSettingsModal() {
    // Create modal if it doesn't exist
    let modal = document.getElementById('pluginSettingsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'pluginSettingsModal';
        modal.className = 'plugin-settings-modal';
        modal.innerHTML = `
            <div class="plugin-settings-content">
                <span class="plugin-settings-close">&times;</span>
                <h2>Plugin Settings</h2>

                <div class="plugin-section">
                    <h3>Official Plugins</h3>
                    <div class="official-plugins-list" id="officialPluginsList"></div>
                </div>

                <div class="plugin-section">
                    <h3>Add External Plugin</h3>
                    <div class="plugin-add-row">
                        <input type="text" id="pluginUrlInput" class="plugin-url-input" placeholder="Enter plugin URL...">
                        <button id="addPluginBtn" class="plugin-add-btn">Add</button>
                    </div>
                    <p class="plugin-hint">Plugins can add new tools, toolboxes, and board templates.</p>
                </div>

                <div class="plugin-section">
                    <h3>Loaded Plugins</h3>
                    <div id="loadedPluginsList" class="loaded-plugins-list"></div>
                </div>

                <div class="plugin-section">
                    <h3>External Plugin URLs</h3>
                    <div id="pluginUrlsList" class="plugin-urls-list"></div>
                </div>

                <div class="plugin-actions">
                    <button id="reloadPluginsBtn" class="plugin-reload-btn">Reload All Plugins</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        renderOfficialPlugins();

        // Add styles
        const style = document.createElement('style');
        style.textContent = `
            .plugin-settings-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--overlay-bg);
                z-index: 10020;
                justify-content: center;
                align-items: center;
            }
            .plugin-settings-modal.open {
                display: flex;
            }
            .plugin-settings-content {
                background: var(--bg-secondary);
                border-radius: 8px;
                padding: 20px;
                width: 90%;
                max-width: 550px;
                max-height: 80vh;
                overflow-y: auto;
            }
            .plugin-settings-content h2 {
                margin-bottom: 20px;
                color: var(--text-heading);
            }
            .plugin-settings-close {
                float: right;
                font-size: 24px;
                cursor: pointer;
                color: var(--text-muted);
            }
            .plugin-settings-close:hover {
                color: var(--text-heading);
            }
            .plugin-section {
                margin-bottom: 25px;
            }
            .plugin-section h3 {
                font-size: 14px;
                color: var(--text-heading);
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px solid var(--border-light);
            }
            .plugin-add-row {
                display: flex;
                gap: 10px;
            }
            .plugin-url-input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 13px;
                background: var(--input-bg);
                color: var(--text-primary);
            }
            .plugin-add-btn {
                padding: 8px 16px;
                background: #27ae60;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .plugin-add-btn:hover {
                background: #219a52;
            }
            .plugin-hint {
                font-size: 11px;
                color: var(--text-muted);
                margin-top: 8px;
            }
            .loaded-plugins-list, .plugin-urls-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .plugin-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px;
                background: var(--bg-tertiary);
                border-radius: 4px;
                font-size: 12px;
            }
            .plugin-item-info {
                flex: 1;
                overflow: hidden;
            }
            .plugin-item-name {
                font-weight: 500;
                color: var(--text-primary);
            }
            .plugin-item-url {
                font-size: 11px;
                color: var(--text-muted);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .plugin-item-type {
                font-size: 10px;
                padding: 2px 6px;
                background: var(--bg-secondary);
                border-radius: 3px;
                margin-left: 8px;
            }
            .plugin-remove-btn {
                padding: 4px 8px;
                background: #e74c3c;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
                font-size: 11px;
            }
            .plugin-remove-btn:hover {
                background: #c0392b;
            }
            .plugin-actions {
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid var(--border-color);
            }
            .plugin-reload-btn {
                padding: 10px 20px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                width: 100%;
            }
            .plugin-reload-btn:hover {
                background: #2980b9;
            }
            .plugin-empty {
                color: var(--text-muted);
                font-style: italic;
                padding: 10px;
            }
            .official-plugins-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .official-plugin-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 12px;
                background: var(--bg-tertiary);
                border-radius: 6px;
                border: 1px solid var(--border-light);
            }
            .official-plugin-icon {
                font-size: 20px;
                flex-shrink: 0;
            }
            .official-plugin-info {
                flex: 1;
                min-width: 0;
            }
            .official-plugin-name {
                display: block;
                font-weight: 500;
                color: var(--text-primary);
                font-size: 13px;
            }
            .official-plugin-desc {
                display: block;
                font-size: 11px;
                color: var(--text-muted);
                margin-top: 2px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .official-plugin-add-btn {
                padding: 6px 14px;
                background: #27ae60;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                flex-shrink: 0;
            }
            .official-plugin-add-btn:hover {
                background: #219a52;
            }
            .official-plugin-add-btn.loaded {
                background: #7f8c8d;
                cursor: default;
            }
            .official-plugin-add-btn.loaded:hover {
                background: #7f8c8d;
            }
            .official-plugin-category {
                font-size: 10px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-muted);
                padding: 8px 4px 2px;
            }
            .official-plugin-category:first-child {
                padding-top: 0;
            }
        `;
        document.head.appendChild(style);

        // Set up event handlers
        modal.querySelector('.plugin-settings-close').onclick = () => modal.classList.remove('open');
        modal.onclick = (e) => {
            if (e.target === modal) modal.classList.remove('open');
        };

        document.getElementById('addPluginBtn').onclick = async () => {
            const input = document.getElementById('pluginUrlInput');
            const url = input.value.trim();
            if (!url) return;

            if (PluginLoader.addPluginUrl(url)) {
                try {
                    await PluginLoader.loadFromUrl(url);
                    input.value = '';
                    refreshPluginLists();
                    populateToolboxFilter();
                    populateFeatureList();
                } catch (e) {
                    alert('Failed to load plugin: ' + e.error);
                }
            } else {
                alert('Plugin URL already added.');
            }
        };

        document.getElementById('reloadPluginsBtn').onclick = async () => {
            // Clear loaded state and reload
            PluginLoader.loadedUrls.clear();
            await PluginLoader.loadAllExternal();
            refreshPluginLists();
            populateToolboxFilter();
            populateFeatureList();
            alert('Plugins reloaded.');
        };

        // Set up official plugin button handlers
        modal.querySelectorAll('.official-plugin-add-btn').forEach(btn => {
            btn.onclick = async () => {
                if (btn.classList.contains('loaded')) return;
                const url = btn.dataset.url;
                if (PluginLoader.addPluginUrl(url)) {
                    try {
                        await PluginLoader.loadFromUrl(url);
                        refreshPluginLists();
                        populateToolboxFilter();
                        populateFeatureList();
                    } catch (e) {
                        alert('Failed to load plugin: ' + e.message);
                    }
                }
                updateOfficialPluginButtons();
            };
        });
    }

    updateOfficialPluginButtons();
    refreshPluginLists();
    modal.classList.add('open');
}

function updateOfficialPluginButtons() {
    const loadedUrls = PluginLoader.getLoadedUrls();
    document.querySelectorAll('.official-plugin-add-btn').forEach(btn => {
        const url = btn.dataset.url;
        if (loadedUrls.includes(url)) {
            btn.textContent = 'Loaded';
            btn.classList.add('loaded');
        } else {
            btn.textContent = 'Add';
            btn.classList.remove('loaded');
        }
    });
}

function refreshPluginLists() {
    // Loaded plugins summary
    const loadedList = document.getElementById('loadedPluginsList');
    const tools = PluginRegistry.getAllTools();
    const toolboxes = PluginRegistry.getAllToolboxes();
    const boardTemplates = PluginRegistry.getAllBoards();

    const embeddedTools = tools.filter(t => t.source === 'embedded').length;
    const externalTools = tools.filter(t => t.source === 'external').length;
    const embeddedToolboxes = toolboxes.filter(t => t.source === 'embedded').length;
    const externalToolboxes = toolboxes.filter(t => t.source === 'external').length;
    const embeddedBoards = boardTemplates.filter(t => t.source === 'embedded').length;
    const externalBoards = boardTemplates.filter(t => t.source === 'external').length;

    loadedList.innerHTML = `
        <div class="plugin-item">
            <div class="plugin-item-info">
                <div class="plugin-item-name">Tools</div>
            </div>
            <span class="plugin-item-type">${embeddedTools} embedded</span>
            <span class="plugin-item-type">${externalTools} external</span>
        </div>
        <div class="plugin-item">
            <div class="plugin-item-info">
                <div class="plugin-item-name">Toolboxes</div>
            </div>
            <span class="plugin-item-type">${embeddedToolboxes} embedded</span>
            <span class="plugin-item-type">${externalToolboxes} external</span>
        </div>
        <div class="plugin-item">
            <div class="plugin-item-info">
                <div class="plugin-item-name">Board Templates</div>
            </div>
            <span class="plugin-item-type">${embeddedBoards} embedded</span>
            <span class="plugin-item-type">${externalBoards} external</span>
        </div>
    `;

    // Plugin URLs
    const urlsList = document.getElementById('pluginUrlsList');
    const urls = PluginLoader.getPluginUrls();

    if (urls.length === 0) {
        urlsList.innerHTML = '<div class="plugin-empty">No external plugins added.</div>';
    } else {
        urlsList.innerHTML = urls.map(url => `
            <div class="plugin-item">
                <div class="plugin-item-info">
                    <div class="plugin-item-url" title="${url}">${url}</div>
                </div>
                <button class="plugin-remove-btn" data-url="${url}">Remove</button>
            </div>
        `).join('');

        // Add remove handlers
        urlsList.querySelectorAll('.plugin-remove-btn').forEach(btn => {
            btn.onclick = () => {
                const url = btn.getAttribute('data-url');
                PluginLoader.removePluginUrl(url);
                refreshPluginLists();
            };
        });
    }
}

function openFeatureSelectModal() {
    const modal = document.getElementById('featureSelectModal');
    modal.classList.add('open');
}

function createNoteWithTemplate(templateId) {
    const template = NOTE_TEMPLATES[templateId] || PluginRegistry.getTool(templateId);
    if (!template) return;

    // Generate unique ID
    const toolId = 'custom-' + Date.now();

    // Add to custom notes list
    customTools.push(toolId);
    saveCustomTools(customTools);

    // Determine if content is HTML or Markdown
    const isHtml = template.content.trim().startsWith('<');

    // Initialize customizations with template content
    toolCustomizations[toolId] = {
        title: template.title,
        templateId: templateId, // Store template ID for HTML templates
        customContent: isHtml ? '' : template.content // Only store markdown in customContent
    };
    saveToolCustomizations(toolCustomizations);

    // Create and add the note to the toolboard
    const tool = createTool(toolId);
    if (tool) {
        const toolboard = document.getElementById('toolboard');
        toolboard.appendChild(tool);

        // Position it in a visible area with slight offset from others
        const offset = customTools.length * 20;
        tool.style.left = (100 + offset) + 'px';
        tool.style.top = (100 + offset) + 'px';

        // Bring to front
        maxZ++;
        tool.style.zIndex = maxZ;

        // Call onInit first if specified, then auto-fit after dynamic content renders
        const doAutoFit = () => {
            requestAnimationFrame(() => {
                autoFitToolContent(tool, false);

                // Update position with auto-fit dimensions
                positions[toolId] = {
                    x: 100 + offset,
                    y: 100 + offset,
                    width: tool.offsetWidth,
                    height: tool.offsetHeight,
                    z: maxZ
                };
                savePositions(positions);
            });
        };

        if (template.onInit && typeof window[template.onInit] === 'function') {
            // Call onInit first, then auto-fit after dynamic content has rendered
            setTimeout(() => {
                window[template.onInit]();
                // Wait for dynamic content to render before auto-fitting
                setTimeout(doAutoFit, 50);
            }, 50);
        } else {
            // No onInit, auto-fit immediately
            doAutoFit();
        }

        // For blank tools, open the content editor immediately
        if (templateId === 'blank') {
            openContentEditor(toolId);
        }
    }
}

function populateExportLists() {
    // Populate notes list (exclude hidden notes)
    const notesList = document.getElementById('exportToolsList');
    const visibleBuiltIn = SECTIONS.filter(id => !hiddenTools.includes(id));
    const allNotes = [...visibleBuiltIn, ...customTools];

    notesList.innerHTML = `
        <label class="select-all-row">
            <input type="checkbox" id="selectAllNotes"> <strong>Select All</strong>
        </label>
        ${allNotes.map(toolId => {
            const custom = toolCustomizations[toolId] || {};
            const content = getToolContent(toolId);
            const title = custom.title || (content ? content.title : toolId);
            const isCustom = customTools.includes(toolId);
            return `<label>
                <input type="checkbox" class="tool-checkbox" value="${toolId}">
                ${title}${isCustom ? ' <em>(custom)</em>' : ''}
            </label>`;
        }).join('')}
    `;

    // Select all for notes
    document.getElementById('selectAllNotes').onchange = (e) => {
        notesList.querySelectorAll('.tool-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
        });
    };

    // Populate boards list
    const boardsList = document.getElementById('exportBoardsList');
    boardsList.innerHTML = `
        <label class="select-all-row">
            <input type="checkbox" id="selectAllBoards"> <strong>Select All</strong>
        </label>
        ${boards.map(board => `<label>
            <input type="checkbox" class="board-checkbox" value="${board.id}"${board.id === currentBoardId ? ' checked' : ''}>
            ${board.name}${board.id === currentBoardId ? ' <em>(current)</em>' : ''}
        </label>`).join('')}
    `;

    // Select all for boards
    document.getElementById('selectAllBoards').onchange = (e) => {
        boardsList.querySelectorAll('.board-checkbox').forEach(cb => {
            cb.checked = e.target.checked;
        });
    };
}

function exportTools() {
    const checkboxes = document.querySelectorAll('.tool-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one note to export.');
        return;
    }

    const exportData = {
        type: 'tools',
        exportedAt: new Date().toISOString(),
        tools: []
    };

    checkboxes.forEach(cb => {
        const toolId = cb.value;
        const toolData = {
            id: toolId,
            isCustom: customTools.includes(toolId),
            customizations: toolCustomizations[toolId] || {},
            position: positions[toolId] || null
        };
        exportData.tools.push(toolData);
    });

    downloadJSON(exportData, `tools-export-${getTimestamp()}.json`);
}

function exportBoards() {
    const checkboxes = document.querySelectorAll('.board-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one board to export.');
        return;
    }

    const exportData = {
        type: 'boards',
        exportedAt: new Date().toISOString(),
        boards: []
    };

    checkboxes.forEach(cb => {
        const boardId = cb.value;
        const board = boards.find(b => b.id === boardId);

        // Get board-specific data
        const boardData = {
            id: boardId,
            name: board.name,
            variables: JSON.parse(localStorage.getItem(`finance_${boardId}_variables`) || 'null'),
            positions: JSON.parse(localStorage.getItem(`finance_${boardId}_positions`) || '{}'),
            toolCustomizations: JSON.parse(localStorage.getItem(`finance_${boardId}_toolCustomizations`) || '{}'),
            customTools: JSON.parse(localStorage.getItem(`finance_${boardId}_customTools`) || '[]'),
            hiddenTools: JSON.parse(localStorage.getItem(`finance_${boardId}_hiddenTools`) || '[]'),
            toolboardSettings: JSON.parse(localStorage.getItem(`finance_${boardId}_toolboardSettings`) || 'null')
        };

        exportData.boards.push(boardData);
    });

    downloadJSON(exportData, `boards-export-${getTimestamp()}.json`);
}

function getTimestamp() {
    const now = new Date();
    const pad = n => String(n).padStart(2, '0');
    return now.getFullYear() +
        pad(now.getMonth() + 1) +
        pad(now.getDate()) +
        pad(now.getHours()) +
        pad(now.getMinutes()) +
        pad(now.getSeconds());
}

function downloadJSON(data, filename) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportBoardAsHTML() {
    // Get current board data
    const boardTitle = document.getElementById('toolboardTitle').textContent || 'toolboard';
    const safeTitle = boardTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();

    // Collect all tool template IDs used in the current board
    const usedTemplateIds = new Set();
    Object.values(toolCustomizations).forEach(custom => {
        if (custom.templateId) {
            usedTemplateIds.add(custom.templateId);
        }
    });

    // Export plugins used by this board (includes external plugins if any)
    const exportedPlugins = PluginRegistry.exportForEmbed(Array.from(usedTemplateIds));

    const embeddedData = {
        boards: [{ id: 'default', name: boardTitle }],
        currentBoard: 'default',
        variables: variables,
        positions: positions,
        toolCustomizations: toolCustomizations,
        customTools: customTools,
        hiddenTools: hiddenTools,
        toolboardSettings: toolboardSettings,
        // Include plugin data for self-contained export
        plugins: {
            tools: exportedPlugins.tools,
            toolboxes: exportedPlugins.toolboxes
        }
    };

    // Close modal before capturing HTML
    const modal = document.getElementById('importExportModal');
    modal.classList.remove('open');

    // Remove any existing embedded-board-data script before capturing
    const existingEmbed = document.getElementById('embedded-board-data');
    if (existingEmbed) existingEmbed.remove();

    // Remove plugin-injected scripts before capturing (they cause issues in exported HTML)
    // The exported HTML uses embedded plugin data instead
    const devScripts = document.getElementById('developer-tools-scripts');
    const finScripts = document.getElementById('finance-tools-scripts');
    if (devScripts) devScripts.remove();
    if (finScripts) finScripts.remove();

    // Get the full HTML of the current document
    const originalHTML = document.documentElement.outerHTML;

    // Re-inject the scripts so they work on the current page after export
    if (typeof injectScriptsForExport === 'undefined') {
        // Scripts were removed; they'll be re-injected when plugins reload if needed
    }

    // Reopen modal briefly so user sees it close after download
    modal.classList.add('open');

    // Create embedded data and import script
    // Base64 encode JSON to avoid any HTML/JS parsing issues
    const jsonData = JSON.stringify(embeddedData);
    const encodedData = btoa(unescape(encodeURIComponent(jsonData)));

    // Data element holds the base64-encoded board data
    const dataElement = '\x3Cscript id="embedded-board-data" type="text/plain">' +
        encodedData + '\x3C/script>\n';

    // Import script goes before </body> so PluginRegistry exists
    const importScript = dataElement + '\x3Cscript>\n' +
        '// Auto-import embedded board data and plugins on load\n' +
        '(function() {\n' +
        '    var dataScript = document.getElementById("embedded-board-data");\n' +
        '    if (!dataScript) return;\n' +
        '    try {\n' +
        '        var data = JSON.parse(decodeURIComponent(escape(atob(dataScript.textContent))));\n' +
        '        // Register embedded plugins first (before app loads)\n' +
        '        if (data.plugins && typeof PluginRegistry !== "undefined") {\n' +
        '            (data.plugins.toolboxes || []).forEach(function(tb) {\n' +
        '                tb.source = "embedded";\n' +
        '                PluginRegistry.registerToolbox(tb);\n' +
        '            });\n' +
        '            (data.plugins.tools || []).forEach(function(t) {\n' +
        '                t.source = "embedded";\n' +
        '                PluginRegistry.registerTool(t);\n' +
        '            });\n' +
        '        }\n' +
        '        // Store board data in localStorage\n' +
        '        localStorage.setItem("financeBoards", JSON.stringify(data.boards));\n' +
        '        localStorage.setItem("financeCurrentBoard", "default");\n' +
        '        localStorage.setItem("finance_default_variables", JSON.stringify(data.variables));\n' +
        '        localStorage.setItem("finance_default_positions", JSON.stringify(data.positions));\n' +
        '        localStorage.setItem("finance_default_toolCustomizations", JSON.stringify(data.toolCustomizations));\n' +
        '        localStorage.setItem("finance_default_customTools", JSON.stringify(data.customTools));\n' +
        '        localStorage.setItem("finance_default_hiddenTools", JSON.stringify(data.hiddenTools));\n' +
        '        localStorage.setItem("finance_default_toolboardSettings", JSON.stringify(data.toolboardSettings));\n' +
        '        // Clear plugin URLs so exported HTML does not try to load external files\n' +
        '        localStorage.removeItem("toolboard_pluginUrls");\n' +
        '        dataScript.remove();\n' +
        '    } catch (e) { console.error("Failed to import embedded board data:", e); }\n' +
        '})();\n' +
        '\x3C/script>\n';

    // Insert flag script at start of <head> (if not already there) and import script before </body>
    let htmlContent = '<!DOCTYPE html>\n' + originalHTML;

    // Only add flag if not already present
    if (!htmlContent.includes('TOOLBOARD_EMBEDDED')) {
        htmlContent = htmlContent.replace(/<head>/i, '<head>\n\x3Cscript>window.TOOLBOARD_EMBEDDED=true;\x3C/script>');
    }

    // Find the LAST </body> tag (not ones inside JS template strings)
    const lastBodyIdx = htmlContent.lastIndexOf('</body>');
    if (lastBodyIdx !== -1) {
        htmlContent = htmlContent.slice(0, lastBodyIdx) + importScript + htmlContent.slice(lastBodyIdx);
    }

    // Download
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${safeTitle}-${getTimestamp()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Close modal
    document.getElementById('importExportModal').classList.remove('open');
}

function exportBoardAsPNG() {
    // Load html2canvas dynamically if not already loaded
    if (typeof html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = () => captureAndDownloadPNG();
        script.onerror = () => alert('Failed to load image export library. Please check your internet connection.');
        document.head.appendChild(script);
    } else {
        captureAndDownloadPNG();
    }
}

function captureAndDownloadPNG() {
    const boardTitle = document.getElementById('toolboardTitle').textContent || 'toolboard';
    const safeTitle = boardTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();

    // Close modal first so it's not in the screenshot
    document.getElementById('importExportModal').classList.remove('open');

    // Small delay to let the modal close
    setTimeout(() => {
        // Capture the entire page
        html2canvas(document.body, {
            backgroundColor: getComputedStyle(document.body).backgroundColor || '#1a1a2e',
            scale: 2, // Higher quality
            useCORS: true,
            logging: false,
            windowWidth: document.documentElement.scrollWidth,
            windowHeight: document.documentElement.scrollHeight
        }).then(canvas => {
            // Download the image
            const link = document.createElement('a');
            link.download = `${safeTitle}-${getTimestamp()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error('PNG export error:', err);
            alert('Failed to export as PNG. Please try again.');
        });
    }, 100);
}

function handleFileImport(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        document.getElementById('importTextarea').value = event.target.result;
    };
    reader.readAsText(file);
}

function importData() {
    const textarea = document.getElementById('importTextarea');
    const resultDiv = document.getElementById('importResult');

    try {
        const data = JSON.parse(textarea.value);

        if (data.type === 'tools' || data.type === 'notes') {
            importTools(data);
            resultDiv.className = 'import-result success';
            const toolsList = data.tools || data.notes;
            resultDiv.textContent = `Successfully imported ${toolsList.length} tool(s).`;
        } else if (data.type === 'boards') {
            importBoards(data);
            resultDiv.className = 'import-result success';
            resultDiv.textContent = `Successfully imported ${data.boards.length} board(s).`;
        } else {
            throw new Error('Unknown export format. Expected "tools" or "boards" type.');
        }

        // Refresh the UI
        renderToolboard();
        populateBoardSelector();
        populateExportLists();

    } catch (err) {
        resultDiv.className = 'import-result error';
        resultDiv.textContent = `Error: ${err.message}`;
    }
}

function importTools(data) {
    const toolsList = data.tools || data.notes; // Support both new and old format
    toolsList.forEach(toolData => {
        let toolId = toolData.id;

        // If it's a custom tool, check for conflicts
        if (toolData.isCustom) {
            // Generate new ID if already exists
            if (customTools.includes(toolId)) {
                toolId = 'custom-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            }
            // Add to custom tools
            if (!customTools.includes(toolId)) {
                customTools.push(toolId);
            }
        }

        // Import customizations
        if (toolData.customizations && Object.keys(toolData.customizations).length > 0) {
            toolCustomizations[toolId] = { ...toolData.customizations };
        }

        // Import position (with offset if position exists)
        if (toolData.position) {
            const pos = { ...toolData.position };
            // Offset if position already taken
            if (positions[toolId]) {
                pos.x = (pos.x || 0) + 30;
                pos.y = (pos.y || 0) + 30;
            }
            pos.z = ++maxZ;
            positions[toolId] = pos;
        }
    });

    // Save changes
    saveCustomTools(customTools);
    saveToolCustomizations(toolCustomizations);
    savePositions(positions);
}

function importBoards(data) {
    data.boards.forEach(boardData => {
        let boardId = boardData.id;

        // Check for conflicts and generate new ID if needed
        if (boards.some(b => b.id === boardId)) {
            boardId = 'board-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
        }

        // Add board to list
        boards.push({
            id: boardId,
            name: boardData.name || 'Imported Board'
        });

        // Save board-specific data
        if (boardData.variables) {
            localStorage.setItem(`finance_${boardId}_variables`, JSON.stringify(boardData.variables));
        }
        if (boardData.positions) {
            localStorage.setItem(`finance_${boardId}_positions`, JSON.stringify(boardData.positions));
        }
        if (boardData.toolCustomizations) {
            localStorage.setItem(`finance_${boardId}_toolCustomizations`, JSON.stringify(boardData.toolCustomizations));
        }
        if (boardData.customTools) {
            localStorage.setItem(`finance_${boardId}_customTools`, JSON.stringify(boardData.customTools));
        }
        if (boardData.hiddenTools) {
            localStorage.setItem(`finance_${boardId}_hiddenTools`, JSON.stringify(boardData.hiddenTools));
        }
        if (boardData.toolboardSettings) {
            localStorage.setItem(`finance_${boardId}_toolboardSettings`, JSON.stringify(boardData.toolboardSettings));
        }
    });

    // Save updated boards list
    saveBoards(boards);
}

function setupButtons() {
    document.getElementById('addToolBtn').onclick = addNewNote;

    // Minimize/Maximize all
    document.getElementById('minimizeAllBtn').onclick = toggleMinimizeAll;

    // Delete all tools
    document.getElementById('deleteAllBtn').onclick = deleteAllTools;
}

// Add a new custom note - now shows feature selection modal
function addNewNote() {
    openFeatureSelectModal();
}

// Delete a custom note
function deleteTool(toolId) {
    const isCustom = customTools.includes(toolId);
    const isBuiltIn = SECTIONS.includes(toolId);

    if (!isCustom && !isBuiltIn) return;

    const message = isCustom
        ? 'Delete this note? This cannot be undone.'
        : 'Hide this note? You can restore it later from the Import/Export menu.';

    if (confirm(message)) {
        if (isCustom) {
            // Remove from customTools array
            customTools = customTools.filter(id => id !== toolId);
            saveCustomTools(customTools);

            // Remove customizations
            delete toolCustomizations[toolId];
            saveToolCustomizations(toolCustomizations);

            // Remove position data
            delete positions[toolId];
            savePositions(positions);
        } else {
            // Hide built-in note
            if (!hiddenTools.includes(toolId)) {
                hiddenTools.push(toolId);
                saveHiddenTools(hiddenTools);
            }
        }

        // Remove from DOM
        const tool = document.querySelector(`[data-tool="${toolId}"]`);
        if (tool) {
            tool.remove();
        }
    }
}

// Toggle minimize/maximize all tools
function toggleMinimizeAll() {
    const tools = document.querySelectorAll('#toolboard .tool');
    if (tools.length === 0) return;

    // If any tool is expanded, minimize all; otherwise maximize all
    const anyExpanded = [...tools].some(t => !t.classList.contains('minimized'));

    tools.forEach(tool => {
        const toolId = tool.getAttribute('data-tool');
        const btn = tool.querySelector('.minimize-btn');
        if (anyExpanded) {
            tool.classList.add('minimized');
            if (btn) btn.classList.add('minimized');
        } else {
            tool.classList.remove('minimized');
            if (btn) btn.classList.remove('minimized');
        }
        toolCustomizations[toolId] = toolCustomizations[toolId] || {};
        toolCustomizations[toolId].minimized = anyExpanded;
    });
    saveToolCustomizations(toolCustomizations);
}

// Delete all tools on the current board
function deleteAllTools() {
    const tools = document.querySelectorAll('#toolboard .tool');
    if (tools.length === 0) return;

    if (!confirm('Delete all tools on this board? This cannot be undone.')) return;

    tools.forEach(tool => {
        const toolId = tool.getAttribute('data-tool');
        const isCustom = customTools.includes(toolId);
        const isBuiltIn = SECTIONS.includes(toolId);

        if (isCustom) {
            customTools = customTools.filter(id => id !== toolId);
            delete toolCustomizations[toolId];
            delete positions[toolId];
        } else if (isBuiltIn) {
            if (!hiddenTools.includes(toolId)) {
                hiddenTools.push(toolId);
            }
        }
        tool.remove();
    });

    saveCustomTools(customTools);
    saveToolCustomizations(toolCustomizations);
    savePositions(positions);
    saveHiddenTools(hiddenTools);
}

// Duplicate a tool
function duplicateTool(toolId) {
    const sourceCustom = toolCustomizations[toolId] || {};
    const sourcePos = positions[toolId] || { x: 50, y: 50 };

    // Generate new tool ID
    const newToolId = 'tool_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Add to custom tools
    customTools.push(newToolId);
    saveCustomTools(customTools);

    // Copy customizations (deep clone)
    toolCustomizations[newToolId] = JSON.parse(JSON.stringify(sourceCustom));
    toolCustomizations[newToolId].title = (sourceCustom.title || 'Tool') + ' (Copy)';
    saveToolCustomizations(toolCustomizations);

    // Set position offset from original
    positions[newToolId] = {
        x: sourcePos.x + 30,
        y: sourcePos.y + 30,
        z: ++maxZ,
        width: sourcePos.width,
        height: sourcePos.height
    };
    savePositions(positions);

    // Create and add the tool to DOM
    const tool = createTool(newToolId);
    if (tool) {
        document.getElementById('toolboard').appendChild(tool);
        // Initialize if it's a checklist or calculator
        initializeCalculators();
    }
}

// Export a tool as HTML file
function exportToolAsHtml(toolId) {
    const custom = toolCustomizations[toolId] || {};
    const content = getToolContent(toolId);
    const title = custom.title || content.title || 'Tool';
    const headerColor = custom.color || '#34495e';

    // Check if this is an interactive tool that needs the full app
    const noteEl = document.querySelector(`[data-tool="${toolId}"]`);
    const contentEl = noteEl?.querySelector('.tool-content');
    const isInteractiveTool = contentEl?.querySelector('.seq-widget, .diff-widget, .calendar-widget, .loan-calc-widget, .jwt-widget');

    if (isInteractiveTool) {
        // Use full-app export for interactive tools
        exportToolAsFullHtml(toolId, title);
        return;
    }

    // Simple export for static content
    let bodyContent = '';

    if (contentEl) {
        bodyContent = contentEl.innerHTML;
    }

    // If it's a checklist, render it nicely for export
    if (custom.checklistItems && custom.checklistItems.length > 0) {
        bodyContent = renderChecklistForExport(custom.checklistItems);
    }

    const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(title)}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        .tool {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }
        .tool-header {
            background: ${headerColor};
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
        }
        .tool-content {
            padding: 20px;
        }
        h1, h2, h3, h4, h5, h6 { margin: 1em 0 0.5em; color: #2c3e50; }
        p { margin: 0.5em 0; }
        ul, ol { margin: 0.5em 0; padding-left: 1.5em; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
        pre { background: #f4f4f4; padding: 12px; border-radius: 4px; overflow-x: auto; }
        pre code { background: none; padding: 0; }
        table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
        blockquote { border-left: 3px solid #3498db; margin: 1em 0; padding-left: 1em; color: #666; }
        a { color: #3498db; }
        img { max-width: 100%; height: auto; }
        .checklist { list-style: none; padding: 0; }
        .checklist-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .checklist-item:last-child { border-bottom: none; }
        .status { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .status.completed { background: #27ae60; border-color: #27ae60; color: white; }
        .status.in_progress { background: #f39c12; border-color: #f39c12; color: white; font-size: 10px; }
        .item-text { flex: 1; }
        .item-text.completed { text-decoration: line-through; color: #999; }
        .subitems { margin-left: 30px; padding-left: 10px; border-left: 2px solid #eee; }
        .exported-date { text-align: center; color: #999; font-size: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="tool">
        <div class="tool-header">${escapeHtml(title)}</div>
        <div class="tool-content">
            ${bodyContent}
            <div class="exported-date">Exported from Toolboard.me on ${new Date().toLocaleDateString()}</div>
        </div>
    </div>
</body>
</html>`;

    // Download the file
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Export interactive tool as full standalone HTML (like board export but single tool)
function exportToolAsFullHtml(toolId, title) {
    const custom = toolCustomizations[toolId] || {};
    const pos = positions[toolId] || {};

    // Create minimal data for just this one tool
    const embeddedData = {
        boards: [{ id: 'default', name: title }],
        currentBoard: 'default',
        variables: {},
        positions: {
            [toolId]: {
                x: 50,
                y: 20,
                w: pos.w || 500,
                h: pos.h || 400,
                z: 1
            }
        },
        toolCustomizations: {
            [toolId]: custom
        },
        customTools: customTools.includes(toolId) ? [toolId] : [],
        hiddenTools: customTools.filter(id => id !== toolId),
        toolboardSettings: {
            title: title,
            color: custom.color || toolboardSettings.color || '#34495e'
        }
    };

    // Close any open modals
    document.querySelectorAll('.modal.open, .tool-settings.open').forEach(m => m.classList.remove('open'));

    // Remove plugin-injected scripts before capturing (they cause issues in exported HTML)
    const devScripts = document.getElementById('developer-tools-scripts');
    const finScripts = document.getElementById('finance-tools-scripts');
    if (devScripts) devScripts.remove();
    if (finScripts) finScripts.remove();

    // Get the full HTML of the current document
    const originalHTML = document.documentElement.outerHTML;

    // Create embedded data and import script
    // Base64 encode JSON to avoid any HTML/JS parsing issues
    const jsonData = JSON.stringify(embeddedData);
    const encodedData = btoa(unescape(encodeURIComponent(jsonData)));

    // Data element holds the base64-encoded tool data
    const dataElement = '\x3Cscript id="embedded-tool-data" type="text/plain">' +
        encodedData + '\x3C/script>\n';

    // Import script goes before </body> so PluginRegistry exists
    const importScript = dataElement + '\x3Cscript>\n' +
        '// Auto-import embedded tool data on load\n' +
        '(function() {\n' +
        '    var dataScript = document.getElementById("embedded-tool-data");\n' +
        '    if (!dataScript) return;\n' +
        '    try {\n' +
        '        var data = JSON.parse(decodeURIComponent(escape(atob(dataScript.textContent))));\n' +
        '        localStorage.setItem("financeBoards", JSON.stringify(data.boards));\n' +
        '        localStorage.setItem("financeCurrentBoard", "default");\n' +
        '        localStorage.setItem("finance_default_variables", JSON.stringify(data.variables));\n' +
        '        localStorage.setItem("finance_default_positions", JSON.stringify(data.positions));\n' +
        '        localStorage.setItem("finance_default_toolCustomizations", JSON.stringify(data.toolCustomizations));\n' +
        '        localStorage.setItem("finance_default_customTools", JSON.stringify(data.customTools));\n' +
        '        localStorage.setItem("finance_default_hiddenTools", JSON.stringify(data.hiddenTools));\n' +
        '        localStorage.setItem("finance_default_toolboardSettings", JSON.stringify(data.toolboardSettings));\n' +
        '        // Clear plugin URLs so exported HTML does not try to load external files\n' +
        '        localStorage.removeItem("toolboard_pluginUrls");\n' +
        '        dataScript.remove();\n' +
        '    } catch (e) { console.error("Failed to import embedded tool data:", e); }\n' +
        '})();\n' +
        '\x3C/script>\n';

    // Insert flag script at start of <head> (if not already there) and import script before </body>
    let htmlContent = '<!DOCTYPE html>\n' + originalHTML;

    // Only add flag if not already present
    if (!htmlContent.includes('TOOLBOARD_EMBEDDED')) {
        htmlContent = htmlContent.replace(/<head>/i, '<head>\n\x3Cscript>window.TOOLBOARD_EMBEDDED=true;\x3C/script>');
    }

    // Find the LAST </body> tag (not ones inside JS template strings)
    const lastBodyIdx = htmlContent.lastIndexOf('</body>');
    if (lastBodyIdx !== -1) {
        htmlContent = htmlContent.slice(0, lastBodyIdx) + importScript + htmlContent.slice(lastBodyIdx);
    }

    // Download
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Render checklist items for HTML export
function renderChecklistForExport(items, isSublist = false) {
    const listClass = isSublist ? 'subitems' : 'checklist';
    let html = `<ul class="${listClass}">`;

    items.forEach(item => {
        const status = item.status || 'pending';
        const statusIcon = status === 'completed' ? '✓' : (status === 'in_progress' ? '▶' : '');
        const textClass = status === 'completed' ? 'completed' : '';

        html += `<li class="checklist-item">
            <span class="status ${status}">${statusIcon}</span>
            <span class="item-text ${textClass}">${escapeHtml(item.text)}</span>
        </li>`;

        if (item.children && item.children.length > 0) {
            html += renderChecklistForExport(item.children, true);
        }
    });

    html += '</ul>';
    return html;
}

// Export a note as PNG image
async function exportToolAsPng(toolId) {
    const noteEl = document.querySelector(`[data-tool="${toolId}"]`);
    if (!noteEl) return;

    const custom = toolCustomizations[toolId] || {};
    const content = getToolContent(toolId);
    const title = custom.title || content.title || 'Note';

    // Store original styles
    const originalPosition = noteEl.style.position;
    const originalTransform = noteEl.style.transform;
    const originalBoxShadow = noteEl.style.boxShadow;

    try {
        // Temporarily adjust note for better capture
        noteEl.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';

        // Use html2canvas to capture the note
        const canvas = await html2canvas(noteEl, {
            backgroundColor: null,
            scale: 2, // Higher resolution
            logging: false,
            useCORS: true,
            allowTaint: true
        });

        // Restore original styles
        noteEl.style.position = originalPosition;
        noteEl.style.transform = originalTransform;
        noteEl.style.boxShadow = originalBoxShadow;

        // Convert to PNG and download
        const link = document.createElement('a');
        link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    } catch (error) {
        // Restore original styles on error
        noteEl.style.position = originalPosition;
        noteEl.style.transform = originalTransform;
        noteEl.style.boxShadow = originalBoxShadow;

        console.error('Error exporting note as PNG:', error);
        alert('Failed to export note as PNG. Please try again.');
    }
}

// Board management functions

function updateBoardSelectorLabel() {
    const trigger = document.getElementById('boardSelectorTrigger');
    if (!trigger) return;
    const board = boards.find(b => b.id === currentBoardId);
    trigger.textContent = board ? board.name : 'Board';
}

function populateBoardSelector() {
    updateBoardSelectorLabel();
}

function updateDeleteBoardButton() {
    // No-op: delete state is handled per-row in the board manager popup
}

function openBoardManager() {
    const overlay = document.getElementById('boardManagerOverlay');
    renderBoardList();
    overlay.classList.add('open');
}

function closeBoardManager() {
    document.getElementById('boardManagerOverlay').classList.remove('open');
}

function renderBoardList() {
    const list = document.getElementById('boardManagerList');
    list.innerHTML = '';

    boards.forEach(board => {
        const row = document.createElement('div');
        row.className = 'board-manager-item' + (board.id === currentBoardId ? ' active' : '');
        row.dataset.boardId = board.id;

        const nameSpan = document.createElement('span');
        nameSpan.className = 'board-manager-item-name';
        nameSpan.textContent = board.name;

        const actions = document.createElement('div');
        actions.className = 'board-manager-actions';

        const renameBtn = document.createElement('button');
        renameBtn.title = 'Rename';
        renameBtn.textContent = '\u270E';
        renameBtn.onclick = (e) => { e.stopPropagation(); startInlineRename(row, board); };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'board-manager-delete-btn';
        deleteBtn.title = 'Delete';
        deleteBtn.textContent = '\u00D7';
        deleteBtn.disabled = boards.length <= 1;
        if (boards.length <= 1) deleteBtn.style.opacity = '0.3';
        deleteBtn.onclick = (e) => { e.stopPropagation(); showDeleteConfirmation(row, board); };

        actions.appendChild(renameBtn);
        actions.appendChild(deleteBtn);

        row.appendChild(nameSpan);
        row.appendChild(actions);

        // Click row to switch board
        row.onclick = () => {
            if (board.id !== currentBoardId) {
                switchToBoard(board.id);
            }
            closeBoardManager();
        };

        // Double-click name to rename
        nameSpan.ondblclick = (e) => { e.stopPropagation(); startInlineRename(row, board); };

        list.appendChild(row);
    });
}

function startInlineRename(row, board) {
    const nameSpan = row.querySelector('.board-manager-item-name');
    const actions = row.querySelector('.board-manager-actions');
    if (!nameSpan) return;

    // Hide name and actions, show input
    nameSpan.style.display = 'none';
    if (actions) actions.style.display = 'none';

    const input = document.createElement('input');
    input.className = 'board-manager-rename-input';
    input.type = 'text';
    input.value = board.name;
    row.insertBefore(input, actions);
    input.focus();
    input.select();

    const commit = () => {
        const newName = input.value.trim();
        if (newName && newName !== board.name) {
            board.name = newName;
            saveBoards(boards);
            // If this is the current board, update settings too
            if (board.id === currentBoardId) {
                toolboardSettings.title = newName;
                localStorage.setItem(boardKey('toolboardSettings'), JSON.stringify(toolboardSettings));
                document.getElementById('toolboardTitle').textContent = newName;
                document.getElementById('toolboardTitleInput').value = newName;
                document.title = newName + ' - Toolboard';
                updateBoardSelectorLabel();
            }
        }
        cleanup();
    };

    const cancel = () => { cleanup(); };

    const cleanup = () => {
        if (input.parentNode) input.remove();
        nameSpan.style.display = '';
        nameSpan.textContent = board.name;
        if (actions) actions.style.display = '';
    };

    input.onkeydown = (e) => {
        if (e.key === 'Enter') { e.preventDefault(); commit(); }
        if (e.key === 'Escape') { e.preventDefault(); cancel(); }
    };
    input.onblur = commit;
}

function showDeleteConfirmation(row, board) {
    if (boards.length <= 1) return;

    const parent = row.parentNode;
    const confirmRow = document.createElement('div');
    confirmRow.className = 'board-manager-confirm-row';

    const msg = document.createElement('span');
    msg.textContent = `Delete "${board.name}"?`;

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'board-manager-confirm-delete';
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => {
        deleteBoard(board.id);
        renderBoardList();
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'board-manager-confirm-cancel';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = () => {
        parent.replaceChild(row, confirmRow);
    };

    confirmRow.appendChild(msg);
    confirmRow.appendChild(deleteBtn);
    confirmRow.appendChild(cancelBtn);

    parent.replaceChild(confirmRow, row);
}

function deleteBoard(boardId) {
    if (boards.length <= 1) return;

    const prefix = `finance_${boardId}_`;
    // Remove board-specific data from localStorage
    localStorage.removeItem(prefix + 'variables');
    localStorage.removeItem(prefix + 'positions');
    localStorage.removeItem(prefix + 'toolCustomizations');
    localStorage.removeItem(prefix + 'customTools');
    localStorage.removeItem(prefix + 'hiddenTools');
    localStorage.removeItem(prefix + 'toolboardSettings');

    // Remove from boards array
    boards = boards.filter(b => b.id !== boardId);
    saveBoards(boards);

    // If we deleted the current board, switch to the first available
    if (boardId === currentBoardId) {
        switchToBoard(boards[0].id);
    } else {
        updateBoardSelectorLabel();
    }
}

function createNewBoardInline() {
    const list = document.getElementById('boardManagerList');

    // Remove any existing new-board input row
    const existing = list.querySelector('.board-manager-new-input-row');
    if (existing) existing.remove();

    const inputRow = document.createElement('div');
    inputRow.className = 'board-manager-new-input-row';

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Board name...';
    inputRow.appendChild(input);
    list.appendChild(inputRow);

    input.focus();
    list.scrollTop = list.scrollHeight;

    const commit = () => {
        const name = input.value.trim();
        if (name) {
            const newBoardId = 'board-' + Date.now();
            boards.push({ id: newBoardId, name: name });
            saveBoards(boards);
            localStorage.setItem(`finance_${newBoardId}_toolboardSettings`, JSON.stringify({ title: name, color: '#2c3e50' }));
            switchToBoard(newBoardId);
            closeBoardManager();
        } else {
            inputRow.remove();
        }
    };

    input.onkeydown = (e) => {
        if (e.key === 'Enter') { e.preventDefault(); commit(); }
        if (e.key === 'Escape') { e.preventDefault(); inputRow.remove(); }
    };
    input.onblur = () => {
        // Small delay to allow click events to fire first
        setTimeout(() => { if (inputRow.parentNode) commit(); }, 100);
    };
}

function createNewBoard() {
    // Legacy fallback — delegates to inline creation
    openBoardManager();
    setTimeout(createNewBoardInline, 50);
}

function switchToBoard(boardId) {
    if (boardId === currentBoardId) return;

    currentBoardId = boardId;
    setCurrentBoardId(boardId);

    // Reload all board-specific data
    variables = loadVariables();
    positions = loadPositions();
    toolCustomizations = loadToolCustomizations();
    customTools = loadCustomTools();
    hiddenTools = loadHiddenTools();
    toolboardSettings = loadToolboardSettings();
    maxZ = Math.max(...Object.values(positions).map(p => p.z || 1), 1);

    // Update UI
    updateBoardSelectorLabel();
    applyToolboardSettings();
    renderToolboard();
}

function deleteCurrentBoard() {
    deleteBoard(currentBoardId);
}

function renameBoardInSelector() {
    const currentBoard = boards.find(b => b.id === currentBoardId);
    if (currentBoard && toolboardSettings.title !== currentBoard.name) {
        currentBoard.name = toolboardSettings.title;
        saveBoards(boards);
        updateBoardSelectorLabel();
    }
}

function setupBoardManager() {
    const trigger = document.getElementById('boardSelectorTrigger');
    const overlay = document.getElementById('boardManagerOverlay');
    const closeBtn = overlay.querySelector('.board-manager-close');
    const newBtn = document.getElementById('boardManagerNewBtn');

    trigger.onclick = openBoardManager;
    closeBtn.onclick = closeBoardManager;
    newBtn.onclick = createNewBoardInline;

    // Close on backdrop click
    overlay.onclick = (e) => {
        if (e.target === overlay) closeBoardManager();
    };

    // Close on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('open')) {
            closeBoardManager();
        }
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
